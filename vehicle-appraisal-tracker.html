<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tracker Fatturazione</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        #preloader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.75); z-index: 99999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            opacity: 1; visibility: visible;
        }
        #preloader.hidden { opacity: 0; visibility: hidden; transition: opacity 0.7s ease-out, visibility 0.7s ease-out; }
        .loader-bar-container { display: flex; gap: 10px; margin-bottom: 25px; }
        .loader-bar { width: 15px; height: 70px; background-color: #007bff; border-radius: 3px; animation: barPulse 1.2s infinite ease-in-out; }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }
        @keyframes barPulse { 0%, 100% { transform: scaleY(0.3); opacity: 0.6; } 50% { transform: scaleY(1); opacity: 1; } }
        #preloader .loading-text { color: #00aeff; font-size: 1.6em; text-align: center; }

        body { font-family: sans-serif; line-height: 1.6; margin: 0; background-color: #1e1e1e; color: #f0f0f0; padding-bottom: 70px; }
        .content-wrapper { padding: 20px; }
        h1, h2 { text-align: center; color: #ffffff; }
        #pageHeaderContainer { background-color: #1e1e1e; z-index: 1000; width: 100%; }
        #pageHeaderContainer.fixed-header { position: fixed; top: 0; left: 0; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 2030; }
        .header-export-row { display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        .header-export-row label { color: #ccc; }
        .header-export-row input[type="month"] { padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; }
        .action-button { padding: 8px 15px; cursor: pointer; background-color: #007bff; color: white; border: 1px solid #0056b3; border-radius: 4px; font-size: 0.9em; }
        .action-button:hover { background-color: #0056b3; border-color: #004085; }
        .action-button.secondary { background-color: #6c757d; border-color: #5a6268; }
        .action-button.success { background-color: #28a745; border-color: #1e7e34; }

        #landingPageSection, #saveRecordSection, .camera-page-section {
            padding: 20px; border: 1px solid #444; border-radius: 8px; margin-top: 20px; background-color: #2a2a2a;
            max-width: 850px; margin-left: auto; margin-right: auto;
        }
        #saveRecordSection { display: none; }
        .camera-page-section { display: none; position: fixed; inset: 0; z-index: 4000; background: #000; }
        .camera-page-section .camera-page-inner { position: absolute; inset: 0; }

        .table-scroll-wrapper { overflow-x: auto; width: 100%; margin-bottom: 10px; border: 1px solid #444; border-radius: 4px; }
        .tracking-table { width: 100%; min-width: 320px; border-collapse: collapse; }
        .tracking-table th, .tracking-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #444; }
        .tracking-table th { background-color: #3a3a3a; color: #ddd; font-weight: bold; }
        .tracking-table tbody tr:hover { background-color: #333; }
        #trackingListContainer { max-height: 350px; overflow-y: auto; }
        #trackingListContainer:empty::after { content: 'Nessuna registrazione. Usa "Aggiungi" o "Scansiona Targa".'; display: block; padding: 20px; color: #888; text-align: center; }

        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; color: #e0e0e0; }
        .form-group input[type="text"], .form-group select { width: 100%; padding: 10px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; box-sizing: border-box; }
        #saveRecordSection .actions { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        #saveRecordSection .actions .action-button { flex: 1; min-width: 120px; }

        /* Targa Scan OCR (stessi stili dell'app perizie) */
        #targaScanPageSection { z-index: 4000; }
        #targaScanStream { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #targaFocusBox {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80vw; max-width: 400px; height: 20vw; max-height: 100px;
            border: 3px solid rgba(255, 255, 0, 0.8);
            box-shadow: 0 0 15px rgba(0,0,0,0.7), 0 0 0 100vw rgba(0,0,0,0.5);
            border-radius: 8px; z-index: 4010;
        }
        #ocrResultDisplay {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background-color: rgba(0,0,0,0.7); color: #fff; padding: 10px 20px; border-radius: 5px;
            font-size: 1.2em; text-align: center; min-width: 250px; z-index: 4020;
        }
        #ocrResultDisplay.success { background-color: rgba(40, 167, 69, 0.8); }
        #ocrResultDisplay.error { background-color: rgba(220, 53, 69, 0.8); }
        #closeTargaScanBtn {
            position: absolute; top: 20px; right: 20px; z-index: 4020;
            width: 45px; height: 45px; background-color: rgba(40, 40, 40, 0.8); color: #ff4d4d;
            border: 1px solid #ff4d4d; border-radius: 4px; font-size: 1.8em; line-height: 43px; text-align: center; padding: 0; cursor: pointer;
        }
        #targaScanCanvas { display: none; }

        #bottomNavCircles {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: flex; justify-content: space-around; align-items: center; padding: 10px 0;
            box-sizing: border-box; background-color: #2a2a2a; border-top: 1px solid #444; z-index: 2025;
        }
        .circle-button {
            width: 75px; height: 75px; background-color: #383838; color: #e0e0e0; border: 1px solid #555;
            border-radius: 6px; flex-shrink: 0; display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 2em; transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .circle-button:hover { background-color: #4a4a4a; transform: translateY(-2px); }
        .circle-button i { line-height: 1; }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="pageHeaderContainer" class="fixed-header">
        <h1 id="mainTitleGlobal">Tracker Fatturazione</h1>
        <div class="header-export-row">
            <label for="inputMonth">Mese:</label>
            <input type="month" id="inputMonth">
            <button type="button" id="btnExportCsv" class="action-button">Esporta CSV</button>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;">
            <h2 style="margin-top: 10px;">Elenco Targhe Registrate</h2>
            <div class="table-scroll-wrapper">
                <table class="tracking-table">
                    <thead>
                        <tr><th>Data</th><th>Ora</th><th>Targa</th><th>Committente</th></tr>
                    </thead>
                    <tbody id="trackingListContainer"></tbody>
                </table>
            </div>
            <div style="margin-top: 15px; text-align: center;">
                <button type="button" id="btnAggiungi" class="action-button success"><i class="fas fa-plus"></i> Aggiungi</button>
            </div>
        </div>

        <div id="saveRecordSection">
            <h2 style="margin-top: 10px;">Salva Registrazione</h2>
            <div class="form-group">
                <label for="inputTarga">Targa</label>
                <input type="text" id="inputTarga" placeholder="Es. AB123CD" maxlength="10" autocomplete="off">
            </div>
            <div class="form-group">
                <label for="selectCommittente">Committente</label>
                <select id="selectCommittente">
                    <option value="Privato">Privato</option>
                    <option value="Concessionaria Rossi">Concessionaria Rossi</option>
                    <option value="Assicurazione Y">Assicurazione Y</option>
                </select>
            </div>
            <div class="actions">
                <button type="button" id="btnSalva" class="action-button success">Salva</button>
                <button type="button" id="btnAnnullaSave" class="action-button secondary">Annulla</button>
            </div>
        </div>

        <div id="targaScanPageSection" class="camera-page-section">
            <div class="camera-page-inner">
                <video id="targaScanStream" autoplay playsinline></video>
                <canvas id="targaScanCanvas"></canvas>
                <div id="targaFocusBox"></div>
                <div id="ocrResultDisplay">Inquadra la targa...</div>
                <button type="button" id="closeTargaScanBtn" class="action-button">×</button>
            </div>
        </div>
    </div>

    <div id="bottomNavCircles">
        <button type="button" id="navElenco" class="circle-button" title="Elenco"><i class="fas fa-list"></i></button>
        <button type="button" id="navScansiona" class="circle-button" title="Scansiona Targa"><i class="fas fa-camera"></i></button>
    </div>

    <script>
    (function () {
        'use strict';

        const STORAGE_KEY = 'tracking_fatturazione';
        const MAX_SAMPLES = 20;
        const MIN_CONFIDENCE = 40;
        const landingPageSection = document.getElementById('landingPageSection');
        const saveRecordSection = document.getElementById('saveRecordSection');
        const trackingListContainer = document.getElementById('trackingListContainer');
        const inputTarga = document.getElementById('inputTarga');
        const selectCommittente = document.getElementById('selectCommittente');
        const inputMonth = document.getElementById('inputMonth');
        const targaScanPageSection = document.getElementById('targaScanPageSection');
        const targaScanStreamElement = document.getElementById('targaScanStream');
        const targaScanCanvas = document.getElementById('targaScanCanvas');
        const ocrResultDisplay = document.getElementById('ocrResultDisplay');
        const closeTargaScanBtn = document.getElementById('closeTargaScanBtn');
        const pageHeaderContainer = document.getElementById('pageHeaderContainer');
        const bottomNavCircles = document.getElementById('bottomNavCircles');

        let currentTargaScanStream = null;
        let isScanningOCR = false;
        let isOcrBusy = false;
        let ocrWorker = null;
        let sampleCount = 0;
        let charFrequencies = [{}, {}, {}, {}, {}, {}, {}];

        function getRecords() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) {
                return [];
            }
        }

        function saveRecord(targa, committente) {
            const records = getRecords();
            records.push({
                targa: String(targa).trim().toUpperCase(),
                committente: String(committente).trim(),
                data_ora: new Date().toISOString()
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        }

        function pad(n) { return n < 10 ? '0' + n : String(n); }
        function formatDate(iso) {
            const d = new Date(iso);
            return pad(d.getDate()) + '/' + pad(d.getMonth() + 1) + '/' + d.getFullYear();
        }
        function formatTime(iso) {
            const d = new Date(iso);
            return pad(d.getHours()) + ':' + pad(d.getMinutes());
        }

        function renderLandingTable() {
            const records = getRecords();
            trackingListContainer.innerHTML = '';
            records.slice().reverse().forEach(function (r) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td>' + formatDate(r.data_ora) + '</td><td>' + formatTime(r.data_ora) + '</td><td>' + (r.targa || '') + '</td><td>' + (r.committente || '') + '</td>';
                trackingListContainer.appendChild(tr);
            });
        }

        function showView(viewName) {
            landingPageSection.style.display = 'none';
            saveRecordSection.style.display = 'none';
            targaScanPageSection.style.display = 'none';

            if (viewName === 'targaScan') {
                pageHeaderContainer.style.display = 'none';
                bottomNavCircles.style.display = 'none';
                targaScanPageSection.style.display = 'flex';
            } else {
                pageHeaderContainer.style.display = 'block';
                bottomNavCircles.style.display = 'flex';
                if (viewName === 'landing') {
                    landingPageSection.style.display = 'block';
                    renderLandingTable();
                } else if (viewName === 'saveRecord') {
                    saveRecordSection.style.display = 'block';
                }
            }
            document.body.style.paddingTop = pageHeaderContainer.offsetHeight + 10 + 'px';
            document.body.style.paddingBottom = (bottomNavCircles && getComputedStyle(bottomNavCircles).display !== 'none' ? bottomNavCircles.offsetHeight + 10 : 70) + 'px';
            window.scrollTo(0, 0);
        }

        /** Ritaglio focus box, margine 15% bande EU, binarizzazione stretta (solo nero/bianco) per ridurre confusione C/G */
        function preprocessCanvas(canvas) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const focusBox = document.getElementById('targaFocusBox').getBoundingClientRect();
            const videoRect = targaScanStreamElement.getBoundingClientRect();
            const scaleX = canvas.width / videoRect.width;
            const scaleY = canvas.height / videoRect.height;

            let cropX = (focusBox.left - videoRect.left) * scaleX;
            let cropY = (focusBox.top - videoRect.top) * scaleY;
            let cropWidth = focusBox.width * scaleX;
            let cropHeight = focusBox.height * scaleY;

            const horizontalMargin = cropWidth * 0.15;
            cropX += horizontalMargin;
            cropWidth -= horizontalMargin * 2;

            const croppedImageData = ctx.getImageData(cropX, cropY, cropWidth, cropHeight);
            canvas.width = cropWidth;
            canvas.height = cropHeight;
            ctx.putImageData(croppedImageData, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let sum = 0;
            const npixels = data.length / 4;
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                sum += gray;
                data[i] = data[i + 1] = data[i + 2] = gray;
            }
            const threshold = npixels > 0 ? Math.min(200, Math.max(60, sum / npixels)) : 128;
            for (let i = 0; i < data.length; i += 4) {
                const v = data[i] < threshold ? 0 : 255;
                data[i] = data[i + 1] = data[i + 2] = v;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        async function initializeOcrWorker() {
            if (ocrWorker) return ocrWorker;
            ocrResultDisplay.textContent = 'Inizializzazione OCR (attendi)...';
            try {
                const worker = await Tesseract.createWorker('ita');
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                    tessedit_pageseg_mode: '8'
                });
                ocrWorker = worker;
                return ocrWorker;
            } catch (error) {
                console.error('Errore inizializzazione Tesseract:', error);
                ocrResultDisplay.textContent = 'Errore OCR!';
                return null;
            }
        }

        async function runOcrScanLoop() {
            if (!isScanningOCR) return;
            if (isOcrBusy) {
                requestAnimationFrame(runOcrScanLoop);
                return;
            }
            isOcrBusy = true;
            const context = targaScanCanvas.getContext('2d', { willReadFrequently: true });
            if (targaScanStreamElement.videoWidth === 0) {
                isOcrBusy = false;
                requestAnimationFrame(runOcrScanLoop);
                return;
            }
            targaScanCanvas.width = targaScanStreamElement.videoWidth;
            targaScanCanvas.height = targaScanStreamElement.videoHeight;
            context.drawImage(targaScanStreamElement, 0, 0, targaScanCanvas.width, targaScanCanvas.height);
            preprocessCanvas(targaScanCanvas);
            try {
                const result = await ocrWorker.recognize(targaScanCanvas);
                const text = (result.data && result.data.text) ? result.data.text : '';
                const confidence = (result.data && typeof result.data.confidence === 'number') ? result.data.confidence : 100;
                const cleanedText = text.replace(/[^A-Z0-9]/gi, '').toUpperCase();
                ocrResultDisplay.textContent = cleanedText || 'Inquadra...';
                ocrResultDisplay.classList.remove('success', 'error');
                const match = cleanedText.match(/([A-Z]{2}[0-9]{3}[A-Z]{2})/);
                if (match && confidence >= MIN_CONFIDENCE) {
                    const plateStr = match[1];
                    sampleCount++;
                    ocrResultDisplay.textContent = 'Acquisizione in corso... ' + sampleCount + '/' + MAX_SAMPLES;
                    for (let i = 0; i < 7; i++) {
                        const c = plateStr[i];
                        if (!charFrequencies[i][c]) charFrequencies[i][c] = 0;
                        charFrequencies[i][c]++;
                    }
                    if (sampleCount >= MAX_SAMPLES) {
                        isScanningOCR = false;
                        ocrResultDisplay.textContent = 'Targa rilevata!';
                        ocrResultDisplay.classList.add('success');
                        stopTargaScan(false);
                        let finalPlate = '';
                        for (let i = 0; i < 7; i++) {
                            var maxCount = 0, maxChar = '';
                            for (var k in charFrequencies[i]) {
                                if (charFrequencies[i][k] > maxCount) {
                                    maxCount = charFrequencies[i][k];
                                    maxChar = k;
                                }
                            }
                            finalPlate += maxChar;
                        }
                        inputTarga.value = finalPlate;
                        selectCommittente.selectedIndex = 0;
                        showView('saveRecord');
                        inputTarga.focus();
                        isOcrBusy = false;
                        return;
                    }
                }
            } catch (e) {
                console.error('Errore riconoscimento OCR', e);
            }
            isOcrBusy = false;
            requestAnimationFrame(runOcrScanLoop);
        }

        function stopTargaScan(navigateToLanding) {
            isScanningOCR = false;
            if (currentTargaScanStream) {
                currentTargaScanStream.getTracks().forEach(function (track) { track.stop(); });
                currentTargaScanStream = null;
            }
            targaScanStreamElement.srcObject = null;
            if (navigateToLanding) {
                showView('landing');
            }
        }

        async function startTargaScan() {
            if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
                alert("Il tuo browser non supporta l'accesso alla fotocamera.");
                return;
            }
            isScanningOCR = true;
            isOcrBusy = false;
            sampleCount = 0;
            charFrequencies = [{}, {}, {}, {}, {}, {}, {}];
            showView('targaScan');
            var worker = await initializeOcrWorker();
            if (!worker) {
                stopTargaScan(true);
                return;
            }
            ocrResultDisplay.textContent = 'Inquadra...';
            ocrResultDisplay.classList.remove('success', 'error');
            var constraints = { video: { facingMode: 'environment' } };
            try {
                currentTargaScanStream = await navigator.mediaDevices.getUserMedia(constraints);
                targaScanStreamElement.srcObject = currentTargaScanStream;
                await targaScanStreamElement.play();
                runOcrScanLoop();
            } catch (err) {
                console.error('Errore avvio stream OCR:', err);
                alert('Impossibile avviare la fotocamera. Controlla i permessi.');
                stopTargaScan(true);
            }
        }

        closeTargaScanBtn.addEventListener('click', function () { stopTargaScan(true); });

        document.getElementById('btnSalva').addEventListener('click', function () {
            var targa = inputTarga.value.trim().toUpperCase();
            if (!targa) {
                alert('Inserisci una targa.');
                return;
            }
            var committente = selectCommittente.value.trim();
            saveRecord(targa, committente);
            alert('Registrazione salvata: ' + targa + ' – ' + committente);
            inputTarga.value = '';
            selectCommittente.selectedIndex = 0;
            showView('landing');
        });

        document.getElementById('btnAnnullaSave').addEventListener('click', function () {
            inputTarga.value = '';
            selectCommittente.selectedIndex = 0;
            showView('landing');
        });

        document.getElementById('btnAggiungi').addEventListener('click', function () {
            inputTarga.value = '';
            selectCommittente.selectedIndex = 0;
            showView('saveRecord');
            inputTarga.focus();
        });

        document.getElementById('btnExportCsv').addEventListener('click', function () {
            var monthVal = inputMonth.value;
            if (!monthVal) {
                alert('Seleziona un mese e un anno.');
                return;
            }
            var parts = monthVal.split('-').map(Number);
            var year = parts[0];
            var month = parts[1];
            var records = getRecords();
            var filtered = records.filter(function (r) {
                var d = new Date(r.data_ora);
                return d.getFullYear() === year && (d.getMonth() + 1) === month;
            });
            if (filtered.length === 0) {
                alert('Nessun dato presente per il mese selezionato.');
                return;
            }
            var header = 'Data;Ora;Targa;Committente';
            var rows = filtered.map(function (r) {
                return formatDate(r.data_ora) + ';' + formatTime(r.data_ora) + ';' + (r.targa || '') + ';' + (r.committente || '');
            });
            var csv = [header].concat(rows).join('\r\n');
            var blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'tracker_fatturazione_' + year + '_' + pad(month) + '.csv';
            a.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('navElenco').addEventListener('click', function () { showView('landing'); });
        document.getElementById('navScansiona').addEventListener('click', startTargaScan);

        var now = new Date();
        inputMonth.value = now.getFullYear() + '-' + pad(now.getMonth() + 1);

        window.addEventListener('load', function () {
            setTimeout(function () {
                document.getElementById('preloader').classList.add('hidden');
                renderLandingTable();
            }, 500);
        });
    })();
    </script>
</body>
</html>
