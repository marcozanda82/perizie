<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riepilogo Perizia con Gestione Foto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Applica il font Inter al corpo del documento */
        }
        /* Stile per il pulsante "Scatta Foto" personalizzato */
        .pulsante-scatta-foto {
            width: 64px; /* 4rem */
            height: 64px; /* 4rem */
            border-radius: 50%;
            background-color: #E5E7EB; /* bg-gray-200 */
            padding: 4px; /* p-1 */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .pulsante-scatta-foto:hover {
            background-color: #D1D5DB; /* bg-gray-300 */
        }
        .pulsante-scatta-foto-interno {
            width: 48px; /* 3rem, (w-16 - p-1*2) * (12/16) ca. */
            height: 48px; /* 3rem */
            border-radius: 50%;
            background-color: #EF4444; /* bg-red-500 */
            transition: all 0.2s ease-in-out;
        }
        .pulsante-scatta-foto:hover .pulsante-scatta-foto-interno {
            background-color: #DC2626; /* bg-red-600 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-lg rounded-lg p-6 space-y-8">
        <div class="flex justify-between items-center border-b pb-4">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-700">Riepilogo Perizia</h1>
            <button id="pulsanteDownloadFoto"
                    class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50
                           disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-150"
                    disabled>
                Scarica Foto
            </button>
        </div>

        <div class="space-y-4">
            <div>
                <h2 class="text-xl font-semibold text-gray-600">Dettagli Targa</h2>
                <p id="targaAttualeDisplay" class="text-gray-800">Targa: Inizializzazione...</p>
                <p id="statoTarga" class="text-gray-800">Stato: Inizializzazione...</p>
            </div>
            <div class="mt-4 p-4 bg-gray-50 rounded-md">
                <p class="text-sm text-gray-600">
                    Il pulsante "Scarica Foto" si attiverà quando la perizia sarà completata. URL:
                    <code class="bg-gray-200 text-xs px-1 rounded">http://192.168.1.154:8080/TARGA.zip</code>.
                </p>
            </div>
        </div>

        <div class="pt-6 border-t">
            <h2 class="text-xl font-semibold text-gray-600 mb-4">Gestione Foto</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                <div class="md:col-span-1">
                    <label for="sezioneFoto" class="block text-sm font-medium text-gray-700 mb-1">Sezione Foto:</label>
                    <select id="sezioneFoto" name="sezioneFoto"
                            class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="remarketing">Remarketing (da 001)</option>
                        <option value="pneumatici">Pneumatici (da 101)</option>
                        <option value="danni">Danni (da 201)</option>
                    </select>
                </div>

                <div class="flex flex-col items-center justify-center md:col-span-1">
                     <p class="text-sm text-gray-500 mb-2">Scatta Foto:</p>
                    <button id="scattaFotoButton" title="Scatta Foto"
                            class="pulsante-scatta-foto focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        <div class="pulsante-scatta-foto-interno"></div>
                    </button>
                </div>
                
                <div class="md:col-span-1 text-center md:text-left">
                    <p class="text-sm font-medium text-gray-700">Prossimo Numero Foto:</p>
                    <p id="prossimoNumeroFotoDisplay" class="text-lg font-semibold text-indigo-600">---</p>
                    <p id="nomeFileFotoGenerato" class="text-xs text-gray-500 mt-1"></p>
                </div>
            </div>
        </div>


        <div class="mt-8 pt-6 border-t">
            <h3 class="text-lg font-semibold text-gray-600 mb-3">Simulazione (Solo per Test)</h3>
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="simCompleteButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-colors duration-150">
                    Simula Completamento Targa Corrente
                </button>
                <button id="simSwitchPlateButton" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-colors duration-150">
                    Simula Cambio Targa (AB123CD / XY789ZA)
                </button>
            </div>
             <p class="mt-3 text-sm text-gray-500">
                Usa questi pulsanti per testare l'attivazione/disattivazione del pulsante "Scarica Foto",
                il cambio della targa e la numerazione delle foto.
             </p>
        </div>
    </div>

    <script>
        // Stato dell'applicazione
        let targaInLavorazione = "AB123CD"; // Targa di esempio iniziale
        let perizieCompletate = {
            "AA111BB": true,
            "CC222DD": false,
            "AB123CD": false,
            "XY789ZA": true
        };

        // NUOVA LOGICA PER NUMERAZIONE FOTO
        // photoSessionData memorizza l'ULTIMO numero usato per targa e sezione.
        // Es: "AB123CD": { "remarketing": 0, "pneumatici": 100, "danni": 200 }
        // significa che la prossima foto remarketing sarà 001, pneumatici 101, danni 201.
        let photoSessionData = {}; 

        const sectionBaseNumbers = {
            "remarketing": 1,    // Inizia da 1 (diventerà 001)
            "pneumatici": 101,
            "danni": 201
        };

        // Inizializza i dati per una targa se non esistono
        function initializeTargaPhotoData(targa) {
            if (!photoSessionData[targa]) {
                photoSessionData[targa] = {
                    "remarketing": sectionBaseNumbers.remarketing - 1, // Es. 0, così il primo è 1
                    "pneumatici": sectionBaseNumbers.pneumatici - 1, // Es. 100, così il primo è 101
                    "danni": sectionBaseNumbers.danni - 1      // Es. 200, così il primo è 201
                };
                console.log(`Dati foto inizializzati per targa ${targa}:`, JSON.parse(JSON.stringify(photoSessionData[targa])));
            }
        }
        
        // Ottiene il prossimo numero di foto per la targa e sezione specificate
        // NON incrementa, solo calcola quale sarebbe il prossimo
        function getPreviewNextPhotoNumber(targa, section) {
            initializeTargaPhotoData(targa); // Assicura che la targa sia inizializzata
            const lastNumberUsed = photoSessionData[targa][section];
            const baseNumber = sectionBaseNumbers[section];
            
            let previewNumber;
            if (lastNumberUsed < baseNumber) { // Se l'ultimo numero usato è inferiore al numero base (es. 0 per remarketing, 100 per gomme)
                previewNumber = baseNumber;    // Il prossimo sarà il numero base
            } else {
                previewNumber = lastNumberUsed + 1; // Altrimenti, incrementa l'ultimo numero usato
            }
            return String(previewNumber).padStart(3, '0');
        }

        // Genera e registra il prossimo numero di foto
        function generateAndRecordNextPhotoNumber(targa, section) {
            initializeTargaPhotoData(targa);
            
            const lastNumberUsed = photoSessionData[targa][section];
            const baseNumber = sectionBaseNumbers[section];

            if (lastNumberUsed < baseNumber) {
                photoSessionData[targa][section] = baseNumber;
            } else {
                photoSessionData[targa][section]++;
            }
            
            let newNumber = photoSessionData[targa][section];
            console.log(`Nuovo numero foto per ${targa} - ${section}: ${newNumber}. Dati sessione:`, JSON.parse(JSON.stringify(photoSessionData[targa])));
            return String(newNumber).padStart(3, '0');
        }
        // FINE NUOVA LOGICA FOTO


        // Funzione per aggiornare l'UI relativa alle foto
        function aggiornaUIFoto() {
            const sezioneSelezionata = document.getElementById('sezioneFoto').value;
            const displayProssimoNumero = document.getElementById('prossimoNumeroFotoDisplay');
            
            if (targaInLavorazione && sezioneSelezionata) {
                const numeroPreview = getPreviewNextPhotoNumber(targaInLavorazione, sezioneSelezionata);
                displayProssimoNumero.textContent = numeroPreview;
            } else {
                displayProssimoNumero.textContent = "---";
            }
            // Pulisce il nome file generato quando si cambia sezione o targa
            document.getElementById('nomeFileFotoGenerato').textContent = '';
        }


        // Funzione per aggiornare lo stato generale della pagina (inclusa UI foto)
        function aggiornaStatoPagina() {
            const pulsanteDownload = document.getElementById('pulsanteDownloadFoto');
            const displayTarga = document.getElementById('targaAttualeDisplay');
            const displayStato = document.getElementById('statoTarga');

            const targaAttuale = targaInLavorazione;
            const isCompleta = perizieCompletate[targaAttuale] === true;

            displayTarga.textContent = `Targa: ${targaAttuale}`;
            displayStato.textContent = `Stato: ${isCompleta ? 'Completata' : 'In Lavorazione'} (${targaAttuale})`;

            if (isCompleta) {
                pulsanteDownload.disabled = false;
                pulsanteDownload.classList.remove('opacity-50', 'cursor-not-allowed');
                pulsanteDownload.classList.add('hover:bg-blue-700');
                pulsanteDownload.onclick = function() {
                    const urlDownload = `http://192.168.1.154:8080/${targaAttuale}.zip`;
                    console.log(`Tentativo di download da: ${urlDownload}`);
                    window.location.href = urlDownload;
                };
            } else {
                pulsanteDownload.disabled = true;
                pulsanteDownload.classList.add('opacity-50', 'cursor-not-allowed');
                pulsanteDownload.classList.remove('hover:bg-blue-700');
                pulsanteDownload.onclick = null;
            }
            
            // Aggiorna anche la UI delle foto perché la targa potrebbe essere cambiata
            initializeTargaPhotoData(targaAttuale); // Assicura che i dati foto esistano per la targa corrente
            aggiornaUIFoto();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const completeButton = document.getElementById('simCompleteButton');
            const switchPlateButton = document.getElementById('simSwitchPlateButton');
            const scattaFotoBtn = document.getElementById('scattaFotoButton');
            const sezioneFotoSelect = document.getElementById('sezioneFoto');

            // Inizializzazione targa iniziale
            if (targaInLavorazione && !perizieCompletate.hasOwnProperty(targaInLavorazione)) {
                 perizieCompletate[targaInLavorazione] = false;
            }
            initializeTargaPhotoData(targaInLavorazione); // Inizializza dati foto per la targa iniziale

            // Event listener per pulsante "Simula Completamento Targa"
            if (completeButton) {
                completeButton.addEventListener('click', () => {
                    if (targaInLavorazione) {
                        if (!perizieCompletate.hasOwnProperty(targaInLavorazione)) {
                             perizieCompletate[targaInLavorazione] = false;
                        }
                        perizieCompletate[targaInLavorazione] = true;
                        console.log(`Targa ${targaInLavorazione} marcata come completa.`);
                        aggiornaStatoPagina();
                    } else {
                        console.warn(`Nessuna targa in lavorazione definita per il completamento.`);
                    }
                });
            }

            // Event listener per pulsante "Simula Cambio Targa"
            if (switchPlateButton) {
                let usaTargaXY = false;
                switchPlateButton.addEventListener('click', () => {
                    targaInLavorazione = usaTargaXY ? "AB123CD" : "XY789ZA";
                    
                    if (!perizieCompletate.hasOwnProperty(targaInLavorazione)) {
                        perizieCompletate[targaInLavorazione] = false;
                    }
                    // Non è necessario inizializzare qui photoSessionData[targaInLavorazione]
                    // perché aggiornaStatoPagina() lo farà tramite initializeTargaPhotoData.
                    console.log(`Cambiata targa in lavorazione a: ${targaInLavorazione}`);
                    usaTargaXY = !usaTargaXY;
                    aggiornaStatoPagina(); // Questo chiamerà anche aggiornaUIFoto
                });
            }

            // Event listener per il cambio di sezione foto
            if (sezioneFotoSelect) {
                sezioneFotoSelect.addEventListener('change', aggiornaUIFoto);
            }

            // Event listener per il pulsante "Scatta Foto"
            if (scattaFotoBtn) {
                scattaFotoBtn.addEventListener('click', () => {
                    const sezioneSelezionata = sezioneFotoSelect.value;
                    if (targaInLavorazione && sezioneSelezionata) {
                        const numeroFotoEffettivo = generateAndRecordNextPhotoNumber(targaInLavorazione, sezioneSelezionata);
                        const nomeFile = `${targaInLavorazione}_${sezioneSelezionata}_${numeroFotoEffettivo}.jpg`;
                        
                        document.getElementById('nomeFileFotoGenerato').textContent = `Generato: ${nomeFile}`;
                        console.log(`Foto "scattata": ${nomeFile}`);
                        
                        // Dopo aver scattato, aggiorna il display del prossimo numero
                        aggiornaUIFoto(); 
                        
                        // Qui andrebbe la logica per catturare effettivamente la foto
                        // alert(`Foto "scattata": ${nomeFile}`); // Sostituito con log e display
                    } else {
                        alert("Seleziona una targa e una sezione prima di scattare la foto.");
                    }
                });
            }

            aggiornaStatoPagina(); // Stato iniziale della pagina
        });
    </script>
</body>
</html>
