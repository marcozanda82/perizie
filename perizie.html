<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Perizia Veicolo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CSS INVARIATO - OMESSO PER BREVITÀ */
        /* ... (tutto il CSS precedente, inclusa la modifica per #preloader .loading-text) ... */
        #preloader .loading-text {
            color: #00aeff;
            animation: textGlow 1.8s infinite alternate ease-in-out;
            text-align: center; 
            width: 100%; 
        }
        #galleryPageSection h2.section-title { margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <script>
    // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const galleryPageSection = document.getElementById('galleryPageSection'); 
    const photoGridContainer = document.getElementById('photoGridContainer'); 
    const backToMainFromGalleryBtn = document.getElementById('backToMainFromGalleryBtn'); 

    const cameraPageSection = document.getElementById('cameraPageSection'); 
    const cameraStreamElement = document.getElementById('cameraStream');
    const freezeFrameDisplayElement = document.getElementById('freezeFrameDisplay');
    const captureBtn = document.getElementById('captureBtn');
    const closeCameraBtn = document.getElementById('closeCameraBtn');
    let currentCameraStream = null;
    let lastViewBeforeCamera = 'landing'; 
    let lastSectionBeforeCamera = null; 


    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer');
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const targaDropdownContainer = document.getElementById('targaDropdownContainer');
    const targaSwitcherDropdown = document.getElementById('targaSwitcherDropdown');
    const targaDetailsDisplay = document.getElementById('targaDetailsDisplay'); 

    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons'); 
    const mainPageNavButtons = navButtonsContainer.querySelector('#mainPageNavButtons'); 
    const utilityNavButtons = pageHeaderContainer.querySelector('#utilityNavButtons'); 

    const navButtons = mainPageNavButtons.querySelectorAll('button[data-target]');
    
    const backToListBtn = utilityNavButtons.querySelector('#backToListBtn');
    const historyBtn = utilityNavButtons.querySelector('#historyBtn');
    const mainExitAppBtn = utilityNavButtons.querySelector('#exitAppBtn'); 
    let syncToSheetsBtn; 
    
    const headerExitBtn = document.getElementById('headerExitBtn');
    const headerPhotosBtn = document.getElementById('headerPhotosBtn');
    const headerPeriziaBtn = document.getElementById('headerPeriziaBtn');
    const headerCameraBtn = document.getElementById('headerCameraBtn');

    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn');
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn');
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn');
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
    const tipoTrazioneSelect = document.getElementById('tipo_trazione');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');
    
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzN4bBhPi4d8i7fSpJQqCJ2CQYOtmes1yKeGeqVe053K4QkdKYH4PuQIughn_9YLEfCkA/exec'; 
    
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';
    const LAST_ACTIVE_PERIZIA_PAGE_KEY = `${APP_PREFIX}lastActivePeriziaPage`;
    // const CAPTURED_PHOTOS_KEY = `${APP_PREFIX}capturedPhotos_LS_LEGACY`; // Non più usato per salvare foto nuove
    const DB_NAME = "perizieFotoDB";
    const DB_VERSION = 1; // Incrementare se si cambia la struttura dello store/indici
    const PHOTO_STORE_NAME = "fotoStore";
    let db;

    let currentGalleryTargaFilter = null;
    let currentGallerySectionFilter = null; 
    let lastViewBeforeGallery = 'landing';
    let lastSectionBeforeGallery = null;

    const currentAppVersion = "1.4.1"; 
    const changelogModal = document.getElementById('changelogModal');
    const closeChangelogBtn = document.getElementById('closeChangelogBtn');
    const changelogList = document.getElementById('changelogList');
    const changelogTitle = document.getElementById('changelogTitle');

    const latestChangesText = `
        <li>Modificata la cattura foto in JPEG per ridurre dimensioni.</li>
        <li>Galleria ora filtrabile per targa e sezione.</li>
        <li>Header completo (con selettore targa e navigazione sezioni) visibile in galleria se aperta da una perizia.</li>
        <li>Testo "Caricamento elenco targhe..." centrato.</li>
        <li>Tempo anteprima foto dopo scatto ridotto a 1 secondo.</li>
        <li>Introdotta gestione base di IndexedDB per archiviazione foto (per supportare >50 foto).</li>
        <li>Cancellazione foto da IndexedDB contestuale alla cancellazione dei dati perizia.</li>
    `;

    let touchstartX = 0;
    let touchendX = 0;
    const swipeThreshold = 50; 
    const sectionOrder = ['remarketing', 'pneumatici', 'danniVerifiche', 'riepilogo'];

    // --- INIZIO SEZIONE CODICE INDEXEDDB ---
    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(PHOTO_STORE_NAME)) {
                    const store = db.createObjectStore(PHOTO_STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    store.createIndex('timestamp_idx', 'timestamp', { unique: false });
                    store.createIndex('targa_idx', 'targa', { unique: false });
                    store.createIndex('section_idx', 'section', { unique: false });
                    console.log("Object store 'fotoStore' creato con indici.");
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("Database IndexedDB aperto con successo.");
                resolve(db);
            };

            request.onerror = (event) => {
                console.error("Errore apertura IndexedDB:", event.target.errorCode);
                reject(event.target.errorCode);
            };
        });
    }

    function addPhotoToDB(photoData) { 
        return new Promise((resolve, reject) => {
            if (!db) { return reject("DB not initialized"); }
            const transaction = db.transaction([PHOTO_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            
            const countRequest = store.count();
            countRequest.onsuccess = () => {
                if (countRequest.result >= 700) { 
                    console.warn("Limite foto in DB raggiunto, tentativo di rimozione della più vecchia.");
                    let oldestPhotoCursor = store.index('timestamp_idx').openCursor(null, 'next');
                    oldestPhotoCursor.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                           const deleteOldestRequest = store.delete(cursor.primaryKey);
                           deleteOldestRequest.onsuccess = () => { console.log("Foto più vecchia rimossa."); actuallyAdd(); }
                           deleteOldestRequest.onerror = (e) => { console.error("Errore rimozione foto vecchia:", e.target.error); actuallyAdd(); /* Prova comunque */ }
                        } else { actuallyAdd(); }
                    };
                    oldestPhotoCursor.onerror = (e) => { console.error("Errore cursore foto vecchia:", e.target.error); actuallyAdd(); /* Prova comunque */ }
                } else { actuallyAdd(); }
            };
            countRequest.onerror = (e) => { console.error("Errore conteggio foto:", e.target.error); actuallyAdd(); };

            function actuallyAdd() {
                const request = store.add(photoData);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => { console.error("Errore aggiunta foto a IDB:", e.target.error); reject(e.target.error); };
            }
            transaction.onerror = (e) => { console.error("Errore transazione aggiunta foto:", e.target.error); if (!transaction.error) reject(e.target.error); };
        });
    }

    function getPhotosFromDB(targaFilter, sectionKeyFilter) {
        return new Promise((resolve, reject) => {
            if (!db) { return reject("DB not initialized"); }
            const transaction = db.transaction([PHOTO_STORE_NAME], 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const photos = [];
            let request;

            if (targaFilter) {
                const targaUpper = targaFilter.toUpperCase();
                const targaIndex = store.index('targa_idx');
                request = targaIndex.openCursor(IDBKeyRange.only(targaUpper));
            } else { 
                request = store.index('timestamp_idx').openCursor(null, 'prev'); // Ordina per timestamp decrescente (più recenti prima)
            }
            
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    const photo = cursor.value;
                    let includePhoto = true;

                    if (targaFilter) { 
                        if (photo.targa.toUpperCase() !== targaFilter.toUpperCase()) { includePhoto = false; }
                    }

                    if (includePhoto && targaFilter && sectionKeyFilter && sectionKeyFilter !== 'riepilogo') {
                        let filterMatchKey = sectionKeyFilter.toLowerCase();
                        if (filterMatchKey === 'danniverifiche') filterMatchKey = 'danni';
                        if (photo.section.toLowerCase() !== filterMatchKey) { includePhoto = false; }
                    }
                    if (includePhoto) { photos.push(photo); }
                    cursor.continue();
                } else {
                    // Se era un filtro per targa, l'ordinamento per timestamp non è stato fatto dall'index primario
                    if (targaFilter) {
                        photos.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    }
                    resolve(photos);
                }
            };
            request.onerror = (e) => { console.error("Errore recupero foto da IDB:", e.target.error); reject(e.target.error); };
        });
    }

    function deletePhotoFromDB(photoId) { 
        return new Promise((resolve, reject) => {
            if (!db) { return reject("DB not initialized"); }
            const transaction = db.transaction([PHOTO_STORE_NAME], 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.delete(photoId);
            request.onsuccess = () => resolve();
            request.onerror = (e) => { console.error("Errore eliminazione foto da IDB:", e.target.error); reject(e.target.error); };
        });
    }

    async function deletePhotosForTargaFromDB(targa) {
        if (!db) { console.error("DB non inizializzato per deletePhotosForTargaFromDB"); return; }
        const targaUpper = targa.toUpperCase();
        const transaction = db.transaction([PHOTO_STORE_NAME], 'readwrite');
        const store = transaction.objectStore(PHOTO_STORE_NAME);
        const targaIndex = store.index('targa_idx');
        const request = targaIndex.openCursor(IDBKeyRange.only(targaUpper));
        let deleteCount = 0;

        return new Promise((resolve, reject) => {
            request.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                    store.delete(cursor.primaryKey); // Non serve await qui, le op IDB in transazione sono accodate
                    deleteCount++;
                    cursor.continue();
                } else {
                    console.log(`${deleteCount} foto eliminate da IndexedDB per la targa ${targaUpper}.`);
                    resolve(deleteCount);
                }
            };
            request.onerror = (event) => {
                console.error(`Errore durante l'eliminazione delle foto per la targa ${targaUpper}:`, event.target.error);
                reject(event.target.error);
            };
            transaction.oncomplete = () => {
                if(request.error) { // Se l'errore del cursore non è stato catturato prima
                     reject(request.error);
                } else {
                     resolve(deleteCount); // Assicura che la promessa si risolva anche se non ci sono foto
                }
            };
            transaction.onerror = (event) => {
                 console.error(`Errore transazione eliminazione foto per targa ${targaUpper}:`, event.target.error);
                 reject(event.target.error);
            };
        });
    }

    async function clearAllPhotosFromDB() {
        if (!db) { console.error("DB non inizializzato per clearAllPhotosFromDB"); return; }
        const transaction = db.transaction([PHOTO_STORE_NAME], 'readwrite');
        const store = transaction.objectStore(PHOTO_STORE_NAME);
        const request = store.clear();
        return new Promise((resolve, reject) => {
            request.onsuccess = () => {
                console.log("Tutte le foto eliminate da IndexedDB.");
                resolve();
            };
            request.onerror = (event) => {
                console.error("Errore durante la cancellazione di tutte le foto da IndexedDB:", event.target.error);
                reject(event.target.error);
            };
        });
    }

    // --- FINE SEZIONE CODICE INDEXEDDB ---

    function capturePhoto() {
        if (captureBtn.disabled) return; 

        if (currentCameraStream && cameraStreamElement.readyState >= cameraStreamElement.HAVE_CURRENT_DATA && cameraStreamElement.videoWidth > 0) {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStreamElement.videoWidth; 
            canvas.height = cameraStreamElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraStreamElement, 0, 0, canvas.width, canvas.height);
            
            // Usa DataURL solo per l'anteprima immediata e il download, non per lo storage persistente
            const previewDataUrl = canvas.toDataURL('image/jpeg', 0.7); 
            freezeFrameDisplayElement.src = previewDataUrl;
            freezeFrameDisplayElement.style.display = 'block';
            cameraStreamElement.style.display = 'none'; 
            captureBtn.disabled = true; 

            canvas.toBlob(async (blob) => {
                if (!blob) {
                    console.error("Errore: canvas.toBlob() ha restituito null.");
                    alert("Errore nella creazione del file immagine.");
                    freezeFrameDisplayElement.style.display = 'none';
                    cameraStreamElement.style.display = 'block';
                    captureBtn.disabled = false;
                    return;
                }

                const targaForFile = (targaSelezionataGlobalmente || currentGalleryTargaFilter || 'SCONOSCIUTA').toUpperCase().replace(/[^A-Z0-9]/g, '');
                const sectionNameForFile = getFilenameSectionName();

                const counterKey = `${APP_PREFIX}photoCount_${targaForFile}_${sectionNameForFile}`;
                let photoNumber = parseInt(localStorage.getItem(counterKey) || '0') + 1;
                localStorage.setItem(counterKey, photoNumber.toString());
                
                const formattedPhotoNumber = String(photoNumber).padStart(3, '0');
                const filename = `${formattedPhotoNumber} ${sectionNameForFile} ${targaForFile}.jpeg`; 
                
                const link = document.createElement('a');
                const objectURLForDownload = URL.createObjectURL(blob);
                link.href = objectURLForDownload;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(objectURLForDownload); // Pulisci subito dopo il download
                console.log(`Foto "${filename}" scaricata.`);

                const photoDataForDB = {
                    // id sarà autogenerato da IndexedDB
                    name: filename,
                    timestamp: new Date().toISOString(),
                    targa: targaForFile,
                    section: sectionNameForFile, 
                    imageBlob: blob
                };

                try {
                    await addPhotoToDB(photoDataForDB);
                    console.log(`Foto "${filename}" salvata in IndexedDB.`);
                } catch (e) {
                    console.error("Errore salvataggio foto in IndexedDB:", e);
                    alert("Errore durante il salvataggio della foto nel database interno. La foto è stata scaricata.");
                }

                setTimeout(() => {
                    freezeFrameDisplayElement.style.display = 'none';
                    freezeFrameDisplayElement.src = '#'; 
                    cameraStreamElement.style.display = 'block';
                    captureBtn.disabled = false; 
                }, 1000); 

            }, 'image/jpeg', 0.7);

        } else {
            console.warn("Stream fotocamera non pronto o dimensioni video non disponibili per la cattura.");
        }
    }
    
    async function populatePhotoGrid(targaFilter, sectionKeyFilter) {
        photoGridContainer.innerHTML = ''; 
        
        photoGridContainer.querySelectorAll('img[src^="blob:"]').forEach(img => {
            if (img.src) URL.revokeObjectURL(img.src);
        });

        let photosToDisplay = [];
        try {
            photosToDisplay = await getPhotosFromDB(targaFilter, sectionKeyFilter);
        } catch (e) {
            console.error("Errore nel caricare le foto da IndexedDB:", e);
            photoGridContainer.innerHTML = '<p>Errore nel caricare le foto dal database.</p>';
            return;
        }

        if (photosToDisplay.length === 0) {
            photoGridContainer.innerHTML = '<p>Nessuna foto trovata per i filtri applicati.</p>';
            return;
        }

        photosToDisplay.forEach((photoData) => {
            const photoItemDiv = document.createElement('div');
            photoItemDiv.classList.add('photo-item');
            const img = document.createElement('img');
            
            if (photoData.imageBlob) {
                img.src = URL.createObjectURL(photoData.imageBlob);
                img.dataset.photoId = photoData.id; // Salva l'ID per eventuale revoca mirata
            } else {
                img.alt = "Dati immagine non disponibili";
            }
            img.alt = photoData.name;
            
            const caption = document.createElement('div');
            caption.classList.add('photo-item-caption');
            caption.textContent = photoData.name;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('photo-item-delete-btn');
            deleteBtn.innerHTML = '&times;'; 
            deleteBtn.title = "Elimina foto";
            deleteBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); 
                if (confirm("Sei sicuro di voler eliminare questa foto dal database dell'app?")) {
                    try {
                        await deletePhotoFromDB(photoData.id); 
                        console.log("Foto eliminata da DB con ID:", photoData.id);
                        if (img.src && img.src.startsWith('blob:')) { // Revoca l'object URL dell'immagine eliminata
                            URL.revokeObjectURL(img.src);
                        }
                        populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter); 
                    } catch (err) {
                        console.error("Errore eliminazione foto da DB:", err);
                        alert("Errore durante l'eliminazione della foto dal database.");
                    }
                }
            });
            photoItemDiv.appendChild(img);
            photoItemDiv.appendChild(caption);
            photoItemDiv.appendChild(deleteBtn);
            photoGridContainer.appendChild(photoItemDiv);
        });
    }

    async function clearLocalDataForTarga(targaUpper) { // MODIFICATA PER ESSERE ASYNC E CANCELLARE FOTO
        if (!targaUpper) return;
        try {
            localStorage.removeItem(`${APP_PREFIX}data_${targaUpper}`);
            console.log(`Dati modulo rimossi per ${targaUpper}.`);
            unmarkTargaAsCompleted(targaUpper); 
            localStorage.removeItem(`${APP_PREFIX}posizione_${targaUpper}`);
            console.log(`Dati posizione rimossi per ${targaUpper}.`);
            localStorage.removeItem(`${APP_PREFIX}urgent_${targaUpper}`);
            console.log(`Dati urgenza rimossi per ${targaUpper}.`);

            // Cancella le foto associate da IndexedDB
            await deletePhotosForTargaFromDB(targaUpper);
            console.log(`Foto per targa ${targaUpper} cancellate da IndexedDB.`);

        } catch (e) {
            console.error(`Errore durante la cancellazione dei dati locali e/o foto per ${targaUpper}:`, e);
            alert(`Errore cancellazione dati locali/foto per ${targaUpper}.`);
        }
    }

    async function clearAllSavedData() { // MODIFICATA PER ESSERE ASYNC E CANCELLARE TUTTE LE FOTO
        if (confirm("ATTENZIONE!\n\nCancellare TUTTI i dati salvati (incluse posizioni, urgenze, flag di cancellazione, filtro piazzale E TUTTE LE FOTO CATTURATE)?\n\nAzione irreversibile.")) { 
            let c = 0; 
            const keysToRemove = []; 
            for (let i=localStorage.length-1;i>=0;i--) { 
                const k=localStorage.key(i); 
                if (k.startsWith(APP_PREFIX)) { 
                    keysToRemove.push(k); 
                } 
            } 
            keysToRemove.forEach(k => { localStorage.removeItem(k); c++; }); 
            
            try {
                await clearAllPhotosFromDB();
                alert(`${c} elementi di configurazione cancellati e tutte le foto rimosse.`); 
            } catch (e) {
                alert(`${c} elementi di configurazione cancellati, MA si è verificato un errore durante la cancellazione delle foto dal database.`);
                console.error("Errore clearAllPhotosFromDB:", e);
            }

            if(sheetFilterDropdown) sheetFilterDropdown.value = 'all'; 
            localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all');  
            populateSavedTargasList(); 
            if (typeof caricaEPopolaTarghe === 'function') caricaEPopolaTarghe();  
            if (typeof showView === 'function') showView('landing'); 
            if (galleryPageSection.style.display === 'block') { // Se la galleria era aperta, aggiornala
                 populatePhotoGrid(null, null); // Mostra galleria globale (che sarà vuota)
            }
        } 
    }

    // ... (Il resto delle funzioni JavaScript come showView, showSection, showGalleryPage, event listeners, ecc.
    //      dovrebbero rimanere sostanzialmente le stesse, ma tenendo conto che populatePhotoGrid
    //      e le funzioni di cancellazione ora sono asincrone.
    //      Gli event listener che chiamano clearLocalDataForTarga e clearAllSavedData
    //      devono essere resi `async` e usare `await`.)

    // Event listener per il pulsante di cancellazione in popolaTargheFiltrate
    // Questa parte è dentro popolaTargheFiltrate, va modificata lì:
    // delB.addEventListener('click', async function(event) { // Reso async
    //    event.stopPropagation(); 
    //    const tDelUpper = this.dataset.targa; 
    //    await clearLocalDataForTarga(tDelUpper); // Await
    //    ... (resto della logica)
    // });

    // Event listener per clearAllProgressBtn in DOMContentLoaded
    // if(clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', async () => await clearAllSavedData()); // Reso async


    document.addEventListener('DOMContentLoaded', async () => { // Reso async per initDB
        try {
            await initDB(); 
        } catch (e) {
            console.error("Inizializzazione IndexedDB fallita:", e);
            alert("Impossibile inizializzare il database delle foto. La galleria potrebbe non funzionare correttamente.");
        }

        syncToSheetsBtn = document.createElement('button');
        syncToSheetsBtn.id = 'syncToSheetsBtn';
        syncToSheetsBtn.classList.add('action-button');
        syncToSheetsBtn.textContent = 'Sincronizza'; 
        syncToSheetsBtn.style.backgroundColor = '#ffc107'; 
        syncToSheetsBtn.style.borderColor = '#e0a800';
        syncToSheetsBtn.style.color = '#212529';
        const historyButton = document.getElementById('historyBtn'); 
        if (historyButton && historyButton.parentNode === utilityNavButtons) {
            utilityNavButtons.insertBefore(syncToSheetsBtn, historyButton.nextSibling);
        } else if (mainExitAppBtn && mainExitAppBtn.parentNode === utilityNavButtons) { 
             utilityNavButtons.insertBefore(syncToSheetsBtn, mainExitAppBtn); 
        } else if (utilityNavButtons.firstChild) {
            utilityNavButtons.insertBefore(syncToSheetsBtn, utilityNavButtons.firstChild);
        } else {
            utilityNavButtons.appendChild(syncToSheetsBtn);
        }
        syncToSheetsBtn.addEventListener('click', syncAllLocalDataToSheets);
        
        document.querySelectorAll('.fill-defaults-btn').forEach(button => {
            button.addEventListener('click', function() { 
                const sectionId = this.dataset.sectionid; 
                const sectionTarget = sectionId.replace('Section', ''); 
                if (sectionId) {
                    fillSectionPositiveOrDefaults(sectionId); 
                    if (saveProgress(targaSelezionataGlobalmente)) {
                        let currentSectionIndex = -1;
                        navButtons.forEach((nb, index) => { 
                            if (nb.dataset.target === sectionTarget) currentSectionIndex = index;
                        });
                        if (currentSectionIndex !== -1 && currentSectionIndex < navButtons.length - 1) { 
                            const nextNavButton = navButtons[currentSectionIndex + 1];
                            if (nextNavButton && nextNavButton.dataset.target) showSection(nextNavButton.dataset.target);
                        }
                    }
                }
            });
        });
        if (tipoTrazioneSelect) tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);
        
        targaSwitcherDropdown.addEventListener('change', async function() {
            const nuovaTargaSelezionata = this.value;
            if (nuovaTargaSelezionata && nuovaTargaSelezionata.toUpperCase() !== (targaSelezionataGlobalmente ? targaSelezionataGlobalmente.toUpperCase() : null)) {
                this.disabled = true;
                if (galleryPageSection.style.display === 'block') {
                    targaSelezionataGlobalmente = nuovaTargaSelezionata.toUpperCase(); 
                    showGalleryPage(targaSelezionataGlobalmente, currentGallerySectionFilter); 
                } else {
                    let currentActiveSectionId = 'remarketing'; 
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    if (activeSectionElement && activeSectionElement.id) {
                        currentActiveSectionId = activeSectionElement.id.replace('Section', '');
                    }
                    await handleTargaSelectionAndSync(nuovaTargaSelezionata, currentActiveSectionId);
                }
                this.disabled = false;
            } else if (nuovaTargaSelezionata) {
                updateTargaDetailsDisplay(nuovaTargaSelezionata);
            }
        });

        if(backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if(historyBtn) historyBtn.addEventListener('click', () => showView('history'));
        
        if(clearAllProgressBtn) { // MODIFICATO event listener
            clearAllProgressBtn.addEventListener('click', async () => {
                await clearAllSavedData();
            });
        }
        
        if(backToMainFromGalleryBtn) {
             backToMainFromGalleryBtn.addEventListener('click', () => {
                console.log(`Ritorno da galleria a: vista='${lastViewBeforeGallery}', sezione='${lastSectionBeforeGallery}'`);
                if (lastViewBeforeGallery === 'checklist' && currentGalleryTargaFilter && lastSectionBeforeGallery) {
                    if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) {
                         targaSelezionataGlobalmente = currentGalleryTargaFilter;
                         loadProgress(targaSelezionataGlobalmente); 
                    }
                    showView('checklist');
                    showSection(lastSectionBeforeGallery);
                } else {
                    showView('landing'); 
                }
            });
        }

        if(saveAndReturnBtn) saveAndReturnBtn.addEventListener('click', handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button=>button.addEventListener('click',handleSaveAndNext));

        if (headerExitBtn) {
            headerExitBtn.addEventListener('click', () => {
                console.log("Header Exit button clicked");
                triggerMainExit(); 
            });
        }

        if (headerPhotosBtn) { 
            headerPhotosBtn.addEventListener('click', () => {
                console.log("Header Photos/Gallery button clicked");
                let targaForGallery = null;
                let sectionKeyForGallery = null; 

                if (checklistContainer.style.display === 'block' && targaSelezionataGlobalmente) {
                    targaForGallery = targaSelezionataGlobalmente;
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    if (activeSectionElement) {
                        sectionKeyForGallery = activeSectionElement.id.replace('Section', ''); 
                    }
                } 
                if (cameraPageSection.style.display === 'flex') { 
                    returnFromCamera(); 
                     setTimeout(() => showGalleryPage(targaForGallery, sectionKeyForGallery), 50); 
                } else {
                    showGalleryPage(targaForGallery, sectionKeyForGallery);
                }
            });
        }

        if (headerPeriziaBtn) {
            headerPeriziaBtn.addEventListener('click', async () => {
                console.log("Header Perizia button clicked");
                if (cameraPageSection.style.display === 'flex') { 
                    returnFromCamera(); 
                } else if (galleryPageSection.style.display === 'block') { 
                    if (currentGalleryTargaFilter && lastViewBeforeGallery === 'checklist' && lastSectionBeforeGallery) {
                        if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) {
                            targaSelezionataGlobalmente = currentGalleryTargaFilter;
                            loadProgress(targaSelezionataGlobalmente);
                        }
                        showView('checklist');
                        showSection(lastSectionBeforeGallery);
                    } else { 
                        showView('landing');
                    }
                } else if (targaSelezionataGlobalmente) { 
                    const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY);
                    const targetSection = (lastActivePage && document.getElementById(lastActivePage + 'Section')) ? lastActivePage : 'riepilogo';
                    if (checklistContainer.style.display !== 'block' || targaSwitcherDropdown.value.toUpperCase() !== targaSelezionataGlobalmente.toUpperCase()) {
                        await handleTargaSelectionAndSync(targaSelezionataGlobalmente, targetSection);
                    } else {
                        showSection(targetSection);
                    }
                } else { 
                    showView('landing');
                }
            });
        }
        
        if (headerCameraBtn) {
            headerCameraBtn.addEventListener('click', () => {
                console.log("Header Camera button clicked");
                if (cameraPageSection.style.display === 'flex') {
                    returnFromCamera(); 
                } else {
                    showCameraPage(); 
                }
            });
        }

        if (captureBtn) captureBtn.addEventListener('click', capturePhoto);
        if (closeCameraBtn) closeCameraBtn.addEventListener('click', returnFromCamera); 

        navButtons.forEach(b => b.addEventListener('click', function() {
            const targetId = this.dataset.target;
            if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter) {
                currentGallerySectionFilter = targetId; 
                showGalleryPage(currentGalleryTargaFilter, currentGallerySectionFilter); 
            } else if (checklistContainer.style.display === 'block' || (!targaSelezionataGlobalmente && landingPageSection.style.display === 'block')) {
                showSection(targetId);
            } else if (!currentGalleryTargaFilter && galleryPageSection.style.display === 'block') {
                 console.log("Click su nav button da galleria globale, azione non definita o vai a landing.");
            }
        }));

        if (checklistContainer) {
            checklistContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
            checklistContainer.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        
        initializeApplicationViewAndLoadData(); 
        
        if (mainExitAppBtn) { 
            mainExitAppBtn.addEventListener('click', () => { 
                const exitCurtain = document.getElementById('exit-curtain'); 
                const mainContentWrapper = document.getElementById('mainContentWrapper'); 
                const pageHeader = document.getElementById('pageHeaderContainer'); 
                if (exitCurtain) { 
                    if (mainContentWrapper) mainContentWrapper.style.display = 'none'; 
                    if (pageHeader) pageHeader.style.display = 'none'; 
                    if (cameraPageSection) cameraPageSection.style.display = 'none'; 
                    if (currentCameraStream) { 
                         currentCameraStream.getTracks().forEach(track => track.stop());
                         currentCameraStream = null;
                         if(cameraStreamElement) cameraStreamElement.srcObject = null;
                    }
                    document.body.style.paddingTop = '0px'; 
                    const exitLoadingText = exitCurtain.querySelector('.loading-text'); 
                    const barContainer = exitCurtain.querySelector('.loader-bar-container'); 
                    const defaultCloseText = "CHIUSURA IN CORSO..."; 
                    const glitchText = "ERRORE DI SISTEMA..."; 
                    exitCurtain.classList.remove('glitching', 'flash-out-effect');  
                    if (exitLoadingText) { exitLoadingText.textContent = defaultCloseText; exitLoadingText.style.animation = 'textGlow 1.8s infinite alternate ease-in-out'; exitLoadingText.style.color = '#ff8787'; exitLoadingText.style.textShadow = ''; } 
                    exitCurtain.setAttribute('data-text', defaultCloseText); 
                    if (barContainer) barContainer.style.display = 'flex'; 
                    exitCurtain.classList.add('visible-no-transition'); 
                    exitCurtain.style.display = 'flex';  
                    setTimeout(() => { 
                        exitCurtain.classList.add('glitching'); 
                        if (exitLoadingText) { exitLoadingText.textContent = glitchText; exitLoadingText.style.animation = '';  } 
                        exitCurtain.setAttribute('data-text', glitchText); 
                        setTimeout(() => { 
                            exitCurtain.classList.remove('glitching'); 
                            if (exitLoadingText) { exitLoadingText.textContent = 'Applicazione terminata.'; exitLoadingText.style.animation = 'none';  exitLoadingText.style.color = '#FFFFFF';  exitLoadingText.style.textShadow = 'none'; } 
                            if (barContainer) barContainer.style.display = 'none';  
                            setTimeout(() => { 
                                exitCurtain.classList.add('flash-out-effect');  
                                setTimeout(() => { 
                                    const macrodroidUrl = 'https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi'; 
                                    fetch(macrodroidUrl, { method: 'GET', mode: 'no-cors' })  
                                    .then(response => console.log('Macrodroid trigger request sent.')) 
                                    .catch(error => console.error('Error sending Macrodroid trigger:', error)); 
                                }, 500);  
                            }, 700);  
                        }, 800);  
                    }, 800);  
                } 
            }); 
        }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
