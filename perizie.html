<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Perizia Veicolo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Preloader & Exit Curtain Styles */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 1;
            visibility: visible;
        }
        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
        }

        #exit-curtain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in, visibility 0.5s ease-in;
        }

        #exit-curtain.hidden {
             opacity: 0;
             visibility: hidden;
             transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
        }

        #exit-curtain.visible-no-transition {
            opacity: 1;
            visibility: visible;
            transition: none;
        }

        .loader-bar-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .loader-bar {
            width: 15px;
            height: 70px;
            background-color: #007bff;
            animation: barPulse 1.2s infinite ease-in-out;
            box-shadow: 0 0 8px #007bff, 0 0 15px #00aeff;
            border-radius: 3px;
        }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        #exit-curtain:not(.glitching):not(.flash-out-effect) .loader-bar {
            animation-direction: reverse;
        }
        #exit-curtain.glitching:not(.flash-out-effect) .loader-bar {
            animation-direction: normal;
        }
        
        @keyframes barPulse {
            0%, 100% { transform: scaleY(0.3); opacity: 0.6; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        #preloader .loading-text,
        #exit-curtain .loading-text {
            font-size: 1.6em;
            letter-spacing: 1px;
        }

        #preloader .loading-text {
            color: #00aeff;
            animation: textGlow 1.8s infinite alternate ease-in-out;
            text-align: center;
            width: 100%;
        }
        
        #exit-curtain .loading-text {
             color: #ff8787;
        }

        @keyframes textGlow {
          from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 0.8;}
          to   { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; opacity: 1;}
        }

        #exit-curtain.glitching .loading-text {
            animation: glitchText 0.8s infinite steps(1, end), textGlow 1.8s infinite alternate ease-in-out;
            color: #ff3030 !important;
            position: relative;
            z-index: 10;
        }

        #exit-curtain.glitching::before,
        #exit-curtain.glitching::after {
            content: attr(data-text);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            padding: 0 20px;
            text-align: center;
            font-size: 1.6em;
            letter-spacing: 1px;
            background: #000000;
            overflow: hidden;
            clip-path: inset(50% 50% 50% 50%);
            z-index: 5;
        }

        #exit-curtain.glitching::before {
            color: #00ffff;
            animation: glitchEffect 0.3s infinite linear alternate-reverse;
        }

        #exit-curtain.glitching::after {
            color: #ff00ff;
            animation: glitchEffect 0.2s infinite linear alternate-reverse, glitchSkew 0.5s infinite linear alternate;
            animation-delay: -0.1s;
        }

        @keyframes glitchEffect {
            0%    { clip-path: inset(40% 0 30% 0); transform: translate(-50.5%, -50.1%) skewX(5deg); opacity: 0.8; }
            10%   { clip-path: inset(20% 0 70% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.7; }
            20%   { clip-path: inset(10% 0 55% 0); transform: translate(-49.8%, -50.2%) skewX(-3deg); opacity: 0.9; }
            30%   { clip-path: inset(50% 0 50% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            40%   { clip-path: inset(60% 0 10% 0); transform: translate(-50.2%, -49.9%) skewY(2deg); opacity: 1; }
            50%   { clip-path: inset(80% 0  5% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.75; }
            60%   { clip-path: inset(25% 0 40% 0); transform: translate(-50.1%, -50.3%) skewX(4deg); opacity: 0.85; }
            70%   { clip-path: inset(15% 0 75% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.9; }
            80%   { clip-path: inset(50% 0 20% 0); transform: translate(-49.9%, -49.8%) skewY(-3deg); opacity: 1; }
            90%   { clip-path: inset(70% 0 10% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            100%  { clip-path: inset(35% 0 45% 0); transform: translate(-50.3%, -50.0%) skewX(-2deg); opacity: 0.8; }
        }

        @keyframes glitchSkew {
            0%   { transform: translate(-50%, -50%) skew(-5deg, -2deg); }
            100% { transform: translate(-50%, -50%) skew(5deg, 2deg); }
        }

        @keyframes glitchText {
            0%, 100% { text-shadow: 0 0 3px red, 0 0 5px blue, 0 0 1px white; transform: translateX(0) translateY(0) skewX(0deg); opacity: 1;}
            10% { text-shadow: 1px 1px 3px red, -1px -1px 5px blue, 0 0 1px white; transform: translateX(-2px) translateY(1px) skewX(5deg); opacity: 0.8;}
            90% { text-shadow: 1px 1px 3px red, -1px -1px 5px blue, 0 0 1px white; transform: translateX(-1px) translateY(1px) skewX(1deg); opacity: 0.9;}
        }

        #exit-curtain.flash-out-effect .loading-text {
            color: #FFFFFF !important;
            text-shadow: none !important;
            animation: textFlashOut 0.5s forwards ease-out;
            transform-origin: center center;
        }

        @keyframes textFlashOut {
            0% {
                opacity: 1;
                transform: scale(1);
                text-shadow: 0 0 5px rgba(255,255,255,0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
                color: #FFFFE0 !important;
                text-shadow: 0 0 15px #FFFFFF,
                             0 0 25px #FFFFFF,
                             0 0 35px #FFFFE0,
                             0 0 50px #FFFF99;
            }
            99% {
                opacity: 0.8;
                transform: scale(1.05);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
                text-shadow: none;
                color: transparent !important;
            }
        }
        
        /* Original .header-circles styles, slightly modified if needed */
        .header-circles { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            width: 100%; 
            /* padding: 10px 0; /* Padding will be on parent #bottomNavCircles */
            box-sizing: border-box; 
            /* background-color: #2a2a2a; /* Background on parent */
            /* border-bottom: 1px solid #444; /* Border on parent as border-top */
        }

.circle-button {
    width: 75px;   /* Originale 50px * 1.5 */
    height: 75px;  /* Originale 50px * 1.5 */
    background-color: #383838;
    color: #e0e0e0;
    border: 1px solid #555;
    border-radius: 6px; /* Mantenuto per angoli arrotondati */
    flex-shrink: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.3s ease;
    font-size: 2.1em;  /* Originale 1.4em * 1.5 */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
        .circle-button:hover {
            background-color: #4a4a4a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        .circle-button:active {
            background-color: #555;
            transform: translateY(0px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .circle-button i { 
            line-height: 1; 
        }
        #headerExitBtn i { color: #dc3545; } 
        #headerPhotosBtn i { color: #007bff; } 
        #headerPeriziaBtn i { color: #ffc107; } 
        #headerCameraBtn i { color: #28a745; } 

        #headerExitBtn:hover i,
        #headerPhotosBtn:hover i,
        #headerPeriziaBtn:hover i,
        #headerCameraBtn:hover i {
            color: #ffffff; 
        }

        /* Styles for the new Bottom Navigation Bar */
        #bottomNavCircles {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
            box-sizing: border-box;
            background-color: #2a2a2a;
            border-top: 1px solid #444;
            z-index: 2025; /* Ensure it's above most content, but camera page might be higher */
        }


        body { 
            font-family: sans-serif; 
            line-height: 1.6; margin: 0; 
            background-color: #1e1e1e; 
            color: #f0f0f0; 
            transition: padding-top 0.3s ease, padding-bottom 0.3s ease; /* Added padding-bottom */
            padding-bottom: 70px; /* Initial padding for the bottom bar, adjust based on #bottomNavCircles height */
        }
        .content-wrapper { padding: 20px; } /* This might need padding-bottom if body doesn't cover it */
        h1, h2 { text-align: center; color: #ffffff; }
        h1#mainTitleGlobal { line-height: 1.2; margin-bottom: 10px; margin-top: 5px; font-size: 1.6em;}
        
        #targaDropdownContainer {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
            margin-top: 5px;
            margin-bottom: 10px;
        }
        #targaSwitcherDropdown {
            padding: 8px 12px; 
            background-color: #383838; 
            color: #f0f0f0;
            border: 1px solid #555;
            border-radius: 4px;
            min-width: 180px; 
            max-width: 220px;
            font-size: 1.1em; 
            font-family: sans-serif;
            cursor: pointer;
            text-align: center; 
        }
        #targaSwitcherDropdown:hover {
            background-color: #454545;
            border-color: #666;
        }
        #targaSwitcherDropdown option {
            padding: 5px; 
            background-color: #383838;
            color: #f0f0f0;
            text-align: left; 
        }
        #targaDetailsDisplay {
            font-size: 0.8em;
            color: #cccccc;
            margin-top: 3px; 
            text-align: center;
            min-height: 1.2em; 
            line-height: 1.3; 
        }
        
        @media (min-width: 480px) { 
            #targaDropdownContainer {
                flex-direction: row; 
                align-items: center; 
            }
            #targaDetailsDisplay {
                margin-top: 0;
                margin-left: 10px;
                text-align: left;
            }
        }
        

        h2.section-title { color: #cccccc; border-bottom: 1px solid #444444; padding-bottom: 5px; margin-top: 30px; text-align: left; }
        #galleryPageSection h2.section-title { margin-top: 10px; text-align: center; } 
        h3, h4 { color: #bbbbbb; margin-top: 20px; margin-bottom: 10px; }
        h4 {font-size: 1.1em; color: #c0c0c0; margin-top: 15px; margin-bottom: 8px;}
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 15px; }
        input[type="checkbox"], input[type="text"], input[type="url"], select, input[type="radio"], textarea { margin-right: 8px; vertical-align: middle; padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; margin-bottom: 5px; font-family: sans-serif;}
        input[type="text"], input[type="url"], textarea { width: calc(100% - 20px); box-sizing: border-box; }
        input[type="radio"] { margin-left: 5px; }
        select:not(#targaSwitcherDropdown) { min-width: 220px; } 
        label { vertical-align: middle; display: block; margin-bottom: 5px; color: #e0e0e0; }
        textarea {resize: vertical;}

        .category-section ul li > input[type="checkbox"] {
            vertical-align: middle;
            margin-right: 4px;
        }
        .category-section ul li > input[type="checkbox"] + label {
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 0;
        }

        #pageHeaderContainer {
            background-color: #1e1e1e;
            z-index: 1000; /* Was 1000, bottom bar is 2025, camera related is 2030 for pageHeaderContainer.fixed-header */
            width: 100%;
        }
        #pageHeaderContainer.fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            padding-bottom: 5px; /* This padding might be for content below the header bar itself */
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            z-index: 2030; /* Keep high if it overlays camera elements, but camera page is full screen */
        }

        #navButtons { 
            display: flex;
            flex-direction: column; 
            align-items: center;
            width: 100%;
        }
        #mainPageNavButtons { 
            display: flex;
            justify-content: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 5px 0;
            width: calc(100% - 20px);
            max-width: 700px;
        }
        #mainPageNavButtons button {
            margin: 3px;
            flex-shrink: 0;
        }
        #utilityNavButtons { 
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 5px; 
            margin-bottom: 5px; 
        }
        #utilityNavButtons button {
            margin: 3px 5px;
        }

        #navButtons button, .action-button { 
             padding: 8px 15px; cursor: pointer; background-color: #007bff; color: white; border: 1px solid #0056b3; border-radius: 4px; transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; font-size: 0.9em;
        }
        .save-and-next-btn { background-color: #0069d9 !important; border-color: #005cbf !important; }
        .save-and-next-btn:hover { background-color: #0056b3 !important; border-color: #004085 !important; }
        #navButtons button:hover, .action-button:hover { background-color: #0056b3; border-color: #004085; }

        @keyframes activeButtonGlow {
            0% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; }
            50% { box-shadow: 0 0 10px rgba(0, 150, 255, 1), 0 0 15px rgba(0, 150, 255, 0.7) inset; }
            100% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; }
        }

        #navButtons button.active { 
            background-color: #0056b3 !important; border-color: #004085 !important; color: white !important;
            animation-name: activeButtonGlow; animation-duration: 1.8s;
            animation-iteration-count: infinite; animation-timing-function: ease-in-out;
            animation-direction: alternate;
        }
        #navButtons button.nav-btn-completed { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        #navButtons button.nav-btn-partial { background-color: #ffc107 !important; border-color: #e0a800 !important; color: #212529 !important; }
        #navButtons button.nav-btn-untouched { background-color: #dc3545 !important; border-color: #c82333 !important; color: white !important; }

        #landingPageSection, .category-section, #historyPageSection, #galleryPageSection, .camera-page-section { 
            padding: 20px; border: 1px solid #444; border-radius: 8px; 
            margin-top: 20px; background-color: #2a2a2a; 
            max-width: 850px; margin-left: auto; margin-right: auto; 
        }

        .category-section, #historyPageSection, #galleryPageSection, .camera-page-section { display: none; } 
        #landingPageSection { display: block; }
        .category-section.active { display: block; }

        .category-section {
            position: relative; 
        }
        .page-action-buttons-container {
            position: absolute;
            top: 20px; 
            right: 20px;
            display: flex;
            gap: 10px; /* Spazio tra i bottoni */
            z-index: 10;
        }
        .page-action-button { /* Stile base per i bottoni di azione pagina */
            width: 35px;
            height: 35px;
            color: white;
            border: 1px solid;
            border-radius: 4px;
            font-size: 1.5em; 
            line-height: 1; 
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .fill-defaults-btn { /* Bottone compila default */
            background-color: #007bff; 
            border-color: #0056b3;
        }
        .fill-defaults-btn:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .fill-defaults-btn:active {
             background-color: #004085;
        }
        .reset-page-btn { /* Bottone reset pagina */
            background-color: #ffc107; /* Giallo */
            border-color: #e0a800;
            color: #212529; /* Testo scuro per contrasto */
        }
        .reset-page-btn:hover {
            background-color: #e0a800;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .reset-page-btn:active {
            background-color: #c69500;
        }


        .summary-item { margin-bottom: 8px; padding: 8px; background-color: #333; border-radius: 3px; }
        .summary-item strong { color: #00aeff; }
        .summary-anomaly {
            background-color: #5d3d3d !important; color: #ffdddd !important;
            border-left: 3px solid #ff8888; padding-left: 10px !important;
        }
        .summary-anomaly strong { color: #ffc0c0 !important; }
        .summary-notes {
            background-color: #3a3a4a !important; color: #e0e0ff !important;
            border-left: 3px solid #8888ff; padding-left: 10px !important;
        }
        .summary-notes strong { color: #c0c0ff !important; }

        .table-scroll-wrapper { overflow-x: auto; width: 100%; margin-bottom: 10px; border: 1px solid #444; border-radius: 4px; }
        .targa-list-table-content { min-width: 650px; } 
        .targa-list-header { display: flex; font-weight: bold; padding: 0 10px 0 10px; border-bottom: 2px solid #777; color: #ddd; background-color: #3a3a3a; }
        .targa-list-header .targa-col { padding: 6px 8px; border-right: 1px solid #555; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1;}
        .targa-list-header .targa-col:last-child { border-right: none; }
        .targa-list-header .targa-col-actions { flex-basis: 60px; text-align: center; flex-grow: 0; }
        .targa-list-header .targa-col-urgenza { flex-basis: 70px; text-align: center; flex-grow: 0; } 


        #targaListContainer { margin-top: 0; max-height: 350px; overflow-y: auto; overflow-x: visible; padding: 0; }
        .targa-list-item { display: flex; align-items: center; border-bottom: 1px solid #444; padding: 0 10px 0 10px; }
        .targa-list-item:last-child { border-bottom: none; }
        .targa-list-item .targa-col {
            padding: 8px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-right: 1px solid #444; text-align: left; flex-grow: 1; display: flex; align-items: center;
        }
        .targa-list-item .targa-col:last-child { border-right: none; }

        .targa-col-targa    { flex-basis: 13%; min-width: 75px;} 
        .targa-col-targa.clickable-targa {
            cursor: pointer;
            color: #8ab4f8;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        .targa-list-item:hover .targa-col-targa.clickable-targa {
            color: #a1c5ff;
            text-decoration: underline;
        }

        .targa-col-posizione{ flex-basis: 12%; min-width: 60px; padding: 4px !important; } 
        .targa-col-urgenza  { flex-basis: 10%; min-width: 50px; text-align: center; justify-content: center;} 
        .targa-col-urgenza input[type="checkbox"] { margin: 0 auto; } 
        .targa-col-marca    { flex-basis: 18%; min-width: 90px;} 
        .targa-col-modello  { flex-basis: 22%; min-width: 100px;}
        .targa-col-piazzale { flex-basis: 18%; min-width: 70px;} 
        .targa-col-actions  { flex-basis: 7%; min-width: 50px; flex-grow: 0; text-align: center; } 


        .targa-col-posizione input.posizione-input {
            width: 100%; padding: 6px 4px; margin: 0; box-sizing: border-box;
            background-color: #404040; color: #f0f0f0;
            border: 1px solid #5a5a5a; border-radius: 3px;
            font-size: 0.9em; text-align: center;
        }
        .targa-col-posizione input.posizione-input:focus {
            background-color: #484848; border-color: #777; outline: none;
        }

        .delete-progress-btn { background-color: #dc3545; border-color: #c82333; color: white; padding: 3px 7px; font-size: 0.8em; line-height: 1; flex-shrink: 0; border-radius: 3px; }
        .delete-progress-btn:hover { background-color: #c82333; border-color: #bd2130; }

        .targa-list-item.status-da-vedere { background-color: #383838 !important; }
        .targa-list-item.status-da-vedere:hover { background-color: #454545 !important; }
        .targa-list-item.status-da-vedere .targa-col { color: #f0f0f0 !important; }
        .targa-list-item.status-da-vedere .targa-col-targa.clickable-targa { color: #8ab4f8 !important; }
        .targa-list-item.status-da-vedere:hover .targa-col-targa.clickable-targa { color: #a1c5ff !important; }
        .targa-list-item.status-da-vedere .targa-col-posizione input.posizione-input { background-color: #4f4f4f; color: #f0f0f0; border-color: #5a5a5a; }

        .targa-list-item.status-visto { background-color: #2E4B35 !important; }
        .targa-list-item.status-visto:hover { background-color: #395c40 !important; }
        .targa-list-item.status-visto .targa-col-targa,
        .targa-list-item.status-visto .targa-col-marca,
        .targa-list-item.status-visto .targa-col-modello,
        .targa-list-item.status-visto .targa-col-piazzale { color: #a3cca3 !important; }
        .targa-list-item.status-visto .targa-col-targa.clickable-targa { color: #81c784 !important; }
        .targa-list-item.status-visto:hover .targa-col-targa.clickable-targa { color: #9ccc65 !important; }
        .targa-list-item.status-visto .targa-col-posizione input.posizione-input { background-color: #384c3d; color: #d0e0d0; }

        .targa-list-item.urgent-item { background-color: #4d3232 !important; border-left: 3px solid #ff6b6b; }
        .targa-list-item.urgent-item:hover { background-color: #5e3f3f !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col { color: #ffc0c0 !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-targa.clickable-targa { color: #ff8a80 !important; }
        .targa-list-item.urgent-item:not(.completed):hover .targa-col-targa.clickable-targa { color: #ff5252 !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-posizione input.posizione-input { background-color: #5a3e3e; color: #ffc0c0; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-urgenza input[type="checkbox"] { accent-color: #ff8a80; }


        .targa-list-item.completed .targa-col-targa,
        .targa-list-item.completed .targa-col-marca,
        .targa-list-item.completed .targa-col-modello,
        .targa-list-item.completed .targa-col-piazzale { color: #888 !important; }
        .targa-list-item.status-visto.completed .targa-col-targa,
        .targa-list-item.status-visto.completed .targa-col-marca,
        .targa-list-item.status-visto.completed .targa-col-modello,
        .targa-list-item.status-visto.completed .targa-col-piazzale { color: #a3cca3 !important; }
        .targa-list-item.status-visto.completed .targa-col-targa.clickable-targa { color: #81c784 !important; }
        .targa-list-item.urgent-item.completed .targa-col-targa,
        .targa-list-item.urgent-item.completed .targa-col-marca,
        .targa-list-item.urgent-item.completed .targa-col-modello,
        .targa-list-item.urgent-item.completed .targa-col-piazzale { color: #a07c7c !important; }
        .targa-list-item.urgent-item.completed .targa-col-targa.clickable-targa { color: #ff8a80 !important; }
        .targa-list-item.urgent-item.completed .targa-col-posizione input.posizione-input { background-color: #4a2e2e; color: #a07c7c; }
        .targa-list-item.urgent-item.completed .targa-col-urgenza input[type="checkbox"] { accent-color: #a07c7c; }


        .targa-list-item.status-parziale { background-color: #ffc107 !important; }
        .targa-list-item.status-parziale:hover { background-color: #e0a800 !important; }
        .targa-list-item.status-parziale .targa-col { color: #212529 !important; }
        .targa-list-item.status-parziale .targa-col-targa.clickable-targa { color: #b8860b !important; }
        .targa-list-item.status-parziale:hover .targa-col-targa.clickable-targa { color: #8B4513 !important; }
        .targa-list-item.status-parziale .targa-col-posizione input.posizione-input { background-color: #ffe082; color: #212529; border-color: #ffc107; }
        .targa-list-item.status-parziale .targa-col-urgenza input[type="checkbox"] { accent-color: #b8860b; }

        .targa-list-item.locally-deleted {
            opacity: 0.5;
            background-color: #404040 !important;
        }
        .targa-list-item.locally-deleted .targa-col-targa {
            text-decoration: line-through;
            color: #aaa !important;
        }
        .targa-list-item.locally-deleted .clickable-targa {
            cursor: default !important;
            text-decoration: line-through !important;
        }
        .targa-list-item.locally-deleted .delete-progress-btn {
            display: none;
        }
        .targa-list-item.locally-deleted input,
        .targa-list-item.locally-deleted select {
            pointer-events: none;
            opacity: 0.7;
        }


        #targheLoadingStatus { text-align: center; padding: 10px; color: #00aeff; }
        #savedTargasListContainer { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #333; border-radius: 4px; margin-bottom: 20px; }
        .saved-targa-button { display: block; width: 100%; padding: 10px; background-color: #383838; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; text-align: left; cursor: pointer; font-size: 0.95em; }
        .saved-targa-button:hover { background-color: #454545; }
        #historyPageSection .action-button { margin-right: 10px; }
        #sheetFilterContainer { margin-bottom: 15px; text-align: center; }
        #sheetFilterContainer label { margin-right: 10px; color: #ccc; display: inline-block; }
        #sheetFilterDropdown { padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; min-width: 250px; vertical-align: middle; }

        .animate-me {
            animation: pulseHighlight 1.5s infinite alternate;
            outline: 2px solid rgba(0, 123, 255, 0.0);
            transition: outline 0.3s ease, box-shadow 0.3s ease;
        }
        @keyframes pulseHighlight {
            from { outline: 2px solid rgba(0, 123, 255, 0.7); box-shadow: 0 0 5px rgba(0, 123, 255, 0.5), 0 0 8px rgba(0, 123, 255, 0.3) inset; }
            to   { outline: 3px solid rgba(0, 150, 255, 1); box-shadow: 0 0 10px rgba(0, 150, 255, 0.8), 0 0 12px rgba(0, 150, 255, 0.5) inset; }
        }
        input[type="checkbox"].animate-me, select.animate-me { position: relative; z-index: 1; }

        /* START: Stili per la pagina Fotocamera */
        .camera-page-section { /* This is the main camera container */
            position: fixed;
            top: 0; /* Will be adjusted by JS if top header exists */
            left: 0;
            width: 100%;
            height: 100%; /* Will be adjusted by JS if top header exists */
            background-color: #000;
            z-index: 2000; /* Below pageHeaderContainer.fixed-header (2030) and bottomNavCircles (2025) if they were to overlap */
            display: none; /* Managed by JS */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 0; /* Adjusted by JS */
            margin: 0;
            border: none;
            border-radius: 0;
            max-width: none;
            box-sizing: border-box;
        }
        #cameraStream {
            width: 100%;
            height: 100%; /* Takes full height of its parent .camera-page-section */
            object-fit: contain;
        }
        #freezeFrameDisplay {
            display: none;
            position: absolute;
            top: 0; /* Relative to .camera-page-section padding */
            left: 0;
            width: 100%;
            height: 100%; /* Relative to .camera-page-section padding */
            object-fit: contain;
            z-index: 2015; /* Above cameraStream, below capture buttons */
            border: 8px solid #00bcd4;
            box-sizing: border-box;
        }

        #captureBtn { /* Capture button itself, inside camera-page-section */
            position: absolute;
            bottom: 40px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 2020; /* Above freeze frame, stream */
            width: 70px; 
            height: 70px; 
            background-color: #fff; 
            border: 4px solid #fff; 
            border-radius: 50%; 
            box-shadow: 0 0 0 4px #333; 
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0; 
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        #captureBtn::before { 
            content: '';
            width: 50px; 
            height: 50px; 
            background-color: #333; 
            border-radius: 50%;
            display: block;
        }

        #captureBtn:hover {
            background-color: #f0f0f0; 
            box-shadow: 0 0 0 5px #555; 
        }
        #captureBtn:active {
            background-color: #e0e0e0;
             box-shadow: 0 0 0 5px #000;
        }
       
        #closeCameraBtn { /* Close button for camera, inside camera-page-section */
            position: absolute;
            bottom: 20px; /* Should be above bottomNavCircles if that bar was visible */
            right: 20px;
            z-index: 2020; /* Same level as capture button */
            width: 45px;
            height: 45px;
            background-color: rgba(40, 40, 40, 0.8);
            color: #ff4d4d;
            border: 1px solid #ff4d4d;
            border-radius: 4px;
            font-size: 1.8em;
            line-height: 43px; 
            text-align: center;
            padding: 0;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #closeCameraBtn:hover {
            background-color: rgba(255, 77, 77, 0.9);
            color: #fff;
            border-color: #fff;
        }

        /* pageHeaderContainer.fixed-header z-index is 2030, it would be on top of camera.
           However, JS will hide most of its content or the container itself during camera view.
           The bottomNavCircles is 2025. The cameraPageSection is 2000.
           Capture buttons are 2020.
           This means if bottomNavCircles was visible, capture buttons would be on top.
           But JS will hide bottomNavCircles.
        */
        /* END: Stili per la pagina Fotocamera */

        /* START: Stili per Changelog Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 15px;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: #333;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            width: 90%;
            max-width: 550px;
            color: #e0e0e0;
            border-top: 5px solid #007bff;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #00aeff;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
            font-size: 1.5em;
        }
        .modal-content ul {
            list-style-position: inside;
            padding-left: 5px;
        }
        .modal-content ul li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .modal-close-btn {
            display: block;
            margin: 25px auto 0 auto;
            padding: 10px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        .modal-close-btn:hover {
            background-color: #0056b3;
        }
        /* END: Stili per Changelog Modal */

        /* START: Stili per Pagina Galleria */
        #galleryPageSection {
            text-align: center;
            overscroll-behavior-y: contain;
        }
        #photoGridContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .photo-item {
            background-color: #3c3c3c;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.35);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        .photo-item img {
            max-width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid #555;
        }
        .photo-item-caption {
            font-size: 0.75em;
            color: #bdbdbd;
            word-wrap: break-word;
            margin-bottom: 8px;
            line-height: 1.3;
            max-height: 3.9em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .photo-item-delete-btn {
            background-color: #c82333;
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 0.9em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
         .photo-item-delete-btn:hover {
            background-color: #a41523;
        }
        /* END: Stili per Pagina Galleria */

        /* START: Stili per Lightbox Immagine */
        #imageLightbox {
            display: none;
            position: fixed;
            z-index: 3000; /* Above bottomNavCircles (2025) and pageHeaderContainer.fixed-header (2030) */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            background-color: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            -webkit-tap-highlight-color: transparent; 
        }
        #lightboxContent {
            position: relative;
            margin: auto;
            padding: 0;
            width: 90%;
            max-width: 700px;
        }
        #lightboxImage {
            display: block;
            width: 100%;
            height: auto;
            max-height: 80vh;
            object-fit: contain;
            border: 3px solid #444;
            border-radius: 5px;
        }
        #closeLightboxBtn {
            position: absolute;
            top: -5px;
            right: -5px;
            color: #fff;
            background-color: #333;
            border: 1px solid #555;
            font-size: 28px;
            font-weight: bold;
            padding: 0px 10px;
            line-height: 1.2;
            border-radius: 50%;
            cursor: pointer;
            transition: color 0.3s, background-color 0.3s;
            z-index: 3010; /* Above lightboxContent */
        }
        #closeLightboxBtn:hover,
        #closeLightboxBtn:focus {
            background-color: #c82333;
            color: #fff;
            text-decoration: none;
        }
        /* END: Stili per Lightbox Immagine */
        
        /* START: Stili per Indicatore Fine Swipe */
        .swipe-end-indicator {
            position: fixed;
            background-color: rgba(255, 0, 0, 0.6); 
            z-index: 10001; /* Above modals */
            opacity: 0;
            transition: opacity 0.15s ease-out;
            pointer-events: none; 
        }
        #swipe-end-indicator-left { top: 0; bottom: 0; left: 0; width: 5px; }
        #swipe-end-indicator-right { top: 0; bottom: 0; right: 0; width: 5px; }
        #swipe-end-indicator-top { left: 0; right: 0; top: 0; height: 5px; }
        #swipe-end-indicator-bottom { left: 0; right: 0; bottom: 0; height: 5px; }
        /* END: Stili per Indicatore Fine Swipe */

        /* Riepilogo Header Flex Container */
        .riepilogo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%; 
        }

        /* Stile per il bottone Download ZIP */
        #downloadZipBtn {
            padding: 8px 12px;
            background-color: #17a2b8; 
            color: white;
            border: 1px solid #117a8b;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-decoration: none; 
            display: inline-flex; 
            align-items: center;
            gap: 5px; 
        }
        #downloadZipBtn:hover {
            background-color: #117a8b;
        }
        #downloadZipBtn i {
            font-size: 1.1em; 
        }


  @media (max-width: 768px) {
    /* ... altri stili ... */
    .circle-button {
        width: 68px;   /* Originale 45px * 1.5 (67.5px arrotondato) */
        height: 68px;  /* Originale 45px * 1.5 (67.5px arrotondato) */
        font-size: 1.8em;  /* Originale 1.2em * 1.5 */
        border-radius: 6px; /* Coerenza con lo stile base */
    }
    /* ... altri stili ... */
            .content-wrapper { margin-top: 0; }
            /* .circle-button { width: 45px; height: 45px; font-size: 1.2em;} */ /* These are now in #bottomNavCircles, adjusted above */
            #bottomNavCircles { padding: 8px 0; } /* Adjust padding for the bottom bar */

            #navButtons button, .action-button { padding: 8px 10px; font-size: 0.85em; }
            #mainPageNavButtons { width: 100%; padding: 5px; box-sizing: border-box; }
            #mainPageNavButtons button { font-size: 0.8em; padding: 6px 8px; }
            #utilityNavButtons button { font-size: 0.85em; padding: 8px 10px; }
            input[type="text"], input[type="url"], select:not(#targaSwitcherDropdown), textarea { width: 100%; box-sizing: border-box; }
            #targaSwitcherDropdown { min-width: 160px; font-size: 1em; }
            #targaDetailsDisplay { font-size: 0.75em; }
            .table-scroll-wrapper { overflow-x: auto; }
            .targa-list-table-content { min-width: 600px; }
            .targa-list-header { display: flex !important; }
            .targa-list-header .targa-col, .targa-list-item .targa-col { padding: 6px 5px; }
            .delete-progress-btn { padding: 5px 8px; }
            .targa-col-targa    { min-width: 65px;}
            .targa-col-posizione{ min-width: 50px;}
            .targa-col-urgenza  { min-width: 45px;}
            .targa-col-marca    { min-width: 70px;}
            .targa-col-modello  { min-width: 80px;}
            .targa-col-piazzale { min-width: 60px;}
            .targa-col-actions  { min-width: 40px;}
            #sheetFilterContainer { display: flex; flex-direction: column; align-items: stretch; }
            #sheetFilterContainer label { margin-bottom: 5px; margin-right: 0; text-align: left;}
            #sheetFilterDropdown { width: 100%; }
            .page-action-buttons-container { top: 15px; right: 15px; gap: 8px;}
            .page-action-button { width: 30px; height: 30px; font-size: 1.2em; }
            #captureBtn { bottom: 30px; width: 60px; height: 60px; border-width: 3px; box-shadow: 0 0 0 3px #333;}
            #captureBtn::before { width: 40px; height: 40px; }
            #closeCameraBtn { bottom: 15px; right: 15px; width: 40px; height: 40px; font-size: 1.6em; line-height: 38px;}
            #photoGridContainer { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;}
            .photo-item img { height: 100px; }
            #lightboxContent { width: 95%; }
            #lightboxImage { max-height: 75vh; }
            #closeLightboxBtn { font-size: 22px; top: 0px; right: 0px; padding: 0px 8px;}
             #downloadZipBtn { padding: 6px 10px; font-size: 0.85em; }
        }
  @media (max-width: 400px) {
    /* ... altri stili ... */
    .circle-button {
        width: 60px;   /* Originale 40px * 1.5 */
        height: 60px;  /* Originale 40px * 1.5 */
        font-size: 1.7em;  /* Originale 1.1em * 1.5 (1.65em arrotondato) */
        border-radius: 6px; /* Coerenza con lo stile base */
    }
    /* ... altri stili ... */
            /* .circle-button { width: 40px; height: 40px; font-size: 1.1em;} */ /* Adjusted above */
            #bottomNavCircles { padding: 6px 0; } /* Adjust padding for the bottom bar */
            /* .header-circles { padding: 8px 0; } /* This class is now a child, parent has padding */
            
            #photoGridContainer { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .modal-content { width: 95%; padding: 15px; }
            .modal-content h2 {font-size: 1.3em;}
            #captureBtn { bottom: 25px; width: 55px; height: 55px; border-width: 3px; box-shadow: 0 0 0 3px #222;}
            #captureBtn::before { width: 35px; height: 35px; background-color: #222; }
            .riepilogo-header { flex-direction: column; align-items: flex-start; gap: 10px;}
            .riepilogo-header .section-title { width: 100%; text-align: center; } 
            #downloadZipBtn { width: 100%; justify-content: center;} 
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="changelogModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="changelogTitle">WebApp Perizie - Novità</h2>
            <ul id="changelogList">
                </ul>
            <button id="closeChangelogBtnModal" class="modal-close-btn">Chiudi</button>
        </div>
    </div>

    <div id="exit-curtain" data-text="CHIUSURA IN CORSO...">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">CHIUSURA IN CORSO...</div>
    </div>

    <div id="imageLightbox">
        <span id="closeLightboxBtn">&times;</span>
        <div id="lightboxContent">
            <img id="lightboxImage" src="#" alt="Immagine Ingrandita">
        </div>
    </div>
    
    <div id="swipe-end-indicator-left" class="swipe-end-indicator"></div>
    <div id="swipe-end-indicator-right" class="swipe-end-indicator"></div>
    <div id="swipe-end-indicator-top" class="swipe-end-indicator"></div> <div id="swipe-end-indicator-bottom" class="swipe-end-indicator"></div>


    <div id="pageHeaderContainer">
        <div id="utilityNavButtons">
            <button id="backToListBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe</button>
            <button id="historyBtn" class="action-button" style="background-color: #17a2b8; border-color: #117a8b;">Salvataggi</button>
            <button id="exitAppBtn" class="action-button" style="background-color: #dc3545; border-color: #c82333;">Esci</button>
            </div>
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>
        <div id="targaDropdownContainer" style="display: none;">
            <select id="targaSwitcherDropdown"></select>
            <span id="targaDetailsDisplay"></span>
        </div>
        <div id="navButtons">
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;">
            <h2 style="margin-top: 10px;">Seleziona Veicolo da Periziare</h2>
            <div id="sheetFilterContainer">
                <label for="sheetFilterDropdown">Filtra per Elenco:</label>
                <select id="sheetFilterDropdown">
                    <option value="all">Tutti gli Elenchi</option>
                </select>
            </div>
            <div id="targheLoadingStatus">Caricamento targhe in corso...</div>
            <div class="table-scroll-wrapper">
                <div class="targa-list-table-content">
                    <div class="targa-list-header">
                        <span class="targa-col targa-col-targa">Targa</span>
                        <span class="targa-col targa-col-posizione">Posizione</span>
                        <span class="targa-col targa-col-urgenza">Urgenza</span>
                        <span class="targa-col targa-col-marca">Marca</span>
                        <span class="targa-col targa-col-modello">Modello</span>
                        <span class="targa-col targa-col-piazzale">Piazzale</span>
                        <span class="targa-col targa-col-actions">Azioni</span>
                    </div>
                    <div id="targaListContainer"></div>
                </div>
            </div>
        </div>

        <div id="checklistContainer" style="display: none;"> 
            <div id="remarketingSection" class="category-section">
                <div class="page-action-buttons-container">
                    <button class="page-action-button reset-page-btn" title="Azzera Campi Pagina" data-sectionid="remarketingSection"><i class="fas fa-undo"></i></button>
                    <button class="page-action-button fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="remarketingSection"><i class="fas fa-check"></i></button>
                </div>
                <h2 class="section-title">1. Foto Remarketing</h2>
                <ul>
                    <li>
                        <label for="tipo_trazione">Trazione veicolo:</label>
                        <select id="tipo_trazione">
                            <option value="">Seleziona...</option>
                            <option value="endotermico">Endotermico</option>
                            <option value="elettrico">Elettrico</option>
                        </select>
                    </li>
                    <li><input type="checkbox" id="foto_angolari"><label for="foto_angolari">Foto angolari (3/4)</label></li>
                    <li>
                        <input type="checkbox" id="foto_vano_carico">
                        <label for="foto_vano_carico">Vano Carico</label>
                    </li>
                    <li>
                        <label for="tipo_equipaggiamento">Equipaggiamento:</label>
                        <select id="tipo_equipaggiamento">
                            <option value="">Seleziona...</option>
                            <option value="kit_gonfia_ripara">Kit</option>
                            <option value="ruota">Ruota</option>
                            <option value="ruotino">Ruotino</option>
                            <option value="runflat">Runflat</option>
                        </select>
                    </li>
                    <li><label for="equipaggiamento_presenza">Presenza equip.:</label><select id="equipaggiamento_presenza"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_interni_pannelli"><label for="foto_interni_pannelli">Interni/pannelli</label></li>
                    <li><input type="checkbox" id="foto_cruscotto"><label for="foto_cruscotto">Cruscotto</label></li>
                    <li><label for="stato_chilometri">Chilometri - Stato:</label><select id="stato_chilometri"><option value="">Seleziona...</option><option value="rilevabili">Rilevabili</option><option value="non_rilevabili">Non rilevabili</option></select></li>
                    <li><label for="stato_cdc">CDC - Stato:</label><select id="stato_cdc"><option value="">Seleziona...</option><option value="originale">Originale</option><option value="copia_conforme">Copia conforme</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_vano_motore"><label for="foto_vano_motore">Vano motore</label></li>
                    <li><input type="checkbox" id="foto_cofano_tetto"><label for="foto_cofano_tetto">Cofano e tetto</label></li>
                    <li>
                        <label for="chiave_telecomando">Chiave con telecomando:</label>
                        <select id="chiave_telecomando">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="seconda_chiave">Seconda chiave:</label>
                        <select id="seconda_chiave">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_rapida">Cavo ricarica rapida:</label>
                        <select id="cavo_ricarica_rapida" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_domestica">Cavo ricarica domestica:</label>
                        <select id="cavo_ricarica_domestica" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="pneumaticiSection" class="category-section">
                <div class="page-action-buttons-container">
                    <button class="page-action-button reset-page-btn" title="Azzera Campi Pagina" data-sectionid="pneumaticiSection"><i class="fas fa-undo"></i></button>
                    <button class="page-action-button fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="pneumaticiSection"><i class="fas fa-check"></i></button>
                </div>
                <h2 class="section-title">2. Foto Pneumatici</h2>
                <ul>
                    <li><label for="pneumatico_as">Ant. sinistro:</label><select id="pneumatico_as"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ad">Ant. destro:</label><select id="pneumatico_ad"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_pd">Post. destro:</label><select id="pneumatico_pd"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ps">Post. sinistro:</label><select id="pneumatico_ps"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="danniVerificheSection" class="category-section">
                <div class="page-action-buttons-container">
                     <button class="page-action-button reset-page-btn" title="Azzera Campi Pagina" data-sectionid="danniVerificheSection"><i class="fas fa-undo"></i></button>
                    <button class="page-action-button fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="danniVerificheSection"><i class="fas fa-check"></i></button>
                </div>
                <h2 class="section-title">3. Foto Danni e Verifiche</h2>
                <ul>
                    <li><label for="motore_accende">Motore si accende:</label><select id="motore_accende"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><label for="batteria_stato">Batteria:</label><select id="batteria_stato"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><input type="checkbox" id="foto_danni_generiche"><label for="foto_danni_generiche">Altre foto danni</label></li>
                    <li>
                        <label for="note_danni_verifiche">Note Danni/Verifiche:</label>
                        <textarea id="note_danni_verifiche" rows="4"></textarea>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Vai al Riepilogo</button></div>
            </div>
            <div id="riepilogoSection" class="category-section">
                <div class="riepilogo-header">
                    <h2 class="section-title" style="margin-bottom: 0; border-bottom: none;">Riepilogo Perizia</h2>
                    <a href="#" id="downloadZipBtn" class="action-button" title="Download ZIP Perizia" target="_blank" style="display: none;"> <i class="fas fa-file-archive"></i> Download ZIP
                    </a>
                </div>
                <div id="summaryContent" style="margin-top: 15px;"><p><em>Compila le sezioni precedenti...</em></p></div>
                <button id="saveAndReturnBtn" class="action-button" style="background-color: #28a745; border-color: #1e7e34; margin-top: 15px;">Salva Perizia e Foto</button>
            </div>
        </div>

        <div id="historyPageSection" style="display: none;">
            <h2 class="section-title" style="text-align: center;">Cronistoria Salvataggi</h2>
            <div id="savedTargasListContainer"><p>Nessun salvataggio trovato.</p></div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="clearAllProgressBtn" class="action-button" style="background-color: #dc3545; border-color: #c82333;">Cancella Tutti i Salvataggi</button>
                <button id="backToLandingFromHistoryBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe Principale</button>
            </div>
        </div>

        <div id="galleryPageSection" style="display: none;">
            <h2 class="section-title" style="text-align: center;">Galleria Foto Catturate</h2>
            <button id="backToMainFromGalleryBtn" class="action-button" style="margin-bottom: 15px; background-color: #6c757d; border-color: #5a6268;">Torna all'Elenco</button>
            <div id="photoGridContainer">
            </div>
        </div>

        <div id="cameraPageSection" class="camera-page-section" style="display: none;">
            <video id="cameraStream" autoplay playsinline></video>
            <img id="freezeFrameDisplay" src="#" alt="Foto Catturata" style="display: none;">
            <button id="captureBtn" class="action-button"></button>
            <button id="closeCameraBtn" class="action-button">×</button> 
        </div>

    </div> <div id="bottomNavCircles">
        <div class="header-circles">
            <button id="headerExitBtn" class="circle-button" title="Esci dall'applicazione"><i class="fas fa-power-off"></i></button>
            <button id="headerPhotosBtn" class="circle-button" title="Galleria Foto App"><i class="fas fa-images"></i></button>
            <button id="headerPeriziaBtn" class="circle-button" title="Vai all'ultima perizia/sezione"><i class="fas fa-clipboard-list"></i></button>
            <button id="headerCameraBtn" class="circle-button" title="Fotocamera"><i class="fas fa-camera-retro"></i></button>
        </div>
    </div>

<script>
    // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const galleryPageSection = document.getElementById('galleryPageSection');
    const photoGridContainer = document.getElementById('photoGridContainer');
    const backToMainFromGalleryBtn = document.getElementById('backToMainFromGalleryBtn');

    const cameraPageSection = document.getElementById('cameraPageSection');
    const cameraStreamElement = document.getElementById('cameraStream');
    const freezeFrameDisplayElement = document.getElementById('freezeFrameDisplay');
    const captureBtn = document.getElementById('captureBtn');
    const closeCameraBtn = document.getElementById('closeCameraBtn');
    let currentCameraStream = null;
    let lastViewBeforeCamera = 'landing'; // Vista attiva prima di aprire la fotocamera
    let lastSectionBeforeCamera = null; // Sezione attiva (es. 'remarketing') prima di aprire la fotocamera

    const bottomNavCircles = document.getElementById('bottomNavCircles'); 

    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer'); 
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const targaDropdownContainer = document.getElementById('targaDropdownContainer');
    const targaSwitcherDropdown = document.getElementById('targaSwitcherDropdown');
    const targaDetailsDisplay = document.getElementById('targaDetailsDisplay');

    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons');
    const mainPageNavButtons = navButtonsContainer.querySelector('#mainPageNavButtons');
    const utilityNavButtons = pageHeaderContainer.querySelector('#utilityNavButtons');

    const navButtons = mainPageNavButtons.querySelectorAll('button[data-target]');

    const backToListBtn = utilityNavButtons.querySelector('#backToListBtn');
    const historyBtn = utilityNavButtons.querySelector('#historyBtn');
    const mainExitAppBtn = utilityNavButtons.querySelector('#exitAppBtn');
    let syncToSheetsBtn;

    const headerExitBtn = document.getElementById('headerExitBtn');
    const headerPhotosBtn = document.getElementById('headerPhotosBtn');
    const headerPeriziaBtn = document.getElementById('headerPeriziaBtn');
    const headerCameraBtn = document.getElementById('headerCameraBtn');

    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn');
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn');
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn');
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
    const tipoTrazioneSelect = document.getElementById('tipo_trazione');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');

    const imageLightbox = document.getElementById('imageLightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const closeLightboxBtnElem = document.getElementById('closeLightboxBtn');
    let currentLightboxImageObjectUrl = null;
    let currentLightboxPhotoList = [];
    let currentLightboxPhotoIndex = -1;

    const downloadZipBtn = document.getElementById('downloadZipBtn');


    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzN4bBhPi4d8i7fSpJQqCJ2CQYOtmes1yKeGeqVe053K4QkdKYH4PuQIughn_9YLEfCkA/exec';

    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null; // Targa attiva per la perizia o la galleria specifica
    const APP_PREFIX = 'periziaApp_';
    const LAST_ACTIVE_PERIZIA_PAGE_KEY = `${APP_PREFIX}lastActivePeriziaPage`;

    const currentAppVersion = "1.6.5"; // Versione aggiornata per riflettere le modifiche
    const changelogModal = document.getElementById('changelogModal');
    const closeChangelogBtnModal = document.getElementById('closeChangelogBtnModal');
    const changelogList = document.getElementById('changelogList');
    const changelogTitle = document.getElementById('changelogTitle');

    const latestChangesText = `
        <li><strong>Correzione Catalogazione Foto:</strong>
            <ul>
                <li>Le foto scattate da una sezione specifica (es. Remarketing) per una targa vengono ora correttamente catalogate con quella sezione e targa, invece che come "generale".</li>
            </ul>
        </li>
        <li><strong>Correzione Navigazione Galleria da Fotocamera:</strong>
            <ul>
                <li>Se si apre la fotocamera da una sezione specifica di una targa (es. Remarketing di AA000BB), e poi si naviga direttamente alla galleria dalla fotocamera, si viene ora indirizzati alla galleria filtrata per quella targa e sezione (Galleria Remarketing di AA000BB).</li>
            </ul>
        </li>
        <li>Miglioramenti precedenti (v1.6.4): Pulsanti Azione Pagina (Azzera, Compila), Download ZIP Perizia.</li>
    `;


    let touchstartX = 0, touchstartY = 0;
    let touchendX = 0, touchendY = 0;
    const swipeThreshold = 50;
    const sectionOrder = ['remarketing', 'pneumatici', 'danniVerifiche', 'riepilogo'];

    let currentGalleryTargaFilter = null; // Targa attualmente filtrata nella galleria
    let currentGallerySectionFilter = null; // Sezione attualmente filtrata nella galleria
    let lastViewBeforeGallery = 'landing'; // Vista attiva prima di aprire la galleria
    let lastSectionBeforeGallery = null; // Sezione attiva prima di aprire la galleria


    let lightboxTouchStartX = 0;
    let lightboxTouchStartY = 0;

    let galleryGridTouchStartY = 0;


    const IDB_NAME = 'PeriziePhotoDB_v1';
    const IDB_VERSION = 1;
    const PHOTO_STORE_NAME = 'capturedPhotosStore';
    let dbPromise = null;

    function openPhotoDB() {
        if (dbPromise) return dbPromise;

        dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(IDB_NAME, IDB_VERSION);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(PHOTO_STORE_NAME)) {
                    const store = db.createObjectStore(PHOTO_STORE_NAME, { keyPath: 'timestamp' });
                    store.createIndex('targaIdx', 'targa', { unique: false });
                    store.createIndex('sezioneIdx', 'sezione', { unique: false });
                    store.createIndex('targaSezioneIdx', ['targa', 'sezione'], { unique: false });
                }
            };

            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => {
                console.error("Errore apertura IndexedDB:", event.target.error);
                dbPromise = null; // Resetta dbPromise in caso di errore per permettere nuovi tentativi
                reject(event.target.error);
            };
        });
        return dbPromise;
    }

    async function savePhotoToDB(photoData) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.put(photoData); // 'put' aggiorna se la chiave esiste, altrimenti aggiunge
            request.onsuccess = () => resolve();
            request.onerror = (event) => {
                console.error('Errore salvataggio foto in IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    async function getAllPhotosFromDB() {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => resolve(event.target.result || []);
            request.onerror = (event) => {
                console.error('Errore recupero tutte le foto da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    async function getPhotosByTargaAndSezioneFromDB(targaFilter, sectionKeyFilter) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            let request;

            // Normalizza targaFilter a uppercase se presente
            const targaUpper = targaFilter ? targaFilter.toUpperCase() : null;

            if (targaUpper && sectionKeyFilter && sectionKeyFilter !== 'riepilogo') {
                 let effectiveSectionKey = sectionKeyFilter.toLowerCase();
                 if (effectiveSectionKey === 'danniverifiche') effectiveSectionKey = 'danni';
                // Cerca per targa E sezione specifica
                const targaSezioneIndex = store.index('targaSezioneIdx');
                request = targaSezioneIndex.getAll(IDBKeyRange.only([targaUpper, effectiveSectionKey]));
            } else if (targaUpper) {
                // Cerca solo per targa (tutte le sezioni per quella targa)
                const targaIndex = store.index('targaIdx');
                request = targaIndex.getAll(IDBKeyRange.only(targaUpper));
            } else {
                // Nessun filtro targa, recupera tutte le foto (usato raramente, es. galleria generale senza filtri)
                request = store.getAll();
            }

            request.onsuccess = (event) => resolve(event.target.result || []);
            request.onerror = (event) => {
                console.error('Errore recupero foto filtrate da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }


    async function deletePhotoFromDB(timestampToDelete) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.delete(timestampToDelete);
            request.onsuccess = () => resolve();
            request.onerror = (event) => {
                console.error('Errore eliminazione foto da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    function showSwipeEndIndicator(side) {
        const indicator = document.getElementById(`swipe-end-indicator-${side}`);
        if (indicator) {
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 300);
        }
    }

    function resetSectionFields(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;

        section.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        section.querySelectorAll('input[type="text"]').forEach(txt => txt.value = '');
        section.querySelectorAll('textarea').forEach(ta => ta.value = '');
        section.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);

        if (sectionId === 'remarketingSection') {
            handleTrazioneChange(); // Gestisce la logica dei campi disabilitati per EV
        }

        updateNavButtonColors(); // Aggiorna i colori dei pulsanti di navigazione
        if (targaSelezionataGlobalmente) {
            saveProgress(targaSelezionataGlobalmente); // Salva lo stato resettato
        }
        // Rimuovi animazioni e reinizializza se la sezione è attiva
        section.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me'));
        if (typeof initSequentialAnimation === 'function' && section.classList.contains('active')) {
            setTimeout(initSequentialAnimation, 50);
        }
         alert(`Campi della sezione ${section.querySelector('h2.section-title')?.textContent.trim() || sectionId} azzerati.`); // Usa alert per ora
    }


    function updateTargaDetailsDisplay(selectedTarga) {
        if (!targaDetailsDisplay || !selectedTarga || !listaTargheCompleta.length) {
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        const veicolo = listaTargheCompleta.find(v => v.targa.toUpperCase() === selectedTarga.toUpperCase());
        if (veicolo) {
            let detailsText = '';
            const marca = veicolo.marca ? String(veicolo.marca).trim() : '';
            const modello = veicolo.modello ? String(veicolo.modello).trim() : '';
            if (marca) detailsText += marca;
            if (modello) detailsText += (detailsText ? ' ' : '') + modello;
            targaDetailsDisplay.textContent = detailsText || '';
        } else {
            targaDetailsDisplay.textContent = '';
        }
    }

    function populateTargaSwitcherDropdown() {
        if (!targaSwitcherDropdown || !targaSelezionataGlobalmente || !listaTargheCompleta.length) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }

        const veicoloAttuale = listaTargheCompleta.find(v => v.targa.toUpperCase() === targaSelezionataGlobalmente.toUpperCase());
        if (!veicoloAttuale || !veicoloAttuale.piazzale) { // Se non c'è piazzale, non mostrare lo switcher
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = ''; // Pulisci anche i dettagli se lo switcher è nascosto
            return;
        }

        const piazzaleCorrente = veicoloAttuale.piazzale;
        // Filtra le targhe dello stesso piazzale, escludendo quelle marcate per cancellazione locale/server
        const targheDelPiazzale = listaTargheCompleta.filter(v => 
            v.piazzale === piazzaleCorrente && 
            !localStorage.getItem(`${APP_PREFIX}deleted_${v.targa.toUpperCase()}`)
        );

        targaSwitcherDropdown.innerHTML = ''; // Pulisci opzioni esistenti

        if (targheDelPiazzale.length === 0) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }

        targheDelPiazzale.sort((a, b) => a.targa.localeCompare(b.targa)); // Ordina alfabeticamente

        targheDelPiazzale.forEach(v => {
            const option = document.createElement('option');
            option.value = v.targa.toUpperCase();
            option.textContent = v.targa;
            if (v.targa.toUpperCase() === targaSelezionataGlobalmente.toUpperCase()) {
                option.selected = true;
            }
            targaSwitcherDropdown.appendChild(option);
        });

        if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex'; // Mostra il container
        updateTargaDetailsDisplay(targaSelezionataGlobalmente); // Aggiorna i dettagli (marca/modello)
    }

    // Funzione per inviare una singola perizia a Google Sheets
    async function inviaPeriziaSingolaASheets(periziaDaInviare) {
        if (!GOOGLE_SHEET_WEB_APP_URL || GOOGLE_SHEET_WEB_APP_URL === 'INCOLLA_QUI_IL_TUO_URL_APPLICAZIONE_WEB') { console.error("URL Web App non configurato."); return { success: false, message: "URL Web App non configurato." }; }
        try {
            const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, { method: 'POST', mode: 'cors',  cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' },  body: JSON.stringify(periziaDaInviare)  });
            let responseData;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) { responseData = await response.json(); }
            else { const textResponse = await response.text(); try { responseData = JSON.parse(textResponse); } catch (e) { responseData = { status: "error", message: "Risposta non JSON: " + textResponse.substring(0,100)}; } }
            if (response.ok && responseData.status === "success") { return { success: true, message: responseData.message, data: responseData.data }; }
            else { return { success: false, message: responseData.message || `Errore server (HTTP ${response.status})` }; }
        } catch (error) { return { success: false, message: "Errore di rete: " + error.message }; }
    }

    // Funzione per recuperare l'ultima perizia da Google Sheets per una targa
    async function fetchLatestPeriziaFromSheets(targa) {
        if (!GOOGLE_SHEET_WEB_APP_URL) { console.warn("URL Web App non configurato per fetch."); return null; }
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targa.toUpperCase()}`)) { console.log(`Fetch per ${targa} saltato, marcata per cancellazione.`); return null; } // Non fare fetch se marcata per cancellazione
        const fetchUrl = `${GOOGLE_SHEET_WEB_APP_URL}?action=getPerizia&targa=${encodeURIComponent(targa.toUpperCase())}&nocache=${new Date().getTime()}`;
        try {
            const response = await fetch(fetchUrl, { method: 'GET', mode: 'cors' });
            if (!response.ok) { console.warn(`Errore HTTP ${response.status} fetch perizia ${targa}.`); return null; }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const result = await response.json();
                if (result.status === "success" && result.data) { return result.data; } // Dati perizia trovati
                else if (result.status === "notfound") { return null; } // Perizia non trovata su Sheets
                else { console.warn(`Risposta Sheets non valida per ${targa}: ${result.message}`); return null; }
            } else { console.warn(`Risposta Sheets non JSON per ${targa}.`); return null; }
        } catch (error) { console.error(`Errore rete fetch perizia ${targa}:`, error); return null; }
    }

    // Compila una sezione con valori positivi o di default
    function fillSectionPositiveOrDefaults(sectionId) { const section = document.getElementById(sectionId); if (!section) return; if (sectionId === 'remarketingSection') { if (tipoTrazioneSelect) tipoTrazioneSelect.value = 'endotermico'; document.getElementById('foto_angolari').checked = true; document.getElementById('foto_vano_carico').checked = true; document.getElementById('tipo_equipaggiamento').value = 'kit_gonfia_ripara'; document.getElementById('equipaggiamento_presenza').value = 'presente'; document.getElementById('foto_interni_pannelli').checked = true; document.getElementById('foto_cruscotto').checked = true; document.getElementById('stato_chilometri').value = 'rilevabili'; document.getElementById('stato_cdc').value = 'originale'; document.getElementById('foto_vano_motore').checked = true; document.getElementById('foto_cofano_tetto').checked = true; document.getElementById('chiave_telecomando').value = 'presente'; document.getElementById('seconda_chiave').value = 'presente'; handleTrazioneChange();  if (tipoTrazioneSelect && tipoTrazioneSelect.value === 'elettrico') { if (cavoRapidaSelect) cavoRapidaSelect.value = 'presente'; if (cavoDomesticaSelect) cavoDomesticaSelect.value = 'presente'; } else {  if (cavoRapidaSelect) cavoRapidaSelect.value = 'non_applicabile';  if (cavoDomesticaSelect) cavoDomesticaSelect.value = 'non_applicabile'; } } else if (sectionId === 'pneumaticiSection') { document.getElementById('pneumatico_as').value = 'conforme'; document.getElementById('pneumatico_ad').value = 'conforme'; document.getElementById('pneumatico_pd').value = 'conforme'; document.getElementById('pneumatico_ps').value = 'conforme'; } else if (sectionId === 'danniVerificheSection') { document.getElementById('motore_accende').value = 'ok'; document.getElementById('batteria_stato').value = 'ok'; document.getElementById('foto_danni_generiche').checked = true;  document.getElementById('note_danni_verifiche').value = 'Nessuna anomalia da segnalare.'; } updateNavButtonColors(); if (typeof initSequentialAnimation === 'function') { section.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me')); initSequentialAnimation(); }  section.querySelectorAll('input, select, textarea').forEach(el => { const event = new Event('change', { bubbles: true }); el.dispatchEvent(event); }); }
    // Gestisce il cambio di tipo trazione (per veicoli elettrici)
    function handleTrazioneChange() { if (!tipoTrazioneSelect || !cavoRapidaSelect || !cavoDomesticaSelect) return; const selectedTrazione = tipoTrazioneSelect.value; const isElectric = selectedTrazione === 'elettrico'; cavoRapidaSelect.disabled = !isElectric; cavoDomesticaSelect.disabled = !isElectric; if (!isElectric) { cavoRapidaSelect.value = "non_applicabile";  cavoDomesticaSelect.value = "non_applicabile"; } else { if (cavoRapidaSelect.value === "" || cavoRapidaSelect.value === "non_applicabile") cavoRapidaSelect.value = ""; if (cavoDomesticaSelect.value === "" || cavoDomesticaSelect.value === "non_applicabile") cavoDomesticaSelect.value = ""; } updateNavButtonColors();  }
    // Salva la posizione per una targa in localStorage
    function savePosizioneForTarga(targa, posizione) { if (!targa) return; try { localStorage.setItem(`${APP_PREFIX}posizione_${targa.toUpperCase()}`, posizione); } catch (e) { console.error("Errore salvataggio posizione in LS:", e); } }
    // Carica la posizione per una targa da localStorage
    function loadPosizioneForTarga(targa) { if (!targa) return ""; try { return localStorage.getItem(`${APP_PREFIX}posizione_${targa.toUpperCase()}`) || ""; } catch (e) { console.error("Errore caricamento posizione da LS:", e); return ""; } }
    // Salva lo stato di urgenza per una targa in localStorage
    function saveUrgentStatusForTarga(targa, isUrgent) {  if (!targa) return; try { localStorage.setItem(`${APP_PREFIX}urgent_${targa.toUpperCase()}`, JSON.stringify(isUrgent)); } catch (e) { console.error("Errore salvataggio urgenza in LS:", e); } }
    // Carica lo stato di urgenza per una targa da localStorage
    function loadUrgentStatusForTarga(targa) { if (!targa) return false; try { const status = localStorage.getItem(`${APP_PREFIX}urgent_${targa.toUpperCase()}`); return status ? JSON.parse(status) : false; } catch (e) { console.error("Errore caricamento urgenza da LS:", e); return false; } }
    // Resetta i campi del form della checklist
    function resetChecklistForm() { const els = document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea'); els.forEach(el => { if (el.type === 'checkbox') el.checked = false; else if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; }); if (tipoTrazioneSelect) {  handleTrazioneChange(); } }
    // Salva i progressi della perizia per una targa in localStorage
    function saveProgress(targa) { if(!targa){console.warn("Salvataggio progressi: targa non fornita."); return false;} const data = {}; document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => { if (el.id) { if (el.type === 'checkbox') data[el.id] = el.checked; else data[el.id] = el.value; } }); data.timestamp = new Date().toISOString();  try { localStorage.setItem(`${APP_PREFIX}data_${targa.toUpperCase()}`, JSON.stringify(data)); updateNavButtonColors(); return true; } catch(e) { alert("Salvataggio locale fallito. Spazio esaurito?"); console.error("Errore salvataggio progressi in LS:", e); return false; } }
    // Carica i progressi della perizia per una targa da localStorage
    function loadProgress(targa) { if(!targa) { console.warn("Caricamento progressi: targa non fornita."); return; } const targaUpper = targa.toUpperCase(); try { const json = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`); if (json) { const data = JSON.parse(json); document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => { if (el.id && data.hasOwnProperty(el.id)) { if (el.type === 'checkbox') el.checked = data[el.id]; else el.value = data[el.id]; } else if (el.id) {  if (el.type === 'checkbox') el.checked = false; else if (el.tagName === 'SELECT') el.selectedIndex = 0; /* Non resettare textarea a vuoto se non presente nei dati, potrebbe avere un valore di default */ } }); } else { resetChecklistForm();  } if (tipoTrazioneSelect) {   handleTrazioneChange(); } updateNavButtonColors();  } catch(e) { console.error(`Errore caricamento progressi per ${targaUpper}:`, e); resetChecklistForm();  updateNavButtonColors(); } }
    // Ottiene le targhe completate da localStorage
    function getCompletedTarghe() { try{const json=localStorage.getItem(`${APP_PREFIX}completedTarghe`);return json?JSON.parse(json):{};}catch(e){console.error("Errore getCompletedTarghe:",e);return{};}}
    // Verifica se una targa è completata
    function isTargaCompleted(targa) { if(!targa) return false; const completed = getCompletedTarghe(); return !!(completed[targa.toUpperCase()]); }
    // Marca una targa come completata
    function markTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe();completed[targa.toUpperCase()]=true;localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));}catch(e){console.error("Errore LS MarkTargaAsCompleted:",e);}}
    // Rimuove la marcatura di completamento per una targa
    function unmarkTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe(); if(completed[targa.toUpperCase()]){ delete completed[targa.toUpperCase()]; localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));}}catch(e){console.error("Errore LS UnmarkTargaAsCompleted:",e);}}

    // Cancella i dati locali per una specifica targa (progressi, foto, etc.)
    function clearLocalDataForTarga(targaUpper) {
        if (!targaUpper) return;
        try {
            localStorage.removeItem(`${APP_PREFIX}data_${targaUpper}`);
            unmarkTargaAsCompleted(targaUpper); // Rimuovi anche lo stato di completamento
            localStorage.removeItem(`${APP_PREFIX}posizione_${targaUpper}`);
            localStorage.removeItem(`${APP_PREFIX}urgent_${targaUpper}`);
            // Resetta i contatori delle foto per questa targa
            const sectionPhotoCounters = [`${APP_PREFIX}photoCount_${targaUpper}_remarketing`, `${APP_PREFIX}photoCount_${targaUpper}_pneumatici`, `${APP_PREFIX}photoCount_${targaUpper}_danni`];
            sectionPhotoCounters.forEach(counterKey => localStorage.removeItem(counterKey));
            // Cancella le foto da IndexedDB per questa targa
            getPhotosByTargaAndSezioneFromDB(targaUpper, null) // null per sectionKeyFilter per prendere tutte le sezioni
                .then(photos => {
                    const deletePromises = photos.map(photo => deletePhotoFromDB(photo.timestamp));
                    return Promise.all(deletePromises);
                })
                .then(() => {
                    console.log(`Foto DB per ${targaUpper} cancellate.`);
                    // Se la galleria è visibile e mostra questa targa (o tutte), aggiornala
                    if (galleryPageSection.style.display === 'block' && (currentGalleryTargaFilter === targaUpper || !currentGalleryTargaFilter)) {
                         populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
                    }
                })
                .catch(err => console.error(`Errore cancellazione foto DB per ${targaUpper}:`, err));
        } catch (e) { alert(`Errore cancellazione dati locali per ${targaUpper}.`); console.error("Errore clearLocalDataForTarga:", e); }
    }

    // Genera e scarica uno screenshot della sezione riepilogo
    function generateAndDownloadScreenshot() { return new Promise((resolve, reject) => { const riepilogoSection = document.getElementById('riepilogoSection'); if (!riepilogoSection) { alert("Errore: Sezione Riepilogo non trovata."); return reject("Sezione riepilogo non trovata"); } if (typeof html2canvas === 'undefined') { alert("Errore: Libreria html2canvas non caricata."); return reject("html2canvas non caricata"); } setTimeout(() => { riepilogoSection.scrollTop = 0;  html2canvas(riepilogoSection, { scale: 2, useCORS: true, logging: false, scrollY: -window.scrollY, windowHeight: riepilogoSection.scrollHeight }) .then(canvas => { const link = document.createElement('a'); let targaSanitized = 'sconosciuta'; let piazzaleSanitized = 'piazzale_sconosciuto'; if (targaSelezionataGlobalmente) { targaSanitized = targaSelezionataGlobalmente.replace(/[^a-zA-Z0-9.-]/g, '_'); const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente); if (veicoloAttuale && veicoloAttuale.piazzale && veicoloAttuale.piazzale.trim() !== "") { piazzaleSanitized = veicoloAttuale.piazzale.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_'); if (!piazzaleSanitized) piazzaleSanitized = 'N_D'; } else { piazzaleSanitized = 'N_D'; } } link.download = `perizia_${targaSanitized}_${piazzaleSanitized}.png`; link.href = canvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); document.body.removeChild(link); resolve(); }) .catch(error => { alert("Errore generazione screenshot."); console.error("Errore html2canvas:", error); reject(error); }); }, 100);  }); }

    // Scarica le foto di una targa come file ZIP
    async function downloadPhotosAsZip(targa) {
        if (!targa) { console.warn("Download ZIP: Targa non fornita."); return; }
        if (typeof JSZip === 'undefined') { alert("Errore: Libreria JSZip non caricata."); return; }
        const originalButtonText = saveAndReturnBtn.textContent;
        saveAndReturnBtn.textContent = 'Creazione ZIP...';
        saveAndReturnBtn.disabled = true;
        try {
            const photos = await getPhotosByTargaAndSezioneFromDB(targa, null); // null per tutte le sezioni
            if (!photos || photos.length === 0) {
                alert(`Nessuna foto per ${targa} da includere nello ZIP.`);
                saveAndReturnBtn.textContent = originalButtonText;
                saveAndReturnBtn.disabled = false;
                return;
            }
            const zip = new JSZip();
            photos.forEach(photoData => {
                if (photoData.blobData instanceof Blob && photoData.name) {
                    zip.file(photoData.name, photoData.blobData);
                }
            });
            const zipBlob = await zip.generateAsync({type:"blob", compression: "DEFLATE"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            const zipFileName = `${targa.toUpperCase().replace(/[^A-Z0-9]/g, '_')}_FOTO.zip`; // Nome file più descrittivo
            link.download = zipFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href); // Libera la memoria
            alert(`File ZIP "${zipFileName}" per ${targa} scaricato.`);
        } catch (error) { alert("Errore durante la creazione del file ZIP."); console.error("Errore downloadPhotosAsZip:", error);
        } finally {
            saveAndReturnBtn.textContent = originalButtonText;
            saveAndReturnBtn.disabled = false;
        }
    }

    // Gestisce il salvataggio della perizia e il ritorno alla lista principale
    async function handleSavePeriziaAndReturn() {
        if (!targaSelezionataGlobalmente) { alert("Nessuna targa attiva. Impossibile salvare."); return; }
        const originalButtonText = saveAndReturnBtn.textContent;
        saveAndReturnBtn.textContent = 'Salvataggio...'; saveAndReturnBtn.disabled = true;
        if (!saveProgress(targaSelezionataGlobalmente)) { // Salva i dati attuali
            alert("Salvataggio dati nel browser fallito.");
            saveAndReturnBtn.textContent = originalButtonText; saveAndReturnBtn.disabled = false; return;
        }
        if (document.getElementById('riepilogoSection').classList.contains('active')) { generateSummary(); } // Aggiorna il riepilogo
        try {
            await generateAndDownloadScreenshot(); // Prova a generare lo screenshot
        } catch (e) { console.warn("Generazione screenshot fallita, ma i dati sono stati salvati localmente.", e); }
        // await downloadPhotosAsZip(targaSelezionataGlobalmente); // Considera se scaricare anche ZIP foto qui
        markTargaAsCompleted(targaSelezionataGlobalmente); updateNavButtonColors();
        if (saveAndReturnBtn.textContent !== originalButtonText) { // Ripristina il testo del bottone
             saveAndReturnBtn.textContent = originalButtonText; saveAndReturnBtn.disabled = false;
        }
        showView('landing'); // Torna alla lista delle targhe
    }

    // Gestisce il salvataggio e il passaggio alla sezione successiva
    function handleSaveAndNext() { if(!targaSelezionataGlobalmente){console.warn("Salva e Prosegui: Nessuna targa selezionata.");return;} if(saveProgress(targaSelezionataGlobalmente)){const oT=this.textContent;this.textContent='Salvato!';this.disabled=true;setTimeout(()=>{this.textContent=oT;this.disabled=false;},1500);}else return; let curIdx=-1; navButtons.forEach((nb,i)=>{if(nb.classList.contains('active'))curIdx=i;}); if(curIdx!==-1&&curIdx<navButtons.length-1){const nextNB=navButtons[curIdx+1];if(nextNB)showSection(nextNB.dataset.target);}}
    // Verifica se un input ha il valore di default
    function isInputDefault(inputElement) { if (!inputElement) return true; if (inputElement.type === 'checkbox') return !inputElement.checked; if (inputElement.tagName === 'SELECT') return inputElement.value === "" || inputElement.selectedIndex === 0; if (inputElement.type === 'text' || inputElement.type === 'url' || inputElement.tagName === 'TEXTAREA') return inputElement.value.trim() === ""; return true; }
    // Ottiene gli input di una sezione
    function getSectionInputs(sectionElementId) { const sectionDiv = document.getElementById(sectionElementId); if (!sectionDiv) return []; return Array.from(sectionDiv.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled)')); }
    // Determina lo stato di una sezione (completata, parziale, non toccata)
    function getSectionStatus(sectionElementId, targaData) { const inputs = getSectionInputs(sectionElementId); if (inputs.length === 0) return 'completed';  let allDefaultOrNA = true;  let allNonDefaultAndApplicable = true;  let hasAtLeastOneNonDefaultAndApplicable = false; inputs.forEach(input => { let isEffectivelyDefault = false; const savedValue = targaData && targaData.hasOwnProperty(input.id) ? targaData[input.id] : undefined; let currentValue = savedValue; if (savedValue === undefined) {  if (input.type === 'checkbox') currentValue = input.checked; else currentValue = input.value; } if (input.type === 'checkbox') { isEffectivelyDefault = !currentValue; } else if (input.tagName === 'SELECT') { isEffectivelyDefault = (currentValue === "" || (input.options.length > 0 && currentValue === input.options[0].value)); if ((input.id === 'cavo_ricarica_rapida' || input.id === 'cavo_ricarica_domestica') && currentValue === 'non_applicabile') { isEffectivelyDefault = true; } } else {  isEffectivelyDefault = (currentValue === ""); } if (!isEffectivelyDefault) { allDefaultOrNA = false; hasAtLeastOneNonDefaultAndApplicable = true; } else {  allNonDefaultAndApplicable = false; } }); if (allDefaultOrNA) return 'untouched'; if (allNonDefaultAndApplicable) return 'completed'; if (hasAtLeastOneNonDefaultAndApplicable) return 'partial';  return 'untouched';  }
    // Aggiorna i colori dei pulsanti di navigazione in base allo stato delle sezioni
    function updateNavButtonColors() { if (!targaSelezionataGlobalmente && checklistContainer.style.display === 'none' && galleryPageSection.style.display === 'none') { navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched', 'active'); btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; }); return; } const targaDataJSON = localStorage.getItem(`${APP_PREFIX}data_${(targaSelezionataGlobalmente || currentGalleryTargaFilter || "").toUpperCase()}`); const targaData = targaDataJSON ? JSON.parse(targaDataJSON) : null; navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched'); if (!btn.classList.contains('active')) { btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; } if (btn.classList.contains('active')) { return; } const targetSection = btn.dataset.target; let status = 'untouched'; const activeTargaForStatus = targaSelezionataGlobalmente || currentGalleryTargaFilter; if (targetSection === 'riepilogo') { if (isTargaCompleted(activeTargaForStatus)) { status = 'completed'; } else { let hasAnyDataForSummary = false; if (targaData && Object.keys(targaData).length > 0 && Object.keys(targaData).some(k => k !== 'timestamp')) { hasAnyDataForSummary = true; } else { ['remarketingSection', 'pneumaticiSection', 'danniVerificheSection'].forEach(secId => { if (getSectionStatus(secId, targaData) !== 'untouched') { hasAnyDataForSummary = true; } }); } status = hasAnyDataForSummary ? 'partial' : 'untouched'; } } else if (targetSection) { status = getSectionStatus(targetSection + 'Section', targaData); } if (status === 'completed') btn.classList.add('nav-btn-completed'); else if (status === 'partial') btn.classList.add('nav-btn-partial'); else btn.classList.add('nav-btn-untouched'); }); }

    // Mostra una vista specifica (landing, checklist, history, gallery, camera)
    function showView(viewName) {
        // Nascondi tutte le sezioni principali
        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        if(cameraPageSection) cameraPageSection.style.display = 'none';
        if(galleryPageSection) galleryPageSection.style.display = 'none';
        if(imageLightbox) imageLightbox.style.display = 'none'; // Chiudi lightbox se aperta

        // Visibilità di default per gli elementi dell'header superiore e della barra inferiore
        if(pageHeaderContainer) pageHeaderContainer.style.display = 'block';
        if(utilityNavButtons) utilityNavButtons.style.display = 'flex';
        if(mainTitleGlobal) mainTitleGlobal.style.display = 'block';
        if(navButtonsContainer) navButtonsContainer.style.display = 'flex';
        if(bottomNavCircles) bottomNavCircles.style.display = 'flex'; // Barra inferiore visibile di default

        let bodyPaddingTopValue = '0px';
        let bodyPaddingBottomValue = '0px';

        if (viewName === 'camera') {
            // In modalità fotocamera, nascondi l'header superiore
            if (pageHeaderContainer) pageHeaderContainer.style.display = 'none';
            // La barra inferiore (bottomNavCircles) rimane visibile come richiesto
            // showCameraPage() gestirà l'adattamento dell'altezza della camera
        }
        
        // Calcola il padding del body in base agli header visibili
        if (pageHeaderContainer && getComputedStyle(pageHeaderContainer).display !== 'none' && pageHeaderContainer.classList.contains('fixed-header')) {
            let hasVisibleTopContent = [utilityNavButtons, mainTitleGlobal, navButtonsContainer, targaDropdownContainer]
                                      .some(el => el && getComputedStyle(el).display !== 'none');
            if(hasVisibleTopContent) {
                bodyPaddingTopValue = `${pageHeaderContainer.offsetHeight + 10}px`;
            }
        }
        if (bottomNavCircles && getComputedStyle(bottomNavCircles).display !== 'none') {
            bodyPaddingBottomValue = `${bottomNavCircles.offsetHeight + 10}px`;
        }
        document.body.style.paddingTop = bodyPaddingTopValue;
        document.body.style.paddingBottom = bodyPaddingBottomValue;


        // Gestione specifica della vista
        if (viewName === 'landing') {
            landingPageSection.style.display = 'block';
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            if (mainTitleGlobal) mainTitleGlobal.innerHTML = "Elenco Veicoli";
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (listaTargheCompleta.length > 0 &&
                (!document.getElementById('preloader') || document.getElementById('preloader').classList.contains('hidden')) &&
                typeof popolaTargheFiltrate === 'function') {
                popolaTargheFiltrate(); // Ricarica lista targhe
            }
            if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        } else if (viewName === 'checklist') {
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            if (!targaSelezionataGlobalmente) { showView('landing'); return; } // Se nessuna targa, torna a landing
            if (localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente.toUpperCase()}`)) {
                showView('landing'); alert(`Perizia per ${targaSelezionataGlobalmente} cancellata.`); return;
            }
            checklistContainer.style.display = 'block';
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'none'; // Nascondi titolo globale
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex'; // Mostra dropdown targa
            populateTargaSwitcherDropdown(); updateTargaDetailsDisplay(targaSelezionataGlobalmente);
            if (tipoTrazioneSelect) handleTrazioneChange(); // Gestisci campi EV
            const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
            if (downloadZipBtn && activeSectionElement && activeSectionElement.id === 'riepilogoSection' && targaSelezionataGlobalmente) {
                downloadZipBtn.href = `https://192.168.1.154:8080/${targaSelezionataGlobalmente.toUpperCase()}.zip`;
                downloadZipBtn.style.display = 'inline-flex';
            } else if (downloadZipBtn) {
                downloadZipBtn.style.display = 'none';
            }
        } else if (viewName === 'history') {
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            historyPageSection.style.display = 'block';
            if (mainTitleGlobal) mainTitleGlobal.innerHTML = "Cronistoria Salvataggi";
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            populateSavedTargasList();
            if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        } else if (viewName === 'gallery') {
            // La visualizzazione effettiva di galleryPageSection è gestita da showGalleryPage()
            // showView('gallery') prepara solo il terreno (padding, header, etc.)
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            // galleryPageSection.style.display = 'block'; // Verrà fatto da showGalleryPage
            if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        } else if (viewName === 'camera') {
            showCameraPage(); // Chiama la funzione specifica per la fotocamera
        } else { // Vista sconosciuta o di default
             if (pageHeaderContainer) pageHeaderContainer.classList.remove('fixed-header');
             if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        }

        updateNavButtonColors(); // Aggiorna colori pulsanti navigazione
        window.scrollTo(0, 0); // Scrolla in cima alla pagina
    }

    // Mostra la pagina della fotocamera
    async function showCameraPage() {
        // Determina l'ultima vista e sezione prima di entrare in modalità fotocamera
        if (galleryPageSection.style.display === 'block') {
            lastViewBeforeCamera = 'gallery';
            lastSectionBeforeCamera = currentGallerySectionFilter; // Salva il filtro sezione della galleria
        } else if (checklistContainer.style.display === 'block') {
            lastViewBeforeCamera = 'checklist';
            const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
            lastSectionBeforeCamera = activeSectionElement ? activeSectionElement.id.replace('Section', '') : null;
        } else if (historyPageSection.style.display === 'block') {
            lastViewBeforeCamera = 'history';
            lastSectionBeforeCamera = null;
        } else { // Default a landing se nessuna altra sezione attiva era rilevante
            lastViewBeforeCamera = 'landing';
            lastSectionBeforeCamera = null;
        }

        // Assicurati che le altre sezioni principali siano nascoste (showView lo fa già in parte)
        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        galleryPageSection.style.display = 'none';

        // Configura la visualizzazione della fotocamera
        cameraStreamElement.style.display = 'block';
        freezeFrameDisplayElement.style.display = 'none';
        cameraPageSection.style.display = 'flex'; // Rendi visibile il contenitore della fotocamera

        // L'header superiore è già stato nascosto da showView('camera')
        // La barra inferiore (bottomNavCircles) è già stata resa visibile da showView('camera')

        let topBarHeight = 0; // pageHeaderContainer è display: none
        let bottomNavHeight = 0;
        if (bottomNavCircles && getComputedStyle(bottomNavCircles).display !== 'none') {
            bottomNavHeight = bottomNavCircles.offsetHeight;
        }

        // Adatta l'altezza della cameraPageSection per fare spazio a bottomNavCircles
        // Il padding del body è già gestito da showView('camera')
        cameraPageSection.style.paddingTop = `${topBarHeight}px`; // Sarà '0px'
        cameraPageSection.style.height = `calc(100vh - ${topBarHeight}px - ${bottomNavHeight}px)`;


        // Avvia lo stream della fotocamera
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            const constraints = {
                video: {
                    facingMode: "environment", // Preferisci fotocamera posteriore
                    width: { ideal: 1920, min: 1280 }, // Risoluzione preferita
                    height: { ideal: 1080, min: 720 },
                    advanced: [{ focusMode: "continuous" }] // Prova autofocus continuo
                },
                audio: false // No audio
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraStreamElement.srcObject = stream;
                currentCameraStream = stream;
                // Prova ad applicare focusMode dopo aver ottenuto lo stream
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack && typeof videoTrack.applyConstraints === 'function') {
                    try { await videoTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); }
                    catch (e) { try { await videoTrack.applyConstraints({ advanced: [{ focusMode: 'auto' }] }); } catch (e2) { console.warn("Focus automatico fallito:", e2); } }
                }
            } catch (err) {
                console.error("Errore getUserMedia principale:", err);
                // Fallback a constraints più semplici se il primo tentativo fallisce
                try {
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                    cameraStreamElement.srcObject = fallbackStream;
                    currentCameraStream = fallbackStream;
                } catch (fallbackErr) {
                    console.error("Errore getUserMedia di fallback:", fallbackErr);
                    alert("Impossibile accedere alla fotocamera: " + fallbackErr.message);
                    returnFromCamera(); // Esegui la pulizia e torna indietro
                    return; // Esci dalla funzione per evitare ulteriori errori
                }
            }
        } else {
            alert("Il browser non supporta l'accesso alla fotocamera (navigator.mediaDevices non disponibile).");
            returnFromCamera(); // Esegui la pulizia e torna indietro
            return; // Esci dalla funzione
        }
        window.scrollTo(0, 0); // Scrolla in cima
    }

    // Gestisce il ritorno dalla pagina della fotocamera
    function returnFromCamera() {
        // Ferma lo stream della fotocamera
        if (currentCameraStream) {
            currentCameraStream.getTracks().forEach(track => track.stop());
            currentCameraStream = null;
            if (cameraStreamElement) cameraStreamElement.srcObject = null;
        }

        // Nascondi la sezione della fotocamera e resetta gli elementi visivi
        if (cameraPageSection) cameraPageSection.style.display = 'none';
        if (cameraStreamElement) cameraStreamElement.style.display = 'block'; // Pronto per la prossima volta
        if (freezeFrameDisplayElement) freezeFrameDisplayElement.style.display = 'none';

        // Resetta gli stili specifici della cameraPageSection
        if (cameraPageSection) {
            cameraPageSection.style.paddingTop = '';
            cameraPageSection.style.height = ''; // Torna al valore CSS di default
        }

        // Ripristina la vista precedente (quella da cui si è entrati in camera)
        // La logica per andare in una *nuova* vista (es. galleria) è gestita dai pulsanti di navigazione
        if (lastViewBeforeCamera === 'gallery') {
            // Ripristina la galleria com'era prima di aprire la camera
            showGalleryPage(currentGalleryTargaFilter, lastSectionBeforeCamera || 'riepilogo');
        } else if (lastViewBeforeCamera === 'checklist' && targaSelezionataGlobalmente && lastSectionBeforeCamera) {
            showView('checklist'); // Mostra il contenitore della checklist
            showSection(lastSectionBeforeCamera); // Attiva la sezione specifica
        } else if (lastViewBeforeCamera === 'history') {
            showView('history');
        } else { // Default a 'landing'
            showView('landing');
        }
    }

    // Ottiene il nome della sezione per il filename della foto e per il salvataggio DB
    function getFilenameSectionName() {
        let sectionNameForFile = "generale"; // Default

        // Priorità al contesto da cui è stata aperta la fotocamera
        if (lastViewBeforeCamera === 'checklist' && lastSectionBeforeCamera && targaSelezionataGlobalmente) {
            // Fotocamera aperta da una sezione specifica della checklist
            let tempSectionKey = lastSectionBeforeCamera.toLowerCase();
            if (['remarketing', 'pneumatici'].includes(tempSectionKey)) {
                sectionNameForFile = tempSectionKey;
            } else if (tempSectionKey === 'danniverifiche') {
                sectionNameForFile = 'danni';
            } else if (tempSectionKey === 'riepilogo') {
                // Se la fotocamera è stata aperta dal riepilogo di una targa, la foto è "generale" per quella targa
                sectionNameForFile = 'generale_riepilogo'; // O semplicemente 'generale' se preferito
            }
            // Altrimenti (se lastSectionBeforeCamera non è uno di questi), rimane 'generale'
        } else if (lastViewBeforeCamera === 'gallery' && currentGalleryTargaFilter && lastSectionBeforeCamera) {
            // Fotocamera aperta da una vista galleria filtrata
            let tempSectionKey = lastSectionBeforeCamera.toLowerCase();
             if (['remarketing', 'pneumatici'].includes(tempSectionKey)) {
                sectionNameForFile = tempSectionKey;
            } else if (tempSectionKey === 'danniverifiche') {
                sectionNameForFile = 'danni';
            } else if (tempSectionKey === 'riepilogo') {
                // Se la galleria mostrava 'riepilogo' (tutte le foto per una targa), le nuove foto sono 'generali' per quella targa
                sectionNameForFile = 'generale_galleria'; // O 'generale'
            }
            // Altrimenti, rimane 'generale'
        }
        // Se nessun contesto specifico (es. fotocamera aperta da landing page, o galleria generale senza filtri targa/sezione),
        // il nome della sezione rimarrà "generale".
        return sectionNameForFile;
    }

    // Ottiene il numero progressivo per la foto
    function getNextPhotoNumber(targa, sectionName) {
        const sectionNormalized = sectionName.toLowerCase();
        let start, end, counterKey;

        // Definisci i range di numerazione per sezione
        if (sectionNormalized === 'remarketing') {
            start = 1; end = 99; counterKey = `${APP_PREFIX}photoCount_${targa}_remarketing`;
        } else if (sectionNormalized === 'pneumatici') {
            start = 101; end = 150; counterKey = `${APP_PREFIX}photoCount_${targa}_pneumatici`;
        } else if (sectionNormalized === 'danni' || sectionNormalized === 'danniverifiche') { // 'danniverifiche' viene mappato a 'danni'
            start = 200; end = 999; counterKey = `${APP_PREFIX}photoCount_${targa}_danni`;
        } else { // Per sezioni generiche o non mappate (es. 'generale_riepilogo', 'generale_galleria')
            // Usa un contatore generico per la targa e la sezione specifica
            // Questo permette flessibilità se si aggiungono nuove categorie di foto non standard
            // Potrebbe iniziare da 1 per ogni nuova combinazione targa/sezione generica
            const genericCounterKey = `${APP_PREFIX}photoCount_${targa}_${sectionNormalized}`;
            let photoNumber = parseInt(localStorage.getItem(genericCounterKey) || '0') + 1;
            localStorage.setItem(genericCounterKey, photoNumber.toString());
            return photoNumber; // Ritorna il numero semplice, la formattazione avverrà dopo
        }

        let currentNumber = parseInt(localStorage.getItem(counterKey) || (start - 1).toString());
        currentNumber++;
        if (currentNumber < start) currentNumber = start; // Assicura che sia almeno il numero di inizio del range
        // Non c'è un vero limite superiore rigido qui, ma il range aiuta a organizzare
        if (currentNumber > end) {
            // console.warn(`Attenzione: Limite teorico foto per "${sectionName}" (${start}-${end}) superato. N.${currentNumber}.`);
        }
        localStorage.setItem(counterKey, currentNumber.toString());
        return currentNumber;
    }

    // Cattura una foto dalla stream della fotocamera
    function capturePhoto() {
        if (captureBtn.disabled) return; // Evita doppi click
        if (currentCameraStream && cameraStreamElement.readyState >= cameraStreamElement.HAVE_CURRENT_DATA && cameraStreamElement.videoWidth > 0) {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStreamElement.videoWidth;
            canvas.height = cameraStreamElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraStreamElement, 0, 0, canvas.width, canvas.height);

            // Mostra l'anteprima
            freezeFrameDisplayElement.src = canvas.toDataURL('image/jpeg', 0.7); // Qualità JPEG 70%
            freezeFrameDisplayElement.style.display = 'block';
            cameraStreamElement.style.display = 'none'; // Nascondi lo stream video
            captureBtn.disabled = true; // Disabilita il pulsante durante l'elaborazione

            // Determina targa e sezione per il nome file e DB
            const targaForFile = (targaSelezionataGlobalmente || currentGalleryTargaFilter || 'SCONOSCIUTA').toUpperCase().replace(/[^A-Z0-9]/g, '');
            const sectionNameForFile = getFilenameSectionName(); // Ottiene la sezione corretta
            const photoNumber = getNextPhotoNumber(targaForFile, sectionNameForFile);

            if (photoNumber === null) { // Controllo teorico, getNextPhotoNumber dovrebbe sempre restituire un numero
                 freezeFrameDisplayElement.style.display = 'none'; freezeFrameDisplayElement.src = '#';
                 cameraStreamElement.style.display = 'block'; captureBtn.disabled = false; return;
            }

            const formattedPhotoNumber = String(photoNumber).padStart(3, '0'); // Es. 001, 101, 200
            const filename = `${formattedPhotoNumber} ${sectionNameForFile} ${targaForFile}.jpeg`;

            canvas.toBlob(async function(blob) {
                if (!blob) {
                    alert("Errore durante la conversione della foto in Blob.");
                    freezeFrameDisplayElement.style.display = 'none'; freezeFrameDisplayElement.src = '#';
                    cameraStreamElement.style.display = 'block'; captureBtn.disabled = false; return;
                }

                const photoObjectToSave = {
                    name: filename,
                    blobData: blob,
                    timestamp: new Date().toISOString(),
                    targa: targaForFile, // Targa corretta
                    sezione: sectionNameForFile // Sezione corretta
                };

                try {
                    await savePhotoToDB(photoObjectToSave); // Salva in IndexedDB
                    
                    // Simula il download (può essere rimosso se non necessario)
                    // const link = document.createElement('a');
                    // link.href = URL.createObjectURL(blob); link.download = filename;
                    // document.body.appendChild(link); link.click(); document.body.removeChild(link);
                    // URL.revokeObjectURL(link.href); // Libera memoria

                } catch (error) { alert("Errore durante il salvataggio della foto nel database locale."); console.error("Errore savePhotoToDB:", error);
                } finally {
                    // Ripristina la vista della fotocamera dopo un breve ritardo
                    setTimeout(() => {
                        freezeFrameDisplayElement.style.display = 'none'; freezeFrameDisplayElement.src = '#';
                        cameraStreamElement.style.display = 'block'; captureBtn.disabled = false;
                    }, 500); // Ritardo per permettere all'utente di vedere l'anteprima
                }
            }, 'image/jpeg', 0.7);
        } else {
            console.warn("Stream fotocamera non pronto o dimensioni video non valide.");
        }
    }

    // Mostra la pagina della galleria, filtrata opzionalmente per targa e sezione
    async function showGalleryPage(targaToFilter = null, sectionToFilter = null) {
        // Salva lo stato attuale prima di cambiare vista (se non si sta già andando in galleria)
        if (galleryPageSection.style.display !== 'block') {
            if (checklistContainer.style.display === 'block') {
                lastViewBeforeGallery = 'checklist';
                const activeSectionEl = document.querySelector('#checklistContainer .category-section.active');
                lastSectionBeforeGallery = activeSectionEl ? activeSectionEl.id.replace('Section', '') : null;
            } else if (landingPageSection.style.display === 'block') {
                lastViewBeforeGallery = 'landing'; lastSectionBeforeGallery = null;
            } else if (historyPageSection.style.display === 'block') {
                lastViewBeforeGallery = 'history'; lastSectionBeforeGallery = null;
            }
            // Non aggiornare se la camera era attiva, lastViewBeforeCamera è già impostato
        }
        
        currentGalleryTargaFilter = targaToFilter ? targaToFilter.toUpperCase() : null;
        currentGallerySectionFilter = sectionToFilter;

        showView('gallery'); // Chiama showView per gestire la transizione generale della UI

        galleryPageSection.style.display = 'block'; // Assicurati che la sezione galleria sia visibile

        const galleryTitleElement = galleryPageSection.querySelector('h2.section-title');
        let galleryTitleText = "Galleria Foto Catturate"; // Titolo di default

        if (currentGalleryTargaFilter) {
            // Se c'è un filtro targa, imposta targaSelezionataGlobalmente per coerenza UI (es. dropdown targa)
            targaSelezionataGlobalmente = currentGalleryTargaFilter; 
            if(mainTitleGlobal) mainTitleGlobal.style.display = 'none';
            if(targaDropdownContainer) targaDropdownContainer.style.display = 'flex';
            populateTargaSwitcherDropdown(); // Popola e seleziona la targa corretta nello switcher
            if(targaSwitcherDropdown.value.toUpperCase() !== currentGalleryTargaFilter) {
                targaSwitcherDropdown.value = currentGalleryTargaFilter; // Assicura selezione corretta
            }
            updateTargaDetailsDisplay(currentGalleryTargaFilter); // Mostra marca/modello
            if(navButtonsContainer) navButtonsContainer.style.display = 'flex'; // Mostra i pulsanti di navigazione sezione
            if(mainPageNavButtons) mainPageNavButtons.style.display = 'flex';
            if(utilityNavButtons) utilityNavButtons.style.display = 'flex';

            navButtons.forEach(b => b.classList.remove('active')); // Resetta stato attivo pulsanti sezione
            let sectionNameForTitle = "Tutte le foto"; // Default se nessuna sezione specifica
            if (currentGallerySectionFilter && currentGallerySectionFilter !== 'riepilogo') {
                const navButtonForSection = mainPageNavButtons.querySelector(`button[data-target="${currentGallerySectionFilter}"]`);
                if (navButtonForSection) {
                    navButtonForSection.classList.add('active'); // Attiva il pulsante della sezione
                    sectionNameForTitle = navButtonForSection.textContent.split('. ')[1] || currentGallerySectionFilter;
                } else { // Fallback se il pulsante non esiste per qualche motivo
                     sectionNameForTitle = currentGallerySectionFilter.charAt(0).toUpperCase() + currentGallerySectionFilter.slice(1);
                     if (currentGallerySectionFilter === 'danniverifiche') sectionNameForTitle = 'Danni/Verifiche';
                }
            } else { // Se la sezione è 'riepilogo' o non specificata, attiva il pulsante Riepilogo
                 const riepilogoNavButton = mainPageNavButtons.querySelector(`button[data-target="riepilogo"]`);
                 if (riepilogoNavButton) riepilogoNavButton.classList.add('active');
                 // sectionNameForTitle rimane "Tutte le foto"
            }
            galleryTitleText = `Galleria: ${currentGalleryTargaFilter} - ${sectionNameForTitle}`;
            updateNavButtonColors(); // Aggiorna i colori dei pulsanti di navigazione
        } else { // Galleria generale (senza filtro targa)
            if (mainTitleGlobal) mainTitleGlobal.innerHTML = "Galleria Foto Catturate";
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
        }
        if(galleryTitleElement) galleryTitleElement.textContent = galleryTitleText; // Imposta il titolo della galleria
        await populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter); // Carica le foto

        window.scrollTo(0,0); // Scrolla in cima
    }

    // Popola la griglia delle foto
    async function populatePhotoGrid(targaFilter, sectionKeyFilter) {
        photoGridContainer.innerHTML = ''; // Pulisci la griglia
        currentLightboxPhotoList = []; // Resetta la lista per la lightbox

        try {
            let photosToDisplay;
            let effectiveSectionKeyForDBQuery = sectionKeyFilter;
            
            // Se sectionKeyFilter è 'riepilogo', significa che vogliamo tutte le foto per la targa (o tutte in generale)
            // In getPhotosByTargaAndSezioneFromDB, se sectionKeyFilter è 'riepilogo' e targaFilter è presente,
            // sectionKeyFilter viene trattato come null per recuperare tutte le sezioni per quella targa.
            if (targaFilter) {
                if (sectionKeyFilter && sectionKeyFilter.toLowerCase() === 'danniverifiche') {
                    effectiveSectionKeyForDBQuery = 'danni'; // Mappa 'danniverifiche' a 'danni' per la query DB
                } else if (sectionKeyFilter && sectionKeyFilter.toLowerCase() === 'riepilogo'){
                    effectiveSectionKeyForDBQuery = null; // Per DB, null significa tutte le sezioni per la targa data
                }
                // Altrimenti, usa sectionKeyFilter com'è (es. 'remarketing', 'pneumatici')
                photosToDisplay = await getPhotosByTargaAndSezioneFromDB(targaFilter, effectiveSectionKeyForDBQuery);
            } else {
                // Nessun filtro targa, mostra tutte le foto (galleria generale)
                photosToDisplay = await getAllPhotosFromDB();
            }

            if (photosToDisplay.length === 0) {
                photoGridContainer.innerHTML = '<p>Nessuna foto trovata per i filtri selezionati.</p>'; return;
            }
            // Ordina le foto dalla più recente alla meno recente
            photosToDisplay.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            photosToDisplay.forEach((photoData) => {
                currentLightboxPhotoList.push(photoData.timestamp); // Aggiungi alla lista per navigazione lightbox
                const photoItemDiv = document.createElement('div');
                photoItemDiv.classList.add('photo-item');
                const img = document.createElement('img');
                let objectUrl = null;
                if (photoData.blobData instanceof Blob) {
                    objectUrl = URL.createObjectURL(photoData.blobData);
                    img.src = objectUrl;
                    // Pulisci l'object URL quando l'immagine non è più necessaria (es. quando l'elemento viene rimosso)
                    // Questo è più complesso da gestire qui, spesso si fa al unload della pagina o quando la galleria viene distrutta.
                    // Per ora, lo lasciamo, ma in un'app complessa andrebbe gestito per evitare memory leak.
                } else { img.alt = `Dati immagine non validi per ${photoData.name}`; img.src="#"; } // Fallback
                img.alt = photoData.name; img.dataset.timestamp = photoData.timestamp;
                img.addEventListener('click', function() { openImageLightbox(this.dataset.timestamp); });

                const caption = document.createElement('div');
                caption.classList.add('photo-item-caption'); caption.textContent = photoData.name;

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('photo-item-delete-btn'); deleteBtn.innerHTML = '&times;'; // Icona X
                deleteBtn.title = "Elimina foto";
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita di triggerare il click sull'immagine
                    if (objectUrl) { URL.revokeObjectURL(objectUrl); } // Revoca l'URL se l'elemento sta per essere rimosso
                    deleteCapturedPhoto(photoData.timestamp, photoData.targa, photoData.sezione);
                });

                photoItemDiv.appendChild(img); photoItemDiv.appendChild(caption);
                photoItemDiv.appendChild(deleteBtn); photoGridContainer.appendChild(photoItemDiv);
            });
        } catch (e) { photoGridContainer.innerHTML = '<p>Errore durante il caricamento delle foto.</p>'; console.error("Errore populatePhotoGrid:", e); }
    }

    // Elimina una foto catturata
    async function deleteCapturedPhoto(timestampToDelete, targa, sezione) {
        if (confirm("Sei sicuro di voler eliminare questa foto? L'azione è irreversibile.")) {
            try {
                await deletePhotoFromDB(timestampToDelete); // Elimina da IndexedDB

                // Rimuovi dalla lista della lightbox se presente
                const indexInLightboxList = currentLightboxPhotoList.indexOf(timestampToDelete);
                if (indexInLightboxList > -1) {
                    currentLightboxPhotoList.splice(indexInLightboxList, 1);
                }

                // Se era l'ultima foto di una sezione specifica per una targa, potresti voler resettare il contatore
                // Questo è opzionale e dipende da come vuoi gestire la numerazione
                if (targa && sezione) {
                    const photosRemaining = await getPhotosByTargaAndSezioneFromDB(targa, sezione);
                    if (photosRemaining.length === 0) {
                        // Resetta il contatore per quella targa/sezione
                        const sectionForCounter = sezione.toLowerCase();
                        let counterKey, startNumber;
                        if (sectionForCounter === 'remarketing') {
                            counterKey = `${APP_PREFIX}photoCount_${targa}_remarketing`; startNumber = 1;
                        } else if (sectionForCounter === 'pneumatici') {
                            counterKey = `${APP_PREFIX}photoCount_${targa}_pneumatici`; startNumber = 101;
                        } else if (sectionForCounter === 'danni' || sectionForCounter === 'danniverifiche') {
                            counterKey = `${APP_PREFIX}photoCount_${targa}_danni`; startNumber = 200;
                        } else { // Per sezioni generiche
                             counterKey = `${APP_PREFIX}photoCount_${targa}_${sectionForCounter}`; startNumber = 1;
                        }
                        if (counterKey && startNumber !== undefined) {
                            // Imposta il contatore al numero *prima* dell'inizio, così il prossimo sarà l'inizio
                            localStorage.setItem(counterKey, (startNumber - 1).toString());
                            console.log(`Contatore per ${targa}/${sezione} resettato.`);
                        }
                    }
                }
                // Ricarica la griglia delle foto per riflettere l'eliminazione
                await populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
            } catch (e) { alert("Errore durante l'eliminazione della foto."); console.error("Errore deleteCapturedPhoto:", e); }
        }
    }

    // Apre l'immagine nella lightbox
    async function openImageLightbox(timestamp) {
        try {
            const db = await openPhotoDB();
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.get(timestamp);

            request.onsuccess = (event) => {
                const photoData = event.target.result;
                if (photoData && photoData.blobData instanceof Blob) {
                    if (currentLightboxImageObjectUrl) { URL.revokeObjectURL(currentLightboxImageObjectUrl); } // Pulisci URL precedente
                    currentLightboxImageObjectUrl = URL.createObjectURL(photoData.blobData);
                    lightboxImage.src = currentLightboxImageObjectUrl;
                    currentLightboxPhotoIndex = currentLightboxPhotoList.indexOf(timestamp); // Imposta l'indice per la navigazione swipe
                    imageLightbox.style.display = 'flex'; // Mostra la lightbox
                } else { alert("Impossibile caricare l'immagine selezionata."); }
            };
            request.onerror = (event) => { alert("Errore durante il caricamento dell'immagine dalla DB."); console.error("Errore DB openImageLightbox:", event.target.error); };
        } catch (error) { alert("Errore database durante l'apertura dell'immagine."); console.error("Errore openImageLightbox:", error); }
    }

    // Chiude la lightbox dell'immagine
    function closeImageLightbox() {
        imageLightbox.style.display = 'none';
        if (currentLightboxImageObjectUrl) {
            URL.revokeObjectURL(currentLightboxImageObjectUrl); // Libera la memoria
            currentLightboxImageObjectUrl = null;
        }
        lightboxImage.src = '#'; // Resetta src
        currentLightboxPhotoIndex = -1; // Resetta indice
    }

    // Gestisce l'inizio del tocco per la navigazione swipe nella lightbox
    function handleLightboxTouchStart(event) {
        if (event.touches.length > 1) return; // Ignora multi-touch
        lightboxTouchStartX = event.changedTouches[0].screenX;
        lightboxTouchStartY = event.changedTouches[0].screenY;
    }

    // Gestisce la fine del tocco per la navigazione swipe nella lightbox
    function handleLightboxTouchEnd(event) {
        if (currentLightboxPhotoIndex === -1 || !lightboxTouchStartX || !lightboxTouchStartY) return;

        let lightboxTouchEndX = event.changedTouches[0].screenX;
        let lightboxTouchEndY = event.changedTouches[0].screenY;
        handleLightboxSwipe(lightboxTouchEndX, lightboxTouchEndY); // Chiama la funzione che gestisce lo swipe

        // Resetta le coordinate di inizio
        lightboxTouchStartX = 0;
        lightboxTouchStartY = 0;
    }

    // Logica per lo swipe nella lightbox (cambia immagine precedente/successiva)
    function handleLightboxSwipe(endX, endY) {
        const deltaX = endX - lightboxTouchStartX;
        const deltaY = endY - lightboxTouchStartY;

        // Determina se lo swipe è prevalentemente orizzontale
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
            if (Math.abs(deltaX) > swipeThreshold) { // Solo se lo swipe supera una certa soglia
                if (deltaX > 0) { // Swipe a destra (immagine precedente)
                    if (currentLightboxPhotoIndex > 0) {
                        currentLightboxPhotoIndex--;
                        openImageLightbox(currentLightboxPhotoList[currentLightboxPhotoIndex]);
                    } else {
                        showSwipeEndIndicator('left'); // Indica che si è all'inizio della lista
                    }
                } else { // Swipe a sinistra (immagine successiva)
                    if (currentLightboxPhotoIndex < currentLightboxPhotoList.length - 1) {
                        currentLightboxPhotoIndex++;
                        openImageLightbox(currentLightboxPhotoList[currentLightboxPhotoIndex]);
                    } else {
                        showSwipeEndIndicator('right'); // Indica che si è alla fine della lista
                    }
                }
            }
        } else { // Swipe verticale (potrebbe chiudere la lightbox o altro)
            if (Math.abs(deltaY) > swipeThreshold) {
                if (deltaY > 0) { // Swipe verso il basso
                     showSwipeEndIndicator('top'); // O implementa chiusura lightbox
                } else { // Swipe verso l'alto
                     showSwipeEndIndicator('bottom');
                }
            }
        }
    }
    
    // Gestione del tocco sulla griglia della galleria (per overscroll/pull-to-refresh)
    function handleGalleryGridTouchStart(event) {
        if (event.touches.length === 1) { // Solo single touch
            galleryGridTouchStartY = event.touches[0].clientY;
        }
    }

    function handleGalleryGridTouchMove(event) {
        if (event.touches.length === 1 && galleryPageSection.style.display === 'block') {
            const currentTouchY = event.touches[0].clientY;
            const deltaY = currentTouchY - galleryGridTouchStartY;
            // Verifica se la pagina è scrollata completamente in cima
            const isPageAtTop = (galleryPageSection.scrollTop || document.documentElement.scrollTop || document.body.scrollTop) === 0;

            // Se si fa swipe verso il basso, la pagina è in cima, e il contenuto non è scrollabile (o è in cima allo scroll)
            if (isPageAtTop && deltaY > 0 && galleryPageSection.scrollHeight <= galleryPageSection.clientHeight) { 
                event.preventDefault(); // Previene il pull-to-refresh del browser se l'elemento è in cima
                showSwipeEndIndicator('top');
            }
        }
    }

    // Gestisce la selezione di una targa e la sincronizzazione dei dati
    async function handleTargaSelectionAndSync(selectedTarga, targetSectionId = null) {
        const targaUpper = selectedTarga.toUpperCase();
        // Se la targa è marcata per cancellazione, non procedere con la perizia
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`)) {
            if (targheLoadingStatus && landingPageSection.style.display === 'block') {
                targheLoadingStatus.textContent = `Targa ${targaUpper} marcata per cancellazione server.`;
            }
            // Se si stava visualizzando questa targa nella checklist, torna alla landing page
            if (targaSelezionataGlobalmente === targaUpper && checklistContainer.style.display === 'block') { showView('landing'); }
            return;
        }

        // Se la targa selezionata è già quella attiva e siamo nella checklist, aggiorna solo i dettagli e la sezione se necessario
        if (targaSelezionataGlobalmente === targaUpper && checklistContainer.style.display === 'block') {
            if (targaSwitcherDropdown.value !== targaUpper) { targaSwitcherDropdown.value = targaUpper; } // Sincronizza dropdown
            updateTargaDetailsDisplay(targaUpper); // Aggiorna marca/modello
            if (targetSectionId) { // Se è specificata una sezione target
                 const currentActiveSectionEl = document.querySelector('#checklistContainer .category-section.active');
                 const currentActiveSectionId = currentActiveSectionEl ? currentActiveSectionEl.id.replace('Section', '') : null;
                 if (currentActiveSectionId !== targetSectionId) { showSection(targetSectionId); } // Cambia sezione
            }
            // Gestisci visibilità bottone ZIP per riepilogo
            if (downloadZipBtn && targetSectionId === 'riepilogo') {
                downloadZipBtn.href = `https://192.168.1.154:8080/${targaUpper.toUpperCase()}.zip`;
                downloadZipBtn.style.display = 'inline-flex';
            } else if (downloadZipBtn) {
                downloadZipBtn.style.display = 'none';
            }
            return;
        }

        targaSelezionataGlobalmente = targaUpper; // Imposta la targa attiva globalmente
        if (targheLoadingStatus && landingPageSection.style.display === 'block') {
            targheLoadingStatus.textContent = `Caricamento dati per ${targaSelezionataGlobalmente}...`;
        }

        // Logica di sincronizzazione: Sheets vs Locale
        let localData = null; let localDatiPeriziaTimestamp = null;
        const localJson = localStorage.getItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`);
        if (localJson) { try { localData = JSON.parse(localJson); localDatiPeriziaTimestamp = localData.timestamp ? new Date(localData.timestamp) : null; } catch (e) { localData = null; } }
        
        const sheetsPeriziaData = await fetchLatestPeriziaFromSheets(targaSelezionataGlobalmente);
        let sheetsRecordTimestamp = null; let sheetsDatiPerizia = null; let isSheetsDataCompleted = false;
        if (sheetsPeriziaData && sheetsPeriziaData.timestamp && sheetsPeriziaData.datiPerizia) {
            sheetsRecordTimestamp = new Date(sheetsPeriziaData.timestamp);
            sheetsDatiPerizia = sheetsPeriziaData.datiPerizia;
            isSheetsDataCompleted = sheetsPeriziaData.completata || false;
        }

        // Se i dati di Sheets sono più recenti (o non ci sono dati locali), aggiorna localStorage
        if (sheetsPeriziaData && sheetsRecordTimestamp && (!localDatiPeriziaTimestamp || sheetsRecordTimestamp > localDatiPeriziaTimestamp)) {
            try {
                if (!localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) { // Non sovrascrivere se marcata per cancellazione
                    localStorage.setItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`, JSON.stringify(sheetsDatiPerizia));
                    savePosizioneForTarga(targaSelezionataGlobalmente, sheetsPeriziaData.posizione || "");
                    saveUrgentStatusForTarga(targaSelezionataGlobalmente, sheetsPeriziaData.urgente || false);
                    if (isSheetsDataCompleted) markTargaAsCompleted(targaSelezionataGlobalmente);
                    else unmarkTargaAsCompleted(targaSelezionataGlobalmente);
                    console.log(`Dati per ${targaSelezionataGlobalmente} aggiornati da Sheets.`);
                }
            } catch (e) { console.error("Errore salvataggio dati da Sheets in LS:", e); }
        } else if (!localData && !localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) {
            // Se non ci sono dati locali né da Sheets (e non è marcata per cancellazione), resetta il form
            resetChecklistForm(); 
        }
        
        // Se dopo la sincronizzazione la targa risulta marcata per cancellazione, non procedere
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) { showView('landing'); return; }

        loadProgress(targaSelezionataGlobalmente); // Carica i dati (locali o aggiornati da Sheets) nel form

        if (targheLoadingStatus && landingPageSection.style.display === 'block') {
            targheLoadingStatus.textContent = "Clicca su una targa per iniziare la perizia:";
        }

        showView('checklist'); // Mostra la vista della checklist

        // Naviga alla sezione specificata o alla prima sezione di default
        if (targetSectionId && document.getElementById(targetSectionId + 'Section')) {
            showSection(targetSectionId);
        } else {
            const firstNav = Array.from(navButtons).find(b => b.dataset.target && !['backToListBtn', 'historyBtn', 'mainExitAppBtn'].includes(b.id));
            if (firstNav && firstNav.dataset.target) { showSection(firstNav.dataset.target); }
            else if (navButtons.length > 0 && navButtons[0].dataset.target) { showSection(navButtons[0].dataset.target); }
            else { showSection('remarketing'); } // Fallback alla prima sezione
        }
    }

    // Popola la lista delle targhe salvate nella pagina di cronistoria
    function populateSavedTargasList() {
        savedTargasListContainer.innerHTML = ''; // Pulisci la lista
        let hasSaves = false;
        const tempSavedTargas = []; // Array temporaneo per raccogliere le targhe
        // Itera su localStorage per trovare le perizie salvate
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}data_`)) { // Chiave dati perizia
                const targa = key.substring(`${APP_PREFIX}data_`.length);
                if (targa && !tempSavedTargas.includes(targa)) {
                    tempSavedTargas.push(targa);
                }
            }
        }

        if (tempSavedTargas.length > 0) hasSaves = true;
        tempSavedTargas.sort(); // Ordina le targhe alfabeticamente

        tempSavedTargas.forEach(targa => {
            // Trova dettagli del veicolo (marca, modello, piazzale) dalla lista completa
            const vehicleDetails = listaTargheCompleta.find(v => v.targa.toUpperCase() === targa.toUpperCase()) || { marca: '', modello: '', piazzale: '' };
            let displayText = targa;
            let details = [];
            if (vehicleDetails.marca) details.push(vehicleDetails.marca);
            if (vehicleDetails.modello) details.push(vehicleDetails.modello);
            if (vehicleDetails.piazzale) details.push(`(Piazzale: ${vehicleDetails.piazzale})`);
            if (details.length > 0) displayText += ` - ${details.join(' ')}`;

            const entryContainer = document.createElement('div'); // Contenitore per bottone targa e bottone azioni
            entryContainer.style.display = 'flex';
            entryContainer.style.justifyContent = 'space-between';
            entryContainer.style.alignItems = 'center';
            entryContainer.style.marginBottom = '8px';

            // Bottone principale per caricare la perizia
            const mainTargaButton = document.createElement('button');
            mainTargaButton.classList.add('saved-targa-button');
            mainTargaButton.style.flexGrow = '1'; mainTargaButton.style.marginRight = '10px';
            mainTargaButton.dataset.targa = targa;
            mainTargaButton.addEventListener('click', async function() {
                if (localStorage.getItem(`${APP_PREFIX}deleted_${this.dataset.targa}`)) {
                    alert(`La targa ${this.dataset.targa} è marcata per la cancellazione dal server. Annulla la marcatura per modificare la perizia.`); return;
                }
                await handleTargaSelectionAndSync(this.dataset.targa); // Carica la perizia
            });

            // Bottone per marcare/annullare marcatura cancellazione da Sheets
            const markForDeleteBtn = document.createElement('button');
            markForDeleteBtn.classList.add('action-button');
            markForDeleteBtn.style.padding = '8px 10px'; markForDeleteBtn.style.fontSize = '0.85em';
            markForDeleteBtn.style.minWidth = '120px'; markForDeleteBtn.dataset.targa = targa;
            const isMarkedForDeletion = !!localStorage.getItem(`${APP_PREFIX}deleted_${targa}`);

            if (isMarkedForDeletion) {
                mainTargaButton.textContent = displayText + " (Marcata per Cancellazione Server)";
                mainTargaButton.style.opacity = '0.6'; // Indica visivamente che è marcata
                markForDeleteBtn.innerHTML = '<i class="fas fa-undo"></i> Annulla Marca';
                markForDeleteBtn.title = `Annulla marcatura per cancellazione da Sheets per ${targa}`;
                markForDeleteBtn.style.backgroundColor = '#ffc107'; markForDeleteBtn.style.borderColor = '#e0a800'; markForDeleteBtn.style.color = '#212529';
            } else {
                mainTargaButton.textContent = displayText;
                markForDeleteBtn.innerHTML = '<i class="fas fa-cloud-times"></i> Marca Del. Server'; // Uso fas fa-cloud-times come esempio
                markForDeleteBtn.title = `Marca ${targa} per la cancellazione da Sheets (i dati locali non verranno modificati ora)`;
                markForDeleteBtn.style.backgroundColor = '#dc3545'; markForDeleteBtn.style.borderColor = '#c82333'; markForDeleteBtn.style.color = 'white';
            }

            markForDeleteBtn.addEventListener('click', function(event) {
                event.stopPropagation(); // Evita di triggerare il click sul bottone principale
                const targaToHandle = this.dataset.targa;
                const currentlyMarked = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaToHandle}`);
                if (currentlyMarked) {
                    if (confirm(`Sei sicuro di voler ANNULLARE la marcatura di cancellazione da Sheets per ${targaToHandle}?`)) {
                        localStorage.removeItem(`${APP_PREFIX}deleted_${targaToHandle}`);
                        alert(`Marcatura di cancellazione da Sheets annullata per ${targaToHandle}.`);
                        populateSavedTargasList(); // Aggiorna la lista nella cronistoria
                        if (typeof popolaTargheFiltrate === 'function' && landingPageSection.style.display === 'block') popolaTargheFiltrate(); // Aggiorna anche la lista principale
                    }
                } else {
                    if (confirm(`Sei sicuro di voler MARCARE ${targaToHandle} per la cancellazione da Sheets?\nI dati locali non verranno modificati ora, ma la perizia verrà rimossa da Sheets alla prossima sincronizzazione.`)) {
                        try {
                            localStorage.setItem(`${APP_PREFIX}deleted_${targaToHandle}`, new Date().toISOString()); // Salva timestamp marcatura
                            alert(`${targaToHandle} marcata per la cancellazione da Sheets.`);
                            populateSavedTargasList();
                            if (typeof popolaTargheFiltrate === 'function' && landingPageSection.style.display === 'block') popolaTargheFiltrate();
                        } catch (e) { alert(`Errore durante la marcatura di ${targaToHandle} per la cancellazione.`); }
                    }
                }
            });
            entryContainer.appendChild(mainTargaButton); entryContainer.appendChild(markForDeleteBtn);
            savedTargasListContainer.appendChild(entryContainer);
        });
        if (!hasSaves) { savedTargasListContainer.innerHTML = '<p style="text-align:center; color: #aaa;">Nessun salvataggio locale trovato.</p>'; }
    }

    // Cancella tutti i dati salvati localmente
    function clearAllSavedData() {
        if (confirm("ATTENZIONE! Sei sicuro di voler cancellare TUTTI i dati salvati localmente (perizie, foto, impostazioni, etc.)? Questa azione è IRREVERSIBILE.")) {
            let c = 0; const keysToRemove = [];
            for (let i=localStorage.length-1;i>=0;i--) { // Itera al contrario per evitare problemi con indici
                const k=localStorage.key(i); if (k.startsWith(APP_PREFIX)) { keysToRemove.push(k); }
            }
            keysToRemove.forEach(k => { localStorage.removeItem(k); c++; });
            // Cancella anche tutte le foto da IndexedDB
            openPhotoDB().then(db => {
                if (!db) { 
                    alert(`Errore: DB non inizializzato. ${c} elementi di localStorage sono stati cancellati.`);
                    return;
                }
                const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(PHOTO_STORE_NAME);
                const request = store.clear(); // Cancella tutti i record nello store
                request.onsuccess = () => {
                    alert(`${c} elementi di localStorage e tutte le foto nel database locale sono stati cancellati.`);
                    if(sheetFilterDropdown) sheetFilterDropdown.value = 'all'; // Resetta filtro piazzale
                    localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all'); // Salva il reset del filtro
                    populateSavedTargasList(); // Aggiorna la cronistoria (sarà vuota)
                    if (typeof caricaEPopolaTarghe === 'function') caricaEPopolaTarghe(); // Ricarica le targhe da CSV
                    if (typeof showView === 'function') showView('landing'); // Torna alla landing page
                    // Se la galleria era visibile, aggiornala (sarà vuota o mostrerà errore)
                    if (galleryPageSection.style.display === 'block') populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
                };
                request.onerror = (event) => alert(`Errore durante la cancellazione delle foto dal database locale. ${c} elementi di localStorage cancellati.`);
            }).catch(err => alert("Errore accesso al database per cancellazione foto. Solo i dati di localStorage sono stati cancellati. Dettagli: " + err));
        }
    }
    // Imposta il dropdown per filtrare per foglio/piazzale
    function setupSheetFilterDropdown() { if (!sheetFilterDropdown) return; const sources = ['all', ...new Set(listaTargheCompleta.map(item => item.piazzale).filter(p => p && p.trim() !== '').sort())]; sheetFilterDropdown.innerHTML = ''; sources.forEach(source => { const option = document.createElement('option'); option.value = source; option.textContent = source === 'all' ? 'Tutti gli Elenchi' : source; sheetFilterDropdown.appendChild(option); }); const savedPiazzaleFilter = localStorage.getItem(`${APP_PREFIX}selectedPiazzaleFilter`); if (savedPiazzaleFilter && sources.includes(savedPiazzaleFilter)) { sheetFilterDropdown.value = savedPiazzaleFilter; } else { sheetFilterDropdown.value = 'all'; localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all'); } sheetFilterDropdown.removeEventListener('change', handleSheetFilterChange); sheetFilterDropdown.addEventListener('change', handleSheetFilterChange); }
    // Gestisce il cambio del filtro foglio/piazzale
    function handleSheetFilterChange() { if (sheetFilterDropdown) { localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, sheetFilterDropdown.value); } popolaTargheFiltrate(); targaSelezionataGlobalmente = null; } // Resetta targa attiva quando cambia filtro

    // Popola la lista delle targhe filtrate nella landing page
    function popolaTargheFiltrate() {
        const tEl = document.getElementById('targaListContainer');
        if (!tEl) return;
        tEl.innerHTML = ''; // Pulisci la lista
        const selectedSource = sheetFilterDropdown ? sheetFilterDropdown.value : 'all';
        // Filtra la lista completa delle targhe in base al piazzale selezionato
        let preliminaryFilteredList = selectedSource === 'all'
            ? [...listaTargheCompleta]
            : listaTargheCompleta.filter(item => item.piazzale === selectedSource);
        
        // Funzione per determinare il rango di ordinamento di un item
        function getItemRank(item) {
            const targaUpper = item.targa.toUpperCase();
            const isMarkedForServerDelete = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`);
            if (isMarkedForServerDelete) return 0; // Priorità massima per quelle marcate per cancellazione (in cima)
            const isUrgent = loadUrgentStatusForTarga(targaUpper);
            const isCompleted = isTargaCompleted(targaUpper);
            const localDataJson = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`);
            let hasData = false;
            if (localDataJson) { try { const parsedData = JSON.parse(localDataJson); hasData = Object.keys(parsedData).some(key => key !== 'timestamp' && parsedData[key] !== "" && parsedData[key] !== false && (!Array.isArray(parsedData[key]) || parsedData[key].length > 0) ); } catch (e) {} }
            
            if (isUrgent && !isCompleted) return 1; // Urgente e non completata
            if (!isUrgent && !isCompleted && hasData) return 2; // Non urgente, non completata, ma con dati parziali
            if (!isUrgent && !isCompleted && !hasData) return 3; // Non urgente, non completata, senza dati (da vedere)
            if (!isUrgent && isCompleted) return 4; // Non urgente e completata
            if (isUrgent && isCompleted) return 5; // Urgente e completata (meno prioritaria di urgente non completata)
            return 6; // Default, dovrebbe essere coperto dai casi sopra
        }

        // Ordina la lista filtrata
        preliminaryFilteredList.sort((a, b) => {
            const rankA = getItemRank(a); const rankB = getItemRank(b);
            if (rankA !== rankB) return rankA - rankB; // Ordina per rango
            return a.targa.localeCompare(b.targa); // Poi per targa
        });

        const filteredList = preliminaryFilteredList;

        if (filteredList.length === 0) {
            tEl.innerHTML = '<p style="text-align:center; padding:10px; color: #aaa;">Nessuna targa trovata per il filtro selezionato.</p>';
            if(targheLoadingStatus) targheLoadingStatus.textContent = selectedSource === 'all' ? "Nessuna targa caricata dal CSV." : `Nessuna targa per l'elenco: ${selectedSource}.`;
            return;
        }

        // Crea gli elementi della lista
        filteredList.forEach((item) => {
            const targaUpper = item.targa.toUpperCase();
            const li = document.createElement('div'); li.classList.add('targa-list-item');
            const isMarkedForServerDeletionFlag = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`);
            if (isMarkedForServerDeletionFlag) li.classList.add('locally-deleted'); // Stile per marcate cancellazione

            const itemCompleted = isTargaCompleted(targaUpper);
            const localDataJson = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`);
            let hasData = false;
            if (localDataJson) { try { const parsed = JSON.parse(localDataJson); hasData = Object.keys(parsed).some(k => k !== 'timestamp' && parsed[k] !== "" && parsed[k] !== false ); } catch (e) {} }
            const isItemUrgent = loadUrgentStatusForTarga(targaUpper);

            // Applica classi di stato in base a urgenza, completamento e dati parziali
            if (!isMarkedForServerDeletionFlag) {
                if (isItemUrgent) {  li.classList.add('urgent-item'); if (itemCompleted) li.classList.add('completed'); }
                else if (itemCompleted) { li.classList.add('status-visto', 'completed'); }
                else if (hasData) { li.classList.add('status-parziale'); }
                else { li.classList.add('status-da-vedere'); }
            }

            // Colonna Targa
            const targaCol = document.createElement('span');
            targaCol.classList.add('targa-col', 'targa-col-targa');
            if (!isMarkedForServerDeletionFlag) { // Rendi cliccabile solo se non marcata per cancellazione
                 targaCol.classList.add('clickable-targa');
                 targaCol.addEventListener('click', async function() {
                    const selectedTargaFromClick = this.dataset.targaValue;
                    if (selectedTargaFromClick) { await handleTargaSelectionAndSync(selectedTargaFromClick); }
                });
            } else { targaCol.title = "Questa targa è marcata per la cancellazione dal server."; }
            targaCol.textContent = item.targa || 'N/D'; targaCol.dataset.targaValue = targaUpper; li.appendChild(targaCol);

            // Colonna Posizione
            const posizioneCol = document.createElement('span'); posizioneCol.classList.add('targa-col', 'targa-col-posizione');
            const posizioneInput = document.createElement('input'); posizioneInput.type = 'text'; posizioneInput.classList.add('posizione-input');
            posizioneInput.dataset.targa = targaUpper; posizioneInput.placeholder = 'Pos.'; posizioneInput.maxLength = 5;
            posizioneInput.value = loadPosizioneForTarga(targaUpper); posizioneInput.disabled = isMarkedForServerDeletionFlag;
            posizioneInput.addEventListener('mousedown', (e) => e.stopPropagation()); // Evita che il click sull'input propaghi alla riga
            posizioneInput.addEventListener('click', (e) => e.stopPropagation());
            posizioneInput.addEventListener('focus', (e) => e.stopPropagation());
            posizioneInput.addEventListener('blur', function() { const newPosition = this.value.trim().toUpperCase(); if (newPosition !== loadPosizioneForTarga(this.dataset.targa)) { savePosizioneForTarga(this.dataset.targa, newPosition); this.style.backgroundColor = 'rgba(76, 175, 80, 0.2)'; setTimeout(() => { this.style.backgroundColor = ''; }, 1000); } }); // Salva al blur
            posizioneInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); this.blur(); }}); // Salva anche con Invio
            posizioneCol.appendChild(posizioneInput); li.appendChild(posizioneCol);

            // Colonna Urgenza
            const urgenzaCol = document.createElement('span'); urgenzaCol.classList.add('targa-col', 'targa-col-urgenza');
            const urgenzaCheckbox = document.createElement('input'); urgenzaCheckbox.type = 'checkbox';
            urgenzaCheckbox.checked = isItemUrgent; urgenzaCheckbox.title = isItemUrgent ? "Rimuovi urgenza" : "Marca come urgente";
            urgenzaCheckbox.disabled = isMarkedForServerDeletionFlag;
            urgenzaCheckbox.addEventListener('mousedown', (e) => e.stopPropagation()); urgenzaCheckbox.addEventListener('click', (e) => e.stopPropagation());
            urgenzaCheckbox.addEventListener('change', function() { saveUrgentStatusForTarga(targaUpper, this.checked);  this.title = this.checked ? "Rimuovi urgenza" : "Marca come urgente"; popolaTargheFiltrate();  }); // Ricarica la lista per riflettere il cambio di ordinamento/stile
            urgenzaCol.appendChild(urgenzaCheckbox); li.appendChild(urgenzaCol);

            // Colonne Marca, Modello, Piazzale
            const marcaCol = document.createElement('span'); marcaCol.classList.add('targa-col', 'targa-col-marca'); marcaCol.textContent = item.marca || 'N/D'; li.appendChild(marcaCol);
            const modelloCol = document.createElement('span'); modelloCol.classList.add('targa-col', 'targa-col-modello'); modelloCol.textContent = item.modello || 'N/D'; li.appendChild(modelloCol);
            const piazzaleCol = document.createElement('span'); piazzaleCol.classList.add('targa-col', 'targa-col-piazzale'); piazzaleCol.textContent = item.piazzale || 'N/D'; li.appendChild(piazzaleCol);

            // Colonna Azioni (es. cancella progressi locali)
            const actionsCol = document.createElement('span'); actionsCol.classList.add('targa-col', 'targa-col-actions');
            if (!isMarkedForServerDeletionFlag) {
                const delB = document.createElement('button'); delB.classList.add('action-button', 'delete-progress-btn');
                delB.dataset.targa = targaUpper; delB.title = `Cancella SOLO i progressi e le foto LOCALI per ${item.targa}`; delB.textContent = 'X';
                delB.addEventListener('click', function(event) {
                    event.stopPropagation(); // Evita di selezionare la targa
                    const tDelUpper = this.dataset.targa;
                    const itemTargaForDisplay = listaTargheCompleta.find(v => v.targa.toUpperCase() === tDelUpper)?.targa || tDelUpper;
                    if (confirm(`Sei sicuro di voler cancellare SOLO i dati LOCALI (progressi e foto) per la targa ${itemTargaForDisplay}?\nQuesta azione NON la marcherà per la cancellazione dal server.`)) {
                        clearLocalDataForTarga(tDelUpper); // Cancella dati locali
                        if (typeof popolaTargheFiltrate === 'function') popolaTargheFiltrate(); // Aggiorna la lista
                        // Se la targa cancellata era quella attiva, torna alla landing page
                        if (targaSelezionataGlobalmente && targaSelezionataGlobalmente.toUpperCase() === tDelUpper) {
                            targaSelezionataGlobalmente = null; showView('landing');
                        }
                    }
                });
                actionsCol.appendChild(delB);
            } else { actionsCol.textContent = 'DEL.SRV'; actionsCol.title = 'Questa targa è marcata per la cancellazione da Sheets. Gestisci dalla Cronistoria Salvataggi.'; }
            li.appendChild(actionsCol); tEl.appendChild(li);
        });
        if(targheLoadingStatus) targheLoadingStatus.textContent = "Clicca su una targa per iniziare la perizia:";
    }

    // Carica e popola le targhe dal CSV di Google Sheets
    async function caricaEPopolaTarghe() {
        if (targheLoadingStatus) targheLoadingStatus.textContent = "Caricamento dati dal server...";
        try {
            const r = await fetch(GOOGLE_SHEET_CSV_URL + `&nocache=${new Date().getTime()}`); // Aggiungi nocache per evitare problemi di cache
            if (!r.ok) { let e = `Errore HTTP ${r.status}.`; if (r.status === 0) e = "Errore di rete o CORS."; else if (r.status === 404) e = "File CSV non trovato sul server."; else if (r.status === 403) e = "Accesso al file CSV negato."; throw new Error(e); }
            const csv = await r.text(); const lines = csv.split(/\r\n|\n|\r/).filter(l => l.trim() !== ''); // Dividi per righe e rimuovi righe vuote
            if (lines.length === 0) { // Nessun dato nel CSV
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessun dato trovato nel file CSV."; listaTargheCompleta = [];
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>'; // Resetta filtro
                if (targaListContainer) targaListContainer.innerHTML = ''; return;
            }
            // Mappa le righe CSV in oggetti, pulendo e normalizzando i dati
            listaTargheCompleta = lines.map(l => { const p = l.split(','); return { targa: (p[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(), marca: (p[1] || '').trim().replace(/^"|"$/g, ''), modello: (p[2] || '').trim().replace(/^"|"$/g, ''), piazzale: (p[3] || '').trim().replace(/^"|"$/g, '') }; }).filter(i => i.targa && i.targa.length > 3); // Filtra targhe non valide
            if (listaTargheCompleta.length === 0) { // Nessuna targa valida dopo il parsing
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessuna targa valida trovata nel file CSV.";
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>';
                if (targaListContainer) targaListContainer.innerHTML = ''; return;
            }
            setupSheetFilterDropdown(); // Imposta il filtro per piazzale
            popolaTargheFiltrate(); // Popola la lista delle targhe
        } catch (e) { // Gestione errori caricamento
            if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore durante il caricamento delle targhe: ${e.message}.`;
            if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>';
            if (targaListContainer) targaListContainer.innerHTML = ''; listaTargheCompleta = [];
        }
    }
    // Inizializza l'animazione sequenziale per gli input di una sezione
    function initSequentialAnimation() { const checklistContainerDiv = document.getElementById('checklistContainer'); if (!checklistContainerDiv || checklistContainerDiv.style.display === 'none') return; const activeSection = checklistContainerDiv.querySelector('.category-section.active'); if (!activeSection) return; activeSection.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me')); const allVisibleElementsInSection = Array.from( activeSection.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled), textarea:not(:disabled)') ).filter(el => { let current = el; while (current && current !== activeSection.parentElement) {  if (getComputedStyle(current).display === 'none' || getComputedStyle(current).visibility === 'hidden') return false; current = current.parentElement; } return el.offsetParent !== null;  }); const startIndex = allVisibleElementsInSection.findIndex(el => isInputDefault(el)); if (startIndex === -1 && allVisibleElementsInSection.length > 0) {  return; } if (allVisibleElementsInSection.length === 0) {   return; } const elementsToAnimate = allVisibleElementsInSection.slice(startIndex >= 0 ? startIndex : 0); if (elementsToAnimate.length === 0) return; let currentIndex = 0; let activeListeners = [];  function clearAllActiveAnimationListeners() { activeListeners.forEach(({element, type, handler}) => { element.removeEventListener(type, handler); element.classList.remove('animate-me');  }); activeListeners = []; } clearAllActiveAnimationListeners(); function animateNextElement() { if (currentIndex >= elementsToAnimate.length) { clearAllActiveAnimationListeners(); return; } const currentElement = elementsToAnimate[currentIndex]; if (!isInputDefault(currentElement)) {  currentIndex++; animateNextElement(); return; } currentElement.classList.add('animate-me'); currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); const onValueChange = (event) => { let processChange = false; if (event.type === 'change') { processChange = true; } else if (event.type === 'blur' && currentElement.tagName !== 'SELECT') {  processChange = true; }  if (processChange && !isInputDefault(currentElement)) {  currentElement.classList.remove('animate-me'); activeListeners = activeListeners.filter(listener => { if (listener.element === currentElement) { listener.element.removeEventListener(listener.type, listener.handler); return false;  } return true;  }); currentIndex++; setTimeout(animateNextElement, 50);  } }; currentElement.addEventListener('change', onValueChange); activeListeners.push({element: currentElement, type: 'change', handler: onValueChange}); if (currentElement.tagName === 'TEXTAREA' || currentElement.type === 'text') { currentElement.addEventListener('blur', onValueChange);  activeListeners.push({element: currentElement, type: 'blur', handler: onValueChange}); } } animateNextElement(); }

    // Mostra una sezione specifica della checklist
    function showSection(targetId) {
        document.querySelectorAll('#checklistContainer .animate-me').forEach(el => { el.classList.remove('animate-me'); }); // Rimuovi animazioni
        sections.forEach(s => s.classList.toggle('active', s.id === targetId + 'Section')); // Attiva/disattiva sezione
        navButtons.forEach(b => { b.classList.toggle('active', b.dataset.target === targetId); }); // Attiva/disattiva pulsante navigazione
        updateNavButtonColors(); // Aggiorna colori pulsanti

        if (checklistContainer.style.display === 'block') { // Se siamo nella checklist
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'none'; // Nascondi titolo globale
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex'; // Mostra dropdown targa
            populateTargaSwitcherDropdown(); updateTargaDetailsDisplay(targaSelezionataGlobalmente);
            localStorage.setItem(LAST_ACTIVE_PERIZIA_PAGE_KEY, targetId); // Salva ultima sezione attiva
        } else { // Se non siamo nella checklist
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'block'; // Mostra titolo globale
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none'; // Nascondi dropdown targa
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = ''; // Pulisci dettagli targa
        }

        const targetSectionElement = document.getElementById(targetId + 'Section');
        // Inizializza animazione sequenziale se la sezione non è il riepilogo
        if (targetSectionElement && Array.from(sections).includes(targetSectionElement) && targetId !== 'riepilogo') {
             setTimeout(initSequentialAnimation, 100);
        } else if (targetId === 'riepilogo') { // Se è la sezione riepilogo
            generateSummary(); // Genera il contenuto del riepilogo
            // Gestisci visibilità bottone Download ZIP
            if (downloadZipBtn && targaSelezionataGlobalmente) {
                downloadZipBtn.href = `https://192.168.1.154:8080/${targaSelezionataGlobalmente.toUpperCase()}.zip`;
                downloadZipBtn.style.display = 'inline-flex';
            } else if (downloadZipBtn) {
                downloadZipBtn.style.display = 'none';
            }
        } else { // Altre sezioni (teoricamente non dovrebbe accadere se non è riepilogo o checklist)
             if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        }
         window.scrollTo(0, 0); // Scrolla in cima
    }

    // Ottiene il testo selezionato da un elemento select
    function getSelectText(selectElementOrId) { const el = typeof selectElementOrId === 'string' ? document.getElementById(selectElementOrId) : selectElementOrId; if (el && el.tagName === 'SELECT' && el.value !== "") { if (el.selectedIndex >= 0 && el.options[el.selectedIndex]) { return el.options[el.selectedIndex].text; } return el.value;  } return "N/S";  }
    // Genera il contenuto del riepilogo della perizia
    function generateSummary() { summaryContent.innerHTML = ''; let targa = targaSelezionataGlobalmente || "N/D"; function createSummaryItem(label, value, isAnomaly = false) { const itemDiv = document.createElement('div'); itemDiv.classList.add('summary-item'); if (isAnomaly) itemDiv.classList.add('summary-anomaly'); itemDiv.innerHTML = `<strong>${label}:</strong> ${value}`; return itemDiv; } summaryContent.appendChild(createSummaryItem("Targa", targa.toUpperCase())); if (targaSelezionataGlobalmente) { const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente); let marcaVeicolo = "N/D", modelloVeicolo = "N/D"; if (veicoloAttuale) { marcaVeicolo = veicoloAttuale.marca || "N/D"; modelloVeicolo = veicoloAttuale.modello || "N/D"; } summaryContent.appendChild(createSummaryItem("Marca", marcaVeicolo)); summaryContent.appendChild(createSummaryItem("Modello", modelloVeicolo)); summaryContent.appendChild(createSummaryItem("Posizione", loadPosizioneForTarga(targaSelezionataGlobalmente) || "N/D")); const isUrgentForSummary = loadUrgentStatusForTarga(targaSelezionataGlobalmente); summaryContent.appendChild(createSummaryItem("Urgente", isUrgentForSummary ? "Sì" : "No", isUrgentForSummary)); } else {  summaryContent.appendChild(createSummaryItem("Marca", "N/D")); summaryContent.appendChild(createSummaryItem("Modello", "N/D")); summaryContent.appendChild(createSummaryItem("Posizione", "N/D")); summaryContent.appendChild(createSummaryItem("Urgente", "N/D")); } summaryContent.innerHTML += `<h3>Remarketing:</h3>`; const tipoTrazioneValue = tipoTrazioneSelect ? tipoTrazioneSelect.value : ""; const isEV = tipoTrazioneValue === 'elettrico'; summaryContent.appendChild(createSummaryItem("Trazione Veicolo", getSelectText(tipoTrazioneSelect))); let equipaggiamento = getSelectText('tipo_equipaggiamento'), presenzaEquip = getSelectText('equipaggiamento_presenza'); let equipAnomalia = (equipaggiamento !== "N/S" && equipaggiamento !== "" && equipaggiamento !== "Seleziona..." && presenzaEquip === "Mancante"); summaryContent.appendChild(createSummaryItem("Equip. Vano Carico", equipaggiamento, equipAnomalia && presenzaEquip === "Mancante")); summaryContent.appendChild(createSummaryItem("Presenza Equip.", presenzaEquip, equipAnomalia)); let kmStato = getSelectText('stato_chilometri'); summaryContent.appendChild(createSummaryItem("Stato Chilometri", kmStato, kmStato === "Non rilevabili")); let cdcStato = getSelectText('stato_cdc'); summaryContent.appendChild(createSummaryItem("Stato CDC", cdcStato, cdcStato === "Mancante")); summaryContent.appendChild(createSummaryItem("Chiave con Telecomando", getSelectText('chiave_telecomando'), getSelectText('chiave_telecomando') === "Non Presente")); summaryContent.appendChild(createSummaryItem("Seconda Chiave", getSelectText('seconda_chiave'), getSelectText('seconda_chiave') === "Non Presente")); if (isEV) { summaryContent.innerHTML += `<h4>Dotazioni Veicolo Elettrico:</h4>`; let cavoRapidaText = getSelectText('cavo_ricarica_rapida'); let cavoDomesticaText = getSelectText('cavo_ricarica_domestica'); summaryContent.appendChild(createSummaryItem("Cavo Ricarica Rapida", cavoRapidaText, cavoRapidaText === "Non Presente")); summaryContent.appendChild(createSummaryItem("Cavo Ricarica Domestica", cavoDomesticaText, cavoDomesticaText === "Non Presente")); } summaryContent.innerHTML += `<h3>Pneumatici:</h3>`; const pneumaticiFields = [ { id: 'pneumatico_as', label: 'Ant. Sinistro' }, { id: 'pneumatico_ad', label: 'Ant. Destro' }, { id: 'pneumatico_pd', label: 'Post. Destro' }, { id: 'pneumatico_ps', label: 'Post. Sinistro' }]; pneumaticiFields.forEach(pneu => { summaryContent.appendChild(createSummaryItem(pneu.label, getSelectText(pneu.id), getSelectText(pneu.id) === "Non conforme")); }); summaryContent.innerHTML += `<h3>Danni/Verifiche:</h3>`; summaryContent.appendChild(createSummaryItem("Motore si Accende", getSelectText('motore_accende'), getSelectText('motore_accende') === 'Non OK')); summaryContent.appendChild(createSummaryItem("Stato Batteria", getSelectText('batteria_stato'), getSelectText('batteria_stato') === 'Non OK')); const noteDanniValue = document.getElementById('note_danni_verifiche') ? document.getElementById('note_danni_verifiche').value.trim() : ""; if (noteDanniValue) { const noteDiv = document.createElement('div'); noteDiv.classList.add('summary-item', 'summary-notes'); const strongNode = document.createElement('strong'); strongNode.textContent = "Note Danni/Verifiche: "; const contentDiv = document.createElement('div'); contentDiv.style.whiteSpace = 'pre-wrap'; contentDiv.style.paddingLeft = '10px'; contentDiv.textContent = noteDanniValue; noteDiv.appendChild(strongNode); noteDiv.appendChild(contentDiv); summaryContent.appendChild(noteDiv); } }

    // Recupera tutti i dati da Google Sheets
    async function fetchAllDataFromSheets() {
        if (!GOOGLE_SHEET_WEB_APP_URL) { console.warn("URL Web App non configurato per fetchAll."); return { success: false, message: "URL Web App non configurato.", data: [] }; }
        const fetchUrl = `${GOOGLE_SHEET_WEB_APP_URL}?nocache=${new Date().getTime()}`; // Aggiungi nocache
        try {
            const response = await fetch(fetchUrl, { method: 'GET', mode: 'cors' });
            if (!response.ok) { return { success: false, message: `Errore Sheets (${response.status}) durante recupero globale.`, data: [] }; }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const result = await response.json();
                // Gestisci diversi formati di risposta di successo
                if (Array.isArray(result)) { return { success: true, data: result, message: "Dati recuperati con successo." }; }
                else if (result && result.status === "success" && Array.isArray(result.data)) { return { success: true, data: result.data, message: result.message || "Dati recuperati con successo."}; }
                else if (result && result.status === "notfound") { return { success: true, data: [], message: result.message || "Nessuna perizia trovata su Sheets."}; } // Nessun dato è comunque un successo
                else { return { success: false, message: "Formato risposta globale da Sheets non valido.", data: [] }; }
            } else { return { success: false, message: "Errore formato risposta globale da Sheets (non JSON).", data: [] }; }
        } catch (error) { return { success: false, message: "Errore di rete durante recupero globale: " + error.message, data: [] }; }
    }

    // Sincronizza tutti i dati locali con Google Sheets
    async function syncAllLocalDataToSheets() {
        const originalSyncButtonText = syncToSheetsBtn.textContent;
        syncToSheetsBtn.disabled = true;
        let updatedFromSheetsCount = 0, localUpdatesFailedCount = 0;
        let sheetsDeletionsSuccessCount = 0, sheetsDeletionsFailedCount = 0;
        let localToSheetsSuccessCount = 0, localToSheetsErrorCount = 0;
        let errorMessages = [];

        // Fase 1: Invia richieste di cancellazione a Sheets per le targhe marcate
        syncToSheetsBtn.textContent = "Sinc (1/4 Del. Sheets)...";
        let deletionRequests = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}deleted_`)) deletionRequests.push(key.substring(`${APP_PREFIX}deleted_`.length));
        }
        if (deletionRequests.length > 0) {
            for (const targa of deletionRequests) {
                const deleteUrl = `${GOOGLE_SHEET_WEB_APP_URL}?action=deletePerizia&targa=${encodeURIComponent(targa)}`;
                try {
                    const response = await fetch(deleteUrl, { method: 'POST', mode: 'cors', body: JSON.stringify({targa: targa})}); // Invia targa nel corpo POST
                    const result = await response.json();
                    if (response.ok && result.status === "success") {
                        localStorage.removeItem(`${APP_PREFIX}deleted_${targa}`); // Rimuovi marcatura locale dopo successo
                        sheetsDeletionsSuccessCount++;
                    } else {
                        sheetsDeletionsFailedCount++; errorMessages.push(`Targa ${targa} (Cancellazione Sheets): ${result.message || 'Errore sconosciuto'}`);
                    }
                } catch (error) {
                    sheetsDeletionsFailedCount++; errorMessages.push(`Targa ${targa} (Cancellazione Sheets - Rete): ${error.message}`);
                }
            }
        }

        // Fase 2: Recupera tutti i dati da Sheets
        syncToSheetsBtn.textContent = "Sinc (2/4 Rec. Sheets)...";
        const sheetsResponse = await fetchAllDataFromSheets();
        if (!sheetsResponse.success) alert(`Errore durante il recupero dei dati da Sheets:\n${sheetsResponse.message}\nLa sincronizzazione potrebbe essere incompleta.`);
        const allSheetsData = sheetsResponse.data || []; // Assicura che sia un array

        // Fase 3: Aggiorna i dati locali con quelli più recenti da Sheets
        syncToSheetsBtn.textContent = "Sinc (3/4 Agg. Locali)...";
        if (allSheetsData.length > 0) {
            for (const sheetPerizia of allSheetsData) {
                if (!sheetPerizia || !sheetPerizia.targa || !sheetPerizia.timestamp || !sheetPerizia.datiPerizia || !sheetPerizia.datiPerizia.timestamp) continue; // Salta dati incompleti
                const targa = sheetPerizia.targa.toUpperCase();
                if (localStorage.getItem(`${APP_PREFIX}deleted_${targa}`)) continue; // Salta se marcata per cancellazione locale (già gestita o in attesa)
                
                const localDataKey = `${APP_PREFIX}data_${targa}`;
                const localDataJSON = localStorage.getItem(localDataKey);
                let localDatiPeriziaTimestamp = null;
                if (localDataJSON) { try { const localDatiPeriziaObject = JSON.parse(localDataJSON); localDatiPeriziaTimestamp = localDatiPeriziaObject.timestamp ? new Date(localDatiPeriziaObject.timestamp) : null; } catch (e) {} }
                
                const sheetsRecordTimestamp = new Date(sheetPerizia.timestamp);
                // Se i dati di Sheets sono più recenti, o non ci sono dati locali, aggiorna locale
                if (!localDatiPeriziaTimestamp || sheetsRecordTimestamp > localDatiPeriziaTimestamp) {
                    try {
                        localStorage.setItem(localDataKey, JSON.stringify(sheetPerizia.datiPerizia));
                        if (sheetPerizia.hasOwnProperty('posizione')) savePosizioneForTarga(targa, sheetPerizia.posizione);
                        if (sheetPerizia.hasOwnProperty('urgente')) saveUrgentStatusForTarga(targa, sheetPerizia.urgente);
                        if (sheetPerizia.hasOwnProperty('completata')) {
                            if (sheetPerizia.completata) markTargaAsCompleted(targa); else unmarkTargaAsCompleted(targa);
                        }
                        updatedFromSheetsCount++;
                    } catch (e) { localUpdatesFailedCount++; console.error(`Errore aggiornamento locale per ${targa} da Sheets:`, e); }
                }
            }
        }

        // Fase 4: Invia i dati locali (più recenti o non presenti su Sheets) a Sheets
        syncToSheetsBtn.textContent = "Sinc (4/4 Invio Sheets)...";
        let perizieLocaliKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}data_`)) {
                 const targaFromKey = key.substring(`${APP_PREFIX}data_`.length);
                 if (!localStorage.getItem(`${APP_PREFIX}deleted_${targaFromKey}`)) perizieLocaliKeys.push(key); // Non inviare se marcata per cancellazione
            }
        }

        if (perizieLocaliKeys.length > 0) {
            for (const key of perizieLocaliKeys) {
                const targa = key.substring(`${APP_PREFIX}data_`.length);
                let datiPeriziaSalvatiLocalmente;
                try { datiPeriziaSalvatiLocalmente = JSON.parse(localStorage.getItem(key)); }
                catch (e) { localToSheetsErrorCount++; errorMessages.push(`Targa ${targa} (Invio a Sheets): Errore lettura dati locali.`); continue; }

                if (!datiPeriziaSalvatiLocalmente || !datiPeriziaSalvatiLocalmente.timestamp) {
                    localToSheetsErrorCount++; errorMessages.push(`Targa ${targa} (Invio a Sheets): Dati locali incompleti o timestamp mancante.`); continue;
                }
                
                // Verifica se i dati locali sono più recenti di quelli su Sheets (se presenti)
                const correspondingSheetData = allSheetsData.find(sp => sp.targa.toUpperCase() === targa);
                let shouldSendToSheets = true;
                if (correspondingSheetData && correspondingSheetData.timestamp) {
                    if (new Date(datiPeriziaSalvatiLocalmente.timestamp) <= new Date(correspondingSheetData.timestamp)) {
                        shouldSendToSheets = false; // Sheets ha dati uguali o più recenti
                    }
                }

                if (shouldSendToSheets) {
                    const periziaDaInviare = {
                        targa: targa, posizione: loadPosizioneForTarga(targa) || "", urgente: loadUrgentStatusForTarga(targa) || false,
                        completata: isTargaCompleted(targa), datiPerizia: datiPeriziaSalvatiLocalmente, timestamp: datiPeriziaSalvatiLocalmente.timestamp // Usa il timestamp dei dati perizia
                    };
                    const result = await inviaPeriziaSingolaASheets(periziaDaInviare);
                    if (result.success) {
                        localToSheetsSuccessCount++;
                        // Se Sheets restituisce un timestamp aggiornato (es. per consistenza), aggiorna locale
                        if (result.data && result.data.timestamp && new Date(result.data.timestamp) > new Date(datiPeriziaSalvatiLocalmente.timestamp)) {
                            datiPeriziaSalvatiLocalmente.timestamp = result.data.timestamp;
                            try { localStorage.setItem(key, JSON.stringify(datiPeriziaSalvatiLocalmente)); } catch (e) {}
                        }
                    } else { localToSheetsErrorCount++; errorMessages.push(`Targa ${targa} (Invio a Sheets): ${result.message || 'Errore sconosciuto'}`); }
                }
            }
        }
        
        syncToSheetsBtn.textContent = "Sincronizzazione Fine";
        let finalMessage = `Sincronizzazione completata.\n\nCANCELLAZIONI (Locale -> Sheets):\n- ${sheetsDeletionsSuccessCount} perizie cancellate da Sheets.\n`;
        if (sheetsDeletionsFailedCount > 0) finalMessage += `- ${sheetsDeletionsFailedCount} errori durante la cancellazione da Sheets.\n`;
        finalMessage += `\nAGGIORNAMENTI (Sheets -> Locale):\n- ${updatedFromSheetsCount} perizie locali aggiornate/create da Sheets.\n`;
        if (localUpdatesFailedCount > 0) finalMessage += `- Errori durante l'aggiornamento locale: ${localUpdatesFailedCount}.\n`;
        finalMessage += `\nINVIO DATI (Locale -> Sheets):\n- ${localToSheetsSuccessCount} perizie inviate/aggiornate con successo su Sheets.\n`;
        if (localToSheetsErrorCount > 0) finalMessage += `- ${localToSheetsErrorCount} errori durante l'invio a Sheets.\n`;
        if (errorMessages.length > 0) finalMessage += "\n\nDETTAGLIO ERRORI:\n" + errorMessages.join("\n");
        alert(finalMessage);

        syncToSheetsBtn.textContent = originalSyncButtonText; syncToSheetsBtn.disabled = false;
        // Aggiorna le viste se necessario
        if (typeof popolaTargheFiltrate === 'function' && landingPageSection.style.display === 'block') popolaTargheFiltrate();
        if (typeof populateSavedTargasList === 'function' && historyPageSection.style.display === 'block') populateSavedTargasList();
    }

    // Funzione per triggerare l'uscita principale (usata da headerExitBtn)
    function triggerMainExit() { if (mainExitAppBtn) mainExitAppBtn.click(); }

    // Gestione inizio tocco per swipe tra sezioni
    function handleTouchStart(event) {
        if (imageLightbox && imageLightbox.style.display === 'flex') return; // Non fare swipe se lightbox è aperta
        const targetElement = event.target;
        // Ignora swipe se si tocca un input, select, textarea o bottone
        if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA' || targetElement.closest('.action-button') || targetElement.closest('.circle-button') || targetElement.closest('.page-action-button')) {
            return;
        }
        // Abilita swipe solo nella checklist o nella galleria filtrata per targa
        if (checklistContainer.style.display === 'block' || (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter)) {
             touchstartX = event.changedTouches[0].screenX;
             touchstartY = event.changedTouches[0].screenY;
        }
    }

    // Gestione fine tocco per swipe tra sezioni
    function handleTouchEnd(event) {
        if (imageLightbox && imageLightbox.style.display === 'flex') return;
        const targetElement = event.target;
         if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA' || targetElement.closest('.action-button') || targetElement.closest('.circle-button') || targetElement.closest('.page-action-button')) {
            return;
        }
        if (checklistContainer.style.display === 'block' || (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter)) {
            touchendX = event.changedTouches[0].screenX;
            touchendY = event.changedTouches[0].screenY;
            handleSwipeGesture(); // Chiama la funzione che gestisce la logica dello swipe
        }
    }

    // Logica per gestire lo swipe tra le sezioni
    async function handleSwipeGesture() {
        const deltaX = touchendX - touchstartX;
        const deltaY = touchendY - touchstartY;

        // Ignora se lo swipe è troppo piccolo
        if (Math.abs(deltaX) < swipeThreshold && Math.abs(deltaY) < swipeThreshold) { return; }

        let currentViewElement = null;
        let sectionArrayForSwipe = sectionOrder; // Usa sectionOrder per la logica di swipe
        let currentSectionIdInSwipe = null;
        let changeFunctionForSwipe = null;

        // Determina la vista corrente e la funzione per cambiare sezione
        if (checklistContainer.style.display === 'block') { // Se siamo nella checklist
            currentViewElement = checklistContainer;
            const activeSectionElement = checklistContainer.querySelector('.category-section.active');
            if (!activeSectionElement) return;
            currentSectionIdInSwipe = activeSectionElement.id.replace('Section', '');
            changeFunctionForSwipe = showSection; // Per la checklist, usiamo showSection
        } else if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter) { // Se siamo nella galleria filtrata per targa
            currentViewElement = galleryPageSection;
            const activeNavButton = mainPageNavButtons.querySelector('button.active'); // Trova il pulsante di navigazione sezione attivo
            currentSectionIdInSwipe = activeNavButton ? activeNavButton.dataset.target : sectionArrayForSwipe[0]; // Sezione attuale o default
            // Per la galleria, lo swipe cambia la "sezione virtuale" e ricarica la galleria
            changeFunctionForSwipe = async (newSection) => {
                 await showGalleryPage(currentGalleryTargaFilter, newSection); // Ricarica galleria con nuova sezione
            };
        }

        if (!currentViewElement || !currentSectionIdInSwipe || !changeFunctionForSwipe) return;

        const currentIndexInSwipe = sectionArrayForSwipe.indexOf(currentSectionIdInSwipe);
        if (currentIndexInSwipe === -1) return; // Sezione attuale non trovata nell'ordine

        // Gestisci swipe orizzontale
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) { 
            if (deltaX > 0) { // Swipe a destra (vai a sezione precedente)
                if (currentIndexInSwipe > 0) {
                    await changeFunctionForSwipe(sectionArrayForSwipe[currentIndexInSwipe - 1]);
                } else {
                    showSwipeEndIndicator('left'); // Indica che si è alla prima sezione
                }
            } else { // Swipe a sinistra (vai a sezione successiva)
                if (currentIndexInSwipe < sectionArrayForSwipe.length - 1) {
                    await changeFunctionForSwipe(sectionArrayForSwipe[currentIndexInSwipe + 1]);
                } else {
                    showSwipeEndIndicator('right'); // Indica che si è all'ultima sezione
                }
            }
        }
        // Swipe verticale non gestito per cambio sezione qui
    }
    
    // Inizializza l'applicazione
    async function initializeApplicationViewAndLoadData() {
        const preloader = document.getElementById('preloader');
        if (preloader) { // Mostra preloader
            preloader.style.display = 'flex'; preloader.classList.remove('hidden');
            preloader.style.opacity = '1'; preloader.style.visibility = 'visible';
            const loadingText = preloader.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = 'CARICAMENTO TARGHE...';
        }
        try { await openPhotoDB(); } // Inizializza IndexedDB per le foto
        catch (error) {
            if (preloader) { const lt = preloader.querySelector('.loading-text'); if(lt) lt.textContent = 'ERRORE DB FOTO!';}
            alert("Errore durante l'inizializzazione del database locale per le foto."); return;
        }
        await caricaEPopolaTarghe(); // Carica le targhe da CSV
        if (preloader) { // Nascondi preloader
            preloader.classList.add('hidden');
            setTimeout(() => { if (preloader) preloader.style.display = 'none'; }, 700);
        }
        showView('landing'); // Mostra la landing page
        // Gestione modale changelog
        if (changelogModal && closeChangelogBtnModal && changelogList && changelogTitle) {
            const lastVersionSeen = localStorage.getItem('appVersionSeen');
            changelogTitle.textContent = `WebApp Perizie - Novità v${currentAppVersion}`;
            changelogList.innerHTML = latestChangesText;
            if (lastVersionSeen !== currentAppVersion) changelogModal.style.display = 'flex'; // Mostra se nuova versione
            closeChangelogBtnModal.onclick = () => {
                changelogModal.style.display = 'none';
                localStorage.setItem('appVersionSeen', currentAppVersion); // Salva versione vista
            };
        }
    }


    // Event listener DOMContentLoaded per inizializzare l'app e aggiungere listener
    document.addEventListener('DOMContentLoaded', () => {
        // Creazione e aggiunta bottone Sincronizza
        syncToSheetsBtn = document.createElement('button');
        syncToSheetsBtn.id = 'syncToSheetsBtn'; syncToSheetsBtn.classList.add('action-button');
        syncToSheetsBtn.textContent = 'Sincronizza';
        syncToSheetsBtn.style.backgroundColor = '#ffc107'; syncToSheetsBtn.style.borderColor = '#e0a800';
        syncToSheetsBtn.style.color = '#212529';
        const historyButton = document.getElementById('historyBtn');
        if (historyButton && historyButton.parentNode === utilityNavButtons) { // Inserisci dopo historyBtn se esiste
            utilityNavButtons.insertBefore(syncToSheetsBtn, historyButton.nextSibling);
        } else if (mainExitAppBtn && mainExitAppBtn.parentNode === utilityNavButtons) { // O prima di exitAppBtn
             utilityNavButtons.insertBefore(syncToSheetsBtn, mainExitAppBtn);
        } else if (utilityNavButtons.firstChild) { // O come primo figlio
            utilityNavButtons.insertBefore(syncToSheetsBtn, utilityNavButtons.firstChild);
        } else { utilityNavButtons.appendChild(syncToSheetsBtn); } // O come ultimo figlio
        syncToSheetsBtn.addEventListener('click', syncAllLocalDataToSheets);

        // Listener per bottoni "Compila Default"
        document.querySelectorAll('.fill-defaults-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.dataset.sectionid; const sectionTarget = sectionId.replace('Section', '');
                if (sectionId) {
                    fillSectionPositiveOrDefaults(sectionId);
                    if (saveProgress(targaSelezionataGlobalmente)) { // Salva e prova a navigare
                        let currentSectionIndex = -1;
                        navButtons.forEach((nb, index) => { if (nb.dataset.target === sectionTarget) currentSectionIndex = index; });
                        if (currentSectionIndex !== -1 && currentSectionIndex < navButtons.length - 1) {
                            const nextNavButton = navButtons[currentSectionIndex + 1];
                            if (nextNavButton && nextNavButton.dataset.target) showSection(nextNavButton.dataset.target);
                        }
                    }
                }
            });
        });
        // Listener per bottoni "Azzera Pagina"
        document.querySelectorAll('.reset-page-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.dataset.sectionid;
                if (sectionId) {
                    if (confirm(`Sei sicuro di voler azzerare tutti i campi in "${sectionId.replace('Section', '')}"?`)) {
                        resetSectionFields(sectionId);
                    }
                }
            });
        });

        if (tipoTrazioneSelect) tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);

        // Listener per il dropdown di cambio targa
        targaSwitcherDropdown.addEventListener('change', async function() {
            const nuovaTargaSelezionata = this.value;
            if (nuovaTargaSelezionata && nuovaTargaSelezionata.toUpperCase() !== (targaSelezionataGlobalmente ? targaSelezionataGlobalmente.toUpperCase() : null)) {
                this.disabled = true; // Disabilita durante il caricamento
                if (galleryPageSection.style.display === 'block') { // Se siamo in galleria
                    const currentSectionForNewTarga = currentGallerySectionFilter || 'riepilogo'; 
                    targaSelezionataGlobalmente = nuovaTargaSelezionata.toUpperCase(); // Aggiorna targa globale
                    await showGalleryPage(targaSelezionataGlobalmente, currentSectionForNewTarga); // Ricarica galleria
                } else { // Se siamo nella checklist
                    let currentActiveSectionId = 'remarketing'; // Default
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    if (activeSectionElement && activeSectionElement.id) {
                        currentActiveSectionId = activeSectionElement.id.replace('Section', '');
                    }
                    await handleTargaSelectionAndSync(nuovaTargaSelezionata, currentActiveSectionId); // Carica nuova targa e sezione
                }
                this.disabled = false; // Riabilita dropdown
            } else if (nuovaTargaSelezionata) { updateTargaDetailsDisplay(nuovaTargaSelezionata); } // Solo aggiorna dettagli se targa non cambia
        });

        // Listener per bottoni di utility (Elenco, Cronistoria, etc.)
        if(backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if(historyBtn) historyBtn.addEventListener('click', () => showView('history'));
        if(clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', clearAllSavedData);
        if(backToLandingFromHistoryBtn) backToLandingFromHistoryBtn.addEventListener('click', () => showView('landing'));

        // Listener per bottone "Torna all'Elenco" dalla galleria
        if(backToMainFromGalleryBtn) {
             backToMainFromGalleryBtn.addEventListener('click', () => {
                // Torna alla vista precedente alla galleria (checklist o landing)
                if (lastViewBeforeGallery === 'checklist' && currentGalleryTargaFilter && lastSectionBeforeGallery) {
                    if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) { // Sincronizza targa globale se necessario
                         targaSelezionataGlobalmente = currentGalleryTargaFilter;
                         loadProgress(targaSelezionataGlobalmente); // Carica progressi per la targa
                    }
                    showView('checklist'); showSection(lastSectionBeforeGallery); // Mostra checklist e sezione corretta
                } else { showView('landing'); } // Altrimenti torna a landing
            });
        }

        if(saveAndReturnBtn) saveAndReturnBtn.addEventListener('click', handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button=>button.addEventListener('click',handleSaveAndNext));

        // Listener per bottoni nella barra di navigazione inferiore (headerCircles)
        if (headerExitBtn) headerExitBtn.addEventListener('click', () => triggerMainExit());
        
        // *** MODIFICA CHIAVE PER NAVIGAZIONE GALLERIA DA FOTOCAMERA ***
        if (headerPhotosBtn) {
            headerPhotosBtn.addEventListener('click', async () => {
                let targaForGalleryTarget = null;
                let sectionKeyForGalleryTarget = null;

                if (cameraPageSection.style.display === 'flex') { // Se la fotocamera è ATTIVA
                    // Determina il contesto da *prima* che la fotocamera fosse aperta
                    if (lastViewBeforeCamera === 'checklist' && targaSelezionataGlobalmente) {
                        targaForGalleryTarget = targaSelezionataGlobalmente;
                        sectionKeyForGalleryTarget = lastSectionBeforeCamera; // Es. 'remarketing', 'pneumatici'
                    } else if (lastViewBeforeCamera === 'gallery') {
                        // Se la fotocamera è stata aperta dalla galleria, usa i filtri di quella galleria
                        targaForGalleryTarget = currentGalleryTargaFilter; 
                        sectionKeyForGalleryTarget = lastSectionBeforeCamera;
                    }
                    // Se la fotocamera è stata aperta da landing/history, targa e sezione target rimarranno null (galleria generale)

                    returnFromCamera(); // Chiudi la fotocamera PRIMA di navigare alla galleria

                    // Aspetta un breve momento per permettere alla UI di aggiornarsi dopo la chiusura della fotocamera
                    setTimeout(async () => {
                        // Se sectionKeyForGalleryTarget è null (es. da landing, o galleria mostrava "tutte le foto per targa"),
                        // showGalleryPage lo interpreterà correttamente come "tutte le foto per la targa data" o "galleria generale".
                        // Default a 'riepilogo' se la sezione non è definita, per mostrare tutte le foto della targa.
                        await showGalleryPage(targaForGalleryTarget, sectionKeyForGalleryTarget || 'riepilogo');
                    }, 50); 
                } else if (checklistContainer.style.display === 'block' && targaSelezionataGlobalmente) {
                    // Fotocamera NON attiva, siamo nella checklist per una targa specifica
                    targaForGalleryTarget = targaSelezionataGlobalmente;
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    sectionKeyForGalleryTarget = activeSectionElement ? activeSectionElement.id.replace('Section', '') : 'riepilogo';
                    await showGalleryPage(targaForGalleryTarget, sectionKeyForGalleryTarget);
                } else if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter){
                    // Fotocamera NON attiva, siamo già in una galleria specifica per targa
                    // Ricarica o resta (la logica attuale ricarica con gli stessi filtri o default)
                    await showGalleryPage(currentGalleryTargaFilter, currentGallerySectionFilter || 'riepilogo');
                } else {
                    // Fallback: fotocamera non attiva, non in checklist, non in galleria specifica -> mostra galleria generale
                    await showGalleryPage(null, null);
                }
            });
        }

        if (headerPeriziaBtn) {
            headerPeriziaBtn.addEventListener('click', async () => {
                if (cameraPageSection.style.display === 'flex') { // Se la fotocamera è attiva
                    returnFromCamera(); // Chiudi la fotocamera
                     // Dopo aver chiuso la fotocamera, vai alla perizia come da logica precedente
                    setTimeout(async () => { // Timeout per permettere a returnFromCamera di completare
                        if (lastViewBeforeCamera === 'checklist' && targaSelezionataGlobalmente && lastSectionBeforeCamera) {
                            showView('checklist');
                            showSection(lastSectionBeforeCamera);
                        } else if (targaSelezionataGlobalmente) { // Se c'era una targa globale attiva prima della camera
                            const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY) || 'riepilogo';
                            await handleTargaSelectionAndSync(targaSelezionataGlobalmente, lastActivePage);
                        } else { // Altrimenti, vai a landing
                            showView('landing');
                        }
                    }, 50);
                } else if (galleryPageSection.style.display === 'block') { // Se siamo in galleria
                    // Torna alla vista precedente alla galleria (checklist o landing)
                    if (lastViewBeforeGallery === 'checklist' && currentGalleryTargaFilter && lastSectionBeforeGallery) {
                        if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) {
                            targaSelezionataGlobalmente = currentGalleryTargaFilter; loadProgress(targaSelezionataGlobalmente);
                        }
                        showView('checklist'); showSection(lastSectionBeforeGallery);
                    } else if (targaSelezionataGlobalmente){ // Se c'è una targa globale (anche se la galleria era generale)
                        const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY) || 'riepilogo';
                        await handleTargaSelectionAndSync(targaSelezionataGlobalmente, lastActivePage);
                    }
                    else { showView('landing'); } // Fallback a landing
                } else if (targaSelezionataGlobalmente) { // Se siamo in un'altra vista (es. landing) ma c'è una targa attiva
                    const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY);
                    const targetSection = (lastActivePage && document.getElementById(lastActivePage + 'Section')) ? lastActivePage : 'riepilogo';
                    // Se non siamo già nella checklist per questa targa, caricala
                    if (checklistContainer.style.display !== 'block' || targaSwitcherDropdown.value.toUpperCase() !== targaSelezionataGlobalmente.toUpperCase()) {
                        await handleTargaSelectionAndSync(targaSelezionataGlobalmente, targetSection);
                    } else { showSection(targetSection); } // Altrimenti mostra solo la sezione
                } else { showView('landing'); } // Fallback a landing
            });
        }
        if (headerCameraBtn) {
            headerCameraBtn.addEventListener('click', () => {
                if (cameraPageSection.style.display === 'flex') { // Se la fotocamera è già attiva
                    returnFromCamera(); // Chiudila
                } else {
                    showView('camera'); // Altrimenti aprila (showView chiamerà showCameraPage)
                }
            });
        }

        if (captureBtn) captureBtn.addEventListener('click', capturePhoto);
        if (closeCameraBtn) closeCameraBtn.addEventListener('click', returnFromCamera);

        // Listener per i pulsanti di navigazione delle sezioni (Remarketing, Pneumatici, etc.)
        navButtons.forEach(b => b.addEventListener('click', async function() {
            const targetId = this.dataset.target;
            if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter) {
                // Se siamo in galleria per una targa, cambia il filtro sezione della galleria
                currentGallerySectionFilter = targetId;
                await showGalleryPage(currentGalleryTargaFilter, currentGallerySectionFilter);
            } else if (checklistContainer.style.display === 'block' || (!targaSelezionataGlobalmente && landingPageSection.style.display === 'block')) {
                // Se siamo nella checklist, o in landing senza targa attiva (improbabile qui), mostra la sezione
                showSection(targetId);
            } else if (targaSelezionataGlobalmente) { // Se nessuna sezione attiva ma c'è una targa, apri la checklist a quella sezione
                await handleTargaSelectionAndSync(targaSelezionataGlobalmente, targetId);
            }
        }));


        if (closeLightboxBtnElem) closeLightboxBtnElem.addEventListener('click', closeImageLightbox);
        if (imageLightbox) { // Listener per chiudere lightbox cliccando sullo sfondo
            imageLightbox.addEventListener('click', function(event) { if (event.target === imageLightbox) closeImageLightbox(); });
            // Listener per swipe nella lightbox
            imageLightbox.addEventListener('touchstart', handleLightboxTouchStart, { passive: false }); // passive:false per preventDefault potenziale
            imageLightbox.addEventListener('touchend', handleLightboxTouchEnd, { passive: true });
        }
        // Listener per swipe tra sezioni
        const mainWrapper = document.getElementById('mainContentWrapper');
        if (mainWrapper) {
            mainWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
            mainWrapper.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        // Listener per gestione overscroll/pull-to-refresh nella galleria
        if (galleryPageSection) {
            galleryPageSection.addEventListener('touchstart', handleGalleryGridTouchStart, { passive: true });
            galleryPageSection.addEventListener('touchmove', handleGalleryGridTouchMove, { passive: false }); // passive:false per preventDefault
        }

        initializeApplicationViewAndLoadData(); // Inizializza l'app

        // Gestione uscita dall'app (Macrodroid)
        if (mainExitAppBtn) {
            mainExitAppBtn.addEventListener('click', () => {
                const exitCurtain = document.getElementById('exit-curtain');
                const mainContentWrapper = document.getElementById('mainContentWrapper');
                const pageHeader = document.getElementById('pageHeaderContainer');
                const bottomNav = document.getElementById('bottomNavCircles');
                if (exitCurtain) {
                    if (mainContentWrapper) mainContentWrapper.style.display = 'none';
                    if (pageHeader) pageHeader.style.display = 'none';
                    if (bottomNav) bottomNav.style.display = 'none';
                    if (cameraPageSection && cameraPageSection.style.display === 'flex') { // Assicurati di chiudere la camera
                        if (currentCameraStream) { currentCameraStream.getTracks().forEach(track => track.stop()); currentCameraStream = null; if(cameraStreamElement) cameraStreamElement.srcObject = null; }
                        cameraPageSection.style.display = 'none';
                    }
                    document.body.style.paddingTop = '0px'; document.body.style.paddingBottom = '0px'; // Resetta padding
                    const exitLoadingText = exitCurtain.querySelector('.loading-text');
                    const barContainer = exitCurtain.querySelector('.loader-bar-container');
                    const defaultCloseText = "CHIUSURA IN CORSO..."; const glitchText = "ERRORE DI SISTEMA...";
                    exitCurtain.classList.remove('glitching', 'flash-out-effect');
                    if (exitLoadingText) { exitLoadingText.textContent = defaultCloseText; exitLoadingText.style.animation = 'textGlow 1.8s infinite alternate ease-in-out'; exitLoadingText.style.color = '#ff8787'; exitLoadingText.style.textShadow = ''; }
                    exitCurtain.setAttribute('data-text', defaultCloseText);
                    if (barContainer) barContainer.style.display = 'flex';
                    exitCurtain.classList.add('visible-no-transition'); exitCurtain.style.display = 'flex';
                    // Animazione di uscita
                    setTimeout(() => {
                        exitCurtain.classList.add('glitching');
                        if (exitLoadingText) { exitLoadingText.textContent = glitchText; exitLoadingText.style.animation = ''; }
                        exitCurtain.setAttribute('data-text', glitchText);
                        setTimeout(() => {
                            exitCurtain.classList.remove('glitching');
                            if (exitLoadingText) { exitLoadingText.textContent = 'Applicazione terminata.'; exitLoadingText.style.animation = 'none';  exitLoadingText.style.color = '#FFFFFF';  exitLoadingText.style.textShadow = 'none'; }
                            if (barContainer) barContainer.style.display = 'none';
                            setTimeout(() => {
                                exitCurtain.classList.add('flash-out-effect');
                                setTimeout(() => { // Chiamata a Macrodroid
                                    const macrodroidUrl = 'https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi';
                                    fetch(macrodroidUrl, { method: 'GET', mode: 'no-cors' }).catch(error => console.error('Errore chiamata Macrodroid:', error));
                                }, 500);
                            }, 700);
                        }, 800);
                    }, 800);
                }
            });
        }
    });
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
