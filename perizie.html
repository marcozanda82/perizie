<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perizia Veicolo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #23272a;
            --card-bg-color: #2c2f33;
            --input-bg-color: #36393f;
            --text-color: #e1e1e1;
            --text-muted-color: #99aab5;
            --primary-accent-color: #61daff;
            --primary-accent-color-darker: #4cb8e0; /* For hover/active states */
            --border-color: #4f545c;
            --border-radius-small: 4px;
            --border-radius-medium: 6px;
            --border-radius-large: 8px;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --font-family-main: 'Roboto', 'Segoe UI', Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;

            --success-color: #43b581;
            --success-color-darker: #3aa170;
            --warning-color: #faa61a;
            --warning-color-darker: #e0900a;
            --danger-color: #f04747;
            --danger-color-darker: #d83f3f;
            --info-color: #7289da;
            --info-color-darker: #5b6eae;
            --secondary-color: #8e9297;
            --secondary-color-darker: #7a7e83;
        }

        /* Preloader & Exit Curtain Styles (Unchanged) */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 1; visibility: visible; }
        #preloader.hidden { opacity: 0; visibility: hidden; transition: opacity 0.7s ease-out, visibility 0.7s ease-out; }
        #exit-curtain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in, visibility 0.5s ease-in; }
        #exit-curtain.hidden { opacity: 0; visibility: hidden; transition: opacity 0.7s ease-out, visibility 0.7s ease-out; }
        #exit-curtain.visible-no-transition { opacity: 1; visibility: visible; transition: none; }
        .loader-bar-container { display: flex; gap: 10px; margin-bottom: 25px; }
        .loader-bar { width: 15px; height: 70px; background-color: var(--primary-accent-color); animation: barPulse 1.2s infinite ease-in-out; box-shadow: 0 0 8px var(--primary-accent-color), 0 0 15px #00aeff; border-radius: 3px; }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }
        #exit-curtain:not(.glitching):not(.flash-out-effect) .loader-bar { animation-direction: reverse; }
        #exit-curtain.glitching:not(.flash-out-effect) .loader-bar { animation-direction: normal; }
        @keyframes barPulse { 0%, 100% { transform: scaleY(0.3); opacity: 0.6; } 50% { transform: scaleY(1); opacity: 1; } }
        #preloader .loading-text, #exit-curtain .loading-text { font-size: 1.6em; letter-spacing: 1px; font-family: var(--font-family-main); }
        #preloader .loading-text { color: var(--primary-accent-color); animation: textGlow 1.8s infinite alternate ease-in-out; }
        #exit-curtain .loading-text { color: #ff8787; }
        @keyframes textGlow { from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 0.8;} to { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; opacity: 1;} }
        #exit-curtain.glitching .loading-text { animation: glitchText 0.8s infinite steps(1, end), textGlow 1.8s infinite alternate ease-in-out; color: #ff3030 !important; position: relative; z-index: 10; }
        #exit-curtain.glitching::before, #exit-curtain.glitching::after { content: attr(data-text); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: auto; padding: 0 20px; text-align: center; font-size: 1.6em; letter-spacing: 1px; background: #111; overflow: hidden; clip-path: inset(50% 50% 50% 50%); z-index: 5; }
        #exit-curtain.glitching::before { color: #00ffff; animation: glitchEffect 0.3s infinite linear alternate-reverse; }
        #exit-curtain.glitching::after { color: #ff00ff; animation: glitchEffect 0.2s infinite linear alternate-reverse, glitchSkew 0.5s infinite linear alternate; animation-delay: -0.1s; }
        @keyframes glitchEffect {0%{clip-path:inset(40% 0 30% 0);transform:translate(-50.5%,-50.1%) skewX(5deg);opacity:.8}10%{clip-path:inset(20% 0 70% 0);transform:translate(-50%,-50%) skewX(0);opacity:.7}20%{clip-path:inset(10% 0 55% 0);transform:translate(-49.8%,-50.2%) skewX(-3deg);opacity:.9}30%{clip-path:inset(50% 0 50% 0);transform:translate(-50%,-50%) skewX(0);opacity:.6}40%{clip-path:inset(60% 0 10% 0);transform:translate(-50.2%,-49.9%) skewY(2deg);opacity:1}50%{clip-path:inset(80% 0 5% 0);transform:translate(-50%,-50%) skewX(0);opacity:.75}60%{clip-path:inset(25% 0 40% 0);transform:translate(-50.1%,-50.3%) skewX(4deg);opacity:.85}70%{clip-path:inset(15% 0 75% 0);transform:translate(-50%,-50%) skewX(0);opacity:.9}80%{clip-path:inset(50% 0 20% 0);transform:translate(-49.9%,-49.8%) skewY(-3deg);opacity:1}90%{clip-path:inset(70% 0 10% 0);transform:translate(-50%,-50%) skewX(0);opacity:.6}100%{clip-path:inset(35% 0 45% 0);transform:translate(-50.3%,-50%) skewX(-2deg);opacity:.8}}
        @keyframes glitchSkew { 0% { transform: translate(-50%, -50%) skew(-5deg, -2deg); } 100% { transform: translate(-50%, -50%) skew(5deg, 2deg); } }
        @keyframes glitchText {0%,100%{text-shadow:0 0 3px red,0 0 5px blue,0 0 1px #fff;transform:translateX(0) translateY(0) skewX(0);opacity:1}10%{text-shadow:1px 1px 3px red,-1px -1px 5px blue,0 0 1px #fff;transform:translateX(-2px) translateY(1px) skewX(5deg);opacity:.8}90%{text-shadow:1px 1px 3px red,-1px -1px 5px blue,0 0 1px #fff;transform:translateX(-1px) translateY(1px) skewX(1deg);opacity:.9}}
        #exit-curtain.flash-out-effect .loading-text { color: #FFF !important; text-shadow: none !important; animation: textFlashOut 0.5s forwards ease-out; transform-origin: center center; }
        @keyframes textFlashOut {0%{opacity:1;transform:scale(1);text-shadow:0 0 5px rgba(255,255,255,.5)}50%{opacity:1;transform:scale(1.1);color:#FFFFE0 !important;text-shadow:0 0 15px #fff,0 0 25px #fff,0 0 35px #FFFFE0,0 0 50px #FFFF99}99%{opacity:.8;transform:scale(1.05)}100%{opacity:0;transform:scale(.8);text-shadow:none;color:transparent !important}}

        body {
            font-family: var(--font-family-main);
            line-height: 1.6;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: padding-top 0.3s ease;
        }
        .content-wrapper {
            padding: 20px;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }
        h1, h2, h3, h4 {
            text-align: center;
            color: var(--text-color);
            font-weight: 500;
        }
        h1#mainTitleGlobal {
            line-height: 1.3;
            margin-bottom: 10px;
            margin-top: 5px;
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        h1#mainTitleGlobal span {
            font-size: 0.6em !important;
            color: var(--text-muted-color) !important;
            font-weight: 400 !important;
            display: block;
            margin-top: 4px;
            line-height: 1.2;
        }
        h2.section-title {
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-top: 25px;
            margin-bottom: 20px;
            text-align: left;
            font-size: 1.5em;
            font-weight: 500;
        }
        h3 { font-size: 1.3em; margin-top: 25px; margin-bottom: 15px; font-weight: 500; text-align: left;}
        h4 { font-size: 1.15em; color: var(--text-muted-color); margin-top: 20px; margin-bottom: 10px; font-weight: 500; text-align: left;}

        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 18px; }

        input[type="checkbox"], input[type="text"], input[type="url"], select, input[type="radio"], textarea {
            vertical-align: middle;
            padding: 10px 12px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            margin-bottom: 8px;
            font-family: var(--font-family-main);
            font-size: 0.95em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"], input[type="url"], textarea {
            width: calc(100% - 26px);
            box-sizing: border-box;
        }
        input[type="radio"] { margin-left: 5px; margin-right: 5px; }
        select { min-width: 240px; }
        label {
            vertical-align: middle;
            display: block;
            margin-bottom: 6px;
            color: var(--text-muted-color);
            font-size: 0.9em;
            font-weight: 500;
        }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-accent-color);
            box-shadow: 0 0 0 3px rgba(97, 218, 255, 0.25);
        }
        .category-section ul li > input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: var(--primary-accent-color);
        }
        .category-section ul li > input[type="checkbox"] + label {
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 0;
            color: var(--text-color);
            font-weight: 400;
            font-size: 0.95em;
        }

        #pageHeaderContainer {
            background-color: var(--card-bg-color);
            z-index: 1000;
            width: 100%;
            padding-bottom: 5px;
            box-shadow: 0 2px 8px var(--shadow-medium);
        }
        #pageHeaderContainer.fixed-header {
            position: fixed;
            top: 0;
            left: 0;
        }

        .header-circles {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 10px 0 8px 0;
            gap: 12px;
            box-sizing: border-box;
        }
        .circle {
            width: 10px;
            height: 10px;
            background-color: var(--text-muted-color);
            border-radius: 50%;
            flex-shrink: 0;
            opacity: 0.5;
            transition: opacity 0.3s ease, background-color 0.3s ease, transform 0.2s ease;
        }
        .header-circles:hover .circle { opacity: 0.7; }
        .circle:hover { opacity: 1; background-color: var(--primary-accent-color); transform: scale(1.2); }

        #navButtons { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: 5px; }
        /* Striscia Utility Buttons (Elenco, Salvataggi, Esci) - ora viene prima */
        #utilityNavButtons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 8px; /* Spazio prima della prossima striscia */
            gap: 8px;
        }
         /* Striscia Main Page Nav Buttons (Sezioni perizia) */
        #mainPageNavButtons {
            display: flex;
            justify-content: center;
            flex-wrap: nowrap; /* Mantiene su una linea, scrollabile */
            overflow-x: auto; /* Permette scroll orizzontale se i bottoni eccedono */
            padding: 5px 0; /* Leggero padding verticale */
            width: calc(100% - 30px); /* Larghezza per contenere lo scroll */
            max-width: 750px; /* Massima larghezza per desktop */
        }

        #mainPageNavButtons button {
            margin: 0 5px;
            flex-shrink: 0;
            position: relative;
            padding: 10px 18px;
        }
        #mainPageNavButtons button::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: var(--primary-accent-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        #mainPageNavButtons button.active::after { width: 60%; }


        #navButtons button, .action-button {
            padding: 10px 18px;
            cursor: pointer;
            background-color: var(--info-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-medium);
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px var(--shadow-light);
        }
        #navButtons button:hover, .action-button:hover {
            box-shadow: 0 3px 7px var(--shadow-medium);
            transform: translateY(-1px);
        }
        #navButtons button:active, .action-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px var(--shadow-light);
        }

        .save-and-next-btn { background-color: var(--info-color) !important; }
        .save-and-next-btn:hover { background-color: var(--info-color-darker) !important; }

        #navButtons button.active { /* Si applica ai bottoni di #mainPageNavButtons */
            background-color: var(--info-color-darker) !important;
            color: white !important;
            box-shadow: inset 0 1px 3px var(--shadow-light), 0 1px 2px var(--shadow-light) !important;
        }
        #navButtons button.active::after { width: 60%; }

        #navButtons button.nav-btn-completed { background-color: var(--success-color) !important; }
        #navButtons button.nav-btn-completed:hover { background-color: var(--success-color-darker) !important; }
        #navButtons button.nav-btn-partial { background-color: var(--warning-color) !important; color: var(--bg-color) !important; }
        #navButtons button.nav-btn-partial:hover { background-color: var(--warning-color-darker) !important; }
        #navButtons button.nav-btn-untouched { background-color: var(--danger-color) !important; }
        #navButtons button.nav-btn-untouched:hover { background-color: var(--danger-color-darker) !important; }

        #backToListBtn { background-color: var(--secondary-color) !important; }
        #backToListBtn:hover { background-color: var(--secondary-color-darker) !important; }
        #historyBtn { background-color: #5bc0de !important; }
        #historyBtn:hover { background-color: #46b8da !important; }
        #exitAppBtn, #clearAllProgressBtn { background-color: var(--danger-color) !important; }
        #exitAppBtn:hover, #clearAllProgressBtn:hover { background-color: var(--danger-color-darker) !important; }
        #saveAndReturnBtn { background-color: var(--success-color) !important; }
        #saveAndReturnBtn:hover { background-color: var(--success-color-darker) !important; }


        #landingPageSection, .category-section, #historyPageSection {
            padding: 25px;
            padding-top: 35px;
            border: none;
            border-radius: var(--border-radius-large);
            margin-top: 25px;
            background-color: var(--card-bg-color);
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 12px var(--shadow-medium);
            position: relative;
        }
        .category-section, #historyPageSection { display: none; }
        #landingPageSection { display: block; padding-top: 25px; }
        .category-section.active { display: block; }

        .fill-defaults-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            width: 40px;
            height: 40px;
            background-color: var(--primary-accent-color);
            color: var(--bg-color);
            border: none;
            border-radius: var(--border-radius-medium);
            font-size: 1.7em;
            font-weight: bold;
            line-height: 1;
            cursor: pointer;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 6px var(--shadow-dark);
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }
        .fill-defaults-btn:hover {
            background-color: var(--primary-accent-color-darker);
            box-shadow: 0 4px 10px var(--shadow-dark);
        }
        .fill-defaults-btn:active {
            transform: translateY(1px) scale(0.95);
            box-shadow: 0 1px 3px var(--shadow-medium);
        }


        .summary-item {
            margin-bottom: 10px; padding: 12px; background-color: var(--input-bg-color);
            border-radius: var(--border-radius-medium); border-left: 4px solid var(--border-color);
        }
        .summary-item strong { color: var(--primary-accent-color); font-weight: 500; }
        .summary-anomaly {
            background-color: rgba(240, 71, 71, 0.15) !important;
            border-left-color: var(--danger-color) !important;
            color: var(--text-color) !important;
        }
        .summary-anomaly strong { color: var(--danger-color) !important; }
        .summary-notes {
            background-color: rgba(97, 218, 255, 0.1) !important;
            border-left-color: var(--primary-accent-color) !important;
            color: var(--text-color) !important;
        }
        .summary-notes strong { color: var(--primary-accent-color) !important; }
        .summary-notes div { white-space: pre-wrap; padding-left: 10px; margin-top: 5px; font-size: 0.95em; }


        .table-scroll-wrapper {
            overflow-x: auto; width: 100%; margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            background-color: var(--input-bg-color);
        }
        .targa-list-table-content { min-width: 750px; }
        .targa-list-header {
            display: flex; font-weight: 500;
            padding: 0 10px; border-bottom: 2px solid var(--border-color);
            color: var(--text-muted-color); background-color: var(--bg-color);
            font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .targa-list-header .targa-col { padding: 10px 12px; border-right: 1px solid var(--bg-color); }
        .targa-list-header .targa-col:last-child { border-right: none; }

        #targaListContainer { margin-top: 0; max-height: 400px; overflow-y: auto; padding: 0; }
        .targa-list-item {
            display: flex; align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding: 0 10px;
            transition: background-color 0.2s ease;
        }
        .targa-list-item:last-child { border-bottom: none; }
        .targa-list-item:hover { background-color: rgba(97, 218, 255, 0.05); }

        .targa-list-item .targa-col {
            padding: 10px 12px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-right: 1px solid var(--border-color);
            text-align: left; flex-grow: 1; display: flex; align-items: center;
            font-size: 0.9em;
        }
        .targa-list-item .targa-col:last-child { border-right: none; }

        .targa-col-urgente { flex-basis: 8%; min-width: 60px; justify-content: center; }
        .targa-col-urgente input[type="checkbox"] { transform: scale(1.3); accent-color: var(--danger-color); margin:0; }
        .targa-col-targa    { flex-basis: 15%; min-width: 90px;}
        .targa-col-targa.clickable-targa {
            cursor: pointer; color: var(--primary-accent-color); font-weight: 500;
            transition: color 0.2s ease, text-decoration 0.2s ease;
        }
        .targa-list-item:hover .targa-col-targa.clickable-targa { color: #82e9ff; text-decoration: underline; }
        .targa-col-posizione{ flex-basis: 12%; min-width: 70px; padding: 6px !important; }
        .targa-col-marca    { flex-basis: 20%; min-width: 100px;}
        .targa-col-modello  { flex-basis: 25%; min-width: 120px;}
        .targa-col-piazzale { flex-basis: 15%; min-width: 90px;}
        .targa-col-actions  { flex-basis: 5%; min-width: 50px; text-align: center; flex-grow: 0; }

        .targa-col-posizione input.posizione-input {
            width: 100%; padding: 8px 6px; margin: 0; box-sizing: border-box;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-small);
            font-size: 0.9em; text-align: center;
        }
        .targa-col-posizione input.posizione-input:focus { background-color: #3e4247; border-color: var(--primary-accent-color); }

        .delete-progress-btn {
            background-color: transparent; border: 1px solid var(--danger-color); color: var(--danger-color);
            padding: 5px 9px; font-size: 0.9em; line-height: 1; border-radius: var(--border-radius-small);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .delete-progress-btn:hover { background-color: var(--danger-color); color: white; }


        .targa-list-item.status-da-vedere { background-color: transparent; }
        .targa-list-item.status-da-vedere:hover { background-color: rgba(97, 218, 255, 0.05); }
        .targa-list-item.status-da-vedere .targa-col { color: var(--text-color); }
        .targa-list-item.status-da-vedere .targa-col-targa.clickable-targa { color: var(--primary-accent-color); }

        .targa-list-item.status-visto { background-color: rgba(67, 181, 129, 0.1); }
        .targa-list-item.status-visto:hover { background-color: rgba(67, 181, 129, 0.18); }
        .targa-list-item.status-visto .targa-col { color: #b8e0c7; }
        .targa-list-item.status-visto .targa-col-targa.clickable-targa { color: var(--success-color); }

        .targa-list-item.urgent-item {
            background-color: rgba(240, 71, 71, 0.1) !important;
            border-left: 4px solid var(--danger-color);
        }
        .targa-list-item.urgent-item:hover { background-color: rgba(240, 71, 71, 0.18) !important; }
        .targa-list-item.urgent-item .targa-col { color: #f5b5b5 !important; }
        .targa-list-item.urgent-item .targa-col-targa.clickable-targa { color: var(--danger-color) !important; }

        .targa-list-item.completed .targa-col { color: var(--text-muted-color) !important; }
        .targa-list-item.status-visto.completed .targa-col { color: #8bbd9f !important; }
        .targa-list-item.status-visto.completed .targa-col-targa.clickable-targa { color: #6aa886 !important; }
        .targa-list-item.urgent-item.completed .targa-col { color: #b18888 !important; }
        .targa-list-item.urgent-item.completed .targa-col-targa.clickable-targa { color: #d87070 !important; }

        .targa-list-item.status-parziale { background-color: rgba(250, 166, 26, 0.1); }
        .targa-list-item.status-parziale:hover { background-color: rgba(250, 166, 26, 0.18); }
        .targa-list-item.status-parziale .targa-col { color: #f8d99b !important; }
        .targa-list-item.status-parziale .targa-col-targa.clickable-targa { color: var(--warning-color) !important; }


        #targheLoadingStatus { text-align: center; padding: 15px; color: var(--text-muted-color); font-size: 1.05em; }
        #savedTargasListContainer {
            display: flex; flex-direction: column; gap: 10px; max-height: 450px; overflow-y: auto;
            padding: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius-medium); margin-bottom: 20px;
        }
        .saved-targa-button {
            display: block; width: 100%; padding: 12px 15px;
            background-color: var(--input-bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-medium);
            text-align: left; cursor: pointer; font-size: 0.95em;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .saved-targa-button:hover { background-color: #3e4247; border-color: var(--primary-accent-color); }

        #historyPageSection .action-button { margin-right: 10px; }
        #sheetFilterContainer { margin-bottom: 20px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #sheetFilterContainer label { margin-right: 0; color: var(--text-muted-color); font-size: 0.9em; }
        #sheetFilterDropdown {
            padding: 10px 12px; background-color: var(--input-bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-medium);
            min-width: 280px; vertical-align: middle; font-size: 0.95em;
        }

        .animate-me {
            animation: pulseHighlight 1.5s infinite alternate;
            outline: 2px solid rgba(97, 218, 255, 0);
            transition: outline 0.3s ease, box-shadow 0.3s ease;
        }
        @keyframes pulseHighlight {
            from { outline-color: rgba(97, 218, 255, 0.8); box-shadow: 0 0 8px rgba(97, 218, 255, 0.6), 0 0 10px rgba(97, 218, 255, 0.4) inset; }
            to   { outline-color: rgba(97, 218, 255, 0.4); box-shadow: 0 0 15px rgba(97, 218, 255, 0.9), 0 0 15px rgba(97, 218, 255, 0.6) inset; }
        }
        input[type="checkbox"].animate-me, select.animate-me { position: relative; z-index: 1; }

        @media (max-width: 768px) {
            .content-wrapper { padding: 15px; }
            h1#mainTitleGlobal { font-size: 1.6em; }
            h2.section-title { font-size: 1.3em; margin-top: 20px; }
             #pageHeaderContainer { padding-bottom: 8px; }
            .header-circles { padding: 8px 0 5px 0; gap: 10px;}
            .circle { width: 8px; height: 8px; }

            #navButtons button, .action-button { padding: 9px 12px; font-size: 0.85em; }
            #mainPageNavButtons { width: calc(100% - 10px); padding: 5px; }
            #mainPageNavButtons button { font-size: 0.8em; padding: 8px 10px; margin: 0 3px; }
            #utilityNavButtons { margin-bottom: 5px; } /* Ridotto spazio sotto utility buttons su mobile */


            input[type="text"], input[type="url"], select, textarea { width: 100%; box-sizing: border-box; font-size: 0.9em; }
            .table-scroll-wrapper { overflow-x: auto; }
            .targa-list-table-content { min-width: 680px; }
            .targa-list-header .targa-col, .targa-list-item .targa-col { padding: 8px 6px; font-size:0.85em; }
            .delete-progress-btn { padding: 5px 8px; font-size: 0.8em;}
            .targa-col-urgente { min-width: 50px; }
            .targa-col-targa    { min-width: 70px;}
            .targa-col-posizione{ min-width: 55px;}
            .targa-col-marca    { min-width: 75px;}
            .targa-col-modello  { min-width: 85px;}
            .targa-col-piazzale { min-width: 65px;}
            .targa-col-actions  { min-width: 40px; }
            #sheetFilterContainer { flex-direction: column; align-items: stretch; gap: 8px;}
            #sheetFilterDropdown { width: 100%; min-width: auto; }
            .fill-defaults-btn { top: 12px; right: 15px; width: 34px; height: 34px; font-size: 1.4em; }
            #landingPageSection, .category-section, #historyPageSection { padding: 20px; padding-top: 30px;}
            #landingPageSection { padding-top: 20px;}
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container"><div class="loader-bar"></div><div class="loader-bar"></div><div class="loader-bar"></div></div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>
    <div id="exit-curtain" data-text="CHIUSURA IN CORSO...">
        <div class="loader-bar-container"><div class="loader-bar"></div><div class="loader-bar"></div><div class="loader-bar"></div></div>
        <div class="loading-text">CHIUSURA IN CORSO...</div>
    </div>

    <div id="pageHeaderContainer">
        <div class="header-circles">
            <div class="circle"></div><div class="circle"></div><div class="circle"></div><div class="circle"></div>
        </div>
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>
        <div id="navButtons">
            <div id="utilityNavButtons">
                <button id="backToListBtn" class="action-button">Elenco Targhe</button>
                <button id="historyBtn" class="action-button">Salvataggi</button>
                <button id="exitAppBtn" class="action-button">Esci</button>
            </div>
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;">
            <h2 style="margin-top: 10px; text-align:left; border-bottom: none;">Seleziona Veicolo</h2>
            <div id="sheetFilterContainer">
                <label for="sheetFilterDropdown">Filtra per Piazzale:</label>
                <select id="sheetFilterDropdown">
                    <option value="all">Tutti i Piazzali</option>
                </select>
            </div>
            <div id="targheLoadingStatus">Caricamento targhe in corso...</div>
            <div class="table-scroll-wrapper">
                <div class="targa-list-table-content">
                    <div class="targa-list-header">
                        <span class="targa-col targa-col-targa">Targa</span>
                        <span class="targa-col targa-col-posizione">Pos.</span>
                        <span class="targa-col targa-col-marca">Marca</span>
                        <span class="targa-col targa-col-modello">Modello</span>
                        <span class="targa-col targa-col-piazzale">Piazzale</span>
                        <span class="targa-col targa-col-actions">Az.</span>
                    </div>
                    <div id="targaListContainer"></div>
                </div>
            </div>
        </div>

        <div id="checklistContainer" style="display: none;">
            <div id="remarketingSection" class="category-section">
                <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="remarketingSection">&#x2713;</button>
                <h2 class="section-title">1. Foto Remarketing</h2>
                <ul>
                    <li><label for="tipo_trazione">Trazione veicolo:</label><select id="tipo_trazione"><option value="">Seleziona...</option><option value="endotermico">Endotermico</option><option value="elettrico">Elettrico</option></select></li>
                    <li><input type="checkbox" id="foto_angolari"><label for="foto_angolari">Foto angolari (3/4)</label></li>
                    <li><input type="checkbox" id="foto_vano_carico"><label for="foto_vano_carico">Vano Carico</label></li>
                    <li><label for="tipo_equipaggiamento">Equipaggiamento:</label><select id="tipo_equipaggiamento"><option value="">Seleziona...</option><option value="kit_gonfia_ripara">Kit</option><option value="ruota">Ruota</option><option value="ruotino">Ruotino</option><option value="runflat">Runflat</option></select></li>
                    <li><label for="equipaggiamento_presenza">Presenza equip.:</label><select id="equipaggiamento_presenza"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_interni_pannelli"><label for="foto_interni_pannelli">Interni/pannelli</label></li>
                    <li><input type="checkbox" id="foto_cruscotto"><label for="foto_cruscotto">Cruscotto</label></li>
                    <li><label for="stato_chilometri">Chilometri - Stato:</label><select id="stato_chilometri"><option value="">Seleziona...</option><option value="rilevabili">Rilevabili</option><option value="non_rilevabili">Non rilevabili</option></select></li>
                    <li><label for="stato_cdc">CDC - Stato:</label><select id="stato_cdc"><option value="">Seleziona...</option><option value="originale">Originale</option><option value="copia_conforme">Copia conforme</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_vano_motore"><label for="foto_vano_motore">Vano motore</label></li>
                    <li><input type="checkbox" id="foto_cofano_tetto"><label for="foto_cofano_tetto">Cofano e tetto</label></li>
                    <li><label for="chiave_telecomando">Chiave con telecomando:</label><select id="chiave_telecomando"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="non_presente">Non Presente</option></select></li>
                    <li><label for="seconda_chiave">Seconda chiave:</label><select id="seconda_chiave"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="non_presente">Non Presente</option></select></li>
                    <li><label for="cavo_ricarica_rapida">Cavo ricarica rapida:</label><select id="cavo_ricarica_rapida" disabled><option value="">Seleziona...</option><option value="presente">Presente</option><option value="non_presente">Non Presente</option><option value="non_applicabile">Non Applicabile</option></select></li>
                    <li><label for="cavo_ricarica_domestica">Cavo ricarica domestica:</label><select id="cavo_ricarica_domestica" disabled><option value="">Seleziona...</option><option value="presente">Presente</option><option value="non_presente">Non Presente</option><option value="non_applicabile">Non Applicabile</option></select></li>
                </ul>
                <div style="text-align: right; margin-top: 25px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="pneumaticiSection" class="category-section">
                 <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="pneumaticiSection">&#x2713;</button>
                <h2 class="section-title">2. Foto Pneumatici</h2>
                <ul>
                    <li><label for="pneumatico_as">Ant. sinistro:</label><select id="pneumatico_as"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ad">Ant. destro:</label><select id="pneumatico_ad"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_pd">Post. destro:</label><select id="pneumatico_pd"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ps">Post. sinistro:</label><select id="pneumatico_ps"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                </ul>
                <div style="text-align: right; margin-top: 25px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="danniVerificheSection" class="category-section">
                <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="danniVerificheSection">&#x2713;</button>
                <h2 class="section-title">3. Foto Danni e Verifiche</h2>
                <ul>
                    <li><label for="motore_accende">Motore si accende:</label><select id="motore_accende"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><label for="batteria_stato">Batteria:</label><select id="batteria_stato"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><input type="checkbox" id="foto_danni_generiche"><label for="foto_danni_generiche">Altre foto danni</label></li>
                    <li><label for="note_danni_verifiche">Note Danni/Verifiche:</label><textarea id="note_danni_verifiche" rows="4"></textarea></li>
                </ul>
                <div style="text-align: right; margin-top: 25px;"><button class="action-button save-and-next-btn">Salva e Vai al Riepilogo</button></div>
            </div>
            <div id="riepilogoSection" class="category-section">
                <h2 class="section-title">Riepilogo Perizia</h2>
                <div id="summaryContent"><p><em>Compila le sezioni precedenti...</em></p></div>
                <button id="saveAndReturnBtn" class="action-button" style="margin-top: 20px;">Salva Perizia</button>
            </div>
        </div>

        <div id="historyPageSection" style="display: none;">
            <h2 class="section-title" style="text-align: center;">Cronistoria Salvataggi</h2>
            <div id="savedTargasListContainer"><p>Nessun salvataggio trovato.</p></div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="clearAllProgressBtn" class="action-button">Cancella Tutti i Salvataggi</button>
                <button id="backToLandingFromHistoryBtn" class="action-button">Elenco Targhe Principale</button>
            </div>
        </div>
    </div>
<script>
    // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer');
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons'); // Contenitore generale dei bottoni nav
    const mainPageNavButtonsDiv = navButtonsContainer.querySelector('#mainPageNavButtons'); // Div per bottoni sezioni
    const utilityNavButtonsDiv = navButtonsContainer.querySelector('#utilityNavButtons'); // Div per bottoni utility
    const navButtons = navButtonsContainer.querySelectorAll('#mainPageNavButtons button[data-target]');
    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const backToListBtn = pageHeaderContainer.querySelector('#backToListBtn');
    const historyBtn = pageHeaderContainer.querySelector('#historyBtn');
    const exitAppBtn = pageHeaderContainer.querySelector('#exitAppBtn');
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn');
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn');
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn');
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
    const tipoTrazioneSelect = document.getElementById('tipo_trazione');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';

    function hexToRgb(hex) {
        let r = 0, g = 0, b = 0;
        if (hex.length == 4) { r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3]; }
        else if (hex.length == 7) { r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6]; }
        return [+r, +g, +b];
    }

    function setCssRgbVariables() {
        const root = document.documentElement; const styles = getComputedStyle(root);
        const primaryAccent = styles.getPropertyValue('--primary-accent-color').trim();
        if (primaryAccent) root.style.setProperty('--primary-accent-color-rgb', hexToRgb(primaryAccent).join(', '));
        const dangerColor = styles.getPropertyValue('--danger-color').trim();
        if (dangerColor) root.style.setProperty('--danger-rgb', hexToRgb(dangerColor).join(', '));
        const successColor = styles.getPropertyValue('--success-color').trim();
        if (successColor) root.style.setProperty('--success-rgb', hexToRgb(successColor).join(', '));
        const warningColor = styles.getPropertyValue('--warning-color').trim();
        if (warningColor) root.style.setProperty('--warning-rgb', hexToRgb(warningColor).join(', '));
    }

    function fillSectionPositiveOrDefaults(sectionId) {
        const section = document.getElementById(sectionId); if (!section) return;
        if (sectionId === 'remarketingSection') {
            if (tipoTrazioneSelect) tipoTrazioneSelect.value = 'endotermico';
            document.getElementById('foto_angolari').checked = true;
            document.getElementById('foto_vano_carico').checked = true;
            document.getElementById('tipo_equipaggiamento').value = 'kit_gonfia_ripara';
            document.getElementById('equipaggiamento_presenza').value = 'presente';
            document.getElementById('foto_interni_pannelli').checked = true;
            document.getElementById('foto_cruscotto').checked = true;
            document.getElementById('stato_chilometri').value = 'rilevabili';
            document.getElementById('stato_cdc').value = 'originale';
            document.getElementById('foto_vano_motore').checked = true;
            document.getElementById('foto_cofano_tetto').checked = true;
            document.getElementById('chiave_telecomando').value = 'presente';
            document.getElementById('seconda_chiave').value = 'presente';
            handleTrazioneChange();
            if (tipoTrazioneSelect && tipoTrazioneSelect.value === 'elettrico') {
                if (cavoRapidaSelect && (cavoRapidaSelect.value === "" || cavoRapidaSelect.value === "non_applicabile")) cavoRapidaSelect.value = 'presente';
                if (cavoDomesticaSelect && (cavoDomesticaSelect.value === "" || cavoDomesticaSelect.value === "non_applicabile")) cavoDomesticaSelect.value = 'presente';
            }
        } else if (sectionId === 'pneumaticiSection') {
            document.getElementById('pneumatico_as').value = 'conforme'; document.getElementById('pneumatico_ad').value = 'conforme';
            document.getElementById('pneumatico_pd').value = 'conforme'; document.getElementById('pneumatico_ps').value = 'conforme';
        } else if (sectionId === 'danniVerificheSection') {
            document.getElementById('motore_accende').value = 'ok'; document.getElementById('batteria_stato').value = 'ok';
            document.getElementById('foto_danni_generiche').checked = false;
            document.getElementById('note_danni_verifiche').value = 'Nessuna anomalia da segnalare.';
        }
        updateNavButtonColors();
        if (typeof initSequentialAnimation === 'function') {
            section.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me'));
            initSequentialAnimation();
        }
        section.querySelectorAll('input, select, textarea').forEach(el => {
            ['change', 'input'].forEach(evtType => el.dispatchEvent(new Event(evtType, { bubbles: true })));
        });
    }

    function handleTrazioneChange() {
        if (!tipoTrazioneSelect || !cavoRapidaSelect || !cavoDomesticaSelect) return;
        const isElectric = tipoTrazioneSelect.value === 'elettrico';
        cavoRapidaSelect.disabled = !isElectric; cavoDomesticaSelect.disabled = !isElectric;
        if (!isElectric) {
            cavoRapidaSelect.value = "non_applicabile"; cavoDomesticaSelect.value = "non_applicabile";
        } else {
            if (cavoRapidaSelect.value === "non_applicabile") cavoRapidaSelect.value = "";
            if (cavoDomesticaSelect.value === "non_applicabile") cavoDomesticaSelect.value = "";
        }
        updateNavButtonColors();
    }

    function savePosizioneForTarga(targa, posizione) { if (!targa) return; try { localStorage.setItem(`<span class="math-inline">\{APP\_PREFIX\}posizione\_</span>{targa}`, posizione); } catch (e) { console.error("LS Err Pos Save:", e); }}
    function loadPosizioneForTarga(targa) { if (!targa) return ""; try { return localStorage.getItem(`<span class="math-inline">\{APP\_PREFIX\}posizione\_</span>{targa}`) || ""; } catch (e) { console.error("LS Err Pos Load:", e); return ""; }}

    function resetChecklistForm() {
        document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => {
            if (el.type === 'checkbox') el.checked = false; else if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
        });
        if (tipoTrazioneSelect) handleTrazioneChange();
        console.log("Modulo resettato.");
    }

    function saveProgress(targa) {
        if(!targa){console.warn("No targa for save.");return false;}
        const data = {};
        document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => {
            if (el.id) data[el.id] = (el.type === 'checkbox') ? el.checked : el.value;
        });
        try { localStorage.setItem(`<span class="math-inline">\{APP\_PREFIX\}data\_</span>{targa}`, JSON.stringify(data)); console.log(`Saved for ${targa}.`); updateNavButtonColors(); return true; }
        catch(e) { console.error("LS Save Err:", e); alert("Save failed."); return false; }
    }

    function loadProgress(targa) {
        if(!targa) return; resetChecklistForm();
        try {
            const json = localStorage.getItem(`<span class="math-inline">\{APP\_PREFIX\}data\_</span>{targa}`);
            if (json) {
                const data = JSON.parse(json);
                Object.keys(data).forEach(id => {
                    const el = document.getElementById(id);
                    if(el) { if (el.type === 'checkbox') el.checked = data[id]; else el.value = data[id]; }
                });
                console.log(`Loaded for ${targa}.`);
            } else { console.log(`No data for ${targa}.`); }
            if (tipoTrazioneSelect) handleTrazioneChange();
            updateNavButtonColors();
        } catch(e) { console.error("LS Load Err:", e); updateNavButtonColors(); }
    }

    function getCompletedTarghe() { try { return JSON.parse(localStorage.getItem(`${APP_PREFIX}completedTarghe`) || '{}'); } catch(e) { return {}; }}
    function markTargaAsCompleted(targa) { if(!targa)return; try { const comp = getCompletedTarghe(); comp[targa]=true; localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(comp)); console.log(`${targa} completed.`);} catch(e){console.error("LS Mark Comp Err:",e);}}
    function isTargaCompleted(targa) { return !!(getCompletedTarghe()[targa]); }

    function deleteProgressForTarga(targa) {
        if(!targa)return;
        try {
            [`data_${targa}`, `posizione_${targa}`, `urgent_${targa}`].forEach(suffix => localStorage.removeItem(APP_PREFIX + suffix));
            const comp = getCompletedTarghe(); if(comp[targa]){ delete comp[targa]; localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(comp));}
            console.log(`Data removed for ${targa}.`);
        } catch(e) { console.error(`Del Err ${targa}:`,e); alert(`Err deleting ${targa}.`); }
        if (typeof popolaTargheFiltrate === 'function') popolaTargheFiltrate();
        if (targaSelezionataGlobalmente === targa) targaSelezionataGlobalmente = null;
    }

    function generateAndDownloadScreenshot() {
        return new Promise((resolve, reject) => {
            const riepilogoEl = document.getElementById('riepilogoSection');
            if (!riepilogoEl) { alert("Err: Riepilogo not found."); return reject("Riepilogo not found"); }
            if (typeof html2canvas === 'undefined') { alert("Err: html2canvas missing."); return reject("html2canvas missing"); }
            setTimeout(() => {
                riepilogoEl.scrollTop = 0;
                html2canvas(riepilogoEl, { scale: 2, useCORS: true, logging: false, backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg-color').trim() || '#2c2f33' })
                .then(canvas => {
                    const link = document.createElement('a');
                    let targaFile = targaSelezionataGlobalmente ? targaSelezionataGlobalmente.replace(/[^a-z0-9]/gi, '_') : 'sconosciuta';
                    const v = listaTargheCompleta.find(vh => vh.targa === targaSelezionataGlobalmente);
                    let piazzaleFile = (v && v.piazzale && v.piazzale.trim()) ? v.piazzale.trim().replace(/[^a-z0-9\s-]/gi, '').replace(/\s+/g, '_') : 'ND';
                    link.download = `perizia_${targaFile}_${piazzaleFile}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click(); resolve(); console.log(`Screenshot: ${link.download}`);
                }).catch(err => { console.error("Screenshot err:", err); alert("Screenshot failed."); reject(err); });
            }, 100);
        });
    }

    async function handleSavePeriziaAndReturn() {
        if(!targaSelezionataGlobalmente || !saveProgress(targaSelezionataGlobalmente)) { alert("Salvataggio fallito o targa non selezionata."); return; }
        if(document.getElementById('riepilogoSection').classList.contains('active')) generateSummary();
        try { await generateAndDownloadScreenshot(); } catch(e) { console.warn("Screenshot failed, data saved."); }
        markTargaAsCompleted(targaSelezionataGlobalmente);
        alert(`Perizia ${targaSelezionataGlobalmente} salvata e completata. Screenshot generato. Torno all'elenco.`);
        targaSelezionataGlobalmente = null; showView('landing');
    }

    function handleSaveAndNext() {
        if(!targaSelezionataGlobalmente || !saveProgress(targaSelezionataGlobalmente)) { alert("Salvataggio fallito o targa non selezionata."); return; }
        const btn = this; const origTxt = btn.textContent; btn.textContent='Salvato!'; btn.disabled=true;
        setTimeout(()=>{ btn.textContent=origTxt; btn.disabled=false; },1500);
        const activeIdx = Array.from(navButtons).findIndex(b => b.classList.contains('active'));
        if(activeIdx !== -1 && activeIdx < navButtons.length - 1) showSection(navButtons[activeIdx + 1].dataset.target);
    }

    function isInputDefault(el) {
        if(!el) return true;
        if(el.type === 'checkbox') return !el.checked;
        if(el.tagName === 'SELECT') return el.value === "" || el.selectedIndex === 0;
        return (el.value || "").trim() === "";
    }

    function getSectionInputs(sectionId) {
        const section = document.getElementById(sectionId);
        return section ? Array.from(section.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled)')) : [];
    }

    function getSectionStatus(sectionId, targaData) {
        const inputs = getSectionInputs(sectionId); if (inputs.length === 0) return 'completed';
        let allDef = true, allNonDef = true, hasNonDef = false;
        inputs.forEach(input => {
            let isDef; const saved = targaData && targaData[input.id];
            if (saved !== undefined) isDef = (input.type === 'checkbox') ? !saved : (saved === "" || (input.options.length > 0 && saved === input.options[0].value));
            else isDef = isInputDefault(input);
            if (!isDef) { allDef = false; hasNonDef = true; } else { allNonDef = false; }
        });
        if (allDef) return 'untouched'; if (allNonDef) return 'completed'; if (hasNonDef) return 'partial'; return 'untouched';
    }

    function updateNavButtonColors() {
        const isInactive = !targaSelezionataGlobalmente && checklistContainer.style.display === 'none';
        if (isInactive) { navButtons.forEach(btn => btn.className = ''); return; } // Reset classes
        const data = JSON.parse(localStorage.getItem(`<span class="math-inline">\{APP\_PREFIX\}data\_</span>{targaSelezionataGlobalmente}`) || '{}');
        navButtons.forEach(btn => {
            if (btn.classList.contains('active')) return; // Active button styling handled by showSection
            btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched');
            const target = btn.dataset.target; let status = 'untouched';
            if (target === 'riepilogo') status = isTargaCompleted(targaSelezionataGlobalmente) ? 'completed' : (Object.keys(data).length > 0 ? 'partial' : 'untouched');
            else if (target) status = getSectionStatus(target + 'Section', data);
            btn.classList.add(`nav-btn-${status}`);
        });
    }

    function showView(viewName) {
        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        const headerCirclesDiv = pageHeaderContainer.querySelector('.header-circles');

        // Gestione visibilit bottoni navigazione
        if (navButtonsContainer) navButtonsContainer.style.display = 'flex'; // Contenitore sempre visibile se non  una vista speciale
        if (utilityNavButtonsDiv) utilityNavButtonsDiv.style.display = 'flex'; // Utility sempre visibili (tranne casi speciali)


        if (viewName === 'landing') {
            landingPageSection.style.display = 'block';
            if (headerCirclesDiv) headerCirclesDiv.style.display = 'flex';
             if (mainPageNavButtonsDiv) mainPageNavButtonsDiv.style.display = 'none'; // Nasconde bottoni sezioni
            mainTitleGlobal.innerHTML = "Elenco Veicoli";
            if (listaTargheCompleta.length > 0 && (!document.getElementById('preloader') || document.getElementById('preloader').classList.contains('hidden'))) {
                popolaTargheFiltrate();
            }
            targaSelezionataGlobalmente = null;
        } else if (viewName === 'checklist' || viewName === 'history') {
            if (headerCirclesDiv) headerCirclesDiv.style.display = 'flex';
            if (mainPageNavButtonsDiv) mainPageNavButtonsDiv.style.display = 'flex'; // Mostra bottoni sezioni

            if (viewName === 'checklist') {
                if (!targaSelezionataGlobalmente) { alert("Nessuna targa selezionata."); showView('landing'); return; }
                checklistContainer.style.display = 'block';
                const veicolo = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente);
                const subId = (veicolo && (veicolo.marca || veicolo.modello)) ? `${veicolo.marca || ''} ${veicolo.modello || ''}`.trim() : "";
                mainTitleGlobal.innerHTML = `<span class="math-inline">\{targaSelezionataGlobalmente\}<span\></span>{subId}</span>`;
            } else { // history
                historyPageSection.style.display = 'block';
                mainTitleGlobal.innerHTML = "Cronistoria Salvataggi";
                populateSavedTargasList();
            }
        } else { // Caso non gestito, nasconde tutto
            if (headerCirclesDiv) headerCirclesDiv.style.display = 'none';
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
            mainTitleGlobal.innerHTML = "";
        }
        // L'header  sempre fisso
        pageHeaderContainer.classList.add('fixed-header');
        updateNavButtonColors();

        let bodyPaddingTop = '20px';
        if (getComputedStyle(pageHeaderContainer).display !== 'none') {
            bodyPaddingTop = `${pageHeaderContainer.offsetHeight + 15}px`;
        }
        document.body.style.paddingTop = bodyPaddingTop;
    }


    function populateSavedTargasList() {
        savedTargasListContainer.innerHTML = ''; let hasSaves = false; const tempSaves = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i); if (key.startsWith(`${APP_PREFIX}data_`)) {
                const targa = key.substring(`${APP_PREFIX}data_`.length); if (targa && !tempSaves.includes(targa)) tempSaves.push(targa);
            }}
        hasSaves = tempSaves.length > 0;
        tempSaves.sort().forEach(targa => {
            const v = listaTargheCompleta.find(vh => vh.targa === targa) || {};
            let display = `${targa} - ${v.marca || ''} ${v.modello || ''} ${v.piazzale ? `(${v.piazzale})` : ''}`.replace(/\s*-\s*jQuery/, ""); // Rimuove trattino finale
            const btn = document.createElement('button'); btn.className = 'saved-targa-button'; btn.textContent = display; btn.dataset.targa = targa;
            btn.onclick = function() {
                targaSelezionataGlobalmente = this.dataset.targa; showView('checklist'); loadProgress(this.dataset.targa);
                const firstNav = Array.from(navButtons).find(b => b.dataset.target && b.dataset.target !== 'riepilogo');
                if (firstNav) showSection(firstNav.dataset.target);};
            savedTargasListContainer.appendChild(btn);
        });
        if (!hasSaves) savedTargasListContainer.innerHTML = '<p style="text-align:center; color: var(--text-muted-color);">Nessun salvataggio.</p>';
    }

    function clearAllSavedData() {
        if (confirm("ATTENZIONE! Cancellare TUTTI i dati? Azione IRREVERSIBILE.")) {
            let c=0; for(let i=localStorage.length-1;i>=0;i--){ const k=localStorage.key(i); if(k.startsWith(APP_PREFIX)){localStorage.removeItem(k);c++;}}
            alert(`${c} elementi rimossi.`); if(sheetFilterDropdown)sheetFilterDropdown.value='all';
            localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all'); // Resetta anche il filtro salvato
            populateSavedTargasList(); if(typeof caricaEPopolaTarghe === 'function')caricaEPopolaTarghe(); if(typeof showView === 'function')showView('landing');
        }
    }

    function setupSheetFilterDropdown() {
        if (!sheetFilterDropdown) return;
        const sources = ['all', ...new Set(listaTargheCompleta.map(i => i.piazzale).filter(p => p && p.trim()))];
        sheetFilterDropdown.innerHTML = sources.map(s => `<option value="<span class="math-inline">\{s\}"\></span>{s === 'all' ? 'Tutti i Piazzali' : s}</option>`).join('');
        const savedFilter = localStorage.getItem(`${APP_PREFIX}selectedPiazzaleFilter`);
        sheetFilterDropdown.value = (savedFilter && sources.includes(savedFilter)) ? savedFilter : 'all';
        if(sheetFilterDropdown.value === 'all' && !savedFilter) localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all');
        sheetFilterDropdown.onchange = handleSheetFilterChange;
    }

    function handleSheetFilterChange() {
        if (sheetFilterDropdown) localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, sheetFilterDropdown.value);
        popolaTargheFiltrate(); targaSelezionataGlobalmente = null;
    }

    function getItemRank(item) {
        const isUrgent = JSON.parse(localStorage.getItem(APP_PREFIX + 'urgent_' + item.targa) || 'false');
        const isCompleted = isTargaCompleted(item.targa);
        const hasData = !!localStorage.getItem(`<span class="math-inline">\{APP\_PREFIX\}data\_</span>{item.targa}`);
        if (isUrgent && !isCompleted) return 1; if (!isUrgent && !isCompleted && hasData) return 2;
        if (!isUrgent && !isCompleted && !hasData) return 3; if (!isUrgent && isCompleted) return 4;
        if (isUrgent && isCompleted) return 5; return 6;
    }

    function popolaTargheFiltrate() {
        const tEl = document.getElementById('targaListContainer');
        const headerEl = document.querySelector('.targa-list-table-content .targa-list-header');
        if (!tEl || !headerEl) return; tEl.innerHTML = '';

        if (!headerEl.querySelector('.targa-col-urgente')) {
            const urgenteHCol = document.createElement('span'); urgenteHCol.className = 'targa-col targa-col-urgente'; urgenteHCol.textContent = 'Urg.';
            headerEl.insertBefore(urgenteHCol, headerEl.firstChild); }

        const selSource = sheetFilterDropdown ? sheetFilterDropdown.value : 'all';
        let filtered = (selSource === 'all') ? [...listaTargheCompleta] : listaTargheCompleta.filter(i => i.piazzale === selSource);
        filtered.sort((a, b) => getItemRank(a) - getItemRank(b) || a.targa.localeCompare(b.targa));

        if (filtered.length === 0) {
            tEl.innerHTML = `<p style="text-align:center; padding:15px; color: var(--text-muted-color);">Nessuna targa per "${selSource === 'all' ? 'Tutti i Piazzali' : selSource}".</p>`;
            if(targheLoadingStatus) targheLoadingStatus.textContent = selSource === 'all' ? "CSV vuoto o nessuna targa." : `Nessuna targa per: ${selSource}.`; return;
        }

        filtered.forEach(item => {
            const li = document.createElement('div'); li.className = 'targa-list-item';
            const isUrgent = JSON.parse(localStorage.getItem(APP_PREFIX + 'urgent_' + item.targa) || 'false');
            const isCompleted = isTargaCompleted(item.targa);
            const hasData = !!localStorage.getItem(`<span class="math-inline">\{APP\_PREFIX\}data\_</span>{item.targa}`);
            if (isUrgent) { li.classList.add('urgent-item'); if (isCompleted) li.classList.add('completed'); }
            else if (isCompleted) { li.classList.add('status-visto', 'completed'); }
            else if (hasData) { li.classList.add('status-parziale'); } else { li.classList.add('status-da-vedere'); }

            const urgenteCol = document.createElement('span'); urgenteCol.className = 'targa-col targa-col-urgente';
            const urgentCb = document.createElement('input'); urgentCb.type = 'checkbox'; urgentCb.checked = isUrgent;
            urgentCb.dataset.targa = item.targa; urgentCb.title = isUrgent ? "Rimuovi urgenza" : "Marca urgente";
            urgentCb.onchange = function(e) { e.stopPropagation(); localStorage.setItem(APP_PREFIX+'urgent_'+this.dataset.targa, this.checked); popolaTargheFiltrate(); };
            ['mousedown','click'].forEach(evt => urgentCb.addEventListener(evt, e => e.stopPropagation()));
            urgenteCol.appendChild(urgentCb); li.appendChild(urgenteCol);

            const createCol = (txt, ...cls) => { const c=document.createElement('span');c.className=['targa-col',...cls].join(' ');c.textContent=txt||'N/D';return c; };
            const targaCol = createCol(item.targa, 'targa-col-targa', 'clickable-targa');
            targaCol.dataset.targaValue = item.targa;
            targaCol.onclick = function() {
                targaSelezionataGlobalmente = this.dataset.targaValue; showView('checklist'); loadProgress(this.dataset.targaValue);
                const firstNav = Array.from(navButtons).find(b => b.dataset.target && b.dataset.target !== 'riepilogo');
                if(firstNav) showSection(firstNav.dataset.target);};
            li.appendChild(targaCol);

            const posCol = createCol('', 'targa-col-posizione');
            const posIn = document.createElement('input'); posIn.type='text'; posIn.className='posizione-input'; posIn.dataset.targa=item.targa;
            posIn.placeholder='Pos.'; posIn.maxLength=5; posIn.value=loadPosizioneForTarga(item.targa);
            ['mousedown','click','focus'].forEach(evt => posIn.addEventListener(evt, e => e.stopPropagation()));
            posIn.onblur = function() {
                const newVal = this.value.trim().toUpperCase(); if (newVal !== loadPosizioneForTarga(this.dataset.targa)) {
                savePosizioneForTarga(this.dataset.targa, newVal); this.style.transition = 'border-color 0.3s ease';
                this.style.borderColor = 'var(--success-color)'; setTimeout(() => { this.style.borderColor = 'var(--border-color)'; }, 1500);}};
            posIn.onkeypress = function(e){if(e.key==='Enter'){e.preventDefault();this.blur();}};
            posCol.appendChild(posIn); li.appendChild(posCol);

            li.appendChild(createCol(item.marca, 'targa-col-marca')); li.appendChild(createCol(item.modello, 'targa-col-modello'));
            li.appendChild(createCol(item.piazzale, 'targa-col-piazzale'));
            const actCol = createCol('', 'targa-col-actions');
            const delB = document.createElement('button'); delB.className = 'action-button delete-progress-btn'; delB.dataset.targa=item.targa;
            delB.title = `Cancella ${item.targa}`; delB.innerHTML = '&#x1F5D1;';
            delB.onclick = function(e) { e.stopPropagation(); if(confirm(`Cancellare dati ${this.dataset.targa}?`)) deleteProgressForTarga(this.dataset.targa);};
            actCol.appendChild(delB); li.appendChild(actCol); tEl.appendChild(li);
        });
        if(targheLoadingStatus) targheLoadingStatus.textContent = "Clicca su una targa o filtra.";
    }

    async function caricaEPopolaTarghe() {
        const preloader = document.getElementById('preloader');
        if (targheLoadingStatus) targheLoadingStatus.textContent = "Caricamento dati...";
        try {
            const r = await fetch(GOOGLE_SHEET_CSV_URL + '&_=' + new Date().getTime());
            if (!r.ok) throw new Error(`HTTP ${r.status}. ${r.status === 0 ? "Rete/CORS?" : ""}`);
            const csv = await r.text(); const lines = csv.split(/\r\n|\n|\r/).filter(l => l.trim());
            if (lines.length === 0) throw new Error("CSV vuoto.");
            listaTargheCompleta = lines.map(l => { const p=l.split(','); return {targa:(p[0]||'').trim().replace(/^"|"jQuery/g,'').toUpperCase(), marca:(p[1]||'').trim().replace(/^"|"jQuery/g,''), modello:(p[2]||'').trim().replace(/^"|"jQuery/g,''), piazzale:(p[3]||'').trim().replace(/^"|"jQuery/g,'')}; }).filter(i => i.targa && i.targa.length > 3);
            if (listaTargheCompleta.length === 0) throw new Error("Nessuna targa valida nel CSV.");
            setupSheetFilterDropdown(); popolaTargheFiltrate();
        } catch (e) {
            console.error("Errore caricamento:", e); if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore: ${e.message}.`;
            listaTargheCompleta = []; if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti</option>'; if (targaListContainer) targaListContainer.innerHTML = '';
        } finally { if (preloader) { preloader.classList.add('hidden'); setTimeout(() => { if(preloader)preloader.style.display='none';}, 700);}}
    }

    function initSequentialAnimation() {
        const activeSection = document.querySelector('#checklistContainer .category-section.active'); if (!activeSection) return;
        activeSection.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me'));
        const visibleInputs = Array.from(activeSection.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled), textarea:not(:disabled)'))
            .filter(el => el.offsetParent !== null && getComputedStyle(el).visibility !== 'hidden' && getComputedStyle(el).display !== 'none');
        const firstEmpty = visibleInputs.findIndex(el => isInputDefault(el));
        if (firstEmpty === -1 && visibleInputs.length > 0) return; if (visibleInputs.length === 0) return;
        const toAnimate = visibleInputs.slice(firstEmpty >= 0 ? firstEmpty : 0); if (toAnimate.length === 0) return;
        let currentIdx = 0; let currentListeners = [];
        function clearCurrentAnimListeners() { currentListeners.forEach(({el,type,handler})=>el.removeEventListener(type,handler)); currentListeners=[]; activeSection.querySelectorAll('.animate-me').forEach(el=>el.classList.remove('animate-me'));}
        clearCurrentAnimListeners();
        function nextAnim() {
            if (currentIdx >= toAnimate.length) return; const el = toAnimate[currentIdx];
            if (!isInputDefault(el)) { currentIdx++; nextAnim(); return; }
            el.classList.add('animate-me'); el.scrollIntoView({behavior:'smooth',block:'center',inline:'nearest'});
            const onChangeOrBlur = (evt) => {
                let process = (evt.type==='change')||(evt.type==='blur'&&el.tagName!=='SELECT')||(evt.type==='blur'&&el.tagName==='SELECT'&&!isInputDefault(el));
                if(process){ clearCurrentAnimListeners(); currentIdx++; setTimeout(nextAnim,50);}};
            el.addEventListener('change', onChangeOrBlur); currentListeners.push({el,type:'change',handler:onChangeOrBlur});
            if(el.tagName==='SELECT'||el.tagName==='TEXTAREA'||el.type==='text'){el.addEventListener('blur',onChangeOrBlur);currentListeners.push({el,type:'blur',handler:onChangeOrBlur});}
        }
        nextAnim();
    }

    function showSection(targetId) {
        document.querySelectorAll('#checklistContainer .animate-me').forEach(el => el.classList.remove('animate-me'));
        sections.forEach(s => s.classList.toggle('active', s.id === targetId + 'Section'));
        navButtons.forEach(b => b.classList.toggle('active', b.dataset.target === targetId));
        updateNavButtonColors();
        if (targetId !== 'riepilogo' && document.getElementById(targetId + 'Section')?.classList.contains('active')) {
            setTimeout(initSequentialAnimation, 100);
        } else if (targetId === 'riepilogo') { generateSummary(); }
    }

    navButtons.forEach(b => b.onclick = function() { showSection(this.dataset.target); });

    function getSelectText(elOrId) { const el=(typeof elOrId==='string')?document.getElementById(elOrId):elOrId; return (el&&el.tagName==='SELECT'&&el.value)?(el.options[el.selectedIndex]?.text||el.value):"N/S"; }

    function generateSummary() {
        summaryContent.innerHTML=''; const targa=targaSelezionataGlobalmente||"N/D";
        const createItem=(lbl,val,isAnom=false)=>{const d=document.createElement('div');d.className=`summary-item ${isAnom?'summary-anomaly':''}`;d.innerHTML=`<strong>${lbl}:</strong> ${val}`;return d;};
        summaryContent.appendChild(createItem("Targa",targa));
        if(targaSelezionataGlobalmente){const v=listaTargheCompleta.find(vh=>vh.targa===targa)||{};summaryContent.appendChild(createItem("Marca",v.marca||"N/D"));summaryContent.appendChild(createItem("Modello",v.modello||"N/D"));summaryContent.appendChild(createItem("Posizione",loadPosizioneForTarga(targa)||"N/D"));}
        summaryContent.innerHTML+=`<h3>Remarketing:</h3>`; const isEV=tipoTrazioneSelect&&tipoTrazioneSelect.value==='elettrico'; summaryContent.appendChild(createItem("Trazione",getSelectText(tipoTrazioneSelect)));
        let eq=getSelectText('tipo_equipaggiamento'),pEq=getSelectText('equipaggiamento_presenza');let eqAnom=(eq!=="N/S"&&eq!==""&&pEq==="Mancante"); summaryContent.appendChild(createItem("Equip.",eq,eqAnom&&pEq==="Mancante")); summaryContent.appendChild(createItem("Pres. Equip.",pEq,eqAnom));
        summaryContent.appendChild(createItem("Stato Km",getSelectText('stato_chilometri'),getSelectText('stato_chilometri')==="Non rilevabili")); summaryContent.appendChild(createItem("Stato CDC",getSelectText('stato_cdc'),getSelectText('stato_cdc')==="Mancante"));
        summaryContent.appendChild(createItem("Chiave Tel.",getSelectText('chiave_telecomando'),getSelectText('chiave_telecomando')==="Non Presente")); summaryContent.appendChild(createItem("2 Chiave",getSelectText('seconda_chiave'),getSelectText('seconda_chiave')==="Non Presente"));
        if(isEV){summaryContent.innerHTML+=`<h4>Dotazioni EV:</h4>`;summaryContent.appendChild(createItem("Cavo Rapida",getSelectText('cavo_ricarica_rapida'),getSelectText('cavo_ricarica_rapida')==="Non Presente"));summaryContent.appendChild(createItem("Cavo Domest.",getSelectText('cavo_ricarica_domestica'),getSelectText('cavo_ricarica_domestica')==="Non Presente"));}
        summaryContent.innerHTML+=`<h3>Pneumatici:</h3>`; ['as','ad','pd','ps'].forEach(p=>summaryContent.appendChild(createItem(`Pneu. ${p.toUpperCase()}`,getSelectText(`pneumatico_${p}`),getSelectText(`pneumatico_${p}`)==="Non conforme")));
        summaryContent.innerHTML+=`<h3>Danni/Verifiche:</h3>`; summaryContent.appendChild(createItem("Motore Accende",getSelectText('motore_accende'),getSelectText('motore_accende')==='Non OK')); summaryContent.appendChild(createItem("Batteria",getSelectText('batteria_stato'),getSelectText('batteria_stato')==='Non OK'));
        const noteVal=document.getElementById('note_danni_verifiche')?.value.trim(); if(noteVal&&noteVal.toLowerCase()!=="nessuna anomalia da segnalare."){const nD=document.createElement('div');nD.className='summary-item summary-notes';nD.innerHTML=`<strong>Note:</strong><div style="white-space:pre-wrap;padding-left:10px;margin-top:5px;">${noteVal}</div>`;summaryContent.appendChild(nD);}
    }

    document.addEventListener('DOMContentLoaded', () => {
        setCssRgbVariables(); const preloader = document.getElementById('preloader');
        document.querySelectorAll('.fill-defaults-btn').forEach(btn => { btn.onclick = function(){if(this.dataset.sectionid) fillSectionPositiveOrDefaults(this.dataset.sectionid);}});
        if(tipoTrazioneSelect)tipoTrazioneSelect.onchange=handleTrazioneChange; handleTrazioneChange();
        if(backToListBtn)backToListBtn.onclick=()=>showView('landing'); if(historyBtn)historyBtn.onclick=()=>showView('history');
        if(clearAllProgressBtn)clearAllProgressBtn.onclick=clearAllSavedData; if(backToLandingFromHistoryBtn)backToLandingFromHistoryBtn.onclick=()=>showView('landing');
        if(saveAndReturnBtn)saveAndReturnBtn.onclick=handleSavePeriziaAndReturn; saveAndNextButtons.forEach(btn=>btn.onclick=handleSaveAndNext);
        async function initApp(){showView('landing');if(preloader){preloader.style.display='flex';preloader.classList.remove('hidden');preloader.querySelector('.loading-text').textContent='CARICAMENTO...';}await caricaEPopolaTarghe();}
        initApp();
        if(exitAppBtn){exitAppBtn.onclick=()=>{const curtain=document.getElementById('exit-curtain');if(document.getElementById('mainContentWrapper'))document.getElementById('mainContentWrapper').style.display='none';if(document.getElementById('pageHeaderContainer'))document.getElementById('pageHeaderContainer').style.display='none';document.body.style.paddingTop='0px';
        if(curtain){const txt=curtain.querySelector('.loading-text'),bars=curtain.querySelector('.loader-bar-container'),defTxt="CHIUSURA...",glTxt="ERRORE SYS...";curtain.classList.remove('glitching','flash-out-effect');if(txt){txt.textContent=defTxt;txt.style.animation='textGlow 1.8s infinite alternate ease-in-out';txt.style.color='#ff8787';txt.style.textShadow='';}curtain.setAttribute('data-text',defTxt);if(bars)bars.style.display='flex';curtain.classList.add('visible-no-transition');curtain.style.display='flex';
        setTimeout(()=>{curtain.classList.add('glitching');if(txt)txt.textContent=glTxt;curtain.setAttribute('data-text',glTxt);
        setTimeout(()=>{curtain.classList.remove('glitching');if(txt){txt.textContent='App Terminata.';txt.style.animation='none';txt.style.color='#FFF';txt.style.textShadow='none';}if(bars)bars.style.display='none';
        setTimeout(()=>{curtain.classList.add('flash-out-effect');
        setTimeout(()=>{fetch('https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi',{method:'GET',mode:'no-cors'}).catch(e=>console.error('MD Err:',e));},500);},700);},800);},800);}}}
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
