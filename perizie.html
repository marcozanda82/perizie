<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perizia Veicolo</title>
    <style>
        /* Preloader & Exit Curtain Styles */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Sfondo semitrasparente */
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 1;
            visibility: visible;
        }
        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
        }

        #exit-curtain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            z-index: 99998; /* Leggermente sotto il preloader se entrambi attivi, ma non dovrebbero */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in, visibility 0.5s ease-in;
        }

        #exit-curtain.visible-no-transition {
            opacity: 1;
            visibility: visible;
            transition: none;
        }

        .loader-bar-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .loader-bar {
            width: 15px;
            height: 70px;
            background-color: #007bff;
            animation: barPulse 1.2s infinite ease-in-out;
            box-shadow: 0 0 8px #007bff, 0 0 15px #00aeff;
            border-radius: 3px;
        }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        #exit-curtain:not(.glitching):not(.flash-out-effect) .loader-bar {
            animation-direction: reverse;
        }
        #exit-curtain.glitching:not(.flash-out-effect) .loader-bar {
            animation-direction: normal;
        }

        @keyframes barPulse {
            0%, 100% { transform: scaleY(0.3); opacity: 0.6; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        #preloader .loading-text,
        #exit-curtain .loading-text {
            font-size: 1.6em;
            letter-spacing: 1px;
        }

        #preloader .loading-text {
            color: #00aeff;
            animation: textGlow 1.8s infinite alternate ease-in-out;
        }

        #exit-curtain .loading-text {
             color: #ff8787;
        }

        @keyframes textGlow {
          from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 0.8;}
          to   { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; opacity: 1;}
        }

        #exit-curtain.glitching .loading-text {
            animation: glitchText 0.4s infinite steps(1, end), textGlow 1.8s infinite alternate ease-in-out; /* Durata glitchText ridotta */
            color: #ff3030 !important;
            position: relative;
            z-index: 10;
        }

        #exit-curtain.glitching::before,
        #exit-curtain.glitching::after {
            content: attr(data-text);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            padding: 0 20px;
            text-align: center;
            font-size: 1.6em;
            letter-spacing: 1px;
            background: #000000;
            overflow: hidden;
            clip-path: inset(50% 50% 50% 50%);
            z-index: 5;
        }

        #exit-curtain.glitching::before {
            color: #00ffff;
            animation: glitchEffect 0.2s infinite linear alternate-reverse; /* Leggermente più veloce */
        }

        #exit-curtain.glitching::after {
            color: #ff00ff;
            animation: glitchEffect 0.15s infinite linear alternate-reverse, glitchSkew 0.3s infinite linear alternate; /* Leggermente più veloce */
            animation-delay: -0.05s;
        }

        @keyframes glitchEffect {
            0%    { clip-path: inset(40% 0 30% 0); transform: translate(-50.5%, -50.1%) skewX(5deg); opacity: 0.8; }
            10%   { clip-path: inset(20% 0 70% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.7; }
            20%   { clip-path: inset(10% 0 55% 0); transform: translate(-49.8%, -50.2%) skewX(-3deg); opacity: 0.9; }
            30%   { clip-path: inset(50% 0 50% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            40%   { clip-path: inset(60% 0 10% 0); transform: translate(-50.2%, -49.9%) skewY(2deg); opacity: 1; }
            50%   { clip-path: inset(80% 0  5% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.75; }
            60%   { clip-path: inset(25% 0 40% 0); transform: translate(-50.1%, -50.3%) skewX(4deg); opacity: 0.85; }
            70%   { clip-path: inset(15% 0 75% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.9; }
            80%   { clip-path: inset(50% 0 20% 0); transform: translate(-49.9%, -49.8%) skewY(-3deg); opacity: 1; }
            90%   { clip-path: inset(70% 0 10% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            100%  { clip-path: inset(35% 0 45% 0); transform: translate(-50.3%, -50.0%) skewX(-2deg); opacity: 0.8; }
        }

        @keyframes glitchSkew {
            0%   { transform: translate(-50%, -50%) skew(-5deg, -2deg); }
            100% { transform: translate(-50%, -50%) skew(5deg, 2deg); }
        }

        @keyframes glitchText { /* Keyframes ridotti per animazione più breve se glitchText è usato a 0.4s */
            0%, 100% { text-shadow: 0 0 2px red, 0 0 3px blue; transform: translateX(0) translateY(0) skewX(0deg); opacity: 1;}
            25% { text-shadow: 1px 1px 2px red, -1px -1px 3px blue; transform: translateX(-1px) translateY(1px) skewX(3deg); opacity: 0.8;}
            50% { text-shadow: -1px 0 2px red, 1px 1px 3px blue; transform: translateX(2px) translateY(-1px) skewX(-2deg); opacity: 1;}
            75% { text-shadow: 0 -1px 2px red, -1px 1px 3px blue; transform: translateX(-1px) translateY(1px) skewX(1deg); opacity: 0.7;}
        }

        #exit-curtain.flash-out-effect .loading-text {
            color: #FFFFFF !important;
            text-shadow: none !important;
            animation: textFlashOut 0.4s forwards ease-out; /* Durata flash ridotta a 0.4s */
            transform-origin: center center;
        }

        @keyframes textFlashOut {
            0% {
                opacity: 1;
                transform: scale(1);
                text-shadow: 0 0 5px rgba(255,255,255,0.5);
            }
            40% {
                opacity: 1;
                transform: scale(1.15);
                color: #FFFFE0 !important;
                text-shadow: 0 0 15px #FFFFFF,
                             0 0 30px #FFFFFF,
                             0 0 45px #FFFFE0,
                             0 0 60px #FFFF99;
            }
            90% {
                opacity: 0.5;
                transform: scale(1.05);
            }
            100% {
                opacity: 0;
                transform: scale(0.5);
                text-shadow: none;
                color: transparent !important;
            }
        }

        /* Stili base e layout */
        .header-circles { display: flex; justify-content: space-around; align-items: center; width: 100%; padding: 8px 0; box-sizing: border-box; }
        .circle { width: 1.5cm; height: 1.5cm; background-color: #ffffff; border-radius: 50%; flex-shrink: 0; opacity: 0.8; }
        body { font-family: sans-serif; line-height: 1.6; margin: 0; background-color: #1e1e1e; color: #f0f0f0; transition: padding-top 0.3s ease; }
        .content-wrapper { padding: 20px; }
        h1, h2 { text-align: center; color: #ffffff; }
        h1#mainTitleGlobal { line-height: 1.2; margin-bottom: 10px; margin-top: 5px; font-size: 1.6em;}
        h2.section-title { color: #cccccc; border-bottom: 1px solid #444444; padding-bottom: 5px; margin-top: 30px; text-align: left; }

        /* Stili specifici elementi UI */
        #pageHeaderContainer { background-color: #2a2a2a; padding: 10px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        #navButtons { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        #mainPageNavButtons button, #utilityNavButtons button {
             padding: 8px 15px; font-size: 0.9em; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; color: #ffffff;
             /* Aggiungi altri stili base comuni se necessario */
        }
         #mainPageNavButtons button { background-color: #007bff; border-color: #0056b3; margin: 2px;} /* Blu */
         #mainPageNavButtons button:hover { background-color: #0056b3; }

         #utilityNavButtons button { margin: 2px; } /* Stili base già presenti */
         #backToListBtn { background-color: #6c757d; border-color: #5a6268; } /* Grigio */
         #historyBtn { background-color: #17a2b8; border-color: #117a8b; } /* Ciano */
         #exitAppBtn { background-color: #dc3545; border-color: #c82333; } /* Rosso */
         #backToListBtn:hover { background-color: #5a6268; }
         #historyBtn:hover { background-color: #117a8b; }
         #exitAppBtn:hover { background-color: #c82333; }

         /* Nascondi i bottoni della checklist di default */
         #mainPageNavButtons { display: none; }


        #sheetFilterDropdown { padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; min-width: 200px; vertical-align: middle; margin-bottom:15px;}
        #targaListContainer { margin-top: 15px; }
        .targa-item { background-color: #333; margin-bottom: 8px; padding: 12px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; border-left: 5px solid #555; }
        .targa-item:hover { background-color: #444; }
        .targa-item.urgent { border-left-color: #ffc107; /* Giallo per urgenza */ }
        .targa-item span { display: block; margin-bottom: 3px; }
        .targa-item .targa { font-weight: bold; font-size: 1.1em; color: #eee; }
        .targa-item .details { font-size: 0.9em; color: #bbb; }
        .targa-item .piazzale { font-size: 0.85em; color: #999; font-style: italic;}
        .targa-item .urgent-label { float: right; color: #ffc107; font-weight: bold; font-size: 0.9em;}


        .animate-me { animation: pulseHighlight 1.5s infinite alternate; outline: 2px solid rgba(0, 123, 255, 0.0); transition: outline 0.3s ease, box-shadow 0.3s ease; }
        @keyframes pulseHighlight { from { outline: 2px solid rgba(0, 123, 255, 0.7); box-shadow: 0 0 5px rgba(0, 123, 255, 0.5), 0 0 8px rgba(0, 123, 255, 0.3) inset; } to   { outline: 3px solid rgba(0, 150, 255, 1); box-shadow: 0 0 10px rgba(0, 150, 255, 0.8), 0 0 12px rgba(0, 150, 255, 0.5) inset; } }
        input[type="checkbox"].animate-me, select.animate-me { position: relative; z-index: 1; }

        /* Stili Responsive */
        @media (max-width: 768px) {
             #navButtons { flex-direction: column; align-items: stretch; }
             #mainPageNavButtons, #utilityNavButtons { width: 100%; display: flex; flex-direction: column;}
             #mainPageNavButtons button, #utilityNavButtons button { width: 100%; margin-bottom: 5px; text-align: center; }
             h1#mainTitleGlobal { font-size: 1.4em; }
             /* Nascondi i bottoni della checklist anche su mobile di default */
             #mainPageNavButtons { display: none; }
         }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="exit-curtain" data-text="CHIUSURA IN CORSO...">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">CHIUSURA IN CORSO...</div>
    </div>

    <div id="pageHeaderContainer">
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>
        <div id="navButtons">
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
            <div id="utilityNavButtons">
                <button id="backToListBtn" class="action-button">Elenco Targhe</button>
                <button id="historyBtn" class="action-button">Salvataggi</button>
                <button id="exitAppBtn" class="action-button">Esci</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: none;"> <h2>Seleziona Veicolo da Periziare</h2>
            <div style="margin-bottom: 15px;"> <label for="sheetFilterDropdown">Filtra per Piazzale: </label>
               <select id="sheetFilterDropdown">
                   <option value="all">Tutti</option>
                   </select>
            </div>
            <div id="targheLoadingStatus" style="text-align: center; padding: 15px; color: #aaa;">Caricamento targhe...</div>
            <div id="targaListContainer">
                </div>
        </div>

        <div id="checklistContainer" style="display: none;">
            <h2 id="checklistSectionTitle">Sezione Checklist</h2>
            <div id="checklistContent">
                </div>
             <button class="save-and-next-btn">Salva e Prosegui</button>
             <button id="saveAndReturnBtn">Salva e Torna all'Elenco</button>

        </div>

        <div id="historyPageSection" style="display: none;">
            <h2>Cronologia Salvataggi</h2>
            <div id="historyContent">
                </div>
             <button id="clearAllProgressBtn">Cancella Tutti i Salvataggi</button>
             <button id="backToLandingFromHistoryBtn">Torna all'Elenco Targhe</button>
        </div>
    </div>

<script>
    // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const mainPageNavButtons = document.getElementById('mainPageNavButtons'); // Riferimento ai bottoni checklist
    const utilityNavButtons = document.getElementById('utilityNavButtons'); // Riferimento ai bottoni utility
    const targaListContainer = document.getElementById('targaListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');

    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';

    // --- Funzioni Essenziali ---

    // Funzione per mostrare la vista corretta e gestire i bottoni di navigazione
    function showView(viewName) {
        console.log(`Switching view to: ${viewName}`); // Debug

        // Nascondi tutte le sezioni principali
        if (landingPageSection) landingPageSection.style.display = 'none';
        if (checklistContainer) checklistContainer.style.display = 'none';
        if (historyPageSection) historyPageSection.style.display = 'none';

        // Nascondi/Mostra i bottoni di navigazione della checklist
        if (mainPageNavButtons) {
            mainPageNavButtons.style.display = (viewName === 'checklist') ? 'flex' : 'none'; // Mostra solo in checklist
             // Adatta 'flex' o 'block' in base al tuo layout CSS (usa 'flex' se usi flexbox per i bottoni)
             // Se usi la media query per 'column', potresti dover aggiustare anche quello via JS o usare classi CSS
             if (window.innerWidth <= 768) {
                 mainPageNavButtons.style.display = (viewName === 'checklist') ? 'flex' : 'none'; // Mantieni flex per colonna su mobile
             }
        }


        // Mostra la sezione richiesta
        if (viewName === 'landing' && landingPageSection) {
            landingPageSection.style.display = 'block';
             // Ricarica o aggiorna l'elenco targhe se necessario quando si torna a questa vista
             popolaTargheFiltrate(); // Assicurati che filtri e lista siano aggiornati
        } else if (viewName === 'checklist' && checklistContainer) {
            checklistContainer.style.display = 'block';
            // Qui dovresti caricare la sezione specifica della checklist (es. Remarketing)
        } else if (viewName === 'history' && historyPageSection) {
            historyPageSection.style.display = 'block';
            // Popola la cronologia
            displayHistory(); // Assumendo tu abbia una funzione per questo
        } else {
             console.error("View name not recognized or section not found:", viewName);
        }
    }


    // Funzione per caricare e processare i dati CSV delle targhe
    async function caricaEPopolaTarghe() {
        if (targheLoadingStatus) targheLoadingStatus.textContent = "Caricamento dati dal server...";
        if (targaListContainer) targaListContainer.innerHTML = ''; // Pulisce la lista precedente

        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) {
                let errorMsg = `Errore HTTP ${response.status}.`;
                if (response.status === 0) errorMsg = "Errore di rete o CORS.";
                else if (response.status === 404) errorMsg = "File CSV non trovato (404).";
                else if (response.status === 403) errorMsg = "Accesso al file CSV negato (403).";
                throw new Error(errorMsg);
            }
            const csvText = await response.text();
            const lines = csvText.split(/\r\n|\n|\r/).filter(line => line.trim() !== ''); // Divide per righe e rimuove vuote

            if (lines.length <= 1) { // Considera che la prima riga potrebbe essere l'intestazione
                 if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessun dato trovato nel file CSV.";
                 listaTargheCompleta = [];
                 setupSheetFilterDropdown(); // Aggiorna dropdown anche se vuoto
                 popolaTargheFiltrate(); // Mostra lista vuota
                 return;
            }

            // Salta l'intestazione se presente (aggiusta se il tuo CSV non ha intestazione)
            const dataLines = lines.slice(1);

            listaTargheCompleta = dataLines.map(line => {
                // Gestione più robusta del parsing CSV (considera virgole nei campi)
                 const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                 const cleanedParts = parts.map(p => (p || '').trim().replace(/^"|"$/g, '').trim());

                return {
                    targa: (cleanedParts[0] || '').toUpperCase(),
                    marca: cleanedParts[1] || '',
                    modello: cleanedParts[2] || '',
                    piazzale: cleanedParts[3] || '',
                    isUrgent: (cleanedParts[4] || '').toUpperCase() === 'U' // Verifica urgenza (colonna 5)
                };
            }).filter(item => item.targa && item.targa.length > 3); // Filtra targhe valide


            if (listaTargheCompleta.length === 0) {
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessuna targa valida trovata dopo il parsing.";
            } else {
                 if (targheLoadingStatus) targheLoadingStatus.style.display = 'none'; // Nascondi messaggio caricamento
            }

            setupSheetFilterDropdown(); // Popola il filtro piazzali
            popolaTargheFiltrate(); // Mostra le targhe filtrate

        } catch (error) {
            console.error("Errore durante il caricamento o popolamento targhe:", error);
            if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore caricamento: ${error.message}. Riprovare.`;
            listaTargheCompleta = [];
            setupSheetFilterDropdown(); // Assicura che il dropdown sia resettato
            popolaTargheFiltrate(); // Mostra lista vuota
        } finally {
             // Gestione Preloader (nascondilo dopo il caricamento)
            const preloader = document.getElementById('preloader');
             if (preloader && !preloader.classList.contains('hidden')) {
                preloader.classList.add('hidden');
                setTimeout(() => {
                    if (preloader) preloader.style.display = 'none';
                }, 700); // Durata transizione CSS
             }
        }
    }

    // Funzione per popolare il dropdown dei piazzali
    function setupSheetFilterDropdown() {
        if (!sheetFilterDropdown) return;

        const piazzaliUnici = ['all', ...new Set(listaTargheCompleta.map(item => item.piazzale).filter(Boolean))]; // Ottiene piazzali unici, aggiunge 'all'
        sheetFilterDropdown.innerHTML = ''; // Pulisce opzioni esistenti

        piazzaliUnici.forEach(piazzale => {
            const option = document.createElement('option');
            option.value = piazzale;
            option.textContent = piazzale === 'all' ? 'Tutti i Piazzali' : piazzale;
            sheetFilterDropdown.appendChild(option);
        });

         // Aggiungi listener per filtrare quando cambia la selezione
         sheetFilterDropdown.removeEventListener('change', popolaTargheFiltrate); // Rimuovi vecchi listener
         sheetFilterDropdown.addEventListener('change', popolaTargheFiltrate);
    }

    // Funzione per mostrare le targhe (filtrate) nella lista
    function popolaTargheFiltrate() {
        if (!targaListContainer) return;

        const filtroPiazzale = sheetFilterDropdown ? sheetFilterDropdown.value : 'all';
        targaListContainer.innerHTML = ''; // Pulisci lista

        const targheFiltrate = listaTargheCompleta.filter(item =>
            filtroPiazzale === 'all' || item.piazzale === filtroPiazzale
        );

        if (targheFiltrate.length === 0 && listaTargheCompleta.length > 0) {
            targaListContainer.innerHTML = '<p style="text-align:center; color: #aaa;">Nessuna targa trovata per questo piazzale.</p>';
        } else if (targheFiltrate.length === 0 && listaTargheCompleta.length === 0 && !targheLoadingStatus.textContent.includes("Errore")) {
             // Non mostrare nulla se la lista è vuota e non c'è stato errore (il messaggio di caricamento/errore è già visibile)
        } else {
            targheFiltrate.forEach(item => {
                const div = document.createElement('div');
                div.className = 'targa-item';
                if (item.isUrgent) {
                    div.classList.add('urgent');
                }
                div.innerHTML = `
                    ${item.isUrgent ? '<span class="urgent-label">URGENTE</span>' : ''}
                    <span class="targa">${item.targa}</span>
                    <span class="details">${item.marca} ${item.modello}</span>
                    <span class="piazzale">Piazzale: ${item.piazzale || 'Non specificato'}</span>
                `;
                div.addEventListener('click', () => selezionaTarga(item.targa)); // Assumendo tu abbia questa funzione
                targaListContainer.appendChild(div);
            });
        }
         // Aggiorna o nascondi lo status di caricamento/errore se necessario
         if (listaTargheCompleta.length > 0 || targheLoadingStatus.textContent.includes("Errore")) {
             targheLoadingStatus.style.display = 'none';
         } else if (!targheLoadingStatus.textContent.includes("Errore")) {
             targheLoadingStatus.textContent = "Nessuna targa disponibile."; // Messaggio finale se vuoto
             targheLoadingStatus.style.display = 'block';
         }
    }

    // Funzione placeholder per selezionare una targa (DA IMPLEMENTARE)
    function selezionaTarga(targa) {
        console.log("Selezionata targa:", targa);
        targaSelezionataGlobalmente = targa;
        // Probabilmente vuoi salvare la targa selezionata e passare alla vista checklist
        // salvaStatoCorrente(); // Salva stato se necessario
        showView('checklist'); // Vai alla checklist
        // Carica la prima sezione della checklist per la targa selezionata
        // loadChecklistSection('remarketing', targa); // Esempio
    }

     // Funzione Placeholder per mostrare la cronologia (DA IMPLEMENTARE)
     function displayHistory() {
         const historyContent = document.getElementById('historyContent');
         if (historyContent) {
             historyContent.innerHTML = "<p>Funzionalità cronologia non ancora implementata.</p>";
             // Qui dovresti leggere i dati salvati (es. da localStorage) e popolarli
         }
     }
    // Funzione Placeholder per cancellare i dati (DA IMPLEMENTARE)
    function clearAllSavedData() {
        console.log("Cancellazione dati...");
        // Logica per rimuovere dati da localStorage o dove li salvi
        displayHistory(); // Aggiorna la vista cronologia
        alert("Cronologia salvataggi cancellata.");
    }

    // Funzione Placeholder per salvare e tornare (DA IMPLEMENTARE)
     function handleSavePeriziaAndReturn() {
         console.log("Salvataggio perizia e ritorno all'elenco...");
         // 1. Salva i dati della sezione corrente della checklist
         // saveCurrentChecklistSectionData();
         // 2. Torna all'elenco
         showView('landing');
     }

     // Funzione Placeholder per salvare e proseguire (DA IMPLEMENTARE)
     function handleSaveAndNext() {
         console.log("Salvataggio e passaggio alla sezione successiva...");
         // 1. Salva i dati della sezione corrente
         // saveCurrentChecklistSectionData();
         // 2. Determina la sezione successiva
         // let nextSection = getNextChecklistSection();
         // 3. Carica la sezione successiva
         // loadChecklistSection(nextSection, targaSelezionataGlobalmente);
     }

     // Funzione Placeholder per gestire cambio trazione (se presente nel tuo HTML)
      function handleTrazioneChange() {
          const tipoTrazioneSelect = document.getElementById('tipo_trazione'); // Assicurati ID sia corretto
          if (tipoTrazioneSelect) {
             console.log("Trazione cambiata:", tipoTrazioneSelect.value);
             // Aggiungi logica se necessaria
          }
      }


    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const preloader = document.getElementById('preloader');

        // Setup listeners bottoni utility (assicurati che gli ID siano corretti)
        const backToListBtn = document.getElementById('backToListBtn');
        const historyBtn = document.getElementById('historyBtn');
        const exitAppBtn = document.getElementById('exitAppBtn');
        const clearAllProgressBtn = document.getElementById('clearAllProgressBtn'); // Nella pagina History
        const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn'); // Nella pagina History
        const saveAndReturnBtn = document.getElementById('saveAndReturnBtn'); // Nella Checklist
        const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn'); // Nella Checklist (potrebbe essere uno solo)
        const tipoTrazioneSelect = document.getElementById('tipo_trazione'); // Se presente


        if(backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if(historyBtn) historyBtn.addEventListener('click', () => showView('history'));
        if(exitAppBtn) exitAppBtn.addEventListener('click', handleExitApp); // Funzione separata per uscita
        if(clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', clearAllSavedData);
        if(backToLandingFromHistoryBtn) backToLandingFromHistoryBtn.addEventListener('click', () => showView('landing'));
        if(saveAndReturnBtn) saveAndReturnBtn.addEventListener('click', handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button => button.addEventListener('click', handleSaveAndNext));

         // Listener per i bottoni della checklist principale (se presenti e per navigare tra sezioni)
         const checklistNavButtons = document.querySelectorAll('#mainPageNavButtons button[data-target]');
         checklistNavButtons.forEach(button => {
             button.addEventListener('click', (event) => {
                 const targetSection = event.target.getAttribute('data-target');
                 console.log("Navigating to checklist section:", targetSection);
                 // loadChecklistSection(targetSection, targaSelezionataGlobalmente); // Carica sezione cliccata
             });
         });


        if (tipoTrazioneSelect) {
            tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);
            // handleTrazioneChange(); // Chiamata iniziale se serve stato di default
        }


        // Funzione Inizializzazione Applicazione
        async function initializeApplication() {
            if (preloader) { // Mostra preloader all'inizio
                preloader.style.display = 'flex';
                preloader.classList.remove('hidden');
                preloader.style.opacity = '1';
                preloader.style.visibility = 'visible';
                const loadingText = preloader.querySelector('.loading-text');
                if (loadingText) loadingText.textContent = 'CARICAMENTO ELENCO...';
            }
            await caricaEPopolaTarghe(); // Carica i dati
            showView('landing'); // Mostra la vista iniziale (elenco targhe) solo DOPO caricamento
        }

        initializeApplication(); // Avvia l'app
    });


    // Funzione per gestire l'uscita dall'app (animazione)
    function handleExitApp() {
         const exitCurtain = document.getElementById('exit-curtain');
         const mainContentWrapper = document.getElementById('mainContentWrapper');
         const pageHeader = document.getElementById('pageHeaderContainer');

         if (exitCurtain) {
             if (mainContentWrapper) mainContentWrapper.style.display = 'none';
             if (pageHeader) pageHeader.style.display = 'none';
             document.body.style.paddingTop = '0px'; // Reset padding se modificato

             const exitLoadingText = exitCurtain.querySelector('.loading-text');
             const barContainer = exitCurtain.querySelector('.loader-bar-container');

             const durationNormal = 800;
             const durationGlitch = 400;
             const durationFlashOut = 400;

             const textNormal = "CHIUSURA IN CORSO...";
             const textGlitch = "ERRORE DI SISTEMA...";

             // Fase 1: Normale
             exitCurtain.classList.remove('glitching', 'flash-out-effect');
             if (exitLoadingText) { /* ... imposta testo e animazione normale ... */
                 exitLoadingText.textContent = textNormal;
                 exitLoadingText.style.animation = 'textGlow 1.8s infinite alternate ease-in-out';
                 exitLoadingText.style.color = '#ff8787';
                 exitLoadingText.style.textShadow = '';
             }
             exitCurtain.setAttribute('data-text', textNormal);
             if (barContainer) barContainer.style.display = 'flex';
             exitCurtain.classList.add('visible-no-transition'); // Mostra subito
             exitCurtain.style.display = 'flex';

             setTimeout(() => {
                 // Fase 2: Glitch
                 exitCurtain.classList.add('glitching');
                 if (exitLoadingText) exitLoadingText.textContent = textGlitch;
                 exitCurtain.setAttribute('data-text', textGlitch);

                 setTimeout(() => {
                     // Fase 3: Flash Out
                     exitCurtain.classList.remove('glitching');
                     if (exitLoadingText) { /* ... resetta stile per flash ... */
                         exitLoadingText.style.animation = 'none';
                         exitLoadingText.style.color = '#FFFFFF';
                         exitLoadingText.style.textShadow = 'none';
                      }
                     if (barContainer) barContainer.style.display = 'none';
                     exitCurtain.classList.add('flash-out-effect');

                     setTimeout(() => {
                         // Dopo Flash Out: Chiudi
                         const macrodroidUrl = 'https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi';
                         fetch(macrodroidUrl, { method: 'GET', mode: 'no-cors' })
                             .then(response => console.log('Macrodroid trigger request sent.'))
                             .catch(error => console.error('Error sending Macrodroid trigger:', error));
                     }, durationFlashOut);

                 }, durationGlitch);

             }, durationNormal);
         }
     }

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
