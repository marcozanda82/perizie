<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perizia Veicolo</title>
    <style>
        /* ... (stili esistenti rimangono invariati) ... */
        .header-circles { display: flex; justify-content: space-around; align-items: center; width: 100%; padding: 8px 0; box-sizing: border-box; position: fixed; top: 10px; left: 0; background-color: #1e1e1e; z-index: 1000; }
        .circle { width: 1.5cm; height: 1.5cm; background-color: #ffffff; border-radius: 50%; flex-shrink: 0; }
        body { font-family: sans-serif; line-height: 1.6; margin: 0; background-color: #1e1e1e; color: #f0f0f0; padding-top: 0; }
        .content-wrapper { padding: 20px; margin-top: 0; }
        h1, h2 { text-align: center; color: #ffffff; }
        h2.section-title { color: #cccccc; border-bottom: 1px solid #444444; padding-bottom: 5px; margin-top: 30px; text-align: left; }
        h3 { color: #bbbbbb; margin-top: 20px; margin-bottom: 10px; }
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 15px; }
        input[type="checkbox"], input[type="text"], input[type="url"], select, input[type="radio"] { margin-right: 8px; vertical-align: middle; padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; margin-bottom: 5px; }
        input[type="text"], input[type="url"] { width: calc(100% - 20px); box-sizing: border-box; }
        input[type="radio"] { margin-left: 5px; }
        select { min-width: 220px; }
        label { vertical-align: middle; display: block; margin-bottom: 5px; color: #e0e0e0; }

        #navButtons { text-align: center; margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; }
        #navButtons button, .action-button, #procediConPeriziaBtn { margin: 5px; padding: 10px 18px; cursor: pointer; background-color: #007bff; color: white; border: 1px solid #0056b3; border-radius: 4px; transition: background-color 0.3s ease, border-color 0.3s ease; font-size: 1em; }
        #procediConPeriziaBtn { display: block; margin: 20px auto; padding: 12px 25px; font-size: 1.1em; }
        .save-and-next-btn { background-color: #0069d9 !important; border-color: #005cbf !important; }
        .save-and-next-btn:hover { background-color: #0056b3 !important; border-color: #004085 !important; }
        #navButtons button:hover, .action-button:hover, #procediConPeriziaBtn:hover { background-color: #0056b3; border-color: #004085; }
        #procediConPeriziaBtn:disabled { background-color: #555; border-color: #444; cursor: not-allowed; }
        #navButtons button.active { background-color: #0056b3; border-color: #004085; }

        #landingPageSection { padding: 20px; border: 1px solid #444; border-radius: 8px; margin-top: 20px; background-color: #2a2a2a; max-width: 800px; margin-left: auto; margin-right: auto; }
        .category-section { display: none; padding: 20px; border: 1px solid #444; border-radius: 8px; margin-top: 20px; background-color: #2a2a2a; }
        .category-section.active { display: block; }
        .summary-item { margin-bottom: 8px; padding: 5px; background-color: #333; border-radius: 3px; }
        .summary-item strong { color: #00aeff; }
        
        .targa-list-header { display: flex; font-weight: bold; padding: 8px 8px 4px 8px; border-bottom: 1px solid #555; margin-bottom: 5px; color: #ccc; }
        .targa-list-header .targa-col-radio-spacer { flex-basis: 30px; flex-shrink: 0; }
        #targaListContainer { margin-top: 5px; max-height: 300px; overflow-y: auto; padding: 0; border: 1px solid #444; border-radius: 4px; }
        .targa-list-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #383838; }
        .targa-list-item:last-child { border-bottom: none; }
        .targa-list-item input[type="radio"] { margin-right: 10px; flex-shrink: 0; }
        label.radio-label-container { display: flex; flex-grow: 1; cursor: pointer; color: #f0f0f0; }
        .targa-col { padding: 0 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: inline-block; }
        .targa-col-targa   { flex-basis: 20%; min-width: 80px;}
        .targa-col-marca   { flex-basis: 25%; min-width: 100px;}
        .targa-col-modello { flex-basis: 30%; min-width: 120px;}
        .targa-col-piazzale{ flex-basis: 25%; min-width: 80px; text-align: left; }
        .targa-list-item.completed label.radio-label-container,
        .targa-list-item.completed label.radio-label-container .targa-col { text-decoration: line-through; color: #888 !important; }

        #targheLoadingStatus { text-align: center; padding: 10px; color: #00aeff; }
        .header-circles, #mainTitleGlobal, #navButtons, #checklistContainer { display: none; }

        @media (max-width: 768px) {
            .content-wrapper { margin-top: 0; }
            .header-circles { padding: 6px 0; top: 5px; }
            .circle { width: 1.2cm; height: 1.2cm; }
            #navButtons button { padding: 8px 12px; font-size: 0.9em; }
            input[type="text"], input[type="url"], select { width: 100%; box-sizing: border-box; }
            .targa-list-header { display: none; } 
            label.radio-label-container { flex-direction: column; align-items: flex-start; } 
            .targa-col { width: 100%; white-space: normal; margin-bottom: 2px; padding-left: 0;}
            .targa-col-targa::before { content: "Targa: "; font-weight: bold; }
            .targa-col-marca::before { content: "Marca: "; font-weight: bold; }
            .targa-col-modello::before { content: "Modello: "; font-weight: bold; }
            .targa-col-piazzale::before { content: "Piazzale: "; font-weight: bold; }
            .targa-list-item input[type="radio"] { margin-top: 5px; }
        }
    </style>
</head>
<body>
    <div class="header-circles">
        <div class="circle"></div> <div class="circle"></div> <div class="circle"></div> <div class="circle"></div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>

        <div id="landingPageSection">
            <h2>Seleziona Veicolo da Periziare</h2>
            <div id="targheLoadingStatus">Caricamento targhe in corso...</div>
            <div class="targa-list-header">
                <div class="targa-col-radio-spacer"></div>
                <span class="targa-col targa-col-targa">Targa</span>
                <span class="targa-col targa-col-marca">Marca</span>
                <span class="targa-col targa-col-modello">Modello</span>
                <span class="targa-col targa-col-piazzale">Piazzale</span>
            </div>
            <div id="targaListContainer"></div>
            <button id="procediConPeriziaBtn" disabled>Procedi alla Perizia</button>
        </div>

        <div id="navButtons">
            <button data-target="remarketing">1. Foto Remarketing</button>
            <button data-target="pneumatici">2. Foto Pneumatici</button>
            <button data-target="danniVerifiche">3. Foto Danni e Verifiche</button>
            <button data-target="riepilogo">Riepilogo Perizia</button>
            <button id="backToListBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe</button>
        </div>

        <div id="checklistContainer">
            <div id="remarketingSection" class="category-section">
                <h2 class="section-title">1. Foto Remarketing (Checklist)</h2>
                <ul>
                    <li><label for="targa_select">Targa Selezionata:</label><select id="targa_select" name="targa_select" disabled><option value="">Nessuna targa</option></select></li>
                    <li><input type="checkbox" id="foto_angolari"><label for="foto_angolari">a) Foto angolari (3/4)</label></li>
                    <li><label for="tipo_equipaggiamento">b) Vano carico - Tipo equipaggiamento:</label><select id="tipo_equipaggiamento" name="tipo_equipaggiamento"><option value="">Seleziona...</option><option value="kit_gonfia_ripara">Kit gonfia e ripara</option><option value="ruota">Ruota</option><option value="ruotino">Ruotino</option><option value="runflat">Runflat</option></select></li>
                    <li><label for="equipaggiamento_presenza">Equipaggiamento presente/mancante?</label><select id="equipaggiamento_presenza" name="equipaggiamento_presenza"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_interni_pannelli"><label for="foto_interni_pannelli">c) Foto interni e pannelli porte</label></li>
                    <li><input type="checkbox" id="foto_cruscotto"><label for="foto_cruscotto">d) Foto cruscotto</label></li>
                    <li><label for="stato_chilometri">e) Foto chilometri - Stato:</label><select id="stato_chilometri" name="stato_chilometri"><option value="">Seleziona...</option><option value="rilevabili">Rilevabili</option><option value="non_rilevabili">Non rilevabili</option></select></li>
                    <li><label for="stato_cdc">f) Foto CDC - Stato:</label><select id="stato_cdc" name="stato_cdc"><option value="">Seleziona...</option><option value="originale">Originale</option><option value="copia_conforme">Copia conforme</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_vano_motore"><label for="foto_vano_motore">g) Foto vano motore</label></li>
                    <li><input type="checkbox" id="foto_cofano_tetto"><label for="foto_cofano_tetto">h) Foto cofano motore e tetto</label></li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>

            <div id="pneumaticiSection" class="category-section">
                <h2 class="section-title">2. Foto Pneumatici (Checklist)</h2>
                <ul>
                    <li><label for="pneumatico_as">a) Anteriore sinistro:</label><select id="pneumatico_as" name="pneumatico_as"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ad">b) Anteriore destro:</label><select id="pneumatico_ad" name="pneumatico_ad"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_pd">c) Posteriore destro:</label><select id="pneumatico_pd" name="pneumatico_pd"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ps">d) Posteriore sinistro:</label><select id="pneumatico_ps" name="pneumatico_ps"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>

            <div id="danniVerificheSection" class="category-section">
                <h2 class="section-title">3. Foto Danni e Verifiche Funzionali</h2>
                <ul>
                    <li><label for="motore_accende">a) Il motore si accende:</label><select id="motore_accende" name="motore_accende"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><label for="batteria_stato">b) Batteria:</label><select id="batteria_stato" name="batteria_stato"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><input type="checkbox" id="foto_danni_generiche"><label for="foto_danni_generiche">Altre foto danni (generiche)</label></li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Vai al Riepilogo</button></div>
            </div>
            
            <div id="riepilogoSection" class="category-section">
                <h2 class="section-title">Riepilogo Perizia</h2>
                <div id="summaryContent"><p><em>Compila le sezioni precedenti per visualizzare il riepilogo.</em></p></div>
                <button id="saveAndReturnBtn" class="action-button" style="background-color: #28a745; border-color: #1e7e34; margin-top: 15px;">Salva Perizia</button>
            </div>
        </div>
    </div>
<script>
    const landingPageSection = document.getElementById('landingPageSection');
    const targaListContainer = document.getElementById('targaListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const procediConPeriziaBtn = document.getElementById('procediConPeriziaBtn');
    const headerCircles = document.querySelector('.header-circles');
    const mainTitleGlobal = document.getElementById('mainTitleGlobal');
    const mainContentWrapper = document.getElementById('mainContentWrapper');
    const navButtonsContainer = document.getElementById('navButtons');
    const checklistContainer = document.getElementById('checklistContainer');
    const targaSelectChecklist = document.getElementById('targa_select');
    const navButtons = document.querySelectorAll('#navButtons button[data-target]');
    const sections = document.querySelectorAll('.category-section');
    const summaryContent = document.getElementById('summaryContent');
    // MODIFICATO: ID e variabile per il nuovo pulsante "Elenco Targhe"
    const backToListBtn = document.getElementById('backToListBtn'); 
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn'); 
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');

    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv'; 
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_'; 

    function resetChecklistForm() { /* ...invariata... */ const els=document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select'); els.forEach(el=>{if(el.type==='checkbox')el.checked=false;else if(el.tagName==='SELECT')el.selectedIndex=0;else el.value='';}); console.log("Modulo resettato."); }
    function saveProgress(targa) { /* ...invariata... */ if(!targa){console.warn("No targa for save.");return false;} const data={}; document.querySelectorAll('#checklistContainer input[type="checkbox"],#checklistContainer select').forEach(el=>{if(el.id){if(el.type==='checkbox')data[el.id]=el.checked;else data[el.id]=el.value;}}); try{localStorage.setItem(`${APP_PREFIX}data_${targa}`,JSON.stringify(data));console.log(`Saved for ${targa}.`);return true;}catch(e){console.error("LS Save Err:",e);alert("Save failed.");return false;}}
    function loadProgress(targa) { /* ...invariata... */ if(!targa)return; resetChecklistForm(); try{const json=localStorage.getItem(`${APP_PREFIX}data_${targa}`); if(json){const data=JSON.parse(json); document.querySelectorAll('#checklistContainer input[type="checkbox"],#checklistContainer select').forEach(el=>{if(el.id&&data.hasOwnProperty(el.id)){if(el.type==='checkbox')el.checked=data[el.id];else el.value=data[el.id];}}); console.log(`Loaded for ${targa}.`);}else console.log(`No saved data for ${targa}.`);}catch(e){console.error("LS Load Err:",e);}}
    function getCompletedTarghe() { /* ...invariata... */ try{const json=localStorage.getItem(`${APP_PREFIX}completedTarghe`);return json?JSON.parse(json):{};}catch(e){return{};}}
    function markTargaAsCompleted(targa) { /* ...invariata... */ if(!targa)return; try{const completed=getCompletedTarghe();completed[targa]=true;localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));console.log(`${targa} marked complete.`);}catch(e){console.error("LS Mark Err:",e);}}
    function isTargaCompleted(targa) { /* ...invariata... */ const completed=getCompletedTarghe(); return !!(completed[targa]); }
    function generateAndDownloadScreenshot() { /* ...invariata... */ return new Promise((resolve,reject)=>{ const riepilogoSection=document.getElementById('riepilogoSection'); if(!riepilogoSection){alert("Err: Riepilogo non trovato.");return reject("");} if(typeof html2canvas==='undefined'){alert("Err: html2canvas non caricata.");return reject("");} setTimeout(()=>{ alert("Screenshot...\nDownload a breve."); riepilogoSection.scrollTop=0; html2canvas(riepilogoSection,{scale:2,useCORS:true,logging:false}).then(canvas=>{const link=document.createElement('a');const targaNomeFile=targaSelezionataGlobalmente?targaSelezionataGlobalmente.replace(/[^a-zA-Z0-9]/g,'_'):'sconosciuta';link.download=`riepilogo_perizia_${targaNomeFile}.png`;link.href=canvas.toDataURL('image/png');document.body.appendChild(link);link.click();document.body.removeChild(link);console.log("Screenshot OK.");resolve();}).catch(error=>{console.error("Screenshot Err:",error);alert("Errore screenshot.");reject(error);});},100);});}
    async function handleSavePeriziaAndReturn() { /* ...invariata... */ if(!targaSelezionataGlobalmente){alert("No targa attiva.");return;} if(!saveProgress(targaSelezionataGlobalmente)){alert("Salvataggio dati fallito.");return;} if(document.getElementById('riepilogoSection').classList.contains('active')){generateSummary();} try{await generateAndDownloadScreenshot();}catch(e){console.warn("Screenshot fallito, ma dati salvati.");} markTargaAsCompleted(targaSelezionataGlobalmente); alert(`Perizia per ${targaSelezionataGlobalmente} salvata, screenshot tentato, completata. Torno all'elenco.`); targaSelezionataGlobalmente=null;showMainUI(false);caricaEPopolaTarghe();}
    function handleSaveAndNext() { /* ...invariata... */ if(!targaSelezionataGlobalmente){alert("No targa.");return;} if(saveProgress(targaSelezionataGlobalmente)){const oT=this.textContent;this.textContent='Salvato!';this.disabled=true;setTimeout(()=>{this.textContent=oT;this.disabled=false;},1500);}else return; let curIdx=-1; navButtons.forEach((nb,i)=>{if(nb.classList.contains('active'))curIdx=i;}); if(curIdx!==-1&&curIdx<navButtons.length-1){const nextNB=navButtons[curIdx+1];if(nextNB)showSection(nextNB.dataset.target);}}
    function showMainUI(show) { /* ...invariata... */ const dV=show?'block':'none',fV=show?'flex':'none';headerCircles.style.display=fV;mainTitleGlobal.style.display=dV;navButtonsContainer.style.display=fV;checklistContainer.style.display=dV;mainContentWrapper.style.paddingTop=show?'70px':'20px';mainContentWrapper.style.margin=show?'0':'0 auto';mainContentWrapper.style.maxWidth=show?'none':'800px';if(show){landingPageSection.style.display='none';if(targaSelezionataGlobalmente)mainTitleGlobal.textContent=`Perizia - Targa: ${targaSelezionataGlobalmente}`;else mainTitleGlobal.textContent=`Perizia Veicolo`;}else{landingPageSection.style.display='block';mainTitleGlobal.textContent=`Perizia Veicolo`;const actR=document.querySelector('input[name="targa_selection_radio"]:checked');if(actR)actR.checked=false;procediConPeriziaBtn.disabled=true;}}
    async function caricaEPopolaTarghe() { /* ...invariata (usa la versione con più colonne)... */
        targheLoadingStatus.textContent = "Caricamento targhe...";
        targheLoadingStatus.style.color = "#00aeff";
        procediConPeriziaBtn.disabled = true; 
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!response.ok) {
                let errMessage = `Errore HTTP ${response.status}.`;
                if(response.status === 0) errMessage = "Errore di rete o CORS.";
                else if(response.status === 404) errMessage = "File CSV non trovato (404).";
                else if(response.status === 403) errMessage = "Accesso al file CSV negato (403).";
                throw new Error(errMessage);
            }
            const csvText = await response.text();
            const lines = csvText.split(/\r\n|\n|\r/).filter(line => line.trim() !== "");

            if (lines.length === 0) {
                targheLoadingStatus.textContent = "Nessun dato trovato nel foglio CSV.";
                targheLoadingStatus.style.color = "orange"; return;
            }
            
            listaTargheCompleta = lines.map(line => {
                const parts = line.split(',');
                return {
                    targa: (parts[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(),
                    marca: (parts[1] || '').trim().replace(/^"|"$/g, ''),
                    modello: (parts[2] || '').trim().replace(/^"|"$/g, ''),
                    piazzale: (parts[3] || '').trim().replace(/^"|"$/g, '')
                };
            }).filter(item => item.targa && item.targa.length > 3);

            targaListContainer.innerHTML = ''; 
            while (targaSelectChecklist.options.length > 1) targaSelectChecklist.remove(1);
            
            if (listaTargheCompleta.length === 0) {
                targheLoadingStatus.textContent = "Nessuna targa valida trovata dopo l'elaborazione del CSV.";
                targheLoadingStatus.style.color = "orange"; return;
            }

            listaTargheCompleta.forEach((item, index) => {
                const listItemDiv = document.createElement('div');
                listItemDiv.classList.add('targa-list-item');
                if (isTargaCompleted(item.targa)) listItemDiv.classList.add('completed');
                const radioId = `targa_radio_${index}`;
                const radioButton = document.createElement('input');
                radioButton.type = 'radio'; radioButton.name = 'targa_selection_radio';
                radioButton.value = item.targa; radioButton.id = radioId;
                const label = document.createElement('label');
                label.htmlFor = radioId; label.classList.add('radio-label-container');
                label.innerHTML = `<span class="targa-col targa-col-targa">${item.targa||'N/D'}</span><span class="targa-col targa-col-marca">${item.marca||'N/D'}</span><span class="targa-col targa-col-modello">${item.modello||'N/D'}</span><span class="targa-col targa-col-piazzale">${item.piazzale||'N/D'}</span>`;
                listItemDiv.appendChild(radioButton); listItemDiv.appendChild(label);
                targaListContainer.appendChild(listItemDiv);
                const optionChecklist = document.createElement('option');
                optionChecklist.value = item.targa; optionChecklist.textContent = item.targa;
                targaSelectChecklist.appendChild(optionChecklist);
            });
            targheLoadingStatus.textContent = "Seleziona una targa dall'elenco:";
            targheLoadingStatus.style.color = "#f0f0f0"; 
            document.querySelectorAll('input[name="targa_selection_radio"]').forEach(radio => {
                radio.addEventListener('change', function(){ if(this.checked){targaSelezionataGlobalmente=this.value;procediConPeriziaBtn.disabled=false;}});
            });
        } catch (error) {
            console.error("Errore caricamento targhe:", error);
            targheLoadingStatus.textContent = `Errore: ${error.message}.`;
            targheLoadingStatus.style.color = "red";
        }
    }
    procediConPeriziaBtn.addEventListener('click', () => { /* ...invariata... */ if(targaSelezionataGlobalmente){targaSelectChecklist.value=targaSelezionataGlobalmente;showMainUI(true);loadProgress(targaSelezionataGlobalmente);if(navButtons.length>0)showSection(navButtons[0].dataset.target);}else alert("Seleziona targa.");});
    function showSection(targetId) { /* ...invariata... */ sections.forEach(s=>s.classList.toggle('active',s.id===targetId+'Section'));navButtons.forEach(b=>b.classList.toggle('active',b.dataset.target===targetId));if(targetId==='riepilogo')generateSummary();}
    navButtons.forEach(b => b.addEventListener('click', function() { showSection(this.dataset.target); }));
    function getSelectText(id) { /* ...invariata... */ const el=document.getElementById(id);if(el&&el.value!==""){if(el.selectedIndex>=0&&el.options[el.selectedIndex])return el.options[el.selectedIndex].text;return el.value;}return"N/S";}
    function generateSummary() { /* ...invariata... */ summaryContent.innerHTML='';let targa=targaSelezionataGlobalmente||(targaSelectChecklist.value||"N/A");summaryContent.innerHTML+=`<div class="summary-item"><strong>Targa:</strong> ${targa}</div>`;summaryContent.innerHTML+=`<h3>Remarketing:</h3><div class="summary-item"><strong>Equip.:</strong> ${getSelectText('tipo_equipaggiamento')}</div><div class="summary-item"><strong>Presenza:</strong> ${getSelectText('equipaggiamento_presenza')}</div><div class="summary-item"><strong>KM:</strong> ${getSelectText('stato_chilometri')}</div><div class="summary-item"><strong>CDC:</strong> ${getSelectText('stato_cdc')}</div>`;summaryContent.innerHTML+=`<h3>Pneumatici:</h3><div class="summary-item"><strong>AS:</strong> ${getSelectText('pneumatico_as')}</div><div class="summary-item"><strong>AD:</strong> ${getSelectText('pneumatico_ad')}</div><div class="summary-item"><strong>PD:</strong> ${getSelectText('pneumatico_pd')}</div><div class="summary-item"><strong>PS:</strong> ${getSelectText('pneumatico_ps')}</div>`;summaryContent.innerHTML+=`<h3>Danni/Verifiche:</h3><div class="summary-item"><strong>Motore:</strong> ${getSelectText('motore_accende')}</div><div class="summary-item"><strong>Batteria:</strong> ${getSelectText('batteria_stato')}</div>`;}
    
    document.addEventListener('DOMContentLoaded', () => {
        showMainUI(false); 
        caricaEPopolaTarghe();
        
        // MODIFICATO: Event listener per il nuovo pulsante "Elenco Targhe"
        if (backToListBtn) { 
            backToListBtn.addEventListener('click', () => {
                targaSelezionataGlobalmente = null; // Resetta la targa attiva
                showMainUI(false); // Mostra la landing page
                // Non è strettamente necessario ricaricare le targhe qui, 
                // a meno che lo stato di completamento non possa cambiare mentre si è sulla checklist
                // caricaEPopolaTarghe(); // Opzionale: rinfresca la lista se necessario
            });
        }

        if (saveAndReturnBtn) {
            saveAndReturnBtn.addEventListener('click', handleSavePeriziaAndReturn);
        }
        
        saveAndNextButtons.forEach(button => {
            button.addEventListener('click', handleSaveAndNext);
        });
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>