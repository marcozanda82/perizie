<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perizia Veicolo</title>
    <style>
        /* Preloader Styles */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000; /* Pagina Nera */
            z-index: 99999; 
            display: flex; /* Nascosto di default, JS lo mostra se necessario */
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
            visibility: visible;
        }
        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
        }
        #preloader .loader-bar-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px; 
        }
        #preloader .loader-bar {
            width: 15px;
            height: 70px; /* Altezza ridotta per un look più compatto */
            background-color: #007bff; /* Blu Elettrico base */
            animation: barPulse 1.2s infinite ease-in-out;
            box-shadow: 0 0 8px #007bff, 0 0 15px #00aeff; /* Glow blu */
            border-radius: 3px;
        }
        #preloader .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        #preloader .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        @keyframes barPulse {
            0%, 100% { transform: scaleY(0.3); opacity: 0.6; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        #preloader .loading-text {
            color: #00aeff; 
            font-size: 1.6em;
            letter-spacing: 1px;
            animation: textGlow 1.8s infinite alternate ease-in-out;
        }
        @keyframes textGlow {
          from { text-shadow: 0 0 5px #007bff, 0 0 10px #00aeff; opacity: 0.8;}
          to   { text-shadow: 0 0 10px #0AF, 0 0 20px #0AF, 0 0 30px #0CF; opacity: 1;}
        }


        /* ... (resto degli stili CSS esistenti) ... */
        .header-circles { display: flex; justify-content: space-around; align-items: center; width: 100%; padding: 8px 0; box-sizing: border-box; }
        .circle { 
            width: 1.5cm; height: 1.5cm; background-color: #ffffff; 
            border-radius: 50%; flex-shrink: 0; 
            opacity: 0.8; 
        }
        body { font-family: sans-serif; line-height: 1.6; margin: 0; background-color: #1e1e1e; color: #f0f0f0; transition: padding-top 0.3s ease; }
        .content-wrapper { padding: 20px; }
        h1, h2 { text-align: center; color: #ffffff; }
        h1#mainTitleGlobal { line-height: 1.2; margin-bottom: 10px; margin-top: 5px; font-size: 1.6em;}
        h2.section-title { color: #cccccc; border-bottom: 1px solid #444444; padding-bottom: 5px; margin-top: 30px; text-align: left; }
        h3, h4 { color: #bbbbbb; margin-top: 20px; margin-bottom: 10px; }
        h4 {font-size: 1.1em; color: #c0c0c0; margin-top: 15px; margin-bottom: 8px;}
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 15px; }
        input[type="checkbox"], input[type="text"], input[type="url"], select, input[type="radio"], textarea { margin-right: 8px; vertical-align: middle; padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; margin-bottom: 5px; font-family: sans-serif;}
        input[type="text"], input[type="url"], textarea { width: calc(100% - 20px); box-sizing: border-box; }
        input[type="radio"] { margin-left: 5px; }
        select { min-width: 220px; }
        label { vertical-align: middle; display: block; margin-bottom: 5px; color: #e0e0e0; }
        textarea {resize: vertical;}

        .category-section ul li > input[type="checkbox"] {
            vertical-align: middle;
            margin-right: 4px; 
        }
        .category-section ul li > input[type="checkbox"] + label {
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 0;
        }

        #pageHeaderContainer {
            background-color: #1e1e1e;
            z-index: 1000;
            width: 100%;
        }
        #pageHeaderContainer.fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            padding-bottom: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        
        #navButtons { 
            display: flex;
            flex-direction: column; 
            align-items: center; 
            width: 100%;
        }
        #mainPageNavButtons {
            display: flex;
            justify-content: center;
            flex-wrap: nowrap; 
            overflow-x: auto; 
            padding: 5px 0;
            width: calc(100% - 20px); 
            max-width: 700px; 
        }
        #mainPageNavButtons button {
            margin: 3px; 
            flex-shrink: 0; 
        }
        #utilityNavButtons {
            display: flex;
            justify-content: center;
            flex-wrap: wrap; 
            margin-top: 5px;
        }
        #utilityNavButtons button {
            margin: 3px 5px; 
        }

        #navButtons button, .action-button, #procediConPeriziaBtn { 
             padding: 8px 15px; cursor: pointer; background-color: #007bff; color: white; border: 1px solid #0056b3; border-radius: 4px; transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; font-size: 0.9em; 
        }
        #procediConPeriziaBtn { display: block; margin: 15px auto; padding: 12px 25px; font-size: 1.1em; }
        .save-and-next-btn { background-color: #0069d9 !important; border-color: #005cbf !important; }
        .save-and-next-btn:hover { background-color: #0056b3 !important; border-color: #004085 !important; }
        #navButtons button:hover, .action-button:hover, #procediConPeriziaBtn:hover { background-color: #0056b3; border-color: #004085; }
        #procediConPeriziaBtn:disabled { background-color: #555; border-color: #444; cursor: not-allowed; }
        
        @keyframes activeButtonGlow {
            0% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; }
            50% { box-shadow: 0 0 10px rgba(0, 150, 255, 1), 0 0 15px rgba(0, 150, 255, 0.7) inset; }
            100% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; }
        }

        #navButtons button.active { 
            background-color: #0056b3 !important; border-color: #004085 !important; color: white !important; 
            animation-name: activeButtonGlow; animation-duration: 1.8s;
            animation-iteration-count: infinite; animation-timing-function: ease-in-out;
            animation-direction: alternate;
        }
        #navButtons button.nav-btn-completed { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        #navButtons button.nav-btn-partial { background-color: #ffc107 !important; border-color: #e0a800 !important; color: #212529 !important; }
        #navButtons button.nav-btn-untouched { background-color: #dc3545 !important; border-color: #c82333 !important; color: white !important; }

        #landingPageSection, .category-section, #historyPageSection { padding: 20px; border: 1px solid #444; border-radius: 8px; margin-top: 20px; background-color: #2a2a2a; max-width: 850px; margin-left: auto; margin-right: auto; }
        
        .category-section, #historyPageSection { display: none; } 
        #landingPageSection { display: block; } 
        .category-section.active { display: block; }
        
        .summary-item { margin-bottom: 8px; padding: 8px; background-color: #333; border-radius: 3px; }
        .summary-item strong { color: #00aeff; }
        .summary-anomaly {
            background-color: #5d3d3d !important; color: #ffdddd !important;
            border-left: 3px solid #ff8888; padding-left: 10px !important; 
        }
        .summary-anomaly strong { color: #ffc0c0 !important; }
        .summary-notes {
            background-color: #3a3a4a !important; color: #e0e0ff !important;
            border-left: 3px solid #8888ff; padding-left: 10px !important;
        }
        .summary-notes strong { color: #c0c0ff !important; }
        
        .table-scroll-wrapper { overflow-x: auto; width: 100%; margin-bottom: 10px; border: 1px solid #444; border-radius: 4px; }
        .targa-list-table-content { min-width: 650px; }
        .targa-list-header { display: flex; font-weight: bold; padding: 0; border-bottom: 2px solid #777; color: #ddd; background-color: #3a3a3a; }
        .targa-list-header .targa-col-radio-spacer { flex-basis: 45px; flex-shrink: 0; padding: 6px 8px; border-right: 1px solid #555; }
        .targa-list-header .targa-col { padding: 6px 8px; border-right: 1px solid #555; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1;}
        .targa-list-header .targa-col:last-child { border-right: none; }
        .targa-list-header .targa-col-actions { flex-basis: 60px; text-align: center; flex-grow: 0; }

        #targaListContainer { margin-top: 0; max-height: 350px; overflow-y: auto; overflow-x: visible; padding: 0; }
        .targa-list-item { display: flex; align-items: center; border-bottom: 1px solid #444; }
        .targa-list-item:last-child { border-bottom: none; }
        .targa-list-item input[type="radio"] { margin: 0 0 0 10px; padding: 10px 0px 10px 0px; border-right: 1px solid #444; margin-right:0; padding-right:10px; flex-shrink: 0; min-width: 35px; box-sizing: content-box; }
        
        label.radio-label-container { 
            display: flex; flex-grow: 1; cursor: pointer; color: #f0f0f0; padding: 0; 
            min-width: calc(100% - 45px - 60px); align-items: center; 
        }
        .targa-list-item .targa-col { 
            padding: 8px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
            border-right: 1px solid #444; text-align: left; flex-grow: 1; display: flex; align-items: center;
        }
        .targa-list-item .targa-col:last-child { border-right: none; }
        
        .targa-col-targa    { flex-basis: 15%; min-width: 80px;}
        .targa-col-posizione{ flex-basis: 15%; min-width: 70px; padding: 4px !important; } 
        .targa-col-marca    { flex-basis: 20%; min-width: 100px;}
        .targa-col-modello  { flex-basis: 25%; min-width: 110px;} 
        .targa-col-piazzale { flex-basis: 20%; min-width: 80px;}  
        .targa-col-actions  { flex-basis: 60px; flex-grow: 0; }

        .targa-col-posizione input.posizione-input {
            width: 100%; padding: 6px 4px; margin: 0; box-sizing: border-box;
            background-color: #404040; color: #f0f0f0;
            border: 1px solid #5a5a5a; border-radius: 3px;
            font-size: 0.9em; text-align: center;
        }
        .targa-col-posizione input.posizione-input:focus {
            background-color: #484848; border-color: #777; outline: none;
        }

        .delete-progress-btn { background-color: #dc3545; border-color: #c82333; color: white; padding: 3px 7px; font-size: 0.8em; line-height: 1; margin-left: 8px; margin-right: 8px; flex-shrink: 0; border-radius: 3px; }
        .delete-progress-btn:hover { background-color: #c82333; border-color: #bd2130; }

        .targa-list-item.status-da-vedere { background-color: #54542E !important; }
        .targa-list-item.status-da-vedere:hover { background-color: #666639 !important; }
        .targa-list-item.status-da-vedere label.radio-label-container .targa-col { color: #f0f0f0 !important; }
        .targa-list-item.status-da-vedere .targa-col-posizione input.posizione-input { background-color: #606038; color: #f0f0f0;}

        .targa-list-item.status-visto { background-color: #2E4B35 !important; }
        .targa-list-item.status-visto:hover { background-color: #395c40 !important; }
        .targa-list-item.status-visto label.radio-label-container .targa-col-targa,
        .targa-list-item.status-visto label.radio-label-container .targa-col-marca,
        .targa-list-item.status-visto label.radio-label-container .targa-col-modello,
        .targa-list-item.status-visto label.radio-label-container .targa-col-piazzale { color: #a3cca3 !important; }
        .targa-list-item.status-visto .targa-col-posizione input.posizione-input { background-color: #384c3d; color: #d0e0d0; }

        .targa-list-item.urgent-item { background-color: #4d3232 !important; border-left: 3px solid #ff6b6b; }
        .targa-list-item.urgent-item:hover { background-color: #5e3f3f !important; }
        .targa-list-item.urgent-item:not(.completed) label.radio-label-container .targa-col { color: #ffc0c0 !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-posizione input.posizione-input { background-color: #5a3e3e; color: #ffc0c0; }

        .targa-list-item.completed label.radio-label-container .targa-col-targa,
        .targa-list-item.completed label.radio-label-container .targa-col-marca,
        .targa-list-item.completed label.radio-label-container .targa-col-modello,
        .targa-list-item.completed label.radio-label-container .targa-col-piazzale { color: #888 !important; }
        
        .targa-list-item.status-visto.completed label.radio-label-container .targa-col-targa,
        .targa-list-item.status-visto.completed label.radio-label-container .targa-col-marca,
        .targa-list-item.status-visto.completed label.radio-label-container .targa-col-modello,
        .targa-list-item.status-visto.completed label.radio-label-container .targa-col-piazzale { color: #a3cca3 !important; }

        .targa-list-item.urgent-item.completed label.radio-label-container .targa-col-targa,
        .targa-list-item.urgent-item.completed label.radio-label-container .targa-col-marca,
        .targa-list-item.urgent-item.completed label.radio-label-container .targa-col-modello,
        .targa-list-item.urgent-item.completed label.radio-label-container .targa-col-piazzale { color: #a07c7c !important; }
        .targa-list-item.urgent-item.completed .targa-col-posizione input.posizione-input { background-color: #4a2e2e; color: #a07c7c; }

        #targheLoadingStatus { text-align: center; padding: 10px; color: #00aeff; }
        #savedTargasListContainer { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #333; border-radius: 4px; margin-bottom: 20px; }
        .saved-targa-button { display: block; width: 100%; padding: 10px; background-color: #383838; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; text-align: left; cursor: pointer; font-size: 0.95em; }
        .saved-targa-button:hover { background-color: #454545; }
        #historyPageSection .action-button { margin-right: 10px; }
        #sheetFilterContainer { margin-bottom: 15px; text-align: center; }
        #sheetFilterContainer label { margin-right: 10px; color: #ccc; display: inline-block; }
        #sheetFilterDropdown { padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; min-width: 250px; vertical-align: middle; }

        @media (max-width: 768px) {
            .content-wrapper { margin-top: 0; }
            .circle { width: 1.2cm; height: 1.2cm; }
            #navButtons button, .action-button { padding: 8px 10px; font-size: 0.85em; } 
            #procediConPeriziaBtn { padding: 10px 15px; font-size: 1em; }

            #mainPageNavButtons {
                width: 100%; 
                padding: 5px; 
                box-sizing: border-box;
            }
             #mainPageNavButtons button {
                font-size: 0.8em; 
                padding: 6px 8px;
            }
            #utilityNavButtons button {
                font-size: 0.85em;
                 padding: 8px 10px;
            }

            input[type="text"], input[type="url"], select, textarea { width: 100%; box-sizing: border-box; }
            .table-scroll-wrapper { overflow-x: auto; }
            .targa-list-table-content { min-width: 600px; } 
            .targa-list-header { display: flex !important; }
            .targa-list-header .targa-col, .targa-list-item .targa-col { padding: 6px 5px; }
            .targa-list-header .targa-col-radio-spacer { flex-basis: 35px; padding: 6px 5px; }
            .targa-list-item input[type="radio"] { min-width: 25px; padding-right: 5px; }
            .delete-progress-btn { padding: 5px 8px; }
            label.radio-label-container { min-width: calc(100% - 35px - 50px); } 
            .targa-col-targa    { min-width: 70px;}
            .targa-col-posizione{ min-width: 60px;}
            .targa-col-marca    { min-width: 80px;}
            .targa-col-modello  { min-width: 90px;}
            .targa-col-piazzale { min-width: 70px;}
            #sheetFilterContainer { display: flex; flex-direction: column; align-items: stretch; }
            #sheetFilterContainer label { margin-bottom: 5px; margin-right: 0; text-align: left;}
            #sheetFilterDropdown { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="preloader" style="display: none;"> {/* Nascosto di default, JS gestisce la visibilità */}
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="pageHeaderContainer"> 
        <div class="header-circles">
            <div class="circle"></div> <div class="circle"></div> <div class="circle"></div> <div class="circle"></div>
        </div>
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1> 
        <div id="navButtons"> 
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
            <div id="utilityNavButtons">
                <button id="backToListBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe</button>
                <button id="historyBtn" class="action-button" style="background-color: #17a2b8; border-color: #117a8b;">Salvataggi</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;"> 
            <h2 style="margin-top: 10px;">Seleziona Veicolo da Periziare</h2>
            
            <div id="sheetFilterContainer">
                <label for="sheetFilterDropdown">Filtra per Elenco:</label>
                <select id="sheetFilterDropdown">
                    <option value="all">Tutti gli Elenchi</option>
                </select>
            </div>
            
            <button id="procediConPeriziaBtn" disabled>Procedi alla Perizia</button>

            <div id="targheLoadingStatus">Caricamento targhe in corso...</div>
            <div class="table-scroll-wrapper">
                <div class="targa-list-table-content"> 
                    <div class="targa-list-header">
                        <div class="targa-col-radio-spacer"></div> 
                        <span class="targa-col targa-col-targa">Targa</span>
                        <span class="targa-col targa-col-posizione">Posizione</span>
                        <span class="targa-col targa-col-marca">Marca</span>
                        <span class="targa-col targa-col-modello">Modello</span>
                        <span class="targa-col targa-col-piazzale">Piazzale</span>
                        <span class="targa-col targa-col-actions">Azioni</span>
                    </div>
                    <div id="targaListContainer"></div>
                </div>
            </div>
        </div>

        <div id="checklistContainer" style="display: none;">
            <div id="remarketingSection" class="category-section">
                <h2 class="section-title">1. Foto Remarketing</h2>
                <ul>
                    <li> 
                        <input type="checkbox" id="is_electric_vehicle">
                        <label for="is_electric_vehicle">Veicolo a trazione elettrica</label>
                    </li>
                    <li><input type="checkbox" id="foto_angolari"><label for="foto_angolari">Foto angolari (3/4)</label></li>
                    <li> 
                        <input type="checkbox" id="foto_vano_carico">
                        <label for="foto_vano_carico">Vano Carico</label>
                    </li>
                    <li> 
                        <label for="tipo_equipaggiamento">Equipaggiamento:</label>
                        <select id="tipo_equipaggiamento">
                            <option value="">Seleziona...</option>
                            <option value="kit_gonfia_ripara">Kit</option>
                            <option value="ruota">Ruota</option>
                            <option value="ruotino">Ruotino</option>
                            <option value="runflat">Runflat</option>
                        </select>
                    </li>
                    <li><label for="equipaggiamento_presenza">Presenza equip.:</label><select id="equipaggiamento_presenza"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_interni_pannelli"><label for="foto_interni_pannelli">Interni/pannelli</label></li>
                    <li><input type="checkbox" id="foto_cruscotto"><label for="foto_cruscotto">Cruscotto</label></li>
                    <li><label for="stato_chilometri">Chilometri - Stato:</label><select id="stato_chilometri"><option value="">Seleziona...</option><option value="rilevabili">Rilevabili</option><option value="non_rilevabili">Non rilevabili</option></select></li>
                    <li><label for="stato_cdc">CDC - Stato:</label><select id="stato_cdc"><option value="">Seleziona...</option><option value="originale">Originale</option><option value="copia_conforme">Copia conforme</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_vano_motore"><label for="foto_vano_motore">Vano motore</label></li>
                    <li><input type="checkbox" id="foto_cofano_tetto"><label for="foto_cofano_tetto">Cofano e tetto</label></li>
                    <li>
                        <label for="chiave_telecomando">Chiave con telecomando:</label>
                        <select id="chiave_telecomando">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="seconda_chiave">Seconda chiave:</label>
                        <select id="seconda_chiave">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_rapida">Cavo ricarica rapida:</label>
                        <select id="cavo_ricarica_rapida" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_domestica">Cavo ricarica domestica:</label>
                        <select id="cavo_ricarica_domestica" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="pneumaticiSection" class="category-section">
                <h2 class="section-title">2. Foto Pneumatici</h2>
                <ul>
                    <li><label for="pneumatico_as">Ant. sinistro:</label><select id="pneumatico_as"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ad">Ant. destro:</label><select id="pneumatico_ad"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_pd">Post. destro:</label><select id="pneumatico_pd"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ps">Post. sinistro:</label><select id="pneumatico_ps"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="danniVerificheSection" class="category-section">
                <h2 class="section-title">3. Foto Danni e Verifiche</h2>
                <ul>
                    <li><label for="motore_accende">Motore si accende:</label><select id="motore_accende"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><label for="batteria_stato">Batteria:</label><select id="batteria_stato"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><input type="checkbox" id="foto_danni_generiche"><label for="foto_danni_generiche">Altre foto danni</label></li>
                    <li>
                        <label for="note_danni_verifiche">Note Danni/Verifiche:</label>
                        <textarea id="note_danni_verifiche" rows="4"></textarea>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Vai al Riepilogo</button></div>
            </div>
            <div id="riepilogoSection" class="category-section">
                <h2 class="section-title">Riepilogo Perizia</h2>
                <div id="summaryContent"><p><em>Compila le sezioni precedenti...</em></p></div>
                <button id="saveAndReturnBtn" class="action-button" style="background-color: #28a745; border-color: #1e7e34; margin-top: 15px;">Salva Perizia</button>
            </div>
        </div>

        <div id="historyPageSection" style="display: none;">
            <h2 class="section-title" style="text-align: center;">Cronistoria Salvataggi</h2>
            <div id="savedTargasListContainer"><p>Nessun salvataggio trovato.</p></div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="clearAllProgressBtn" class="action-button" style="background-color: #dc3545; border-color: #c82333;">Cancella Tutti i Salvataggi</button>
                <button id="backToLandingFromHistoryBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe Principale</button>
            </div>
        </div>
    </div>
<script>
    // ... (JavaScript precedente, inclusa la definizione delle costanti globali per gli elementi dell'header) ...
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection'); 
    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer'); 
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const procediConPeriziaBtn = document.getElementById('procediConPeriziaBtn');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer'); 
    const headerCircles = pageHeaderContainer.querySelector('.header-circles');
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons');

    const navButtons = navButtonsContainer.querySelectorAll('#mainPageNavButtons button[data-target]');
    const utilityButtons = navButtonsContainer.querySelectorAll('#utilityNavButtons button');


    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const backToListBtn = pageHeaderContainer.querySelector('#backToListBtn'); 
    const historyBtn = pageHeaderContainer.querySelector('#historyBtn'); 
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn'); 
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn'); 
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn'); 
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown'); 
    const isElectricVehicleCheckbox = document.getElementById('is_electric_vehicle');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');

    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv'; 
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_'; 

    function handleElectricVehicleChange() {
        if (!isElectricVehicleCheckbox || !cavoRapidaSelect || !cavoDomesticaSelect) return; 
        const isChecked = isElectricVehicleCheckbox.checked;
        cavoRapidaSelect.disabled = !isChecked;
        cavoDomesticaSelect.disabled = !isChecked;
        if (!isChecked) {
            cavoRapidaSelect.value = ""; 
            cavoDomesticaSelect.value = ""; 
        }
    }

    function savePosizioneForTarga(targa, posizione) {
        if (!targa) return;
        try {
            localStorage.setItem(`${APP_PREFIX}posizione_${targa}`, posizione);
        } catch (e) {
            console.error("Errore salvataggio posizione LS:", e);
        }
    }

    function loadPosizioneForTarga(targa) {
        if (!targa) return "";
        try {
            return localStorage.getItem(`${APP_PREFIX}posizione_${targa}`) || "";
        } catch (e) {
            console.error("Errore caricamento posizione LS:", e);
            return "";
        }
    }

    function resetChecklistForm() { 
        const els = document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea'); 
        els.forEach(el => {
            if (el.type === 'checkbox') el.checked = false;
            else if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        }); 
        if (cavoRapidaSelect) cavoRapidaSelect.disabled = true;
        if (cavoDomesticaSelect) cavoDomesticaSelect.disabled = true;
        console.log("Modulo resettato."); 
    }

    function saveProgress(targa) { 
        if(!targa){console.warn("Nessuna targa attiva per il salvataggio.");return false;} 
        const data = {}; 
        document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => {
            if (el.id) {
                if (el.type === 'checkbox') data[el.id] = el.checked;
                else data[el.id] = el.value;
            }
        }); 
        try {
            localStorage.setItem(`${APP_PREFIX}data_${targa}`, JSON.stringify(data));
            console.log(`Progresso salvato per la targa ${targa}.`); 
            updateNavButtonColors(); 
            return true;
        } catch(e) {
            console.error("Errore durante il salvataggio in localStorage:", e);
            alert("Salvataggio fallito. Spazio esaurito o errore del browser.");
            return false;
        }
    }

    function loadProgress(targa) { 
        if(!targa) return; 
        resetChecklistForm(); 
        try {
            const json = localStorage.getItem(`${APP_PREFIX}data_${targa}`); 
            if (json) {
                const data = JSON.parse(json); 
                document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => {
                    if (el.id && data.hasOwnProperty(el.id)) {
                        if (el.type === 'checkbox') el.checked = data[el.id];
                        else el.value = data[el.id];
                    }
                }); 
                console.log(`Progresso caricato per la targa ${targa}.`);
            } else {
                console.log(`Nessun dato salvato trovato per la targa ${targa}.`);
            }
            if (isElectricVehicleCheckbox) {
                 handleElectricVehicleChange();
            }
            updateNavButtonColors(); 
        } catch(e) {
            console.error("Errore durante il caricamento da localStorage:", e); 
            updateNavButtonColors();
        }
    }
    function getCompletedTarghe() { try{const json=localStorage.getItem(`${APP_PREFIX}completedTarghe`);return json?JSON.parse(json):{};}catch(e){return{};}}
    function markTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe();completed[targa]=true;localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));console.log(`${targa} marked complete.`);}catch(e){console.error("LS Mark Err:",e);}}
    function isTargaCompleted(targa) { const completed=getCompletedTarghe(); return !!(completed[targa]); }
    
    function deleteProgressForTarga(targa) { 
        if(!targa){return;} 
        try {
            localStorage.removeItem(`${APP_PREFIX}data_${targa}`);
            console.log(`Dati modulo rimossi per ${targa}.`);
            const completed = getCompletedTarghe();
            if(completed.hasOwnProperty(targa)){
                delete completed[targa];
                localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));
                console.log(`Stato completamento rimosso per ${targa}.`);
            }
            localStorage.removeItem(`${APP_PREFIX}posizione_${targa}`); 
            console.log(`Dati posizione rimossi per ${targa}.`);

        } catch(e) {
            console.error(`Errore cancellazione dati per ${targa}:`,e);
            alert(`Errore cancellazione dati per ${targa}.`);
        }
        if (typeof popolaTargheFiltrate === 'function') {
             popolaTargheFiltrate();
        }
        if (targaSelezionataGlobalmente === targa) { 
             targaSelezionataGlobalmente = null;
             procediConPeriziaBtn.disabled = true;
        }
    }

    function generateAndDownloadScreenshot() {
        return new Promise((resolve, reject) => {
            const riepilogoSection = document.getElementById('riepilogoSection');
            if (!riepilogoSection) {
                alert("Errore: Sezione Riepilogo non trovata per lo screenshot.");
                return reject("Sezione riepilogo non trovata");
            }
            if (typeof html2canvas === 'undefined') {
                alert("Errore: Libreria html2canvas non caricata.");
                return reject("html2canvas non caricata");
            }

            setTimeout(() => {
                console.log("Inizio generazione screenshot...");
                riepilogoSection.scrollTop = 0; 
                html2canvas(riepilogoSection, { scale: 2, useCORS: true, logging: false })
                    .then(canvas => {
                        const link = document.createElement('a');
                        
                        let targaSanitized = 'sconosciuta';
                        let piazzaleSanitized = 'piazzale_sconosciuto';

                        if (targaSelezionataGlobalmente) {
                            targaSanitized = targaSelezionataGlobalmente.replace(/[^a-zA-Z0-9.-]/g, '_'); 
                            
                            const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente);
                            if (veicoloAttuale && veicoloAttuale.piazzale && veicoloAttuale.piazzale.trim() !== "") {
                                piazzaleSanitized = veicoloAttuale.piazzale.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_');
                                if (!piazzaleSanitized) piazzaleSanitized = 'N_D'; 
                            } else {
                                piazzaleSanitized = 'N_D'; 
                            }
                        }
                        
                        link.download = `perizia_${targaSanitized}_${piazzaleSanitized}.png`;
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        console.log(`Screenshot generato e download avviato: ${link.download}`);
                        resolve();
                    })
                    .catch(error => {
                        console.error("Errore durante la generazione dello screenshot:", error);
                        alert("Si è verificato un errore durante la generazione dello screenshot.");
                        reject(error);
                    });
            }, 100); 
        });
    }
    async function handleSavePeriziaAndReturn() { if(!targaSelezionataGlobalmente){alert("No targa attiva.");return;} if(!saveProgress(targaSelezionataGlobalmente)){alert("Salvataggio dati fallito.");return;} if(document.getElementById('riepilogoSection').classList.contains('active')){generateSummary();} try{await generateAndDownloadScreenshot();}catch(e){console.warn("Screenshot fallito, ma dati salvati.");} markTargaAsCompleted(targaSelezionataGlobalmente); updateNavButtonColors(); alert(`Perizia per ${targaSelezionataGlobalmente} salvata, screenshot tentato, completata. Torno all'elenco.`); targaSelezionataGlobalmente=null;showView('landing');}
    function handleSaveAndNext() { if(!targaSelezionataGlobalmente){alert("No targa.");return;} if(saveProgress(targaSelezionataGlobalmente)){const oT=this.textContent;this.textContent='Salvato!';this.disabled=true;setTimeout(()=>{this.textContent=oT;this.disabled=false;},1500);}else return; let curIdx=-1; navButtons.forEach((nb,i)=>{if(nb.classList.contains('active'))curIdx=i;}); if(curIdx!==-1&&curIdx<navButtons.length-1){const nextNB=navButtons[curIdx+1];if(nextNB)showSection(nextNB.dataset.target);}}
    
    function isInputDefault(inputElement) { if (inputElement.type === 'checkbox') return !inputElement.checked; if (inputElement.tagName === 'SELECT') return inputElement.value === "" || inputElement.selectedIndex === 0; return true; }
    function getSectionInputs(sectionElementId) { const sectionDiv = document.getElementById(sectionElementId); if (!sectionDiv) return []; return sectionDiv.querySelectorAll('input[type="checkbox"], select'); }
    function getSectionStatus(sectionElementId, targaData) { const inputs = getSectionInputs(sectionElementId); if (inputs.length === 0) return 'completed'; let allDefault = true; let allNonDefault = true; let hasAtLeastOneNonDefault = false; inputs.forEach(input => { let isDefault; const savedValue = targaData && targaData.hasOwnProperty(input.id) ? targaData[input.id] : undefined; if (input.type === 'checkbox') { isDefault = (savedValue !== undefined ? !savedValue : !input.checked); } else { isDefault = (savedValue !== undefined ? (savedValue === "" || savedValue === input.options[0].value) : (input.value === "" || input.selectedIndex === 0)); } if (!isDefault) { allDefault = false; hasAtLeastOneNonDefault = true; } else { allNonDefault = false; } }); if (allDefault) return 'untouched'; if (allNonDefault) return 'completed'; if (hasAtLeastOneNonDefault) return 'partial'; return 'untouched'; }
    function updateNavButtonColors() { if (!targaSelezionataGlobalmente && checklistContainer.style.display === 'none') { navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched', 'active'); btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; }); return; } const targaDataJSON = localStorage.getItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`); const targaData = targaDataJSON ? JSON.parse(targaDataJSON) : null; navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched'); if (!btn.classList.contains('active')) { btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; } if (btn.classList.contains('active')) { return; } const targetSection = btn.dataset.target; let status = 'untouched'; if (targetSection === 'riepilogo') { if (isTargaCompleted(targaSelezionataGlobalmente)) { status = 'completed'; } else { let hasAnyDataForSummary = false; if (targaData && Object.keys(targaData).length > 0) { hasAnyDataForSummary = true; } else { ['remarketingSection', 'pneumaticiSection', 'danniVerificheSection'].forEach(secId => { if (getSectionStatus(secId, targaData) !== 'untouched') { hasAnyDataForSummary = true; } }); } status = hasAnyDataForSummary ? 'partial' : 'untouched'; } } else if (targetSection) { status = getSectionStatus(targetSection + 'Section', targaData); } if (status === 'completed') btn.classList.add('nav-btn-completed'); else if (status === 'partial') btn.classList.add('nav-btn-partial'); else btn.classList.add('nav-btn-untouched'); }); }

    function showView(viewName) {
        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';

        let bodyPaddingTopValue = '20px'; 

        if (viewName === 'landing') {
            landingPageSection.style.display = 'block';
            pageHeaderContainer.classList.add('fixed-header'); 
            headerCircles.style.display = 'flex';
            navButtonsContainer.style.display = 'none'; 
            mainTitleGlobal.innerHTML = "Elenco Veicoli"; 
            
            const activeRadio = document.querySelector('input[name="targa_selection_radio"]:checked');
            if (activeRadio) activeRadio.checked = false;
            procediConPeriziaBtn.disabled = true;
            if (sheetFilterDropdown) sheetFilterDropdown.value = 'all';
            if (listaTargheCompleta.length > 0 && typeof popolaTargheFiltrate === 'function') {
                popolaTargheFiltrate();
            }
            targaSelezionataGlobalmente = null;
            updateNavButtonColors(); 

        } else if (viewName === 'checklist' || viewName === 'history') {
            pageHeaderContainer.classList.add('fixed-header');
            headerCircles.style.display = 'flex';
            navButtonsContainer.style.display = 'flex';

            if (viewName === 'checklist') {
                if (!targaSelezionataGlobalmente) {
                    alert("Nessuna targa selezionata.");
                    showView('landing'); 
                    return; 
                }
                checklistContainer.style.display = 'block';
                const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente);
                let subIdentifier = (veicoloAttuale && (veicoloAttuale.marca || veicoloAttuale.modello))
                    ? `${veicoloAttuale.marca || ''} ${veicoloAttuale.modello || ''}`.trim()
                    : "";
                mainTitleGlobal.innerHTML = `${targaSelezionataGlobalmente}<br><span style="font-size: 0.5em; color: #ccc; font-weight: normal; line-height: 1.2;">${subIdentifier}</span>`;
            } else { 
                historyPageSection.style.display = 'block';
                mainTitleGlobal.innerHTML = "Cronistoria Salvataggi";
                populateSavedTargasList();
            }
            updateNavButtonColors();
        } else { 
            pageHeaderContainer.classList.remove('fixed-header');
            headerCircles.style.display = 'none';
            navButtonsContainer.style.display = 'none';
            mainTitleGlobal.innerHTML = ""; 
        }
        
        if (pageHeaderContainer.classList.contains('fixed-header')) {
            pageHeaderContainer.style.display = 'block'; 
            bodyPaddingTopValue = `${pageHeaderContainer.offsetHeight + 10}px`;
        } else {
            let nonFixedHeaderHeight = 0;
            if (mainTitleGlobal && typeof getComputedStyle === 'function' && getComputedStyle(mainTitleGlobal).display !== 'none') { 
                 nonFixedHeaderHeight = mainTitleGlobal.offsetHeight;
            }
            bodyPaddingTopValue = `${nonFixedHeaderHeight + 20}px`;
        }
        document.body.style.paddingTop = bodyPaddingTopValue;
    }
    
    function populateSavedTargasList() { savedTargasListContainer.innerHTML = ''; let hasSaves = false; const tempSavedTargas = []; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith(`${APP_PREFIX}data_`)) { const targa = key.substring(`${APP_PREFIX}data_`.length); if (targa && !tempSavedTargas.includes(targa)) { tempSavedTargas.push(targa);}}} if (tempSavedTargas.length > 0) hasSaves = true; tempSavedTargas.sort(); tempSavedTargas.forEach(targa => { const vehicleDetails = listaTargheCompleta.find(v => v.targa === targa) || { marca: '', modello: '', piazzale: '' }; let displayText = targa; let details = []; if (vehicleDetails.marca) details.push(vehicleDetails.marca); if (vehicleDetails.modello) details.push(vehicleDetails.modello); if (vehicleDetails.piazzale) details.push(`(Piazzale: ${vehicleDetails.piazzale})`); if (details.length > 0) { displayText += ` - ${details.join(' ')}`; } const button = document.createElement('button'); button.classList.add('saved-targa-button'); button.textContent = displayText; button.dataset.targa = targa; button.addEventListener('click', function() { targaSelezionataGlobalmente = this.dataset.targa; showView('checklist'); loadProgress(targaSelezionataGlobalmente); const firstChecklistNavButton = Array.from(navButtons).find(btn => btn.dataset.target && btn.id !== 'backToListBtn' && btn.id !== 'historyBtn'); if (firstChecklistNavButton) { showSection(firstChecklistNavButton.dataset.target); } else if (navButtons.length > 0 && navButtons[0].dataset.target) { showSection(navButtons[0].dataset.target); }}); savedTargasListContainer.appendChild(button); }); if (!hasSaves) { savedTargasListContainer.innerHTML = '<p style="text-align:center; color: #aaa;">Nessun salvataggio trovato.</p>'; } }
    
    function clearAllSavedData() { 
        if (confirm("ATTENZIONE!\n\nCancellare TUTTI i dati salvati (incluse posizioni)?\n\nAzione irreversibile.")) { 
            let c = 0; 
            for (let i=localStorage.length-1;i>=0;i--) { 
                const k=localStorage.key(i); 
                if (k.startsWith(APP_PREFIX)) { 
                    localStorage.removeItem(k);c++;
                }
            } 
            alert(`${c} elementi cancellati.`); 
            localStorage.removeItem(`${APP_PREFIX}preloaderPlayed_v2`); // Rimuovi anche il flag del preloader
            populateSavedTargasList(); 
            caricaEPopolaTarghe(); 
            showView('landing'); 
        } 
    }
    
    function setupSheetFilterDropdown() {
        if (!sheetFilterDropdown) return;
        const sources = ['all', ...new Set(listaTargheCompleta.map(item => item.piazzale).filter(p => p && p.trim() !== ''))];
        sheetFilterDropdown.innerHTML = ''; 
        sources.forEach(source => {
            const option = document.createElement('option');
            option.value = source;
            option.textContent = source === 'all' ? 'Tutti gli Elenchi' : source;
            sheetFilterDropdown.appendChild(option);
        });
        sheetFilterDropdown.removeEventListener('change', handleSheetFilterChange); 
        sheetFilterDropdown.addEventListener('change', handleSheetFilterChange);
    }

    function handleSheetFilterChange() {
        popolaTargheFiltrate();
        procediConPeriziaBtn.disabled = true; 
        const activeRadio = document.querySelector('input[name="targa_selection_radio"]:checked');
        if (activeRadio) activeRadio.checked = false; 
        targaSelezionataGlobalmente = null; 
    }

    function popolaTargheFiltrate() {
        const tEl = document.getElementById('targaListContainer');
        tEl.innerHTML = ''; 
        procediConPeriziaBtn.disabled = true;

        const selectedSource = sheetFilterDropdown ? sheetFilterDropdown.value : 'all';
        
        let preliminaryFilteredList = selectedSource === 'all'
            ? [...listaTargheCompleta] 
            : listaTargheCompleta.filter(item => item.piazzale === selectedSource);

        function getItemRank(item) {
            const isUrgent = item.isUrgent;
            const isCompleted = isTargaCompleted(item.targa);

            if (isUrgent && !isCompleted) return 1; 
            if (!isUrgent && !isCompleted) return 2; 
            if (!isUrgent && isCompleted) return 3; 
            if (isUrgent && isCompleted) return 4;   
            return 5; 
        }

        preliminaryFilteredList.sort((a, b) => {
            const rankA = getItemRank(a);
            const rankB = getItemRank(b);

            if (rankA !== rankB) {
                return rankA - rankB;
            }
            return a.targa.localeCompare(b.targa); 
        });
        
        const filteredList = preliminaryFilteredList;

        if (filteredList.length === 0) {
            tEl.innerHTML = '<p style="text-align:center; padding:10px; color: #aaa;">Nessuna targa trovata per questo filtro.</p>';
            targheLoadingStatus.textContent = selectedSource === 'all' ? "Nessuna targa nel CSV." : `Nessuna targa per l'elenco: ${selectedSource}.`;
            return;
        }

        filteredList.forEach((item, idx) => {
            const li = document.createElement('div');
            li.classList.add('targa-list-item');
            
            const itemCompleted = isTargaCompleted(item.targa);

            if (item.isUrgent) {
                li.classList.add('urgent-item');
                if (itemCompleted) {
                    li.classList.add('completed'); 
                }
            } else {
                if (itemCompleted) {
                    li.classList.add('status-visto');
                    li.classList.add('completed'); 
                } else {
                    li.classList.add('status-da-vedere');
                }
            }

            const rId = `targa_radio_filt_${idx}_${Date.now()}`; 
            const rb = document.createElement('input');
            rb.type = 'radio';
            rb.name = 'targa_selection_radio'; 
            rb.value = item.targa;
            rb.id = rId;
            li.appendChild(rb);

            const lab = document.createElement('label');
            lab.htmlFor = rId;
            lab.classList.add('radio-label-container');

            const targaCol = document.createElement('span');
            targaCol.classList.add('targa-col', 'targa-col-targa');
            targaCol.textContent = item.targa || 'N/D';
            lab.appendChild(targaCol);
            
            const posizioneCol = document.createElement('span');
            posizioneCol.classList.add('targa-col', 'targa-col-posizione');
            const posizioneInput = document.createElement('input');
            posizioneInput.type = 'text';
            posizioneInput.classList.add('posizione-input'); 
            posizioneInput.dataset.targa = item.targa;
            posizioneInput.placeholder = 'Pos.';
            posizioneInput.maxLength = 5; 
            posizioneInput.value = loadPosizioneForTarga(item.targa);
            posizioneInput.addEventListener('mousedown', (e) => e.stopPropagation());
            posizioneInput.addEventListener('click', (e) => e.stopPropagation());
            posizioneInput.addEventListener('focus', (e) => e.stopPropagation());
            posizioneInput.addEventListener('blur', function() {
                const newPosition = this.value.trim().toUpperCase();
                if (newPosition !== loadPosizioneForTarga(this.dataset.targa)) { 
                    savePosizioneForTarga(this.dataset.targa, newPosition);
                    this.style.transition = 'background-color 0.3s ease';
                    this.style.backgroundColor = 'rgba(76, 175, 80, 0.2)'; 
                    setTimeout(() => { this.style.backgroundColor = ''; }, 1000);
                }
            });
            posizioneInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); 
                    this.blur(); 
                }
            });
            posizioneCol.appendChild(posizioneInput);
            lab.appendChild(posizioneCol); 

            const marcaCol = document.createElement('span');
            marcaCol.classList.add('targa-col', 'targa-col-marca');
            marcaCol.textContent = item.marca || 'N/D';
            lab.appendChild(marcaCol);

            const modelloCol = document.createElement('span');
            modelloCol.classList.add('targa-col', 'targa-col-modello');
            modelloCol.textContent = item.modello || 'N/D';
            lab.appendChild(modelloCol);

            const piazzaleCol = document.createElement('span');
            piazzaleCol.classList.add('targa-col', 'targa-col-piazzale');
            piazzaleCol.textContent = item.piazzale || 'N/D';
            lab.appendChild(piazzaleCol);

            li.appendChild(lab);

            const delB = document.createElement('button');
            delB.classList.add('action-button', 'delete-progress-btn');
            delB.dataset.targa = item.targa;
            delB.title = `Cancella progressi per ${item.targa}`;
            delB.textContent = 'X';
            delB.addEventListener('click', function() {
                const tDel = this.dataset.targa;
                if (confirm(`ATTENZIONE:\n\nCancellare dati per ${tDel} (inclusa posizione)?\n\nAzione irreversibile.`)) {
                    deleteProgressForTarga(tDel); 
                }
            });
            li.appendChild(delB);
            tEl.appendChild(li);
        });

        document.querySelectorAll('input[name="targa_selection_radio"]').forEach(r => {
            r.addEventListener('change', function() {
                if (this.checked) {
                    targaSelezionataGlobalmente = this.value;
                    procediConPeriziaBtn.disabled = false;
                }
            });
        });
        targheLoadingStatus.textContent = "Seleziona targa dall'elenco:";
    }


    async function caricaEPopolaTarghe() { 
        targheLoadingStatus.textContent = "Caricamento..."; 
        procediConPeriziaBtn.disabled = true; 
        try { 
            const r=await fetch(GOOGLE_SHEET_CSV_URL); 
            if(!r.ok){let e=`HTTP ${r.status}.`;if(r.status===0)e="Rete/CORS.";else if(r.status===404)e="CSV(404).";else if(r.status===403)e="Accesso(403).";throw new Error(e);} 
            const csv=await r.text(); 
            const lines=csv.split(/\r\n|\n|\r/).filter(l=>l.trim()!==''); 
            if(lines.length===0){targheLoadingStatus.textContent="No dati CSV.";return;} 
            
            listaTargheCompleta = lines.map(l => {
                const p = l.split(',');
                return {
                    targa: (p[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(),
                    marca: (p[1] || '').trim().replace(/^"|"$/g, ''),
                    modello: (p[2] || '').trim().replace(/^"|"$/g, ''),
                    piazzale: (p[3] || '').trim().replace(/^"|"$/g, ''),
                    isUrgent: (p[4] || '').trim().toUpperCase() === 'URGENTE' 
                };
            }).filter(i => i.targa && i.targa.length > 3);
            
            if(listaTargheCompleta.length===0){
                targheLoadingStatus.textContent="No targhe valide nel CSV.";
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>';
                if (targaListContainer) targaListContainer.innerHTML = ''; 
                return;
            }
            setupSheetFilterDropdown(); 
            popolaTargheFiltrate(); 
        } catch(e) {
            console.error("Errore caricamento/popolamento targhe:",e);
            targheLoadingStatus.textContent=`Errore: ${e.message}.`;
            if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>';
            if (targaListContainer) targaListContainer.innerHTML = '';
        }
    }
    
    procediConPeriziaBtn.addEventListener('click', () => { if(targaSelezionataGlobalmente){ showView('checklist'); loadProgress(targaSelezionataGlobalmente); const firstNav = Array.from(navButtons).find(b=>b.dataset.target && b.id!=='backToListBtn' && b.id!=='historyBtn'); if(firstNav)showSection(firstNav.dataset.target); else if(navButtons.length>0&&navButtons[0].dataset.target)showSection(navButtons[0].dataset.target);} else alert("Seleziona targa.");});
    
    function showSection(targetId) {
        sections.forEach(s=>s.classList.toggle('active',s.id === targetId + 'Section'));
        navButtons.forEach(b => { 
            if (b.dataset.target === targetId) {
                b.classList.add('active');
            } else {
                b.classList.remove('active');
            }
        });
        updateNavButtonColors(); 
        if (targetId === 'riepilogo') generateSummary();
    }

    navButtons.forEach(b => b.addEventListener('click', function() { showSection(this.dataset.target); }));
    
    function getSelectText(id) {
        const el = document.getElementById(id);
        if (el && el.value !== "") {
            if (el.selectedIndex >= 0 && el.options[el.selectedIndex]) {
                return el.options[el.selectedIndex].text;
            }
            return el.value; 
        }
        return "N/S"; 
    }

    function generateSummary() {
        summaryContent.innerHTML = ''; 
        let targa = targaSelezionataGlobalmente || "N/D";
        
        function createSummaryItem(label, value, isAnomaly = false) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('summary-item');
            if (isAnomaly) {
                itemDiv.classList.add('summary-anomaly');
            }
            itemDiv.innerHTML = `<strong>${label}:</strong> ${value}`;
            return itemDiv;
        }
        
        summaryContent.appendChild(createSummaryItem("Targa", targa));

        if (targaSelezionataGlobalmente) {
            const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente);
            let marcaVeicolo = "N/D";
            let modelloVeicolo = "N/D";

            if (veicoloAttuale) {
                marcaVeicolo = veicoloAttuale.marca || "N/D";
                modelloVeicolo = veicoloAttuale.modello || "N/D";
            }
            summaryContent.appendChild(createSummaryItem("Marca", marcaVeicolo));
            summaryContent.appendChild(createSummaryItem("Modello", modelloVeicolo));

            const posizioneVeicolo = loadPosizioneForTarga(targaSelezionataGlobalmente);
            summaryContent.appendChild(createSummaryItem("Posizione", posizioneVeicolo || "N/D"));
        } else {
            summaryContent.appendChild(createSummaryItem("Marca", "N/D"));
            summaryContent.appendChild(createSummaryItem("Modello", "N/D"));
            summaryContent.appendChild(createSummaryItem("Posizione", "N/D"));
        }

        summaryContent.innerHTML += `<h3>Remarketing:</h3>`;
        const isEV = document.getElementById('is_electric_vehicle') && document.getElementById('is_electric_vehicle').checked;
        summaryContent.appendChild(createSummaryItem("Trazione Elettrica", isEV ? "Sì" : "No"));

        let equipaggiamento = getSelectText('tipo_equipaggiamento');
        let presenzaEquip = getSelectText('equipaggiamento_presenza');
        let equipAnomalia = (equipaggiamento !== "N/S" && equipaggiamento !== "" && equipaggiamento !== "Seleziona..." && presenzaEquip === "Mancante");
        summaryContent.appendChild(createSummaryItem("Equip. Vano Carico", equipaggiamento, equipAnomalia && presenzaEquip === "Mancante"));
        summaryContent.appendChild(createSummaryItem("Presenza Equip.", presenzaEquip, equipAnomalia));

        let kmStato = getSelectText('stato_chilometri');
        summaryContent.appendChild(createSummaryItem("Stato Chilometri", kmStato, kmStato === "Non rilevabili"));

        let cdcStato = getSelectText('stato_cdc');
        summaryContent.appendChild(createSummaryItem("Stato CDC", cdcStato, cdcStato === "Mancante"));
        
        summaryContent.appendChild(createSummaryItem("Chiave con Telecomando", getSelectText('chiave_telecomando'), getSelectText('chiave_telecomando') === "Non Presente"));
        summaryContent.appendChild(createSummaryItem("Seconda Chiave", getSelectText('seconda_chiave'), getSelectText('seconda_chiave') === "Non Presente"));

        if (isEV) {
            summaryContent.innerHTML += `<h4>Dotazioni Veicolo Elettrico:</h4>`;
            let cavoRapidaStato = getSelectText('cavo_ricarica_rapida');
            summaryContent.appendChild(createSummaryItem("Cavo Ricarica Rapida", cavoRapidaStato, cavoRapidaStato === "Non Presente"));

            let cavoDomesticaStato = getSelectText('cavo_ricarica_domestica');
            summaryContent.appendChild(createSummaryItem("Cavo Ricarica Domestica", cavoDomesticaStato, cavoDomesticaStato === "Non Presente"));
        }


        summaryContent.innerHTML += `<h3>Pneumatici:</h3>`;
        const pneumaticiFields = [
            { id: 'pneumatico_as', label: 'Ant. Sinistro' }, { id: 'pneumatico_ad', label: 'Ant. Destro' },
            { id: 'pneumatico_pd', label: 'Post. Destro' }, { id: 'pneumatico_ps', label: 'Post. Sinistro' }
        ];
        pneumaticiFields.forEach(pneu => {
            let pneuStato = getSelectText(pneu.id);
            summaryContent.appendChild(createSummaryItem(pneu.label, pneuStato, pneuStato === "Non conforme"));
        });
        
        summaryContent.innerHTML += `<h3>Danni/Verifiche:</h3>`;
        summaryContent.appendChild(createSummaryItem("Motore si Accende", getSelectText('motore_accende'), getSelectText('motore_accende') === 'Non OK'));
        summaryContent.appendChild(createSummaryItem("Stato Batteria", getSelectText('batteria_stato'), getSelectText('batteria_stato') === 'Non OK'));
        
        const noteDanniValue = document.getElementById('note_danni_verifiche') ? document.getElementById('note_danni_verifiche').value.trim() : "";
        if (noteDanniValue) {
            const noteDiv = document.createElement('div');
            noteDiv.classList.add('summary-item', 'summary-notes');
            const strongNode = document.createElement('strong');
            strongNode.textContent = "Note Danni/Verifiche: ";
            const contentDiv = document.createElement('div');
            contentDiv.style.whiteSpace = 'pre-wrap';
            contentDiv.style.paddingLeft = '10px';
            contentDiv.textContent = noteDanniValue; 
            
            noteDiv.appendChild(strongNode);
            noteDiv.appendChild(contentDiv);
            summaryContent.appendChild(noteDiv);
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const preloader = document.getElementById('preloader');
        const PRELOADER_FLAG = `${APP_PREFIX}preloaderPlayed_v2`; // Usa un nome versionato per il flag

        async function initializeApp() {
            if (!localStorage.getItem(PRELOADER_FLAG)) {
                if(preloader) preloader.style.display = 'flex';
                 // Non nascondere subito, ma dopo caricaEPopolaTarghe
            } else {
                if(preloader) preloader.style.display = 'none'; // Nascondi subito se già visto
            }

            showView('landing'); // Imposta la vista iniziale
            await caricaEPopolaTarghe(); // Attendi il caricamento dei dati

            if (!localStorage.getItem(PRELOADER_FLAG)) {
                if(preloader) {
                    preloader.classList.add('hidden');
                    preloader.addEventListener('transitionend', () => {
                        if (preloader.classList.contains('hidden')) {
                            preloader.style.display = 'none';
                        }
                    }, { once: true });
                }
                localStorage.setItem(PRELOADER_FLAG, 'true');
            } else {
                 if(preloader && preloader.style.display !== 'none') { // Assicura che sia nascosto
                    preloader.style.opacity = '0';
                    preloader.style.visibility = 'hidden';
                    preloader.style.display = 'none';
                 }
            }
        }
        
        if (isElectricVehicleCheckbox) { 
            isElectricVehicleCheckbox.addEventListener('change', handleElectricVehicleChange);
        }
        handleElectricVehicleChange(); // Stato iniziale cavi

        initializeApp(); // Avvia l'app

        if(backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if(historyBtn) historyBtn.addEventListener('click', () => showView('history')); 
        if(clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', clearAllSavedData); 
        if(backToLandingFromHistoryBtn) backToLandingFromHistoryBtn.addEventListener('click', () => showView('landing')); 
        if(saveAndReturnBtn)saveAndReturnBtn.addEventListener('click',handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button=>button.addEventListener('click',handleSaveAndNext));
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
