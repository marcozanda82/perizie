<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Perizia Veicolo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Preloader & Exit Curtain Styles */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); 
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 1;
            visibility: visible;
        }
        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
        }

        #exit-curtain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in, visibility 0.5s ease-in;
        }

        #exit-curtain.hidden {
             opacity: 0;
             visibility: hidden;
             transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
        }

        #exit-curtain.visible-no-transition {
            opacity: 1;
            visibility: visible;
            transition: none;
        }

        .loader-bar-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .loader-bar {
            width: 15px;
            height: 70px;
            background-color: #007bff;
            animation: barPulse 1.2s infinite ease-in-out;
            box-shadow: 0 0 8px #007bff, 0 0 15px #00aeff;
            border-radius: 3px;
        }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        #exit-curtain:not(.glitching):not(.flash-out-effect) .loader-bar {
            animation-direction: reverse;
        }
        #exit-curtain.glitching:not(.flash-out-effect) .loader-bar {
            animation-direction: normal;
        }
        
        @keyframes barPulse {
            0%, 100% { transform: scaleY(0.3); opacity: 0.6; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        #preloader .loading-text,
        #exit-curtain .loading-text {
            font-size: 1.6em;
            letter-spacing: 1px;
        }

        #preloader .loading-text {
            color: #00aeff;
            animation: textGlow 1.8s infinite alternate ease-in-out;
            text-align: center; 
            width: 100%; 
        }
        
        #exit-curtain .loading-text {
             color: #ff8787;
        }

        @keyframes textGlow {
          from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 0.8;}
          to   { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; opacity: 1;}
        }

        #exit-curtain.glitching .loading-text {
            animation: glitchText 0.8s infinite steps(1, end), textGlow 1.8s infinite alternate ease-in-out;
            color: #ff3030 !important; 
            position: relative;
            z-index: 10;
        }

        #exit-curtain.glitching::before,
        #exit-curtain.glitching::after {
            content: attr(data-text);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            padding: 0 20px;
            text-align: center;
            font-size: 1.6em;
            letter-spacing: 1px;
            background: #000000;
            overflow: hidden;
            clip-path: inset(50% 50% 50% 50%);
            z-index: 5;
        }

        #exit-curtain.glitching::before {
            color: #00ffff;
            animation: glitchEffect 0.3s infinite linear alternate-reverse;
        }

        #exit-curtain.glitching::after {
            color: #ff00ff;
            animation: glitchEffect 0.2s infinite linear alternate-reverse, glitchSkew 0.5s infinite linear alternate;
            animation-delay: -0.1s;
        }

        @keyframes glitchEffect {
            0%    { clip-path: inset(40% 0 30% 0); transform: translate(-50.5%, -50.1%) skewX(5deg); opacity: 0.8; }
            10%   { clip-path: inset(20% 0 70% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.7; }
            20%   { clip-path: inset(10% 0 55% 0); transform: translate(-49.8%, -50.2%) skewX(-3deg); opacity: 0.9; }
            30%   { clip-path: inset(50% 0 50% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            40%   { clip-path: inset(60% 0 10% 0); transform: translate(-50.2%, -49.9%) skewY(2deg); opacity: 1; }
            50%   { clip-path: inset(80% 0  5% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.75; }
            60%   { clip-path: inset(25% 0 40% 0); transform: translate(-50.1%, -50.3%) skewX(4deg); opacity: 0.85; }
            70%   { clip-path: inset(15% 0 75% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.9; }
            80%   { clip-path: inset(50% 0 20% 0); transform: translate(-49.9%, -49.8%) skewY(-3deg); opacity: 1; }
            90%   { clip-path: inset(70% 0 10% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            100%  { clip-path: inset(35% 0 45% 0); transform: translate(-50.3%, -50.0%) skewX(-2deg); opacity: 0.8; }
        }

        @keyframes glitchSkew {
            0%   { transform: translate(-50%, -50%) skew(-5deg, -2deg); }
            100% { transform: translate(-50%, -50%) skew(5deg, 2deg); }
        }

        @keyframes glitchText {
            0%, 100% { text-shadow: 0 0 3px red, 0 0 5px blue, 0 0 1px white; transform: translateX(0) translateY(0) skewX(0deg); opacity: 1;}
            10% { text-shadow: 1px 1px 3px red, -1px -1px 5px blue, 0 0 1px white; transform: translateX(-2px) translateY(1px) skewX(5deg); opacity: 0.8;}
            90% { text-shadow: 1px 1px 3px red, -1px -1px 5px blue, 0 0 1px white; transform: translateX(-1px) translateY(1px) skewX(1deg); opacity: 0.9;}
        }

        #exit-curtain.flash-out-effect .loading-text {
            color: #FFFFFF !important;
            text-shadow: none !important;
            animation: textFlashOut 0.5s forwards ease-out;
            transform-origin: center center;
        }

        @keyframes textFlashOut {
            0% {
                opacity: 1;
                transform: scale(1);
                text-shadow: 0 0 5px rgba(255,255,255,0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
                color: #FFFFE0 !important;
                text-shadow: 0 0 15px #FFFFFF,
                             0 0 25px #FFFFFF,
                             0 0 35px #FFFFE0,
                             0 0 50px #FFFF99;
            }
            99% {
                opacity: 0.8;
                transform: scale(1.05);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
                text-shadow: none;
                color: transparent !important;
            }
        }
        
        .header-circles { 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            width: 100%; 
            padding: 10px 0; 
            box-sizing: border-box; 
            background-color: #2a2a2a; 
            border-bottom: 1px solid #444;
        }
        .circle-button {
            width: 50px; 
            height: 50px; 
            background-color: #383838; 
            color: #e0e0e0; 
            border: 1px solid #555;
            border-radius: 50%; 
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.3s ease;
            font-size: 1.4em; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .circle-button:hover {
            background-color: #4a4a4a;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        .circle-button:active {
            background-color: #555;
            transform: translateY(0px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .circle-button i { 
            line-height: 1; 
        }
        #headerExitBtn i { color: #dc3545; } 
        #headerPhotosBtn i { color: #007bff; } 
        #headerPeriziaBtn i { color: #ffc107; } 
        #headerCameraBtn i { color: #28a745; } 

        #headerExitBtn:hover i,
        #headerPhotosBtn:hover i,
        #headerPeriziaBtn:hover i,
        #headerCameraBtn:hover i {
            color: #ffffff; 
        }


        body { font-family: sans-serif; line-height: 1.6; margin: 0; background-color: #1e1e1e; color: #f0f0f0; transition: padding-top 0.3s ease; }
        .content-wrapper { padding: 20px; }
        h1, h2 { text-align: center; color: #ffffff; }
        h1#mainTitleGlobal { line-height: 1.2; margin-bottom: 10px; margin-top: 5px; font-size: 1.6em;}
        
        #targaDropdownContainer {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            gap: 5px; 
            margin-top: 5px;
            margin-bottom: 10px;
        }
        #targaSwitcherDropdown {
            padding: 8px 12px; 
            background-color: #383838; 
            color: #f0f0f0;
            border: 1px solid #555;
            border-radius: 4px;
            min-width: 180px; 
            max-width: 220px;
            font-size: 1.1em; 
            font-family: sans-serif;
            cursor: pointer;
            text-align: center; 
        }
        #targaSwitcherDropdown:hover {
            background-color: #454545;
            border-color: #666;
        }
        #targaSwitcherDropdown option {
            padding: 5px; 
            background-color: #383838;
            color: #f0f0f0;
            text-align: left; 
        }
        #targaDetailsDisplay {
            font-size: 0.8em;
            color: #cccccc;
            margin-top: 3px; 
            text-align: center;
            min-height: 1.2em; 
            line-height: 1.3; 
        }
        
        @media (min-width: 480px) { 
            #targaDropdownContainer {
                flex-direction: row; 
                align-items: center; 
            }
            #targaDetailsDisplay {
                margin-top: 0;
                margin-left: 10px;
                text-align: left;
            }
        }
        

        h2.section-title { color: #cccccc; border-bottom: 1px solid #444444; padding-bottom: 5px; margin-top: 30px; text-align: left; }
        #galleryPageSection h2.section-title { margin-top: 10px; text-align: center; } 
        h3, h4 { color: #bbbbbb; margin-top: 20px; margin-bottom: 10px; }
        h4 {font-size: 1.1em; color: #c0c0c0; margin-top: 15px; margin-bottom: 8px;}
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 15px; }
        input[type="checkbox"], input[type="text"], input[type="url"], select, input[type="radio"], textarea { margin-right: 8px; vertical-align: middle; padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; margin-bottom: 5px; font-family: sans-serif;}
        input[type="text"], input[type="url"], textarea { width: calc(100% - 20px); box-sizing: border-box; }
        input[type="radio"] { margin-left: 5px; }
        select:not(#targaSwitcherDropdown) { min-width: 220px; } 
        label { vertical-align: middle; display: block; margin-bottom: 5px; color: #e0e0e0; }
        textarea {resize: vertical;}

        .category-section ul li > input[type="checkbox"] {
            vertical-align: middle;
            margin-right: 4px;
        }
        .category-section ul li > input[type="checkbox"] + label {
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 0;
        }

        #pageHeaderContainer {
            background-color: #1e1e1e;
            z-index: 1000;
            width: 100%;
        }
        #pageHeaderContainer.fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            padding-bottom: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        #navButtons { 
            display: flex;
            flex-direction: column; 
            align-items: center;
            width: 100%;
        }
        #mainPageNavButtons { 
            display: flex;
            justify-content: center;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 5px 0;
            width: calc(100% - 20px);
            max-width: 700px;
        }
        #mainPageNavButtons button {
            margin: 3px;
            flex-shrink: 0;
        }
        #utilityNavButtons { 
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 5px; 
            margin-bottom: 5px; 
        }
        #utilityNavButtons button {
            margin: 3px 5px;
        }

        #navButtons button, .action-button { 
             padding: 8px 15px; cursor: pointer; background-color: #007bff; color: white; border: 1px solid #0056b3; border-radius: 4px; transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; font-size: 0.9em;
        }
        .save-and-next-btn { background-color: #0069d9 !important; border-color: #005cbf !important; }
        .save-and-next-btn:hover { background-color: #0056b3 !important; border-color: #004085 !important; }
        #navButtons button:hover, .action-button:hover { background-color: #0056b3; border-color: #004085; }

        @keyframes activeButtonGlow {
            0% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; }
            50% { box-shadow: 0 0 10px rgba(0, 150, 255, 1), 0 0 15px rgba(0, 150, 255, 0.7) inset; }
            100% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; }
        }

        #navButtons button.active { 
            background-color: #0056b3 !important; border-color: #004085 !important; color: white !important;
            animation-name: activeButtonGlow; animation-duration: 1.8s;
            animation-iteration-count: infinite; animation-timing-function: ease-in-out;
            animation-direction: alternate;
        }
        #navButtons button.nav-btn-completed { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        #navButtons button.nav-btn-partial { background-color: #ffc107 !important; border-color: #e0a800 !important; color: #212529 !important; }
        #navButtons button.nav-btn-untouched { background-color: #dc3545 !important; border-color: #c82333 !important; color: white !important; }

        #landingPageSection, .category-section, #historyPageSection, #galleryPageSection, .camera-page-section { 
            padding: 20px; border: 1px solid #444; border-radius: 8px; 
            margin-top: 20px; background-color: #2a2a2a; 
            max-width: 850px; margin-left: auto; margin-right: auto; 
        }

        .category-section, #historyPageSection, #galleryPageSection, .camera-page-section { display: none; } 
        #landingPageSection { display: block; }
        .category-section.active { display: block; }

        .category-section {
            position: relative; 
        }
        .fill-defaults-btn {
            position: absolute;
            top: 20px; 
            right: 20px;
            width: 35px;
            height: 35px;
            background-color: #007bff; 
            color: white;
            border: 1px solid #0056b3;
            border-radius: 4px;
            font-size: 1.5em; 
            line-height: 1; 
            cursor: pointer;
            z-index: 10; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .fill-defaults-btn:hover {
            background-color: #0056b3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .fill-defaults-btn:active {
             background-color: #004085;
        }


        .summary-item { margin-bottom: 8px; padding: 8px; background-color: #333; border-radius: 3px; }
        .summary-item strong { color: #00aeff; }
        .summary-anomaly {
            background-color: #5d3d3d !important; color: #ffdddd !important;
            border-left: 3px solid #ff8888; padding-left: 10px !important;
        }
        .summary-anomaly strong { color: #ffc0c0 !important; }
        .summary-notes {
            background-color: #3a3a4a !important; color: #e0e0ff !important;
            border-left: 3px solid #8888ff; padding-left: 10px !important;
        }
        .summary-notes strong { color: #c0c0ff !important; }

        .table-scroll-wrapper { overflow-x: auto; width: 100%; margin-bottom: 10px; border: 1px solid #444; border-radius: 4px; }
        .targa-list-table-content { min-width: 650px; } 
        .targa-list-header { display: flex; font-weight: bold; padding: 0 10px 0 10px; border-bottom: 2px solid #777; color: #ddd; background-color: #3a3a3a; }
        .targa-list-header .targa-col { padding: 6px 8px; border-right: 1px solid #555; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1;}
        .targa-list-header .targa-col:last-child { border-right: none; }
        .targa-list-header .targa-col-actions { flex-basis: 60px; text-align: center; flex-grow: 0; }
        .targa-list-header .targa-col-urgenza { flex-basis: 70px; text-align: center; flex-grow: 0; } 


        #targaListContainer { margin-top: 0; max-height: 350px; overflow-y: auto; overflow-x: visible; padding: 0; }
        .targa-list-item { display: flex; align-items: center; border-bottom: 1px solid #444; padding: 0 10px 0 10px; }
        .targa-list-item:last-child { border-bottom: none; }
        .targa-list-item .targa-col {
            padding: 8px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-right: 1px solid #444; text-align: left; flex-grow: 1; display: flex; align-items: center;
        }
        .targa-list-item .targa-col:last-child { border-right: none; }

        .targa-col-targa    { flex-basis: 13%; min-width: 75px;} 
        .targa-col-targa.clickable-targa {
            cursor: pointer;
            color: #8ab4f8;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        .targa-list-item:hover .targa-col-targa.clickable-targa {
            color: #a1c5ff;
            text-decoration: underline;
        }

        .targa-col-posizione{ flex-basis: 12%; min-width: 60px; padding: 4px !important; } 
        .targa-col-urgenza  { flex-basis: 10%; min-width: 50px; text-align: center; justify-content: center;} 
        .targa-col-urgenza input[type="checkbox"] { margin: 0 auto; } 
        .targa-col-marca    { flex-basis: 18%; min-width: 90px;} 
        .targa-col-modello  { flex-basis: 22%; min-width: 100px;}
        .targa-col-piazzale { flex-basis: 18%; min-width: 70px;} 
        .targa-col-actions  { flex-basis: 7%; min-width: 50px; flex-grow: 0; text-align: center; } 


        .targa-col-posizione input.posizione-input {
            width: 100%; padding: 6px 4px; margin: 0; box-sizing: border-box;
            background-color: #404040; color: #f0f0f0;
            border: 1px solid #5a5a5a; border-radius: 3px;
            font-size: 0.9em; text-align: center;
        }
        .targa-col-posizione input.posizione-input:focus {
            background-color: #484848; border-color: #777; outline: none;
        }

        .delete-progress-btn { background-color: #dc3545; border-color: #c82333; color: white; padding: 3px 7px; font-size: 0.8em; line-height: 1; flex-shrink: 0; border-radius: 3px; }
        .delete-progress-btn:hover { background-color: #c82333; border-color: #bd2130; }

        .targa-list-item.status-da-vedere { background-color: #383838 !important; }
        .targa-list-item.status-da-vedere:hover { background-color: #454545 !important; }
        .targa-list-item.status-da-vedere .targa-col { color: #f0f0f0 !important; }
        .targa-list-item.status-da-vedere .targa-col-targa.clickable-targa { color: #8ab4f8 !important; }
        .targa-list-item.status-da-vedere:hover .targa-col-targa.clickable-targa { color: #a1c5ff !important; }
        .targa-list-item.status-da-vedere .targa-col-posizione input.posizione-input { background-color: #4f4f4f; color: #f0f0f0; border-color: #5a5a5a; }

        .targa-list-item.status-visto { background-color: #2E4B35 !important; }
        .targa-list-item.status-visto:hover { background-color: #395c40 !important; }
        .targa-list-item.status-visto .targa-col-targa,
        .targa-list-item.status-visto .targa-col-marca,
        .targa-list-item.status-visto .targa-col-modello,
        .targa-list-item.status-visto .targa-col-piazzale { color: #a3cca3 !important; }
        .targa-list-item.status-visto .targa-col-targa.clickable-targa { color: #81c784 !important; }
        .targa-list-item.status-visto:hover .targa-col-targa.clickable-targa { color: #9ccc65 !important; }
        .targa-list-item.status-visto .targa-col-posizione input.posizione-input { background-color: #384c3d; color: #d0e0d0; }

        .targa-list-item.urgent-item { background-color: #4d3232 !important; border-left: 3px solid #ff6b6b; }
        .targa-list-item.urgent-item:hover { background-color: #5e3f3f !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col { color: #ffc0c0 !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-targa.clickable-targa { color: #ff8a80 !important; }
        .targa-list-item.urgent-item:not(.completed):hover .targa-col-targa.clickable-targa { color: #ff5252 !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-posizione input.posizione-input { background-color: #5a3e3e; color: #ffc0c0; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-urgenza input[type="checkbox"] { accent-color: #ff8a80; }


        .targa-list-item.completed .targa-col-targa,
        .targa-list-item.completed .targa-col-marca,
        .targa-list-item.completed .targa-col-modello,
        .targa-list-item.completed .targa-col-piazzale { color: #888 !important; }
        .targa-list-item.status-visto.completed .targa-col-targa,
        .targa-list-item.status-visto.completed .targa-col-marca,
        .targa-list-item.status-visto.completed .targa-col-modello,
        .targa-list-item.status-visto.completed .targa-col-piazzale { color: #a3cca3 !important; }
        .targa-list-item.status-visto.completed .targa-col-targa.clickable-targa { color: #81c784 !important; }
        .targa-list-item.urgent-item.completed .targa-col-targa,
        .targa-list-item.urgent-item.completed .targa-col-marca,
        .targa-list-item.urgent-item.completed .targa-col-modello,
        .targa-list-item.urgent-item.completed .targa-col-piazzale { color: #a07c7c !important; }
        .targa-list-item.urgent-item.completed .targa-col-targa.clickable-targa { color: #ff8a80 !important; }
        .targa-list-item.urgent-item.completed .targa-col-posizione input.posizione-input { background-color: #4a2e2e; color: #a07c7c; }
        .targa-list-item.urgent-item.completed .targa-col-urgenza input[type="checkbox"] { accent-color: #a07c7c; }


        .targa-list-item.status-parziale { background-color: #ffc107 !important; }
        .targa-list-item.status-parziale:hover { background-color: #e0a800 !important; }
        .targa-list-item.status-parziale .targa-col { color: #212529 !important; }
        .targa-list-item.status-parziale .targa-col-targa.clickable-targa { color: #b8860b !important; }
        .targa-list-item.status-parziale:hover .targa-col-targa.clickable-targa { color: #8B4513 !important; }
        .targa-list-item.status-parziale .targa-col-posizione input.posizione-input { background-color: #ffe082; color: #212529; border-color: #ffc107; }
        .targa-list-item.status-parziale .targa-col-urgenza input[type="checkbox"] { accent-color: #b8860b; }

        .targa-list-item.locally-deleted {
            opacity: 0.5;
            background-color: #404040 !important; 
        }
        .targa-list-item.locally-deleted .targa-col-targa {
            text-decoration: line-through;
            color: #aaa !important;
        }
        .targa-list-item.locally-deleted .clickable-targa {
            cursor: default !important; 
            text-decoration: line-through !important;
        }
        .targa-list-item.locally-deleted .delete-progress-btn {
            display: none; 
        }
        .targa-list-item.locally-deleted input,
        .targa-list-item.locally-deleted select {
            pointer-events: none;
            opacity: 0.7;
        }


        #targheLoadingStatus { text-align: center; padding: 10px; color: #00aeff; }
        #savedTargasListContainer { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #333; border-radius: 4px; margin-bottom: 20px; }
        .saved-targa-button { display: block; width: 100%; padding: 10px; background-color: #383838; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; text-align: left; cursor: pointer; font-size: 0.95em; }
        .saved-targa-button:hover { background-color: #454545; }
        #historyPageSection .action-button { margin-right: 10px; }
        #sheetFilterContainer { margin-bottom: 15px; text-align: center; }
        #sheetFilterContainer label { margin-right: 10px; color: #ccc; display: inline-block; }
        #sheetFilterDropdown { padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; min-width: 250px; vertical-align: middle; }

        .animate-me {
            animation: pulseHighlight 1.5s infinite alternate;
            outline: 2px solid rgba(0, 123, 255, 0.0);
            transition: outline 0.3s ease, box-shadow 0.3s ease;
        }
        @keyframes pulseHighlight {
            from { outline: 2px solid rgba(0, 123, 255, 0.7); box-shadow: 0 0 5px rgba(0, 123, 255, 0.5), 0 0 8px rgba(0, 123, 255, 0.3) inset; }
            to   { outline: 3px solid rgba(0, 150, 255, 1); box-shadow: 0 0 10px rgba(0, 150, 255, 0.8), 0 0 12px rgba(0, 150, 255, 0.5) inset; }
        }
        input[type="checkbox"].animate-me, select.animate-me { position: relative; z-index: 1; }

        /* START: Stili per la pagina Fotocamera */
        .camera-page-section {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000; 
            z-index: 2000; 
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 0; 
            margin: 0; 
            border: none; 
            border-radius: 0; 
            max-width: none; 
            box-sizing: border-box; 
        }
        #cameraStream {
            width: 100%;
            height: 100%; 
            object-fit: contain; 
        }
        #freezeFrameDisplay { 
            display: none; 
            position: absolute;
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%; 
            object-fit: contain; 
            z-index: 2015; 
            border: 8px solid #00bcd4; 
            box-sizing: border-box; 
        }

        #captureBtn {
            position: absolute;
            bottom: 30px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 2020; 
            padding: 12px 20px;
            font-size: 1.1em;
            background-color: #007bff;
            border-color: #0056b3;
        }
         #captureBtn i {
            margin-right: 8px;
        }
        
        #closeCameraBtn {
            position: absolute;
            bottom: 20px; 
            right: 20px; 
            z-index: 2020; 
            width: 45px; 
            height: 45px; 
            background-color: rgba(40, 40, 40, 0.8); 
            color: #ff4d4d; 
            border: 1px solid #ff4d4d;
            border-radius: 4px; 
            font-size: 1.8em; 
            line-height: 43px; 
            text-align: center;
            padding: 0; 
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #closeCameraBtn:hover {
            background-color: rgba(255, 77, 77, 0.9); 
            color: #fff; 
            border-color: #fff;
        }

        #pageHeaderContainer.fixed-header {
            z-index: 2030; 
        }
        /* END: Stili per la pagina Fotocamera */

        /* START: Stili per Changelog Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7); 
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 10000; 
            padding: 15px;
            box-sizing: border-box;
        }
        .modal-content {
            background-color: #333; 
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            width: 90%;
            max-width: 550px;
            color: #e0e0e0; 
            border-top: 5px solid #007bff;
            max-height: 80vh; 
            overflow-y: auto;
        }
        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #00aeff;
            border-bottom: 1px solid #555; 
            padding-bottom: 10px;
            font-size: 1.5em;
        }
        .modal-content ul {
            list-style-position: inside; 
            padding-left: 5px; 
        }
        .modal-content ul li {
            margin-bottom: 10px;
            line-height: 1.6;
        }
        .modal-close-btn {
            display: block;
            margin: 25px auto 0 auto;
            padding: 10px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        .modal-close-btn:hover {
            background-color: #0056b3;
        }
        /* END: Stili per Changelog Modal */

        /* START: Stili per Pagina Galleria */
        #galleryPageSection {
            text-align: center;
        }
        /* #galleryActions è rimosso perché lo ZIP è automatico */
        #photoGridContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .photo-item {
            background-color: #3c3c3c; 
            border-radius: 6px; 
            padding: 10px;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.35);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative; 
        }
        /* .photo-item.selected e .photo-item-checkbox sono rimossi */
        .photo-item img {
            max-width: 100%;
            height: 120px; 
            object-fit: cover;
            border-radius: 4px; 
            margin-bottom: 8px;
            cursor: pointer; 
            border: 1px solid #555; 
        }
        .photo-item-caption {
            font-size: 0.75em; 
            color: #bdbdbd;
            word-wrap: break-word;
            margin-bottom: 8px;
            line-height: 1.3;
            max-height: 3.9em; 
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .photo-item-delete-btn {
            background-color: #c82333; 
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 0.9em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
         .photo-item-delete-btn:hover {
            background-color: #a41523;
        }
        /* END: Stili per Pagina Galleria */

        /* START: Stili per Lightbox Immagine */
        #imageLightbox {
            display: none; 
            position: fixed;
            z-index: 3000; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.85); 
            justify-content: center;
            align-items: center;
        }
        #lightboxContent {
            position: relative;
            margin: auto;
            padding: 0;
            width: 90%;
            max-width: 700px; 
        }
        #lightboxImage {
            display: block;
            width: 100%;
            height: auto;
            max-height: 80vh; 
            object-fit: contain;
            border: 3px solid #444;
            border-radius: 5px;
        }
        #closeLightboxBtn {
            position: absolute;
            top: -5px; 
            right: -5px; 
            color: #fff;
            background-color: #333;
            border: 1px solid #555;
            font-size: 28px;
            font-weight: bold;
            padding: 0px 10px;
            line-height: 1.2;
            border-radius: 50%;
            cursor: pointer;
            transition: color 0.3s, background-color 0.3s;
            z-index: 3010;
        }
        #closeLightboxBtn:hover,
        #closeLightboxBtn:focus {
            background-color: #c82333;
            color: #fff;
            text-decoration: none;
        }
        /* END: Stili per Lightbox Immagine */


        @media (max-width: 768px) {
            .content-wrapper { margin-top: 0; }
            .circle-button { width: 45px; height: 45px; font-size: 1.2em;} 
            #navButtons button, .action-button { padding: 8px 10px; font-size: 0.85em; }
            #mainPageNavButtons { width: 100%; padding: 5px; box-sizing: border-box; }
            #mainPageNavButtons button { font-size: 0.8em; padding: 6px 8px; }
            #utilityNavButtons button { font-size: 0.85em; padding: 8px 10px; }
            input[type="text"], input[type="url"], select:not(#targaSwitcherDropdown), textarea { width: 100%; box-sizing: border-box; }
            #targaSwitcherDropdown { min-width: 160px; font-size: 1em; } 
            #targaDetailsDisplay { font-size: 0.75em; }
            .table-scroll-wrapper { overflow-x: auto; }
            .targa-list-table-content { min-width: 600px; } 
            .targa-list-header { display: flex !important; }
            .targa-list-header .targa-col, .targa-list-item .targa-col { padding: 6px 5px; }
            .delete-progress-btn { padding: 5px 8px; }
            .targa-col-targa    { min-width: 65px;}
            .targa-col-posizione{ min-width: 50px;}
            .targa-col-urgenza  { min-width: 45px;}
            .targa-col-marca    { min-width: 70px;}
            .targa-col-modello  { min-width: 80px;}
            .targa-col-piazzale { min-width: 60px;}
            .targa-col-actions  { min-width: 40px;}
            #sheetFilterContainer { display: flex; flex-direction: column; align-items: stretch; }
            #sheetFilterContainer label { margin-bottom: 5px; margin-right: 0; text-align: left;}
            #sheetFilterDropdown { width: 100%; }
            .fill-defaults-btn { top: 15px; right: 15px; width: 30px; height: 30px; font-size: 1.2em; }
            #captureBtn { bottom: 20px; padding: 10px 15px; font-size: 1em; }
            #closeCameraBtn { bottom: 15px; right: 15px; width: 40px; height: 40px; font-size: 1.6em; line-height: 38px;}
            #photoGridContainer { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;}
            .photo-item img { height: 100px; }
            #lightboxContent { width: 95%; }
            #lightboxImage { max-height: 75vh; }
            #closeLightboxBtn { font-size: 22px; top: 0px; right: 0px; padding: 0px 8px;}
            /* #galleryActions non serve più qui */
        }
         @media (max-width: 400px) { 
            .circle-button { width: 40px; height: 40px; font-size: 1.1em;}
            .header-circles { padding: 8px 0; }
            #photoGridContainer { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .modal-content { width: 95%; padding: 15px; }
            .modal-content h2 {font-size: 1.3em;}
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="changelogModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="changelogTitle">WebApp Perizie - Novità</h2>
            <ul id="changelogList">
                </ul>
            <button id="closeChangelogBtnModal" class="modal-close-btn">Chiudi</button>
        </div>
    </div>

    <div id="exit-curtain" data-text="CHIUSURA IN CORSO...">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">CHIUSURA IN CORSO...</div>
    </div>

    <div id="imageLightbox">
        <span id="closeLightboxBtn">&times;</span>
        <div id="lightboxContent">
            <img id="lightboxImage" src="#" alt="Immagine Ingrandita">
        </div>
    </div>

    <div id="pageHeaderContainer">
        <div class="header-circles">
            <button id="headerExitBtn" class="circle-button" title="Esci dall'applicazione"><i class="fas fa-power-off"></i></button>
            <button id="headerPhotosBtn" class="circle-button" title="Galleria Foto App"><i class="fas fa-images"></i></button>
            <button id="headerPeriziaBtn" class="circle-button" title="Vai all'ultima perizia/sezione"><i class="fas fa-clipboard-list"></i></button>
            <button id="headerCameraBtn" class="circle-button" title="Fotocamera"><i class="fas fa-camera-retro"></i></button>
        </div>
        <div id="utilityNavButtons">
            <button id="backToListBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe</button>
            <button id="historyBtn" class="action-button" style="background-color: #17a2b8; border-color: #117a8b;">Salvataggi</button>
            <button id="exitAppBtn" class="action-button" style="background-color: #dc3545; border-color: #c82333;">Esci</button>
            </div>
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>
        <div id="targaDropdownContainer" style="display: none;">
            <select id="targaSwitcherDropdown"></select>
            <span id="targaDetailsDisplay"></span>
        </div>
        <div id="navButtons">
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;">
            <h2 style="margin-top: 10px;">Seleziona Veicolo da Periziare</h2>
            <div id="sheetFilterContainer">
                <label for="sheetFilterDropdown">Filtra per Elenco:</label>
                <select id="sheetFilterDropdown">
                    <option value="all">Tutti gli Elenchi</option>
                </select>
            </div>
            <div id="targheLoadingStatus">Caricamento targhe in corso...</div>
            <div class="table-scroll-wrapper">
                <div class="targa-list-table-content">
                    <div class="targa-list-header">
                        <span class="targa-col targa-col-targa">Targa</span>
                        <span class="targa-col targa-col-posizione">Posizione</span>
                        <span class="targa-col targa-col-urgenza">Urgenza</span>
                        <span class="targa-col targa-col-marca">Marca</span>
                        <span class="targa-col targa-col-modello">Modello</span>
                        <span class="targa-col targa-col-piazzale">Piazzale</span>
                        <span class="targa-col targa-col-actions">Azioni</span>
                    </div>
                    <div id="targaListContainer"></div>
                </div>
            </div>
        </div>

        <div id="checklistContainer" style="display: none;"> 
            <div id="remarketingSection" class="category-section">
                <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="remarketingSection">✓</button>
                <h2 class="section-title">1. Foto Remarketing</h2>
                <ul>
                    <li>
                        <label for="tipo_trazione">Trazione veicolo:</label>
                        <select id="tipo_trazione">
                            <option value="">Seleziona...</option>
                            <option value="endotermico">Endotermico</option>
                            <option value="elettrico">Elettrico</option>
                        </select>
                    </li>
                    <li><input type="checkbox" id="foto_angolari"><label for="foto_angolari">Foto angolari (3/4)</label></li>
                    <li>
                        <input type="checkbox" id="foto_vano_carico">
                        <label for="foto_vano_carico">Vano Carico</label>
                    </li>
                    <li>
                        <label for="tipo_equipaggiamento">Equipaggiamento:</label>
                        <select id="tipo_equipaggiamento">
                            <option value="">Seleziona...</option>
                            <option value="kit_gonfia_ripara">Kit</option>
                            <option value="ruota">Ruota</option>
                            <option value="ruotino">Ruotino</option>
                            <option value="runflat">Runflat</option>
                        </select>
                    </li>
                    <li><label for="equipaggiamento_presenza">Presenza equip.:</label><select id="equipaggiamento_presenza"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_interni_pannelli"><label for="foto_interni_pannelli">Interni/pannelli</label></li>
                    <li><input type="checkbox" id="foto_cruscotto"><label for="foto_cruscotto">Cruscotto</label></li>
                    <li><label for="stato_chilometri">Chilometri - Stato:</label><select id="stato_chilometri"><option value="">Seleziona...</option><option value="rilevabili">Rilevabili</option><option value="non_rilevabili">Non rilevabili</option></select></li>
                    <li><label for="stato_cdc">CDC - Stato:</label><select id="stato_cdc"><option value="">Seleziona...</option><option value="originale">Originale</option><option value="copia_conforme">Copia conforme</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_vano_motore"><label for="foto_vano_motore">Vano motore</label></li>
                    <li><input type="checkbox" id="foto_cofano_tetto"><label for="foto_cofano_tetto">Cofano e tetto</label></li>
                    <li>
                        <label for="chiave_telecomando">Chiave con telecomando:</label>
                        <select id="chiave_telecomando">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="seconda_chiave">Seconda chiave:</label>
                        <select id="seconda_chiave">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_rapida">Cavo ricarica rapida:</label>
                        <select id="cavo_ricarica_rapida" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_domestica">Cavo ricarica domestica:</label>
                        <select id="cavo_ricarica_domestica" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="pneumaticiSection" class="category-section">
                <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="pneumaticiSection">✓</button>
                <h2 class="section-title">2. Foto Pneumatici</h2>
                <ul>
                    <li><label for="pneumatico_as">Ant. sinistro:</label><select id="pneumatico_as"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ad">Ant. destro:</label><select id="pneumatico_ad"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_pd">Post. destro:</label><select id="pneumatico_pd"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ps">Post. sinistro:</label><select id="pneumatico_ps"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="danniVerificheSection" class="category-section">
                <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="danniVerificheSection">✓</button>
                <h2 class="section-title">3. Foto Danni e Verifiche</h2>
                <ul>
                    <li><label for="motore_accende">Motore si accende:</label><select id="motore_accende"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><label for="batteria_stato">Batteria:</label><select id="batteria_stato"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><input type="checkbox" id="foto_danni_generiche"><label for="foto_danni_generiche">Altre foto danni</label></li>
                    <li>
                        <label for="note_danni_verifiche">Note Danni/Verifiche:</label>
                        <textarea id="note_danni_verifiche" rows="4"></textarea>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 20px;"><button class="action-button save-and-next-btn">Salva e Vai al Riepilogo</button></div>
            </div>
            <div id="riepilogoSection" class="category-section">
                <h2 class="section-title">Riepilogo Perizia</h2>
                <div id="summaryContent"><p><em>Compila le sezioni precedenti...</em></p></div>
                
                <div style="text-align: center; margin-top: 15px;"> <a href="#" id="downloadPhotosBtn" class="action-button" style="background-color: #17a2b8; border-color: #117a8b; margin-right: 10px; display: none;">Scarica Foto</a>
                    <button id="saveAndReturnBtn" class="action-button" style="background-color: #28a745; border-color: #1e7e34;">Salva Perizia e Foto</button>
                </div>
                 </div>
        </div>

        <div id="historyPageSection" style="display: none;">
            <h2 class="section-title" style="text-align: center;">Cronistoria Salvataggi</h2>
            <div id="savedTargasListContainer"><p>Nessun salvataggio trovato.</p></div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="clearAllProgressBtn" class="action-button" style="background-color: #dc3545; border-color: #c82333;">Cancella Tutti i Salvataggi</button>
                <button id="backToLandingFromHistoryBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe Principale</button>
            </div>
        </div>

        <div id="galleryPageSection" style="display: none;">
            <h2 class="section-title" style="text-align: center;">Galleria Foto Catturate</h2>
            <button id="backToMainFromGalleryBtn" class="action-button" style="margin-bottom: 15px; background-color: #6c757d; border-color: #5a6268;">Torna all'Elenco</button>
            <div id="photoGridContainer">
            </div>
        </div>

        <div id="cameraPageSection" class="camera-page-section" style="display: none;">
            <video id="cameraStream" autoplay playsinline></video>
            <img id="freezeFrameDisplay" src="#" alt="Foto Catturata" style="display: none;">
            <button id="captureBtn" class="action-button"><i class="fas fa-camera"></i> Scatta Foto</button>
            <button id="closeCameraBtn" class="action-button">×</button> 
        </div>

    </div>
<script>
    // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const galleryPageSection = document.getElementById('galleryPageSection'); 
    const photoGridContainer = document.getElementById('photoGridContainer'); 
    const backToMainFromGalleryBtn = document.getElementById('backToMainFromGalleryBtn'); 

    const cameraPageSection = document.getElementById('cameraPageSection'); 
    const cameraStreamElement = document.getElementById('cameraStream');
    const freezeFrameDisplayElement = document.getElementById('freezeFrameDisplay');
    const captureBtn = document.getElementById('captureBtn');
    const closeCameraBtn = document.getElementById('closeCameraBtn');
    let currentCameraStream = null;
    let lastViewBeforeCamera = 'landing'; 
    let lastSectionBeforeCamera = null; 


    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer');
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const targaDropdownContainer = document.getElementById('targaDropdownContainer');
    const targaSwitcherDropdown = document.getElementById('targaSwitcherDropdown');
    const targaDetailsDisplay = document.getElementById('targaDetailsDisplay'); 

    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons'); 
    const mainPageNavButtons = navButtonsContainer.querySelector('#mainPageNavButtons'); 
    const utilityNavButtons = pageHeaderContainer.querySelector('#utilityNavButtons'); 

    const navButtons = mainPageNavButtons.querySelectorAll('button[data-target]');
    
    const backToListBtn = utilityNavButtons.querySelector('#backToListBtn');
    const historyBtn = utilityNavButtons.querySelector('#historyBtn');
    const mainExitAppBtn = utilityNavButtons.querySelector('#exitAppBtn'); 
    let syncToSheetsBtn; 
    
    const headerExitBtn = document.getElementById('headerExitBtn');
    const headerPhotosBtn = document.getElementById('headerPhotosBtn');
    const headerPeriziaBtn = document.getElementById('headerPeriziaBtn');
    const headerCameraBtn = document.getElementById('headerCameraBtn');

    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const downloadPhotosBtn = document.getElementById('downloadPhotosBtn'); // MODIFICA QUI: Dichiarazione variabile
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn');
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn');
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn');
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
    const tipoTrazioneSelect = document.getElementById('tipo_trazione');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');
    
    const imageLightbox = document.getElementById('imageLightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const closeLightboxBtnElem = document.getElementById('closeLightboxBtn'); // Rinominato per evitare conflitto
    let currentLightboxImageObjectUrl = null;


    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzN4bBhPi4d8i7fSpJQqCJ2CQYOtmes1yKeGeqVe053K4QkdKYH4PuQIughn_9YLEfCkA/exec'; 
    
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';
    const LAST_ACTIVE_PERIZIA_PAGE_KEY = `${APP_PREFIX}lastActivePeriziaPage`;

    const currentAppVersion = "1.6.0"; // MODIFICA: Versione per ZIP automatico
    const changelogModal = document.getElementById('changelogModal');
    const closeChangelogBtnModal = document.getElementById('closeChangelogBtnModal'); 
    const changelogList = document.getElementById('changelogList');
    const changelogTitle = document.getElementById('changelogTitle');

    const latestChangesText = `
        <li><strong>ZIP con tutte le foto della perizia scaricato automaticamente al "Salva Perizia".</strong></li>
        <li><strong>Nome del file ZIP basato sulla targa.</strong></li>
        <li>Rimossa selezione manuale foto/checkbox dalla galleria per ZIP.</li>
        <li>Swipe per navigare tra le sezioni della galleria (per targa).</li>
        <li>Click su anteprima foto in galleria per ingrandimento (lightbox).</li>
        <li>Durata anteprima foto dopo scatto dimezzata a 0.5 secondi.</li>
    `;


    let touchstartX = 0;
    let touchendX = 0;
    const swipeThreshold = 50; 
    const sectionOrder = ['remarketing', 'pneumatici', 'danniVerifiche', 'riepilogo'];

    let currentGalleryTargaFilter = null;
    let currentGallerySectionFilter = null; 
    let lastViewBeforeGallery = 'landing';
    let lastSectionBeforeGallery = null;

    // START: IndexedDB Helper Functions
    const IDB_NAME = 'PeriziePhotoDB_v1'; 
    const IDB_VERSION = 1;
    const PHOTO_STORE_NAME = 'capturedPhotosStore'; 
    let dbPromise = null;

    function openPhotoDB() {
        if (dbPromise) return dbPromise;

        dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(IDB_NAME, IDB_VERSION);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(PHOTO_STORE_NAME)) {
                    const store = db.createObjectStore(PHOTO_STORE_NAME, { keyPath: 'timestamp' });
                    store.createIndex('targaIdx', 'targa', { unique: false });
                    store.createIndex('sezioneIdx', 'sezione', { unique: false });
                    store.createIndex('targaSezioneIdx', ['targa', 'sezione'], { unique: false });
                    console.log('Object store created/updated:', PHOTO_STORE_NAME);
                }
            };

            request.onsuccess = (event) => {
                console.log('Database opened successfully');
                resolve(event.target.result);
            };

            request.onerror = (event) => {
                console.error("Errore apertura IndexedDB:", event.target.error);
                dbPromise = null; 
                reject(event.target.error);
            };
        });
        return dbPromise;
    }

    async function savePhotoToDB(photoData) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.put(photoData);

            request.onsuccess = () => {
                console.log('Foto salvata in DB con timestamp:', photoData.timestamp);
                resolve();
            };
            request.onerror = (event) => {
                console.error('Errore salvataggio foto in IndexedDB:', event.target.error);
                reject(event.target.error);
            };
            transaction.oncomplete = () => {
                // console.log('Transazione salvataggio foto completata.'); // Log opzionale
            };
            transaction.onerror = (event) => {
                console.error('Errore transazione salvataggio foto:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    async function getAllPhotosFromDB() {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.getAll();

            request.onsuccess = (event) => {
                resolve(event.target.result || []);
            };
            request.onerror = (event) => {
                console.error('Errore recupero tutte le foto da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }
    
    async function getPhotosByTargaAndSezioneFromDB(targaFilter, sectionKeyFilter) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            let request;

            if (targaFilter && sectionKeyFilter && sectionKeyFilter !== 'riepilogo') {
                 let effectiveSectionKey = sectionKeyFilter.toLowerCase();
                 if (effectiveSectionKey === 'danniverifiche') effectiveSectionKey = 'danni';
                
                const targaSezioneIndex = store.index('targaSezioneIdx');
                request = targaSezioneIndex.getAll(IDBKeyRange.only([targaFilter.toUpperCase(), effectiveSectionKey]));
            } else if (targaFilter) { 
                const targaIndex = store.index('targaIdx');
                request = targaIndex.getAll(IDBKeyRange.only(targaFilter.toUpperCase()));
            } else { 
                request = store.getAll();
            }

            request.onsuccess = (event) => {
                resolve(event.target.result || []);
            };
            request.onerror = (event) => {
                console.error('Errore recupero foto filtrate da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }


    async function deletePhotoFromDB(timestampToDelete) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.delete(timestampToDelete);

            request.onsuccess = () => {
                console.log('Foto eliminata da DB con timestamp:', timestampToDelete);
                resolve();
            };
            request.onerror = (event) => {
                console.error('Errore eliminazione foto da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }
    // END: IndexedDB Helper Functions


    function updateTargaDetailsDisplay(selectedTarga) {
        if (!targaDetailsDisplay || !selectedTarga || !listaTargheCompleta.length) {
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        const veicolo = listaTargheCompleta.find(v => v.targa.toUpperCase() === selectedTarga.toUpperCase());
        if (veicolo) {
            let detailsText = '';
            const marca = veicolo.marca ? String(veicolo.marca).trim() : '';
            const modello = veicolo.modello ? String(veicolo.modello).trim() : '';
            if (marca) detailsText += marca;
            if (modello) detailsText += (detailsText ? ' ' : '') + modello;
            targaDetailsDisplay.textContent = detailsText || '';
        } else {
            targaDetailsDisplay.textContent = '';
        }
    }

    function populateTargaSwitcherDropdown() {
        if (!targaSwitcherDropdown || !targaSelezionataGlobalmente || !listaTargheCompleta.length) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        const veicoloAttuale = listaTargheCompleta.find(v => v.targa.toUpperCase() === targaSelezionataGlobalmente.toUpperCase());
        if (!veicoloAttuale || !veicoloAttuale.piazzale) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        const piazzaleCorrente = veicoloAttuale.piazzale;
        const targheDelPiazzale = listaTargheCompleta.filter(v => v.piazzale === piazzaleCorrente && !localStorage.getItem(`${APP_PREFIX}deleted_${v.targa.toUpperCase()}`)); 
        targaSwitcherDropdown.innerHTML = ''; 
        if (targheDelPiazzale.length === 0) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        targheDelPiazzale.sort((a, b) => a.targa.localeCompare(b.targa)); 
        targheDelPiazzale.forEach(v => {
            const option = document.createElement('option');
            option.value = v.targa.toUpperCase();
            option.textContent = v.targa; 
            if (v.targa.toUpperCase() === targaSelezionataGlobalmente.toUpperCase()) {
                option.selected = true;
            }
            targaSwitcherDropdown.appendChild(option);
        });
        if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex';
        updateTargaDetailsDisplay(targaSelezionataGlobalmente); 
    }

    async function inviaPeriziaSingolaASheets(periziaDaInviare) { 
        if (!GOOGLE_SHEET_WEB_APP_URL || GOOGLE_SHEET_WEB_APP_URL === 'INCOLLA_QUI_IL_TUO_URL_APPLICAZIONE_WEB') { console.error("URL della Web App Google Sheets non configurato."); return { success: false, message: "URL Web App non configurato." }; } 
        // console.log("Tentativo di invio perizia a Google Sheets:", periziaDaInviare); 
        try { 
            const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, { method: 'POST', mode: 'cors',  cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' },  body: JSON.stringify(periziaDaInviare)  }); 
            let responseData; 
            const contentType = response.headers.get("content-type"); 
            if (contentType && contentType.indexOf("application/json") !== -1) { 
                responseData = await response.json(); 
            } else { 
                const textResponse = await response.text(); 
                console.warn("Risposta dal server non è JSON, ricevuta come testo:", textResponse); 
                try { responseData = JSON.parse(textResponse); }  
                catch (e) { responseData = { status: "error", message: "Risposta non JSON dal server: " + textResponse.substring(0,100) + "..."}; } 
            } 
            if (response.ok && responseData.status === "success") { 
                // console.log("Perizia inviata con successo a Google Sheets:", responseData.message, "Dati ritornati:", responseData.data); 
                return { success: true, message: responseData.message, data: responseData.data }; 
            } else { 
                console.error("Errore dall'API di Google Sheets o risposta non OK:", responseData.message || `HTTP Status ${response.status}`); 
                return { success: false, message: responseData.message || `Errore server (HTTP ${response.status})` }; 
            } 
        } catch (error) { 
            console.error("Errore di rete o fetch durante l'invio a Google Sheets:", error); 
            return { success: false, message: "Errore di rete: " + error.message }; 
        } 
    }
    
    async function fetchLatestPeriziaFromSheets(targa) { 
        if (!GOOGLE_SHEET_WEB_APP_URL) { console.error("URL della Web App Google Sheets non configurato per il fetch."); return null; } 
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targa.toUpperCase()}`)) {
            // console.log(`WorkspaceLatestPerizia: Targa ${targa} marcata come cancellata localmente. Non verrà recuperata da Sheets.`);
            return null;
        }
        const fetchUrl = `${GOOGLE_SHEET_WEB_APP_URL}?action=getPerizia&targa=${encodeURIComponent(targa.toUpperCase())}&nocache=${new Date().getTime()}`; 
        // console.log("Fetching latest perizia from Sheets for targa:", targa, "URL:", fetchUrl); 
        try { 
            const response = await fetch(fetchUrl, { method: 'GET', mode: 'cors' }); 
            if (!response.ok) { 
                const errorText = await response.text(); 
                console.error(`Errore HTTP ${response.status} nel fetch da Sheets: ${errorText}`); 
                return null; 
            } 
            const contentType = response.headers.get("content-type"); 
            if (contentType && contentType.indexOf("application/json") !== -1) { 
                const result = await response.json(); 
                if (result.status === "success" && result.data) { 
                    // console.log("Dati perizia singola ricevuti da Sheets:", result.data); 
                    return result.data;  
                } else if (result.status === "notfound") { 
                    // console.log("Perizia non trovata in Sheets per targa:", targa); 
                    return null; 
                } else { 
                    console.warn("Risposta da Sheets (singola) non conteneva dati validi o status non era 'success'/'notfound':", result.message || result); 
                    return null; 
                } 
            } else { 
                const textResponse = await response.text(); 
                console.error("Risposta da Sheets (singola) non era JSON:", textResponse); 
                return null; 
            } 
        } catch (error) { 
            console.error("Errore di rete o fetch generico durante il recupero (singolo) da Sheets:", error); 
            return null; 
        } 
    }

    function fillSectionPositiveOrDefaults(sectionId) { const section = document.getElementById(sectionId); if (!section) return; if (sectionId === 'remarketingSection') { if (tipoTrazioneSelect) tipoTrazioneSelect.value = 'endotermico'; document.getElementById('foto_angolari').checked = true; document.getElementById('foto_vano_carico').checked = true; document.getElementById('tipo_equipaggiamento').value = 'kit_gonfia_ripara'; document.getElementById('equipaggiamento_presenza').value = 'presente'; document.getElementById('foto_interni_pannelli').checked = true; document.getElementById('foto_cruscotto').checked = true; document.getElementById('stato_chilometri').value = 'rilevabili'; document.getElementById('stato_cdc').value = 'originale'; document.getElementById('foto_vano_motore').checked = true; document.getElementById('foto_cofano_tetto').checked = true; document.getElementById('chiave_telecomando').value = 'presente'; document.getElementById('seconda_chiave').value = 'presente'; handleTrazioneChange();  if (tipoTrazioneSelect && tipoTrazioneSelect.value === 'elettrico') { if (cavoRapidaSelect) cavoRapidaSelect.value = 'presente'; if (cavoDomesticaSelect) cavoDomesticaSelect.value = 'presente'; } else {  if (cavoRapidaSelect) cavoRapidaSelect.value = 'non_applicabile';  if (cavoDomesticaSelect) cavoDomesticaSelect.value = 'non_applicabile'; } } else if (sectionId === 'pneumaticiSection') { document.getElementById('pneumatico_as').value = 'conforme'; document.getElementById('pneumatico_ad').value = 'conforme'; document.getElementById('pneumatico_pd').value = 'conforme'; document.getElementById('pneumatico_ps').value = 'conforme'; } else if (sectionId === 'danniVerificheSection') { document.getElementById('motore_accende').value = 'ok'; document.getElementById('batteria_stato').value = 'ok'; document.getElementById('foto_danni_generiche').checked = true;  document.getElementById('note_danni_verifiche').value = 'Nessuna anomalia da segnalare.'; } updateNavButtonColors(); if (typeof initSequentialAnimation === 'function') { section.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me')); initSequentialAnimation(); }  section.querySelectorAll('input, select, textarea').forEach(el => { const event = new Event('change', { bubbles: true }); el.dispatchEvent(event); }); }
    function handleTrazioneChange() { if (!tipoTrazioneSelect || !cavoRapidaSelect || !cavoDomesticaSelect) return; const selectedTrazione = tipoTrazioneSelect.value; const isElectric = selectedTrazione === 'elettrico'; cavoRapidaSelect.disabled = !isElectric; cavoDomesticaSelect.disabled = !isElectric; if (!isElectric) { cavoRapidaSelect.value = "non_applicabile";  cavoDomesticaSelect.value = "non_applicabile"; } else { if (cavoRapidaSelect.value === "" || cavoRapidaSelect.value === "non_applicabile") cavoRapidaSelect.value = ""; if (cavoDomesticaSelect.value === "" || cavoDomesticaSelect.value === "non_applicabile") cavoDomesticaSelect.value = ""; } updateNavButtonColors();  }
    function savePosizioneForTarga(targa, posizione) { if (!targa) return; try { localStorage.setItem(`${APP_PREFIX}posizione_${targa.toUpperCase()}`, posizione); } catch (e) { console.error("Errore salvataggio posizione LS:", e); } }
    function loadPosizioneForTarga(targa) { if (!targa) return ""; try { return localStorage.getItem(`${APP_PREFIX}posizione_${targa.toUpperCase()}`) || ""; } catch (e) { console.error("Errore caricamento posizione LS:", e); return ""; } }
    function saveUrgentStatusForTarga(targa, isUrgent) {  if (!targa) return; try { localStorage.setItem(`${APP_PREFIX}urgent_${targa.toUpperCase()}`, JSON.stringify(isUrgent)); } catch (e) { console.error("Errore salvataggio stato urgenza LS:", e); } }
    function loadUrgentStatusForTarga(targa) { if (!targa) return false; try { const status = localStorage.getItem(`${APP_PREFIX}urgent_${targa.toUpperCase()}`); return status ? JSON.parse(status) : false; } catch (e) { console.error("Errore caricamento stato urgenza LS:", e); return false; } }
    function resetChecklistForm() { const els = document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea'); els.forEach(el => { if (el.type === 'checkbox') el.checked = false; else if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; }); if (tipoTrazioneSelect) {  handleTrazioneChange(); } console.log("Modulo resettato."); }
    function saveProgress(targa) { if(!targa){console.warn("Nessuna targa attiva per il salvataggio.");return false;} const data = {}; document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => { if (el.id) { if (el.type === 'checkbox') data[el.id] = el.checked; else data[el.id] = el.value; } }); data.timestamp = new Date().toISOString();  try { localStorage.setItem(`${APP_PREFIX}data_${targa.toUpperCase()}`, JSON.stringify(data)); console.log(`Progresso salvato localmente per la targa ${targa.toUpperCase()} con timestamp ${data.timestamp}.`); updateNavButtonColors(); return true; } catch(e) { console.error("Errore durante il salvataggio in localStorage:", e); alert("Salvataggio locale fallito. Spazio esaurito o errore del browser."); return false; } }
    function loadProgress(targa) { if(!targa) return; const targaUpper = targa.toUpperCase(); try { const json = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`); if (json) { const data = JSON.parse(json); document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => { if (el.id && data.hasOwnProperty(el.id)) { if (el.type === 'checkbox') el.checked = data[el.id]; else el.value = data[el.id]; } else if (el.id) {  if (el.type === 'checkbox') el.checked = false; else if (el.tagName === 'SELECT') el.selectedIndex = 0; } }); console.log(`Progresso caricato da localStorage per la targa ${targaUpper}. Timestamp: ${data.timestamp || 'N/A'}`); } else { console.log(`Nessun dato salvato in localStorage trovato per la targa ${targaUpper}. Reset form.`); resetChecklistForm();  } if (tipoTrazioneSelect) {   handleTrazioneChange(); } updateNavButtonColors();  } catch(e) { console.error("Errore durante il caricamento da localStorage:", e); resetChecklistForm();  updateNavButtonColors(); } }
    function getCompletedTarghe() { try{const json=localStorage.getItem(`${APP_PREFIX}completedTarghe`);return json?JSON.parse(json):{};}catch(e){console.error("Errore LS getCompletedTarghe:", e); return{};}}
    function isTargaCompleted(targa) { if(!targa) return false; const completed = getCompletedTarghe(); return !!(completed[targa.toUpperCase()]); }
    function markTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe();completed[targa.toUpperCase()]=true;localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));console.log(`${targa.toUpperCase()} marked complete locally.`);}catch(e){console.error("Errore LS Mark Err:",e);}}
    function unmarkTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe(); if(completed[targa.toUpperCase()]){ delete completed[targa.toUpperCase()]; localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed)); console.log(`${targa.toUpperCase()} unmarked as complete locally.`);}}catch(e){console.error("Errore LS Unmark Err:",e);}}
    
    function clearLocalDataForTarga(targaUpper) {
        if (!targaUpper) return;
        try {
            localStorage.removeItem(`${APP_PREFIX}data_${targaUpper}`);
            console.log(`Dati modulo rimossi per ${targaUpper}.`);
            unmarkTargaAsCompleted(targaUpper); 
            localStorage.removeItem(`${APP_PREFIX}posizione_${targaUpper}`);
            console.log(`Dati posizione rimossi per ${targaUpper}.`);
            localStorage.removeItem(`${APP_PREFIX}urgent_${targaUpper}`);
            console.log(`Dati urgenza rimossi per ${targaUpper}.`);

            getPhotosByTargaAndSezioneFromDB(targaUpper, null) 
                .then(photos => {
                    const deletePromises = photos.map(photo => deletePhotoFromDB(photo.timestamp));
                    return Promise.all(deletePromises);
                })
                .then(() => {
                    console.log(`Tutte le foto per ${targaUpper} cancellate da IndexedDB.`);
                    if (galleryPageSection.style.display === 'block' && (currentGalleryTargaFilter === targaUpper || !currentGalleryTargaFilter)) {
                         populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter); 
                    }
                })
                .catch(err => console.error(`Errore cancellazione foto da DB per targa ${targaUpper}:`, err));

        } catch (e) {
            console.error(`Errore durante la cancellazione dei dati locali per ${targaUpper}:`, e);
            alert(`Errore cancellazione dati locali per ${targaUpper}.`);
        }
    }

    function generateAndDownloadScreenshot() { return new Promise((resolve, reject) => { const riepilogoSection = document.getElementById('riepilogoSection'); if (!riepilogoSection) { alert("Errore: Sezione Riepilogo non trovata per lo screenshot."); return reject("Sezione riepilogo non trovata"); } if (typeof html2canvas === 'undefined') { alert("Errore: Libreria html2canvas non caricata."); return reject("html2canvas non caricata"); } setTimeout(() => { /* console.log("Inizio generazione screenshot...");*/ riepilogoSection.scrollTop = 0;  html2canvas(riepilogoSection, { scale: 2, useCORS: true, logging: false, scrollY: -window.scrollY, windowHeight: riepilogoSection.scrollHeight }) .then(canvas => { const link = document.createElement('a'); let targaSanitized = 'sconosciuta'; let piazzaleSanitized = 'piazzale_sconosciuto'; if (targaSelezionataGlobalmente) { targaSanitized = targaSelezionataGlobalmente.replace(/[^a-zA-Z0-9.-]/g, '_'); const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente); if (veicoloAttuale && veicoloAttuale.piazzale && veicoloAttuale.piazzale.trim() !== "") { piazzaleSanitized = veicoloAttuale.piazzale.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_'); if (!piazzaleSanitized) piazzaleSanitized = 'N_D'; } else { piazzaleSanitized = 'N_D'; } } link.download = `perizia_${targaSanitized}_${piazzaleSanitized}.png`; link.href = canvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); document.body.removeChild(link); console.log(`Screenshot generato e download avviato: ${link.download}`); resolve(); }) .catch(error => { console.error("Errore durante la generazione dello screenshot:", error); alert("Si è verificato un errore durante la generazione dello screenshot."); reject(error); }); }, 100);  }); }
    
    async function downloadPhotosAsZip(targa) {
        if (!targa) {
            console.warn("Nessuna targa fornita per scaricare le foto come ZIP.");
            return;
        }
        if (typeof JSZip === 'undefined') {
            alert("Errore: Libreria JSZip non caricata. Impossibile creare ZIP.");
            return;
        }

        const originalButtonText = saveAndReturnBtn.textContent;
        saveAndReturnBtn.textContent = 'Creazione ZIP...';
        saveAndReturnBtn.disabled = true;

        try {
            const photos = await getPhotosByTargaAndSezioneFromDB(targa, null); // null per ottenere tutte le foto della targa
            if (!photos || photos.length === 0) {
                alert(`Nessuna foto trovata per la targa ${targa} da includere nello ZIP.`);
                saveAndReturnBtn.textContent = originalButtonText;
                saveAndReturnBtn.disabled = false;
                return;
            }

            const zip = new JSZip();
            photos.forEach(photoData => {
                if (photoData.blobData instanceof Blob && photoData.name) {
                    zip.file(photoData.name, photoData.blobData);
                }
            });

            const zipBlob = await zip.generateAsync({type:"blob", compression: "DEFLATE"});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            const zipFileName = `${targa.toUpperCase().replace(/[^A-Z0-9]/g, '_')}.zip`;
            link.download = zipFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            console.log(`File ZIP "${zipFileName}" generato e download avviato.`);
            alert(`File ZIP "${zipFileName}" per la targa ${targa} scaricato con successo.`);

        } catch (error) {
            console.error("Errore durante la creazione o il download del file ZIP:", error);
            alert("Si è verificato un errore durante la creazione del file ZIP delle foto.");
        } finally {
            saveAndReturnBtn.textContent = originalButtonText; // Ripristina anche se c'è stato solo lo screenshot
            saveAndReturnBtn.disabled = false;
        }
    }

    async function handleSavePeriziaAndReturn() {  
        if (!targaSelezionataGlobalmente) { 
            alert("Nessuna targa attiva selezionata per il salvataggio."); 
            return; 
        } 
        const originalButtonText = saveAndReturnBtn.textContent; 
        saveAndReturnBtn.textContent = 'Salvataggio perizia...'; 
        saveAndReturnBtn.disabled = true; 
        
        if (!saveProgress(targaSelezionataGlobalmente)) {  
            alert("Salvataggio dati nel browser fallito."); 
            saveAndReturnBtn.textContent = originalButtonText; 
            saveAndReturnBtn.disabled = false; 
            return; 
        } 
        
        if (document.getElementById('riepilogoSection').classList.contains('active')) { 
            generateSummary();  
        } 
        
        try { 
            await generateAndDownloadScreenshot(); 
            // Dopo lo screenshot, prova a generare e scaricare lo ZIP delle foto
            await downloadPhotosAsZip(targaSelezionataGlobalmente);
        } catch (e) { 
            console.warn("Generazione screenshot o ZIP fallita, ma i dati sono stati salvati localmente.", e); 
            // L'alert per l'errore ZIP è già in downloadPhotosAsZip
        } 
        
        markTargaAsCompleted(targaSelezionataGlobalmente);  
        updateNavButtonColors();  
        
        // Il ripristino del bottone è gestito da downloadPhotosAsZip o qui se quello non parte
        if (saveAndReturnBtn.textContent !== originalButtonText) { // Se non già ripristinato da downloadPhotosAsZip
             saveAndReturnBtn.textContent = originalButtonText;
             saveAndReturnBtn.disabled = false;
        }
        
        // Non mostrare un alert generico qui, gli alert specifici sono in generateAndDownloadScreenshot e downloadPhotosAsZip
        // alert(`Perizia per ${targaSelezionataGlobalmente} salvata localmente. Screenshot e ZIP foto tentati.`); 
        showView('landing');  
    }

    function handleSaveAndNext() { if(!targaSelezionataGlobalmente){alert("No targa.");return;} if(saveProgress(targaSelezionataGlobalmente)){const oT=this.textContent;this.textContent='Salvato!';this.disabled=true;setTimeout(()=>{this.textContent=oT;this.disabled=false;},1500);}else return; let curIdx=-1; navButtons.forEach((nb,i)=>{if(nb.classList.contains('active'))curIdx=i;}); if(curIdx!==-1&&curIdx<navButtons.length-1){const nextNB=navButtons[curIdx+1];if(nextNB)showSection(nextNB.dataset.target);}}
    function isInputDefault(inputElement) { if (!inputElement) return true; if (inputElement.type === 'checkbox') return !inputElement.checked; if (inputElement.tagName === 'SELECT') return inputElement.value === "" || inputElement.selectedIndex === 0; if (inputElement.type === 'text' || inputElement.type === 'url' || inputElement.tagName === 'TEXTAREA') return inputElement.value.trim() === ""; return true; }
    function getSectionInputs(sectionElementId) { const sectionDiv = document.getElementById(sectionElementId); if (!sectionDiv) return []; return Array.from(sectionDiv.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled)')); }
    function getSectionStatus(sectionElementId, targaData) { const inputs = getSectionInputs(sectionElementId); if (inputs.length === 0) return 'completed';  let allDefaultOrNA = true;  let allNonDefaultAndApplicable = true;  let hasAtLeastOneNonDefaultAndApplicable = false; inputs.forEach(input => { let isEffectivelyDefault = false; const savedValue = targaData && targaData.hasOwnProperty(input.id) ? targaData[input.id] : undefined; let currentValue = savedValue; if (savedValue === undefined) {  if (input.type === 'checkbox') currentValue = input.checked; else currentValue = input.value; } if (input.type === 'checkbox') { isEffectivelyDefault = !currentValue; } else if (input.tagName === 'SELECT') { isEffectivelyDefault = (currentValue === "" || (input.options.length > 0 && currentValue === input.options[0].value)); if ((input.id === 'cavo_ricarica_rapida' || input.id === 'cavo_ricarica_domestica') && currentValue === 'non_applicabile') { isEffectivelyDefault = true; } } else {  isEffectivelyDefault = (currentValue === ""); } if (!isEffectivelyDefault) { allDefaultOrNA = false; hasAtLeastOneNonDefaultAndApplicable = true; } else {  allNonDefaultAndApplicable = false; } }); if (allDefaultOrNA) return 'untouched'; if (allNonDefaultAndApplicable) return 'completed'; if (hasAtLeastOneNonDefaultAndApplicable) return 'partial';  return 'untouched';  }
    function updateNavButtonColors() { if (!targaSelezionataGlobalmente && checklistContainer.style.display === 'none' && galleryPageSection.style.display === 'none') { navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched', 'active'); btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; }); return; } const targaDataJSON = localStorage.getItem(`${APP_PREFIX}data_${(targaSelezionataGlobalmente || currentGalleryTargaFilter || "").toUpperCase()}`); const targaData = targaDataJSON ? JSON.parse(targaDataJSON) : null; navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched'); if (!btn.classList.contains('active')) { btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; } if (btn.classList.contains('active')) { return; } const targetSection = btn.dataset.target; let status = 'untouched'; const activeTargaForStatus = targaSelezionataGlobalmente || currentGalleryTargaFilter; if (targetSection === 'riepilogo') { if (isTargaCompleted(activeTargaForStatus)) { status = 'completed'; } else { let hasAnyDataForSummary = false; if (targaData && Object.keys(targaData).length > 0 && Object.keys(targaData).some(k => k !== 'timestamp')) { hasAnyDataForSummary = true; } else { ['remarketingSection', 'pneumaticiSection', 'danniVerificheSection'].forEach(secId => { if (getSectionStatus(secId, targaData) !== 'untouched') { hasAnyDataForSummary = true; } }); } status = hasAnyDataForSummary ? 'partial' : 'untouched'; } } else if (targetSection) { status = getSectionStatus(targetSection + 'Section', targaData); } if (status === 'completed') btn.classList.add('nav-btn-completed'); else if (status === 'partial') btn.classList.add('nav-btn-partial'); else btn.classList.add('nav-btn-untouched'); }); }

    // START: Funzioni per la pagina Fotocamera
    async function showCameraPage() {
        if (galleryPageSection.style.display === 'block') {
            lastViewBeforeCamera = 'gallery';
            lastSectionBeforeCamera = currentGallerySectionFilter; 
        } else if (checklistContainer.style.display === 'block') {
            lastViewBeforeCamera = 'checklist';
            const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
            lastSectionBeforeCamera = activeSectionElement ? activeSectionElement.id.replace('Section', '') : null;
        } else if (historyPageSection.style.display === 'block') {
            lastViewBeforeCamera = 'history';
            lastSectionBeforeCamera = null;
        } else { 
            lastViewBeforeCamera = 'landing';
            lastSectionBeforeCamera = null;
        }
        console.log(`Prima della fotocamera: vista='${lastViewBeforeCamera}', sezione='${lastSectionBeforeCamera}'`);

        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        galleryPageSection.style.display = 'none'; 
        cameraStreamElement.style.display = 'block'; 
        freezeFrameDisplayElement.style.display = 'none'; 
        cameraPageSection.style.display = 'flex'; 
        
        if(utilityNavButtons) utilityNavButtons.style.display = 'none';
        if(mainTitleGlobal) mainTitleGlobal.style.display = 'none';
        if(targaDropdownContainer) targaDropdownContainer.style.display = 'none';
        if(navButtonsContainer) navButtonsContainer.style.display = 'none'; 

        pageHeaderContainer.classList.add('fixed-header'); 
        const headerCirclesDiv = document.querySelector('.header-circles');
        if (headerCirclesDiv) {
             headerCirclesDiv.style.display = 'flex';
             document.body.style.paddingTop = `${headerCirclesDiv.offsetHeight}px`;
             cameraPageSection.style.paddingTop = `${headerCirclesDiv.offsetHeight}px`;
             cameraPageSection.style.height = `calc(100vh - ${headerCirclesDiv.offsetHeight}px)`; 
        } else {
            document.body.style.paddingTop = '0px'; 
            cameraPageSection.style.paddingTop = `0px`; 
            cameraPageSection.style.height = `100vh`;
        }


        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            const constraints = { 
                video: {
                    facingMode: "environment",
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                    advanced: [{ focusMode: "continuous" }]
                },
                audio: false
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraStreamElement.srcObject = stream;
                currentCameraStream = stream;

                const videoTrack = stream.getVideoTracks()[0];
                const capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
                // console.log("Capacità traccia video:", JSON.stringify(capabilities, null, 2));

                if (videoTrack && typeof videoTrack.applyConstraints === 'function') {
                    try {
                        await videoTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                        // console.log("Vincolo focusMode 'continuous' applicato.");
                    } catch (e) {
                        console.warn("Impossibile applicare focusMode 'continuous' via applyConstraints:", e.name, e.message);
                        try {
                             await videoTrack.applyConstraints({ advanced: [{ focusMode: 'auto' }] });
                             // console.log("Vincolo focusMode 'auto' applicato come fallback.");
                        } catch (e2) {
                            console.warn("Impossibile applicare focusMode 'auto' via applyConstraints:", e2.name, e2.message);
                        }
                    }
                } else {
                     // console.log("Autofocus (focusMode: continuous) richiesto in initial constraints.");
                }

            } catch (err) {
                console.error("Errore accesso fotocamera con constraints iniziali:", err.name, err.message);
                try {
                    // console.log("Tentativo di fallback con constraints minimi (solo facingMode)...");
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                    cameraStreamElement.srcObject = fallbackStream;
                    currentCameraStream = fallbackStream;
                    // console.log("Accesso fotocamera riuscito in fallback (constraints minimi).");
                } catch (fallbackErr) {
                    console.error("Errore accesso fotocamera anche in fallback:", fallbackErr.name, fallbackErr.message);
                    alert("Impossibile accedere alla fotocamera: " + fallbackErr.message);
                    returnFromCamera();
                }
            }
        } else {
            alert("Il tuo browser non supporta l'accesso alla fotocamera.");
            returnFromCamera();
        }
        window.scrollTo(0, 0);
    }

    function returnFromCamera() {
        if (currentCameraStream) {
            currentCameraStream.getTracks().forEach(track => track.stop());
            currentCameraStream = null;
            cameraStreamElement.srcObject = null;
        }
        cameraPageSection.style.display = 'none';
        cameraStreamElement.style.display = 'block'; 
        freezeFrameDisplayElement.style.display = 'none'; 
        cameraPageSection.style.paddingTop = ''; 
        cameraPageSection.style.height = '';    

        // console.log(`Ritorno da fotocamera a: vista='${lastViewBeforeCamera}', sezione='${lastSectionBeforeCamera}'`);

        if (lastViewBeforeCamera === 'gallery') { 
            showGalleryPage(currentGalleryTargaFilter, currentGallerySectionFilter);
        } else if (lastViewBeforeCamera === 'checklist' && targaSelezionataGlobalmente && lastSectionBeforeCamera) {
            showView('checklist'); 
            showSection(lastSectionBeforeCamera);
        } else if (lastViewBeforeCamera === 'history') {
            showView('history');
        } else { 
            showView('landing');
        }
    }

    function getFilenameSectionName() {
        let sectionNameForFile = "generale"; 
        if (lastSectionBeforeCamera) { 
            let tempSectionKey = lastSectionBeforeCamera.toLowerCase();
            if (['remarketing', 'pneumatici'].includes(tempSectionKey)) {
                sectionNameForFile = tempSectionKey;
            } else if (tempSectionKey === 'danniverifiche') {
                sectionNameForFile = 'danni';
            } else if (tempSectionKey === 'riepilogo') { 
                sectionNameForFile = 'riepilogo_foto'; 
            } else if (lastViewBeforeCamera === 'gallery' && currentGallerySectionFilter && currentGallerySectionFilter !== 'riepilogo') {
                 sectionNameForFile = currentGallerySectionFilter.toLowerCase() === 'danniverifiche' ? 'danni' : currentGallerySectionFilter.toLowerCase();
            } else if (lastViewBeforeCamera === 'gallery' && currentGallerySectionFilter === 'riepilogo') {
                 sectionNameForFile = 'targa_completa'; 
            }
        }
        // console.log("Nome sezione per file foto:", sectionNameForFile, "da lastSectionBeforeCamera:", lastSectionBeforeCamera, "lastView:", lastViewBeforeCamera);
        return sectionNameForFile;
    }

    function capturePhoto() {
        if (captureBtn.disabled) return; 

        if (currentCameraStream && cameraStreamElement.readyState >= cameraStreamElement.HAVE_CURRENT_DATA && cameraStreamElement.videoWidth > 0) {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStreamElement.videoWidth; 
            canvas.height = cameraStreamElement.videoHeight;
            // console.log(`Cattura foto con risoluzione: ${canvas.width}x${canvas.height}`);

            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraStreamElement, 0, 0, canvas.width, canvas.height);
            
            freezeFrameDisplayElement.src = canvas.toDataURL('image/jpeg', 0.7); 
            freezeFrameDisplayElement.style.display = 'block';
            cameraStreamElement.style.display = 'none'; 
            captureBtn.disabled = true; 

            const targaForFile = (targaSelezionataGlobalmente || currentGalleryTargaFilter || 'SCONOSCIUTA').toUpperCase().replace(/[^A-Z0-9]/g, '');
            const sectionNameForFile = getFilenameSectionName();
            const counterKey = `${APP_PREFIX}photoCount_${targaForFile}_${sectionNameForFile}`;
            let photoNumber = parseInt(localStorage.getItem(counterKey) || '0') + 1;
            localStorage.setItem(counterKey, photoNumber.toString());
            const formattedPhotoNumber = String(photoNumber).padStart(3, '0');
            const filename = `${formattedPhotoNumber} ${sectionNameForFile} ${targaForFile}.jpeg`; 
            
            canvas.toBlob(async function(blob) {
                if (!blob) {
                    console.error("Errore: canvas.toBlob ha restituito null.");
                    alert("Errore nella conversione della foto. Riprova.");
                    freezeFrameDisplayElement.style.display = 'none';
                    freezeFrameDisplayElement.src = '#'; 
                    cameraStreamElement.style.display = 'block';
                    captureBtn.disabled = false; 
                    return;
                }

                const photoObjectToSave = {
                    name: filename,
                    blobData: blob,
                    timestamp: new Date().toISOString(),
                    targa: targaForFile,
                    sezione: sectionNameForFile
                };

                try {
                    await savePhotoToDB(photoObjectToSave);
                    console.log(`Foto "${filename}" salvata in IndexedDB.`);

                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob); 
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href); 
                    console.log(`Foto "${filename}" scaricata.`);

                } catch (error) {
                    console.error("Errore salvataggio foto in IndexedDB o download:", error);
                    alert("Errore durante il salvataggio della foto nel database locale (IndexedDB).");
                } finally {
                    setTimeout(() => {
                        freezeFrameDisplayElement.style.display = 'none';
                        freezeFrameDisplayElement.src = '#'; 
                        cameraStreamElement.style.display = 'block';
                        captureBtn.disabled = false; 
                    }, 500); 
                }
            }, 'image/jpeg', 0.7); 

        } else {
            console.warn("Stream fotocamera non pronto o dimensioni video non disponibili per la cattura.");
        }
    }
    // END: Funzioni per la pagina Fotocamera

    // START: Funzioni per Pagina Galleria e Lightbox
    async function showGalleryPage(targaToFilter = null, sectionToFilter = null) {
        if (checklistContainer.style.display === 'block') {
            lastViewBeforeGallery = 'checklist';
            const activeSectionEl = document.querySelector('#checklistContainer .category-section.active');
            lastSectionBeforeGallery = activeSectionEl ? activeSectionEl.id.replace('Section', '') : null;
        } else if (landingPageSection.style.display === 'block') {
            lastViewBeforeGallery = 'landing';
            lastSectionBeforeGallery = null;
        } else if (historyPageSection.style.display === 'block') {
            lastViewBeforeGallery = 'history';
            lastSectionBeforeGallery = null;
        } 

        currentGalleryTargaFilter = targaToFilter ? targaToFilter.toUpperCase() : null;
        currentGallerySectionFilter = sectionToFilter; 

        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        cameraPageSection.style.display = 'none';
        galleryPageSection.style.display = 'block';
        
        const galleryTitleElement = galleryPageSection.querySelector('h2.section-title');
        let galleryTitleText = "Galleria Foto Catturate";

        if (currentGalleryTargaFilter) {
            targaSelezionataGlobalmente = currentGalleryTargaFilter; 
            mainTitleGlobal.style.display = 'none';
            targaDropdownContainer.style.display = 'flex';
            populateTargaSwitcherDropdown(); 
            if(targaSwitcherDropdown.value.toUpperCase() !== currentGalleryTargaFilter) {
                targaSwitcherDropdown.value = currentGalleryTargaFilter;
            }
            updateTargaDetailsDisplay(currentGalleryTargaFilter);
            navButtonsContainer.style.display = 'flex';
            mainPageNavButtons.style.display = 'flex';
            utilityNavButtons.style.display = 'flex'; 

            navButtons.forEach(b => b.classList.remove('active'));
            let sectionNameForTitle = "Tutte le foto"; 
            if (currentGallerySectionFilter && currentGallerySectionFilter !== 'riepilogo') {
                const navButtonForSection = mainPageNavButtons.querySelector(`button[data-target="${currentGallerySectionFilter}"]`);
                if (navButtonForSection) {
                    navButtonForSection.classList.add('active');
                    sectionNameForTitle = navButtonForSection.textContent.split('. ')[1] || currentGallerySectionFilter; 
                } else { 
                     sectionNameForTitle = currentGallerySectionFilter.charAt(0).toUpperCase() + currentGallerySectionFilter.slice(1);
                     if (currentGallerySectionFilter === 'danniverifiche') sectionNameForTitle = 'Danni/Verifiche'; 
                }
            } else if (currentGallerySectionFilter === 'riepilogo') {
                 const riepilogoNavButton = mainPageNavButtons.querySelector(`button[data-target="riepilogo"]`);
                 if (riepilogoNavButton) riepilogoNavButton.classList.add('active');
            }
            galleryTitleText = `Galleria: ${currentGalleryTargaFilter} - ${sectionNameForTitle}`;
            updateNavButtonColors(); 
        } else { 
            mainTitleGlobal.style.display = 'block';
            mainTitleGlobal.innerHTML = "Galleria Foto Catturate"; 
            targaDropdownContainer.style.display = 'none';
            navButtonsContainer.style.display = 'none'; 
            utilityNavButtons.style.display = 'flex'; 
        }
        if(galleryTitleElement) galleryTitleElement.textContent = galleryTitleText;

        await populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
        if (pageHeaderContainer.classList.contains('fixed-header')) {
            document.body.style.paddingTop = `${pageHeaderContainer.offsetHeight + 10}px`;
        }
        window.scrollTo(0,0);
    }

    async function populatePhotoGrid(targaFilter, sectionKeyFilter) {
        photoGridContainer.innerHTML = ''; 
        
        try {
            let photosToDisplay;
            let effectiveSectionKey = sectionKeyFilter;
            if (targaFilter) { 
                if (sectionKeyFilter && sectionKeyFilter.toLowerCase() === 'danniverifiche') {
                    effectiveSectionKey = 'danni';
                } else if (sectionKeyFilter && sectionKeyFilter.toLowerCase() === 'riepilogo'){
                    effectiveSectionKey = null; 
                }
                photosToDisplay = await getPhotosByTargaAndSezioneFromDB(targaFilter, effectiveSectionKey);
            } else { 
                photosToDisplay = await getAllPhotosFromDB(); 
            }


            if (photosToDisplay.length === 0) {
                photoGridContainer.innerHTML = '<p>Nessuna foto trovata per i filtri applicati.</p>';
                return;
            }

            photosToDisplay.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 

            photosToDisplay.forEach((photoData) => {
                const photoItemDiv = document.createElement('div');
                photoItemDiv.classList.add('photo-item');
                const img = document.createElement('img');
                let objectUrl = null; 
                
                if (photoData.blobData instanceof Blob) {
                    objectUrl = URL.createObjectURL(photoData.blobData);
                    img.src = objectUrl;
                } else {
                    console.warn("Dati immagine non Blob per:", photoData.name);
                    img.alt = `Dati non validi ${photoData.name}`;
                }
                
                img.alt = photoData.name;
                img.dataset.timestamp = photoData.timestamp; 

                img.addEventListener('click', function() {
                    openImageLightbox(this.dataset.timestamp);
                });

                const caption = document.createElement('div');
                caption.classList.add('photo-item-caption');
                caption.textContent = photoData.name;
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('photo-item-delete-btn');
                deleteBtn.innerHTML = '&times;'; 
                deleteBtn.title = "Elimina foto";
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    if (objectUrl) { 
                        URL.revokeObjectURL(objectUrl);
                    }
                    deleteCapturedPhoto(photoData.timestamp); 
                });
                photoItemDiv.appendChild(img);
                photoItemDiv.appendChild(caption);
                photoItemDiv.appendChild(deleteBtn);
                photoGridContainer.appendChild(photoItemDiv);
            });

        } catch (e) {
            console.error("Errore nel parsing o recupero delle foto da IndexedDB:", e);
            photoGridContainer.innerHTML = '<p>Errore nel caricare le foto dal database.</p>';
        }
    }
    
    async function deleteCapturedPhoto(timestampToDelete) { 
        if (confirm("Sei sicuro di voler eliminare questa foto dalla galleria dell'app?")) {
            try {
                await deletePhotoFromDB(timestampToDelete);
                await populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter); 
            } catch (e) {
                console.error("Errore durante l'eliminazione della foto da IndexedDB o ripopolamento:", e);
                alert("Errore durante l'eliminazione della foto.");
            }
        }
    }

    async function openImageLightbox(timestamp) {
        try {
            const db = await openPhotoDB();
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.get(timestamp);

            request.onsuccess = (event) => {
                const photoData = event.target.result;
                if (photoData && photoData.blobData instanceof Blob) {
                    if (currentLightboxImageObjectUrl) {
                        URL.revokeObjectURL(currentLightboxImageObjectUrl); 
                    }
                    currentLightboxImageObjectUrl = URL.createObjectURL(photoData.blobData);
                    lightboxImage.src = currentLightboxImageObjectUrl;
                    imageLightbox.style.display = 'flex'; 
                } else {
                    console.error("Foto non trovata o dati blob non validi per il lightbox.");
                    alert("Impossibile caricare l'immagine ingrandita.");
                }
            };
            request.onerror = (event) => {
                console.error("Errore recupero foto per lightbox:", event.target.error);
                alert("Errore nel caricamento dell'immagine per l'ingrandimento.");
            };
        } catch (error) {
            console.error("Errore apertura DB per lightbox:", error);
            alert("Errore database per visualizzare l'immagine.");
        }
    }

    function closeImageLightbox() {
        imageLightbox.style.display = 'none';
        if (currentLightboxImageObjectUrl) {
            URL.revokeObjectURL(currentLightboxImageObjectUrl);
            currentLightboxImageObjectUrl = null;
        }
        lightboxImage.src = '#'; 
    }

    // END: Funzioni per Pagina Galleria e Lightbox


    function showView(viewName) {
        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        if(cameraPageSection) cameraPageSection.style.display = 'none';
        if(galleryPageSection) galleryPageSection.style.display = 'none'; 
        if(imageLightbox) imageLightbox.style.display = 'none'; 
        
        const headerCirclesDiv = document.querySelector('.header-circles');
        if (viewName !== 'camera') { 
            if(utilityNavButtons) utilityNavButtons.style.display = 'flex';
            if(headerCirclesDiv) headerCirclesDiv.style.display = 'flex';
        }

        if (viewName === 'landing') {
            landingPageSection.style.display = 'block';
            pageHeaderContainer.classList.add('fixed-header');
            if (mainTitleGlobal) { mainTitleGlobal.innerHTML = "Elenco Veicoli"; mainTitleGlobal.style.display = 'block';}
            if (navButtonsContainer) navButtonsContainer.style.display = 'none'; 
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (listaTargheCompleta.length > 0 &&
                (!document.getElementById('preloader') || document.getElementById('preloader').classList.contains('hidden')) &&
                typeof popolaTargheFiltrate === 'function') {
                popolaTargheFiltrate();
            }
        } else if (viewName === 'checklist') {
            pageHeaderContainer.classList.add('fixed-header');
            if (navButtonsContainer) navButtonsContainer.style.display = 'flex'; 
            if (mainPageNavButtons) mainPageNavButtons.style.display = 'flex';
            if (!targaSelezionataGlobalmente) { 
                console.warn("Tentativo di mostrare checklist senza targa selezionata. Reindirizzamento a landing.");
                showView('landing'); 
                return;
            }
            if (localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente.toUpperCase()}`)) {
                console.warn(`Tentativo di mostrare checklist per targa ${targaSelezionataGlobalmente} cancellata. Reindirizzamento a landing.`);
                showView('landing');
                alert(`La perizia per ${targaSelezionataGlobalmente} è stata cancellata e non può essere modificata.`);
                return;
            }

            checklistContainer.style.display = 'block';
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'none'; 
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex'; 
            populateTargaSwitcherDropdown(); 
            updateTargaDetailsDisplay(targaSelezionataGlobalmente); 
            if (tipoTrazioneSelect) handleTrazioneChange();
        } else if (viewName === 'history') {
            pageHeaderContainer.classList.add('fixed-header');
            historyPageSection.style.display = 'block';
            if (mainTitleGlobal) { mainTitleGlobal.innerHTML = "Cronistoria Salvataggi"; mainTitleGlobal.style.display = 'block'; }
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            populateSavedTargasList();
        } else if (viewName === 'gallery') { 
            pageHeaderContainer.classList.add('fixed-header');
            galleryPageSection.style.display = 'block'; 
        } else if (viewName !== 'camera') { 
             pageHeaderContainer.classList.remove('fixed-header');
             if (headerCirclesDiv) headerCirclesDiv.style.display = 'none'; 
             if (utilityNavButtons) utilityNavButtons.style.display = 'none';
             if (mainTitleGlobal) mainTitleGlobal.innerHTML = "";
        }
        updateNavButtonColors(); 

        let bodyPaddingTopValue = '0px';
        if (viewName !== 'camera') {
            if (pageHeaderContainer.classList.contains('fixed-header') && getComputedStyle(pageHeaderContainer).display !== 'none') {
                bodyPaddingTopValue = `${pageHeaderContainer.offsetHeight + 10}px`;
            } else {
                let nonFixedHeaderHeight = 0;
                if (mainTitleGlobal && getComputedStyle(mainTitleGlobal).display !== 'none' && !pageHeaderContainer.classList.contains('fixed-header')) {
                    nonFixedHeaderHeight = mainTitleGlobal.offsetHeight;
                }
                bodyPaddingTopValue = `${nonFixedHeaderHeight + 20}px`;
            }
            document.body.style.paddingTop = bodyPaddingTopValue;
        }
        window.scrollTo(0, 0);
    }

    async function handleTargaSelectionAndSync(selectedTarga, targetSectionId = null) {
        const targaUpper = selectedTarga.toUpperCase();

        if (localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`)) {
            // console.log(`handleTargaSelectionAndSync: Targa ${targaUpper} è stata cancellata localmente. Non verrà caricata.`);
            if (targheLoadingStatus && landingPageSection.style.display === 'block') {
                targheLoadingStatus.textContent = `Targa ${targaUpper} cancellata. Selezionane un'altra.`;
            }
            if (targaSelezionataGlobalmente === targaUpper && checklistContainer.style.display === 'block') {
                showView('landing'); 
            }
            return; 
        }

        if (targaSelezionataGlobalmente === targaUpper && checklistContainer.style.display === 'block') {
            if (targaSwitcherDropdown.value !== targaUpper) {
                targaSwitcherDropdown.value = targaUpper;
            }
            updateTargaDetailsDisplay(targaUpper);
            if (targetSectionId) {
                 const currentActiveSectionEl = document.querySelector('#checklistContainer .category-section.active');
                 const currentActiveSectionId = currentActiveSectionEl ? currentActiveSectionEl.id.replace('Section', '') : null;
                 if (currentActiveSectionId !== targetSectionId) {
                    showSection(targetSectionId);
                 }
            }
            return; 
        }

        targaSelezionataGlobalmente = targaUpper;
        // console.log(`Targa ${targaSelezionataGlobalmente} selezionata. Target section: ${targetSectionId}`);
        if (targheLoadingStatus && landingPageSection.style.display === 'block') {
            targheLoadingStatus.textContent = `Caricamento dati per ${targaSelezionataGlobalmente}...`;
        }

        let localData = null;
        let localDatiPeriziaTimestamp = null; 
        const localJson = localStorage.getItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`);
        if (localJson) {
            try {
                localData = JSON.parse(localJson); 
                localDatiPeriziaTimestamp = localData.timestamp ? new Date(localData.timestamp) : null;
            } catch (e) { console.error("Errore parsing dati locali:", e); localData = null; }
        }

        const sheetsPeriziaData = await fetchLatestPeriziaFromSheets(targaSelezionataGlobalmente); 
        let sheetsRecordTimestamp = null; 
        let sheetsDatiPerizia = null;
        let isSheetsDataCompleted = false;

        if (sheetsPeriziaData && sheetsPeriziaData.timestamp && sheetsPeriziaData.datiPerizia) {
            sheetsRecordTimestamp = new Date(sheetsPeriziaData.timestamp);
            sheetsDatiPerizia = sheetsPeriziaData.datiPerizia;
            isSheetsDataCompleted = sheetsPeriziaData.completata || false;
        }
        
        if (sheetsPeriziaData && sheetsRecordTimestamp && (!localDatiPeriziaTimestamp || sheetsRecordTimestamp > localDatiPeriziaTimestamp)) {
            // console.log(`Dati da Google Sheets per ${targaSelezionataGlobalmente} sono più recenti. Uso quelli.`);
            try {
                if (!localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) {
                    localStorage.setItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`, JSON.stringify(sheetsDatiPerizia));
                    savePosizioneForTarga(targaSelezionataGlobalmente, sheetsPeriziaData.posizione || "");
                    saveUrgentStatusForTarga(targaSelezionataGlobalmente, sheetsPeriziaData.urgente || false);
                    if (isSheetsDataCompleted) markTargaAsCompleted(targaSelezionataGlobalmente);
                    else unmarkTargaAsCompleted(targaSelezionataGlobalmente);
                } else {
                    // console.log(`Targa ${targaSelezionataGlobalmente} marcata per cancellazione, non sovrascrivo con dati da Sheets anche se più recenti.`);
                }
            } catch (e) { console.error("Errore salvataggio dati da Sheets in LS:", e); }
        } else if (localData) {
            // console.log(`Dati locali per ${targaSelezionataGlobalmente} sono più recenti o uguali, o Sheets non ha dati, o è marcata cancellata.`);
        } else if (!localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) { 
            // console.log(`Nessun dato per ${targaSelezionataGlobalmente}. Inizio perizia da zero.`);
            resetChecklistForm(); 
        }
        
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) {
             showView('landing');
             return;
        }

        loadProgress(targaSelezionataGlobalmente); 
        
        if (targheLoadingStatus && landingPageSection.style.display === 'block') {
            targheLoadingStatus.textContent = "Clicca su una targa per iniziare la perizia:";
        }
        
        showView('checklist'); 

        if (targetSectionId && document.getElementById(targetSectionId + 'Section')) {
            showSection(targetSectionId);
        } else {
            const firstNav = Array.from(navButtons).find(b => b.dataset.target && !['backToListBtn', 'historyBtn', 'mainExitAppBtn'].includes(b.id));
            if (firstNav && firstNav.dataset.target) {
                showSection(firstNav.dataset.target);
            } else if (navButtons.length > 0 && navButtons[0].dataset.target) {
                showSection(navButtons[0].dataset.target);
            } else { 
                showSection('remarketing'); 
            }
        }
    }
    
    function populateSavedTargasList() {
        savedTargasListContainer.innerHTML = '';
        let hasSaves = false;
        const tempSavedTargas = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}data_`)) {
                const targa = key.substring(`${APP_PREFIX}data_`.length);
                if (targa && !localStorage.getItem(`${APP_PREFIX}deleted_${targa}`) && !tempSavedTargas.includes(targa)) {
                    tempSavedTargas.push(targa);
                }
            }
        }
        if (tempSavedTargas.length > 0) hasSaves = true;
        tempSavedTargas.sort();
        tempSavedTargas.forEach(targa => {
            const vehicleDetails = listaTargheCompleta.find(v => v.targa === targa) || { marca: '', modello: '', piazzale: '' };
            let displayText = targa;
            let details = [];
            if (vehicleDetails.marca) details.push(vehicleDetails.marca);
            if (vehicleDetails.modello) details.push(vehicleDetails.modello);
            if (vehicleDetails.piazzale) details.push(`(Piazzale: ${vehicleDetails.piazzale})`);
            if (details.length > 0) {
                displayText += ` - ${details.join(' ')}`;
            }
            const button = document.createElement('button');
            button.classList.add('saved-targa-button');
            button.textContent = displayText;
            button.dataset.targa = targa;
            button.addEventListener('click', async function() { 
                await handleTargaSelectionAndSync(this.dataset.targa);
            });
            savedTargasListContainer.appendChild(button);
        });
        if (!hasSaves) {
            savedTargasListContainer.innerHTML = '<p style="text-align:center; color: #aaa;">Nessun salvataggio valido trovato.</p>';
        }
    }

    function clearAllSavedData() { 
        if (confirm("ATTENZIONE!\n\nCancellare TUTTI i dati salvati (incluse perizie, posizioni, urgenze, foto, flag di cancellazione e filtro piazzale)?\n\nAzione irreversibile.")) { 
            let c = 0; 
            const keysToRemove = []; 
            for (let i=localStorage.length-1;i>=0;i--) { 
                const k=localStorage.key(i); 
                if (k.startsWith(APP_PREFIX)) { 
                    keysToRemove.push(k); 
                } 
            } 
            keysToRemove.forEach(k => { localStorage.removeItem(k); c++; }); 
            
            openPhotoDB().then(db => {
                const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(PHOTO_STORE_NAME);
                const request = store.clear(); 
                request.onsuccess = () => {
                    console.log(`Tutte le foto cancellate da IndexedDB (${PHOTO_STORE_NAME}).`);
                    alert(`${c} elementi di localStorage e tutte le foto da IndexedDB cancellati.`); 
                    if(sheetFilterDropdown) sheetFilterDropdown.value = 'all'; 
                    localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all');  
                    populateSavedTargasList(); 
                    if (typeof caricaEPopolaTarghe === 'function') caricaEPopolaTarghe();  
                    if (typeof showView === 'function') showView('landing'); 
                    if (galleryPageSection.style.display === 'block') { 
                        populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
                    }
                };
                request.onerror = (event) => {
                    console.error('Errore cancellazione foto da IndexedDB:', event.target.error);
                    alert(`Errore durante la cancellazione delle foto da IndexedDB. ${c} elementi di localStorage cancellati.`);
                };
            }).catch(err => {
                console.error("Errore apertura DB per cancellazione foto:", err);
                alert("Errore apertura DB per cancellare le foto. Solo i dati di localStorage sono stati cancellati.");
            });
        } 
    }
    function setupSheetFilterDropdown() { if (!sheetFilterDropdown) return; const sources = ['all', ...new Set(listaTargheCompleta.map(item => item.piazzale).filter(p => p && p.trim() !== '').sort())]; sheetFilterDropdown.innerHTML = ''; sources.forEach(source => { const option = document.createElement('option'); option.value = source; option.textContent = source === 'all' ? 'Tutti gli Elenchi' : source; sheetFilterDropdown.appendChild(option); }); const savedPiazzaleFilter = localStorage.getItem(`${APP_PREFIX}selectedPiazzaleFilter`); if (savedPiazzaleFilter && sources.includes(savedPiazzaleFilter)) { sheetFilterDropdown.value = savedPiazzaleFilter; } else { sheetFilterDropdown.value = 'all'; localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all'); } sheetFilterDropdown.removeEventListener('change', handleSheetFilterChange); sheetFilterDropdown.addEventListener('change', handleSheetFilterChange); }
    function handleSheetFilterChange() { if (sheetFilterDropdown) { localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, sheetFilterDropdown.value); } popolaTargheFiltrate(); targaSelezionataGlobalmente = null; }
    
    function popolaTargheFiltrate() {
        const tEl = document.getElementById('targaListContainer');
        if (!tEl) return;
        tEl.innerHTML = '';
        const selectedSource = sheetFilterDropdown ? sheetFilterDropdown.value : 'all';
        
        let preliminaryFilteredList = selectedSource === 'all' 
            ? [...listaTargheCompleta] 
            : listaTargheCompleta.filter(item => item.piazzale === selectedSource);

        function getItemRank(item) {
            const targaUpper = item.targa.toUpperCase();
            const isLocallyDeleted = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`);
            if (isLocallyDeleted) return 0; 
            
            const isUrgent = loadUrgentStatusForTarga(targaUpper); 
            const isCompleted = isTargaCompleted(targaUpper);
            const localDataJson = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`);
            let hasData = false;
            if (localDataJson) {
                try {
                    const parsedData = JSON.parse(localDataJson);
                    hasData = Object.keys(parsedData).some(key => key !== 'timestamp' && parsedData[key] !== "" && parsedData[key] !== false && (!Array.isArray(parsedData[key]) || parsedData[key].length > 0) );
                } catch (e) { /* ignore */ }
            }
            if (isUrgent && !isCompleted) return 1; 
            if (!isUrgent && !isCompleted && hasData) return 2; 
            if (!isUrgent && !isCompleted && !hasData) return 3; 
            if (!isUrgent && isCompleted) return 4; 
            if (isUrgent && isCompleted) return 5;  
            return 6; 
        }

        preliminaryFilteredList.sort((a, b) => {
            const rankA = getItemRank(a);
            const rankB = getItemRank(b);
            if (rankA !== rankB) return rankA - rankB;
            return a.targa.localeCompare(b.targa); 
        });

        const filteredList = preliminaryFilteredList;

        if (filteredList.length === 0) {
            tEl.innerHTML = '<p style="text-align:center; padding:10px; color: #aaa;">Nessuna targa trovata per questo filtro.</p>';
            if(targheLoadingStatus) targheLoadingStatus.textContent = selectedSource === 'all' ? "Nessuna targa nel CSV." : `Nessuna targa per l'elenco: ${selectedSource}.`;
            return;
        }

        filteredList.forEach((item, idx) => {
            const targaUpper = item.targa.toUpperCase();
            const li = document.createElement('div');
            li.classList.add('targa-list-item');

            const isLocallyDeletedFlag = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`);
            if (isLocallyDeletedFlag) {
                li.classList.add('locally-deleted');
            }

            const itemCompleted = isTargaCompleted(targaUpper);
            const localDataJson = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`);
            let hasData = false;
            if (localDataJson) { try { const parsed = JSON.parse(localDataJson); hasData = Object.keys(parsed).some(k => k !== 'timestamp' && parsed[k] !== "" && parsed[k] !== false ); } catch (e) {} }
            const isItemUrgent = loadUrgentStatusForTarga(targaUpper); 

            if (!isLocallyDeletedFlag) { 
                if (isItemUrgent) {  li.classList.add('urgent-item'); if (itemCompleted) li.classList.add('completed'); } 
                else if (itemCompleted) { li.classList.add('status-visto', 'completed'); } 
                else if (hasData) { li.classList.add('status-parziale'); } 
                else { li.classList.add('status-da-vedere'); }
            }

            const targaCol = document.createElement('span');
            targaCol.classList.add('targa-col', 'targa-col-targa');
            if (!isLocallyDeletedFlag) { 
                 targaCol.classList.add('clickable-targa');
                 targaCol.addEventListener('click', async function() { 
                    const selectedTargaFromClick = this.dataset.targaValue; 
                    if (selectedTargaFromClick) { await handleTargaSelectionAndSync(selectedTargaFromClick); } 
                });
            }
            targaCol.textContent = item.targa || 'N/D'; 
            targaCol.dataset.targaValue = targaUpper; 
            li.appendChild(targaCol);

            const posizioneCol = document.createElement('span'); 
            posizioneCol.classList.add('targa-col', 'targa-col-posizione'); 
            const posizioneInput = document.createElement('input'); 
            posizioneInput.type = 'text'; 
            posizioneInput.classList.add('posizione-input'); 
            posizioneInput.dataset.targa = targaUpper; 
            posizioneInput.placeholder = 'Pos.'; 
            posizioneInput.maxLength = 5; 
            posizioneInput.value = loadPosizioneForTarga(targaUpper); 
            posizioneInput.disabled = isLocallyDeletedFlag; 
            posizioneInput.addEventListener('mousedown', (e) => e.stopPropagation()); 
            posizioneInput.addEventListener('click', (e) => e.stopPropagation()); 
            posizioneInput.addEventListener('focus', (e) => e.stopPropagation()); 
            posizioneInput.addEventListener('blur', function() { const newPosition = this.value.trim().toUpperCase(); if (newPosition !== loadPosizioneForTarga(this.dataset.targa)) { savePosizioneForTarga(this.dataset.targa, newPosition); this.style.transition = 'background-color 0.3s ease'; this.style.backgroundColor = 'rgba(76, 175, 80, 0.2)'; setTimeout(() => { this.style.backgroundColor = ''; }, 1000); } }); 
            posizioneInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); this.blur(); }}); 
            posizioneCol.appendChild(posizioneInput); 
            li.appendChild(posizioneCol); 

            const urgenzaCol = document.createElement('span'); 
            urgenzaCol.classList.add('targa-col', 'targa-col-urgenza'); 
            const urgenzaCheckbox = document.createElement('input'); 
            urgenzaCheckbox.type = 'checkbox'; 
            urgenzaCheckbox.checked = isItemUrgent; 
            urgenzaCheckbox.title = isItemUrgent ? "Togli urgenza" : "Marca come urgente"; 
            urgenzaCheckbox.disabled = isLocallyDeletedFlag; 
            urgenzaCheckbox.addEventListener('mousedown', (e) => e.stopPropagation()); 
            urgenzaCheckbox.addEventListener('click', (e) => e.stopPropagation()); 
            urgenzaCheckbox.addEventListener('change', function() { saveUrgentStatusForTarga(targaUpper, this.checked);  this.title = this.checked ? "Togli urgenza" : "Marca come urgente"; popolaTargheFiltrate();  }); 
            urgenzaCol.appendChild(urgenzaCheckbox); 
            li.appendChild(urgenzaCol); 

            const marcaCol = document.createElement('span'); marcaCol.classList.add('targa-col', 'targa-col-marca'); marcaCol.textContent = item.marca || 'N/D'; li.appendChild(marcaCol); 
            const modelloCol = document.createElement('span'); modelloCol.classList.add('targa-col', 'targa-col-modello'); modelloCol.textContent = item.modello || 'N/D'; li.appendChild(modelloCol); 
            const piazzaleCol = document.createElement('span'); piazzaleCol.classList.add('targa-col', 'targa-col-piazzale'); piazzaleCol.textContent = item.piazzale || 'N/D'; li.appendChild(piazzaleCol); 
            
            const actionsCol = document.createElement('span'); 
            actionsCol.classList.add('targa-col', 'targa-col-actions'); 
            if (!isLocallyDeletedFlag) { 
                const delB = document.createElement('button'); 
                delB.classList.add('action-button', 'delete-progress-btn'); 
                delB.dataset.targa = targaUpper;  
                delB.title = `Cancella progressi locali per ${item.targa} e gestisci marcatura per cancellazione da Sheets`; 
                delB.textContent = 'X'; 

                delB.addEventListener('click', function(event) { 
                    event.stopPropagation(); 
                    const tDelUpper = this.dataset.targa; 
                    clearLocalDataForTarga(tDelUpper); 
                    if (confirm(`I dati locali e le foto per la targa ${item.targa} sono stati cancellati.\n\nVuoi anche marcarla per la cancellazione da Google Sheets alla prossima sincronizzazione?`)) {
                        try {
                            localStorage.setItem(`${APP_PREFIX}deleted_${tDelUpper}`, new Date().toISOString());
                            console.log(`Targa ${tDelUpper} contrassegnata per la cancellazione da Sheets.`);
                        } catch (e) {
                            console.error(`Errore nel marcare ${tDelUpper} come cancellata per Sheets:`, e);
                            alert(`Errore nel marcare ${tDelUpper} per la cancellazione da Sheets.`);
                        }
                    } else {
                        // console.log(`L'utente ha scelto di non marcare ${tDelUpper} per la cancellazione da Sheets.`);
                    }
                    if (typeof popolaTargheFiltrate === 'function') {
                        popolaTargheFiltrate();
                    }
                    if (targaSelezionataGlobalmente && targaSelezionataGlobalmente.toUpperCase() === tDelUpper) {
                        targaSelezionataGlobalmente = null;
                        showView('landing');
                    }
                }); 
                actionsCol.appendChild(delB); 
            } else {
                actionsCol.textContent = 'DEL'; 
                actionsCol.title = 'Marcata per cancellazione da Sheets';
            }
            li.appendChild(actionsCol); 
            tEl.appendChild(li); 
        });
        if(targheLoadingStatus) targheLoadingStatus.textContent = "Clicca su una targa per iniziare la perizia:";
    }

    async function caricaEPopolaTarghe() { 
        if (targheLoadingStatus) targheLoadingStatus.textContent = "Caricamento dati dal server..."; 
        try { 
            const r = await fetch(GOOGLE_SHEET_CSV_URL + `&nocache=${new Date().getTime()}`); 
            if (!r.ok) { 
                let e = `HTTP ${r.status}.`; 
                if (r.status === 0) e = "Errore di rete o CORS."; 
                else if (r.status === 404) e = "File CSV non trovato (404)."; 
                else if (r.status === 403) e = "Accesso al file CSV negato (403)."; 
                throw new Error(e); 
            } 
            const csv = await r.text(); 
            const lines = csv.split(/\r\n|\n|\r/).filter(l => l.trim() !== ''); 
            if (lines.length === 0) { 
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessun dato nel file CSV."; 
                listaTargheCompleta = []; 
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>'; 
                if (targaListContainer) targaListContainer.innerHTML = ''; 
                return; 
            } 
            listaTargheCompleta = lines.map(l => { 
                const p = l.split(','); 
                return {  
                    targa: (p[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(), 
                    marca: (p[1] || '').trim().replace(/^"|"$/g, ''), 
                    modello: (p[2] || '').trim().replace(/^"|"$/g, ''), 
                    piazzale: (p[3] || '').trim().replace(/^"|"$/g, '') 
                }; 
            }).filter(i => i.targa && i.targa.length > 3);  
            if (listaTargheCompleta.length === 0) { 
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessuna targa valida trovata nel file CSV.";  
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>'; 
                if (targaListContainer) targaListContainer.innerHTML = ''; 
                return; 
            } 
            setupSheetFilterDropdown(); 
            popolaTargheFiltrate(); 
        } catch (e) { 
            console.error("Errore caricamento/popolamento targhe:", e); 
            if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore caricamento: ${e.message}. Riprova.`; 
            if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>'; 
            if (targaListContainer) targaListContainer.innerHTML = '';  
            listaTargheCompleta = []; 
        } 
    }
    function initSequentialAnimation() { const checklistContainerDiv = document.getElementById('checklistContainer'); if (!checklistContainerDiv || checklistContainerDiv.style.display === 'none') return; const activeSection = checklistContainerDiv.querySelector('.category-section.active'); if (!activeSection) return; activeSection.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me')); const allVisibleElementsInSection = Array.from( activeSection.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled), textarea:not(:disabled)') ).filter(el => { let current = el; while (current && current !== activeSection.parentElement) {  if (getComputedStyle(current).display === 'none' || getComputedStyle(current).visibility === 'hidden') return false; current = current.parentElement; } return el.offsetParent !== null;  }); const startIndex = allVisibleElementsInSection.findIndex(el => isInputDefault(el)); if (startIndex === -1 && allVisibleElementsInSection.length > 0) {  return; } if (allVisibleElementsInSection.length === 0) {   return; } const elementsToAnimate = allVisibleElementsInSection.slice(startIndex >= 0 ? startIndex : 0); if (elementsToAnimate.length === 0) return; let currentIndex = 0; let activeListeners = [];  function clearAllActiveAnimationListeners() { activeListeners.forEach(({element, type, handler}) => { element.removeEventListener(type, handler); element.classList.remove('animate-me');  }); activeListeners = []; } clearAllActiveAnimationListeners(); function animateNextElement() { if (currentIndex >= elementsToAnimate.length) { clearAllActiveAnimationListeners(); return; } const currentElement = elementsToAnimate[currentIndex]; if (!isInputDefault(currentElement)) {  currentIndex++; animateNextElement(); return; } currentElement.classList.add('animate-me'); currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); const onValueChange = (event) => { let processChange = false; if (event.type === 'change') { processChange = true; } else if (event.type === 'blur' && currentElement.tagName !== 'SELECT') {  processChange = true; }  if (processChange && !isInputDefault(currentElement)) {  currentElement.classList.remove('animate-me'); activeListeners = activeListeners.filter(listener => { if (listener.element === currentElement) { listener.element.removeEventListener(listener.type, listener.handler); return false;  } return true;  }); currentIndex++; setTimeout(animateNextElement, 50);  } }; currentElement.addEventListener('change', onValueChange); activeListeners.push({element: currentElement, type: 'change', handler: onValueChange}); if (currentElement.tagName === 'TEXTAREA' || currentElement.type === 'text') { currentElement.addEventListener('blur', onValueChange);  activeListeners.push({element: currentElement, type: 'blur', handler: onValueChange}); } } animateNextElement(); }

    function showSection(targetId) {
        document.querySelectorAll('#checklistContainer .animate-me').forEach(el => {
            el.classList.remove('animate-me');
        });
        sections.forEach(s => s.classList.toggle('active', s.id === targetId + 'Section'));
        navButtons.forEach(b => { 
            b.classList.toggle('active', b.dataset.target === targetId);
        });
        updateNavButtonColors(); 
        if (checklistContainer.style.display === 'block') { 
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex';
            populateTargaSwitcherDropdown(); 
            updateTargaDetailsDisplay(targaSelezionataGlobalmente); 
            localStorage.setItem(LAST_ACTIVE_PERIZIA_PAGE_KEY, targetId);
        } else {
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'block';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
        }
        const targetSectionElement = document.getElementById(targetId + 'Section');
        if (targetSectionElement && Array.from(sections).includes(targetSectionElement) && targetId !== 'riepilogo') {
             setTimeout(initSequentialAnimation, 100); 
        } else if (targetId === 'riepilogo') {
            generateSummary();
        }
         window.scrollTo(0, 0); 
    }

    function getSelectText(selectElementOrId) { const el = typeof selectElementOrId === 'string' ? document.getElementById(selectElementOrId) : selectElementOrId; if (el && el.tagName === 'SELECT' && el.value !== "") { if (el.selectedIndex >= 0 && el.options[el.selectedIndex]) { return el.options[el.selectedIndex].text; } return el.value;  } return "N/S";  }
    
    // MODIFICA QUI: Aggiornata la funzione generateSummary
    function generateSummary() { 
        summaryContent.innerHTML = ''; 
        let targa = targaSelezionataGlobalmente || "N/D"; 
        
        function createSummaryItem(label, value, isAnomaly = false) { 
            const itemDiv = document.createElement('div'); 
            itemDiv.classList.add('summary-item'); 
            if (isAnomaly) itemDiv.classList.add('summary-anomaly'); 
            itemDiv.innerHTML = `<strong>${label}:</strong> ${value}`; 
            return itemDiv; 
        } 
        summaryContent.appendChild(createSummaryItem("Targa", targa.toUpperCase())); 
        if (targaSelezionataGlobalmente) { 
            const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente); 
            let marcaVeicolo = "N/D", modelloVeicolo = "N/D"; 
            if (veicoloAttuale) { 
                marcaVeicolo = veicoloAttuale.marca || "N/D"; 
                modelloVeicolo = veicoloAttuale.modello || "N/D"; 
            } 
            summaryContent.appendChild(createSummaryItem("Marca", marcaVeicolo)); 
            summaryContent.appendChild(createSummaryItem("Modello", modelloVeicolo)); 
            summaryContent.appendChild(createSummaryItem("Posizione", loadPosizioneForTarga(targaSelezionataGlobalmente) || "N/D")); 
            const isUrgentForSummary = loadUrgentStatusForTarga(targaSelezionataGlobalmente); 
            summaryContent.appendChild(createSummaryItem("Urgente", isUrgentForSummary ? "Sì" : "No", isUrgentForSummary)); 
        } else {  
            summaryContent.appendChild(createSummaryItem("Marca", "N/D")); 
            summaryContent.appendChild(createSummaryItem("Modello", "N/D")); 
            summaryContent.appendChild(createSummaryItem("Posizione", "N/D")); 
            summaryContent.appendChild(createSummaryItem("Urgente", "N/D")); 
        } 
        summaryContent.innerHTML += `<h3>Remarketing:</h3>`; 
        const tipoTrazioneValue = tipoTrazioneSelect ? tipoTrazioneSelect.value : ""; 
        const isEV = tipoTrazioneValue === 'elettrico'; 
        summaryContent.appendChild(createSummaryItem("Trazione Veicolo", getSelectText(tipoTrazioneSelect))); 
        let equipaggiamento = getSelectText('tipo_equipaggiamento'), presenzaEquip = getSelectText('equipaggiamento_presenza'); 
        let equipAnomalia = (equipaggiamento !== "N/S" && equipaggiamento !== "" && equipaggiamento !== "Seleziona..." && presenzaEquip === "Mancante"); 
        summaryContent.appendChild(createSummaryItem("Equip. Vano Carico", equipaggiamento, equipAnomalia && presenzaEquip === "Mancante")); 
        summaryContent.appendChild(createSummaryItem("Presenza Equip.", presenzaEquip, equipAnomalia)); 
        let kmStato = getSelectText('stato_chilometri'); 
        summaryContent.appendChild(createSummaryItem("Stato Chilometri", kmStato, kmStato === "Non rilevabili")); 
        let cdcStato = getSelectText('stato_cdc'); 
        summaryContent.appendChild(createSummaryItem("Stato CDC", cdcStato, cdcStato === "Mancante")); 
        summaryContent.appendChild(createSummaryItem("Chiave con Telecomando", getSelectText('chiave_telecomando'), getSelectText('chiave_telecomando') === "Non Presente")); 
        summaryContent.appendChild(createSummaryItem("Seconda Chiave", getSelectText('seconda_chiave'), getSelectText('seconda_chiave') === "Non Presente")); 
        if (isEV) { 
            summaryContent.innerHTML += `<h4>Dotazioni Veicolo Elettrico:</h4>`; 
            let cavoRapidaText = getSelectText('cavo_ricarica_rapida'); 
            let cavoDomesticaText = getSelectText('cavo_ricarica_domestica'); 
            summaryContent.appendChild(createSummaryItem("Cavo Ricarica Rapida", cavoRapidaText, cavoRapidaText === "Non Presente")); 
            summaryContent.appendChild(createSummaryItem("Cavo Ricarica Domestica", cavoDomesticaText, cavoDomesticaText === "Non Presente")); 
        } 
        summaryContent.innerHTML += `<h3>Pneumatici:</h3>`; 
        const pneumaticiFields = [ 
            { id: 'pneumatico_as', label: 'Ant. Sinistro' }, 
            { id: 'pneumatico_ad', label: 'Ant. Destro' }, 
            { id: 'pneumatico_pd', label: 'Post. Destro' }, 
            { id: 'pneumatico_ps', label: 'Post. Sinistro' }
        ]; 
        pneumaticiFields.forEach(pneu => { 
            summaryContent.appendChild(createSummaryItem(pneu.label, getSelectText(pneu.id), getSelectText(pneu.id) === "Non conforme")); 
        }); 
        summaryContent.innerHTML += `<h3>Danni/Verifiche:</h3>`; 
        summaryContent.appendChild(createSummaryItem("Motore si Accende", getSelectText('motore_accende'), getSelectText('motore_accende') === 'Non OK')); 
        summaryContent.appendChild(createSummaryItem("Stato Batteria", getSelectText('batteria_stato'), getSelectText('batteria_stato') === 'Non OK')); 
        const noteDanniValue = document.getElementById('note_danni_verifiche') ? document.getElementById('note_danni_verifiche').value.trim() : ""; 
        if (noteDanniValue) { 
            const noteDiv = document.createElement('div'); 
            noteDiv.classList.add('summary-item', 'summary-notes'); 
            const strongNode = document.createElement('strong'); 
            strongNode.textContent = "Note Danni/Verifiche: "; 
            const contentDiv = document.createElement('div'); 
            contentDiv.style.whiteSpace = 'pre-wrap'; 
            contentDiv.style.paddingLeft = '10px'; 
            contentDiv.textContent = noteDanniValue; 
            noteDiv.appendChild(strongNode); 
            noteDiv.appendChild(contentDiv); 
            summaryContent.appendChild(noteDiv); 
        }

        // LOGICA PER IL PULSANTE SCARICA FOTO
        if (targaSelezionataGlobalmente && downloadPhotosBtn) {
            const targaCompleted = isTargaCompleted(targaSelezionataGlobalmente);
            if (targaCompleted) {
                downloadPhotosBtn.href = `http://192.168.1.154:8080/${targaSelezionataGlobalmente.toUpperCase()}.zip`;
                downloadPhotosBtn.style.display = 'inline-block'; // Mostra il pulsante
                downloadPhotosBtn.removeAttribute('disabled');
                downloadPhotosBtn.style.opacity = '1';
                downloadPhotosBtn.style.cursor = 'pointer';
                downloadPhotosBtn.title = `Scarica ZIP foto per ${targaSelezionataGlobalmente.toUpperCase()}`;
            } else {
                downloadPhotosBtn.style.display = 'inline-block'; // Mostra comunque il pulsante ma disabilitato
                downloadPhotosBtn.href = '#'; // Link non attivo
                downloadPhotosBtn.setAttribute('disabled', 'disabled');
                downloadPhotosBtn.style.opacity = '0.5';
                downloadPhotosBtn.style.cursor = 'not-allowed';
                downloadPhotosBtn.title = `La perizia per ${targaSelezionataGlobalmente.toUpperCase()} deve essere conclusa per scaricare le foto.`;
            }
        } else if (downloadPhotosBtn) {
            downloadPhotosBtn.style.display = 'none'; // Nascondi se nessuna targa selezionata
        }
    }
    // FINE MODIFICA
    
    async function fetchAllDataFromSheets() { 
        if (!GOOGLE_SHEET_WEB_APP_URL) { console.error("URL della Web App Google Sheets non configurato per il fetch di tutti i dati."); return { success: false, message: "URL Web App non configurato.", data: [] }; } 
        const fetchUrl = `${GOOGLE_SHEET_WEB_APP_URL}?nocache=${new Date().getTime()}`;  
        // console.log("Fetching all perizie from Sheets. URL:", fetchUrl); 
        try { 
            const response = await fetch(fetchUrl, { method: 'GET', mode: 'cors' }); 
            if (!response.ok) { 
                const errorText = await response.text(); 
                console.error(`Errore HTTP ${response.status} nel fetch di tutti i dati da Sheets: ${errorText}`); 
                return { success: false, message: `Errore Sheets (${response.status}) nel recupero globale.`, data: [] }; 
            } 
            const contentType = response.headers.get("content-type"); 
            if (contentType && contentType.indexOf("application/json") !== -1) { 
                const result = await response.json(); 
                if (Array.isArray(result)) {  
                    // console.log("Dati globali ricevuti da Sheets (array diretto):", result.length, "perizie."); 
                    return { success: true, data: result, message: "Dati recuperati con successo." }; 
                } else if (result && result.status === "success" && Array.isArray(result.data)) {  
                    // console.log("Dati globali ricevuti da Sheets (oggetto con .data):", result.data.length, "perizie."); 
                    return { success: true, data: result.data, message: result.message || "Dati recuperati con successo."}; 
                } else if (result && result.status === "notfound") {   
                    // console.log("Nessuna perizia trovata in Sheets (notfound).");  
                    return { success: true, data: [], message: result.message || "Nessuna perizia trovata."}; 
                } else { 
                    console.warn("Risposta da Sheets (globale) non era un array o oggetto atteso:", result); 
                    return { success: false, message: "Formato risposta globale non valido.", data: [] }; 
                } 
            } else { 
                const textResponse = await response.text(); 
                console.error("Risposta da Sheets (globale) non era JSON:", textResponse); 
                return { success: false, message: "Errore formato risposta globale Sheets (non JSON).", data: [] }; 
            } 
        } catch (error) { 
            console.error("Errore di rete o fetch generico durante il recupero globale da Sheets:", error); 
            return { success: false, message: "Errore di rete recupero globale: " + error.message, data: [] }; 
        } 
    }

    async function syncAllLocalDataToSheets() {
        const originalSyncButtonText = syncToSheetsBtn.textContent;
        syncToSheetsBtn.disabled = true;
        let updatedFromSheetsCount = 0;
        let localUpdatesFailedCount = 0;
        let sheetsDeletionsSuccessCount = 0;
        let sheetsDeletionsFailedCount = 0;
        let localToSheetsSuccessCount = 0;
        let localToSheetsErrorCount = 0;
        let errorMessages = [];

        syncToSheetsBtn.textContent = "Sinc (0/4 DelSheets)...";
        // console.log("SYNC - Fase 0: Processo cancellazioni per Google Sheets.");
        let deletionRequests = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}deleted_`)) {
                const targaToDelete = key.substring(`${APP_PREFIX}deleted_`.length);
                deletionRequests.push(targaToDelete);
            }
        }
        if (deletionRequests.length > 0) {
            for (const targa of deletionRequests) {
                // console.log(`SYNC - Tentativo di cancellazione targa ${targa} da Sheets...`);
                const deleteUrl = `${GOOGLE_SHEET_WEB_APP_URL}?action=deletePerizia&targa=${encodeURIComponent(targa)}`;
                try {
                    const response = await fetch(deleteUrl, { method: 'POST', mode: 'cors', body: JSON.stringify({targa: targa})}); 
                    const result = await response.json();
                    if (response.ok && result.status === "success") {
                        // console.log(`SYNC - Targa ${targa} cancellata con successo da Sheets.`);
                        localStorage.removeItem(`${APP_PREFIX}deleted_${targa}`); 
                        sheetsDeletionsSuccessCount++;
                    } else {
                        console.error(`SYNC - Errore cancellazione targa ${targa} da Sheets:`, result.message || response.statusText);
                        sheetsDeletionsFailedCount++;
                        errorMessages.push(`Targa ${targa} (Cancellazione Sheets): ${result.message || 'Errore sconosciuto'}`);
                    }
                } catch (error) {
                    console.error(`SYNC - Errore di rete durante cancellazione targa ${targa} da Sheets:`, error);
                    sheetsDeletionsFailedCount++;
                    errorMessages.push(`Targa ${targa} (Cancellazione Sheets): Errore di rete - ${error.message}`);
                }
            }
        }
        // console.log(`SYNC - Fase 0 completata. Cancellazioni Sheets: ${sheetsDeletionsSuccessCount} successi, ${sheetsDeletionsFailedCount} fallimenti.`);

        syncToSheetsBtn.textContent = "Sinc (1/4 RecSheets)...";
        // console.log("SYNC - Fase 1: Recupero di tutti i dati da Google Sheets.");
        const sheetsResponse = await fetchAllDataFromSheets();
        if (!sheetsResponse.success) {
            alert(`Errore nel recupero dei dati da Sheets:\n${sheetsResponse.message}\nLa sincronizzazione potrebbe essere incompleta.`);
        }
        const allSheetsData = sheetsResponse.data || []; 
        // console.log(`SYNC - Fase 1 completata. Ricevute ${allSheetsData.length} perizie da Sheets.`);

        syncToSheetsBtn.textContent = "Sinc (2/4 AggLoc)...";
        // console.log("SYNC - Fase 2: Confronto dati Sheets con localStorage e aggiornamento locale.");
        if (allSheetsData.length > 0) {
            for (const sheetPerizia of allSheetsData) {
                if (!sheetPerizia || !sheetPerizia.targa || !sheetPerizia.timestamp || !sheetPerizia.datiPerizia || !sheetPerizia.datiPerizia.timestamp) {
                    console.warn("SYNC - Saltata perizia da Sheets per dati/timestamp mancanti:", sheetPerizia);
                    continue;
                }
                const targa = sheetPerizia.targa.toUpperCase();

                if (localStorage.getItem(`${APP_PREFIX}deleted_${targa}`)) {
                    // console.log(`SYNC - Targa ${targa} è marcata per la cancellazione localmente. Non verrà aggiornata da Sheets.`);
                    continue; 
                }

                const localDataKey = `${APP_PREFIX}data_${targa}`;
                const localDataJSON = localStorage.getItem(localDataKey);
                let localDatiPeriziaTimestamp = null;
                if (localDataJSON) {
                    try {
                        const localDatiPeriziaObject = JSON.parse(localDataJSON);
                        localDatiPeriziaTimestamp = localDatiPeriziaObject.timestamp ? new Date(localDatiPeriziaObject.timestamp) : null;
                    } catch (e) { console.error(`SYNC - Errore parsing dati locali per targa ${targa}:`, e); }
                } 
                const sheetsRecordTimestamp = new Date(sheetPerizia.timestamp); 
                
                if (!localDatiPeriziaTimestamp || sheetsRecordTimestamp > localDatiPeriziaTimestamp) {
                    // console.log(`SYNC - Targa ${targa}: Dati Sheets più recenti (Sheets Record TS: ${sheetsRecordTimestamp}, Locale datiPerizia TS: ${localDatiPeriziaTimestamp || 'N/A'}). Aggiorno localStorage.`);
                    try {
                        localStorage.setItem(localDataKey, JSON.stringify(sheetPerizia.datiPerizia)); 
                        if (sheetPerizia.hasOwnProperty('posizione')) { savePosizioneForTarga(targa, sheetPerizia.posizione); }
                        if (sheetPerizia.hasOwnProperty('urgente')) { saveUrgentStatusForTarga(targa, sheetPerizia.urgente); }
                        if (sheetPerizia.hasOwnProperty('completata')) {
                            if (sheetPerizia.completata) { markTargaAsCompleted(targa); } else { unmarkTargaAsCompleted(targa); }
                        }
                        updatedFromSheetsCount++;
                    } catch (e) {
                        console.error(`SYNC - Errore aggiornamento localStorage per targa ${targa} da Sheets:`, e);
                        localUpdatesFailedCount++;
                    }
                } else {
                    // console.log(`SYNC - Targa ${targa}: Dati locali più recenti o uguali. Nessun aggiornamento da Sheets.`);
                }
            }
        }
        // console.log(`SYNC - Fase 2 completata. Aggiornate/Create localmente ${updatedFromSheetsCount} perizie da Sheets. Errori locali: ${localUpdatesFailedCount}`);

        syncToSheetsBtn.textContent = "Sinc (3/4 InvioSheets)...";
        // console.log("SYNC - Fase 3: Invio delle perizie locali a Google Sheets.");
        let perizieLocaliKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}data_`)) {
                 const targaFromKey = key.substring(`${APP_PREFIX}data_`.length);
                 if (!localStorage.getItem(`${APP_PREFIX}deleted_${targaFromKey}`)) {
                    perizieLocaliKeys.push(key);
                 } else {
                    // console.log(`SYNC - Targa ${targaFromKey} marcata per cancellazione, non verrà inviata a Sheets.`);
                 }
            }
        }

        if (perizieLocaliKeys.length === 0 && updatedFromSheetsCount === 0 && localUpdatesFailedCount === 0 && deletionRequests.length === 0) {
            alert("Nessuna operazione di sincronizzazione da eseguire (nessuna perizia locale, nessuna novità da Sheets, nessuna cancellazione in sospeso).");
            syncToSheetsBtn.textContent = originalSyncButtonText; 
            syncToSheetsBtn.disabled = false;
            return;
        }

        for (const key of perizieLocaliKeys) {
            const targa = key.substring(`${APP_PREFIX}data_`.length); 
            let datiPeriziaSalvatiLocalmente; 
            try {
                datiPeriziaSalvatiLocalmente = JSON.parse(localStorage.getItem(key));
            } catch (e) {
                console.error(`SYNC - Errore parsing dati per targa ${targa} da localStorage per invio:`, e);
                localToSheetsErrorCount++;
                errorMessages.push(`Targa ${targa} (Invio Sheets): Errore lettura dati locali.`);
                continue;
            }
            if (!datiPeriziaSalvatiLocalmente || !datiPeriziaSalvatiLocalmente.timestamp) { 
                console.warn(`SYNC - Dati per targa ${targa} incompleti o senza timestamp (locale), skip invio a Sheets.`); 
                localToSheetsErrorCount++; 
                errorMessages.push(`Targa ${targa} (Invio Sheets): Dati locali incompleti o timestamp mancante.`); 
                continue;
            }
            const periziaDaInviare = {
                targa: targa,
                posizione: loadPosizioneForTarga(targa) || "",
                urgente: loadUrgentStatusForTarga(targa) || false,
                completata: isTargaCompleted(targa),
                datiPerizia: datiPeriziaSalvatiLocalmente, 
                timestamp: datiPeriziaSalvatiLocalmente.timestamp 
            };
            // console.log(`SYNC - Invio targa ${targa} a Sheets...`);
            const result = await inviaPeriziaSingolaASheets(periziaDaInviare);
            if (result.success) {
                localToSheetsSuccessCount++;
                if (result.data && result.data.timestamp && new Date(result.data.timestamp) > new Date(datiPeriziaSalvatiLocalmente.timestamp)) {
                    // console.log(`SYNC - Timestamp per ${targa} su Sheets (${result.data.timestamp}) è più recente del timestamp dei datiPerizia locali (${datiPeriziaSalvatiLocalmente.timestamp}). Aggiorno timestamp locale.`);
                    datiPeriziaSalvatiLocalmente.timestamp = result.data.timestamp; 
                    try { localStorage.setItem(key, JSON.stringify(datiPeriziaSalvatiLocalmente)); } catch (e) { console.error(`SYNC - Errore salvataggio timestamp aggiornato da server per ${targa}:`,e); }
                }
            } else {
                localToSheetsErrorCount++;
                errorMessages.push(`Targa ${targa} (Invio Sheets): ${result.message || 'Errore sconosciuto'}`);
            }
        }
        // console.log("SYNC - Fase 3 completata.");

        syncToSheetsBtn.textContent = "Sinc (4/4 Fine)";
        let finalMessage = `Sincronizzazione completata.\n\n`;
        finalMessage += `CANCELLAZIONI (Locale -> Sheets):\n`;
        finalMessage += `- ${sheetsDeletionsSuccessCount} perizie cancellate da Sheets.\n`;
        if (sheetsDeletionsFailedCount > 0) finalMessage += `- ${sheetsDeletionsFailedCount} errori durante la cancellazione da Sheets.\n`;

        finalMessage += `\nAGGIORNAMENTI (Sheets -> Locale):\n`;
        finalMessage += `- ${updatedFromSheetsCount} perizie locali aggiornate/create da Sheets.\n`;
        if (localUpdatesFailedCount > 0) finalMessage += `- Errori durante aggiornamento locale: ${localUpdatesFailedCount}.\n`; 

        finalMessage += `\nINVIO DATI (Locale -> Sheets):\n`;
        finalMessage += `- ${localToSheetsSuccessCount} perizie inviate/aggiornate con successo su Sheets.\n`;
        if (localToSheetsErrorCount > 0) finalMessage += `- ${localToSheetsErrorCount} perizie con errori durante l'invio.\n`;
        
        if (errorMessages.length > 0) {
            finalMessage += "\n\nDETTAGLIO ERRORI (controllare console per info complete):\n" + errorMessages.join("\n");
        }
        alert(finalMessage);
        syncToSheetsBtn.textContent = originalSyncButtonText; 
        syncToSheetsBtn.disabled = false;
        if (typeof popolaTargheFiltrate === 'function' && landingPageSection.style.display === 'block') { 
            popolaTargheFiltrate(); 
        }
         if (typeof populateSavedTargasList === 'function' && historyPageSection.style.display === 'block') {
            populateSavedTargasList();
        }
    }

    function triggerMainExit() {
        if (mainExitAppBtn) {
            mainExitAppBtn.click();
        } else {
            console.error("Pulsante di uscita principale non trovato.");
        }
    }

    function handleTouchStart(event) {
        if (imageLightbox && imageLightbox.style.display === 'flex') return;
        const targetElement = event.target;
        if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA' || targetElement.closest('.action-button') || targetElement.closest('.circle-button')) {
            return;
        }
        
        if (checklistContainer.style.display === 'block' || (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter)) {
             touchstartX = event.changedTouches[0].screenX;
        }
    }

    function handleTouchEnd(event) {
        if (imageLightbox && imageLightbox.style.display === 'flex') return;
        const targetElement = event.target;
         if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA' || targetElement.closest('.action-button') || targetElement.closest('.circle-button')) {
            return;
        }

        if (checklistContainer.style.display === 'block' || (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter)) {
            touchendX = event.changedTouches[0].screenX;
            handleSwipeGesture();
        }
    }

    async function handleSwipeGesture() {
        const deltaX = touchendX - touchstartX;
        if (Math.abs(deltaX) < swipeThreshold) {
            return; 
        }

        if (checklistContainer.style.display === 'block') {
            const activeSectionElement = checklistContainer.querySelector('.category-section.active');
            if (!activeSectionElement) return;
            const currentSectionId = activeSectionElement.id.replace('Section', '');
            const currentIndex = sectionOrder.indexOf(currentSectionId);
            if (currentIndex === -1) return;

            if (deltaX > 0 && currentIndex > 0) { 
                showSection(sectionOrder[currentIndex - 1]);
            } else if (deltaX < 0 && currentIndex < sectionOrder.length - 1) { 
                showSection(sectionOrder[currentIndex + 1]);
            }
        } else if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter) {
            let currentGallerySectionId = currentGallerySectionFilter || 'riepilogo'; 
            const currentIndex = sectionOrder.indexOf(currentGallerySectionId);
            if (currentIndex === -1) { // Se la sezione corrente non è in sectionOrder (es. una sezione custom), non fare nulla
                console.warn("Sezione galleria corrente non trovata in sectionOrder per swipe:", currentGallerySectionId);
                return;
            }

            if (deltaX > 0 && currentIndex > 0) { 
                await showGalleryPage(currentGalleryTargaFilter, sectionOrder[currentIndex - 1]);
            } else if (deltaX < 0 && currentIndex < sectionOrder.length - 1) { 
                await showGalleryPage(currentGalleryTargaFilter, sectionOrder[currentIndex + 1]);
            }
        }
    }

    async function initializeApplicationViewAndLoadData() {
        const preloader = document.getElementById('preloader');
        
        if (preloader) {
            preloader.style.display = 'flex';
            preloader.classList.remove('hidden');
            preloader.style.opacity = '1';
            preloader.style.visibility = 'visible';
            const loadingText = preloader.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = 'CARICAMENTO ELENCO TARGHE...';
        }
        
        try {
            await openPhotoDB(); 
            console.log("IndexedDB inizializzato o già pronto.");
        } catch (error) {
            console.error("Errore critico inizializzazione IndexedDB:", error);
            if (preloader) {
                const loadingText = preloader.querySelector('.loading-text');
                if (loadingText) loadingText.textContent = 'ERRORE DATABASE FOTO!';
            }
            alert("Errore critico nell'inizializzazione del database delle foto. L'app potrebbe non funzionare correttamente.");
            return; 
        }


        await caricaEPopolaTarghe(); 

        if (preloader) {
            preloader.classList.add('hidden');
            setTimeout(() => { if (preloader) preloader.style.display = 'none'; }, 700);
        }
        
        showView('landing'); 

        if (changelogModal && closeChangelogBtnModal && changelogList && changelogTitle) {
            const lastVersionSeen = localStorage.getItem('appVersionSeen');
            changelogTitle.textContent = `WebApp Perizie - Novità v${currentAppVersion}`;
            changelogList.innerHTML = latestChangesText;

            if (lastVersionSeen !== currentAppVersion) {
                changelogModal.style.display = 'flex';
            }
            closeChangelogBtnModal.onclick = () => {
                changelogModal.style.display = 'none';
                localStorage.setItem('appVersionSeen', currentAppVersion);
            };
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        syncToSheetsBtn = document.createElement('button');
        syncToSheetsBtn.id = 'syncToSheetsBtn';
        syncToSheetsBtn.classList.add('action-button');
        syncToSheetsBtn.textContent = 'Sincronizza'; 
        syncToSheetsBtn.style.backgroundColor = '#ffc107'; 
        syncToSheetsBtn.style.borderColor = '#e0a800';
        syncToSheetsBtn.style.color = '#212529';
        const historyButton = document.getElementById('historyBtn'); 
        if (historyButton && historyButton.parentNode === utilityNavButtons) {
            utilityNavButtons.insertBefore(syncToSheetsBtn, historyButton.nextSibling);
        } else if (mainExitAppBtn && mainExitAppBtn.parentNode === utilityNavButtons) { 
             utilityNavButtons.insertBefore(syncToSheetsBtn, mainExitAppBtn); 
        } else if (utilityNavButtons.firstChild) {
            utilityNavButtons.insertBefore(syncToSheetsBtn, utilityNavButtons.firstChild);
        } else {
            utilityNavButtons.appendChild(syncToSheetsBtn);
        }
        syncToSheetsBtn.addEventListener('click', syncAllLocalDataToSheets);
        
        document.querySelectorAll('.fill-defaults-btn').forEach(button => {
            button.addEventListener('click', function() { 
                const sectionId = this.dataset.sectionid; 
                const sectionTarget = sectionId.replace('Section', ''); 
                if (sectionId) {
                    fillSectionPositiveOrDefaults(sectionId); 
                    if (saveProgress(targaSelezionataGlobalmente)) {
                        let currentSectionIndex = -1;
                        navButtons.forEach((nb, index) => { 
                            if (nb.dataset.target === sectionTarget) currentSectionIndex = index;
                        });
                        if (currentSectionIndex !== -1 && currentSectionIndex < navButtons.length - 1) { 
                            const nextNavButton = navButtons[currentSectionIndex + 1];
                            if (nextNavButton && nextNavButton.dataset.target) showSection(nextNavButton.dataset.target);
                        }
                    }
                }
            });
        });
        if (tipoTrazioneSelect) tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);
        
        targaSwitcherDropdown.addEventListener('change', async function() {
            const nuovaTargaSelezionata = this.value;
            if (nuovaTargaSelezionata && nuovaTargaSelezionata.toUpperCase() !== (targaSelezionataGlobalmente ? targaSelezionataGlobalmente.toUpperCase() : null)) {
                this.disabled = true;
                if (galleryPageSection.style.display === 'block') {
                    targaSelezionataGlobalmente = nuovaTargaSelezionata.toUpperCase(); 
                    await showGalleryPage(targaSelezionataGlobalmente, currentGallerySectionFilter); 
                } else {
                    let currentActiveSectionId = 'remarketing'; 
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    if (activeSectionElement && activeSectionElement.id) {
                        currentActiveSectionId = activeSectionElement.id.replace('Section', '');
                    }
                    await handleTargaSelectionAndSync(nuovaTargaSelezionata, currentActiveSectionId);
                }
                this.disabled = false;
            } else if (nuovaTargaSelezionata) {
                updateTargaDetailsDisplay(nuovaTargaSelezionata);
            }
        });

        if(backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if(historyBtn) historyBtn.addEventListener('click', () => showView('history'));
        if(clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', clearAllSavedData);
        
        if(backToMainFromGalleryBtn) {
             backToMainFromGalleryBtn.addEventListener('click', () => {
                // console.log(`Ritorno da galleria a: vista='${lastViewBeforeGallery}', sezione='${lastSectionBeforeGallery}'`);
                if (lastViewBeforeGallery === 'checklist' && currentGalleryTargaFilter && lastSectionBeforeGallery) {
                    if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) {
                         targaSelezionataGlobalmente = currentGalleryTargaFilter;
                         loadProgress(targaSelezionataGlobalmente); 
                    }
                    showView('checklist');
                    showSection(lastSectionBeforeGallery);
                } else {
                    showView('landing'); 
                }
            });
        }

        if(saveAndReturnBtn) saveAndReturnBtn.addEventListener('click', handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button=>button.addEventListener('click',handleSaveAndNext));

        if (headerExitBtn) {
            headerExitBtn.addEventListener('click', () => {
                // console.log("Header Exit button clicked");
                triggerMainExit(); 
            });
        }

        if (headerPhotosBtn) { 
            headerPhotosBtn.addEventListener('click', async () => {
                // console.log("Header Photos/Gallery button clicked");
                let targaForGallery = null;
                let sectionKeyForGallery = null; 

                if (checklistContainer.style.display === 'block' && targaSelezionataGlobalmente) {
                    targaForGallery = targaSelezionataGlobalmente;
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    if (activeSectionElement) {
                        sectionKeyForGallery = activeSectionElement.id.replace('Section', ''); 
                    }
                } 

                if (cameraPageSection.style.display === 'flex') { 
                    returnFromCamera(); 
                     setTimeout(async () => await showGalleryPage(targaForGallery, sectionKeyForGallery), 50); 
                } else {
                    await showGalleryPage(targaForGallery, sectionKeyForGallery);
                }
            });
        }

        if (headerPeriziaBtn) {
            headerPeriziaBtn.addEventListener('click', async () => {
                // console.log("Header Perizia button clicked");
                if (cameraPageSection.style.display === 'flex') { 
                    returnFromCamera(); 
                } else if (galleryPageSection.style.display === 'block') { 
                    if (currentGalleryTargaFilter && lastViewBeforeGallery === 'checklist' && lastSectionBeforeGallery) {
                        if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) {
                            targaSelezionataGlobalmente = currentGalleryTargaFilter;
                            loadProgress(targaSelezionataGlobalmente);
                        }
                        showView('checklist');
                        showSection(lastSectionBeforeGallery);
                    } else { 
                        showView('landing');
                    }
                } else if (targaSelezionataGlobalmente) { 
                    const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY);
                    const targetSection = (lastActivePage && document.getElementById(lastActivePage + 'Section')) ? lastActivePage : 'riepilogo';
                    if (checklistContainer.style.display !== 'block' || targaSwitcherDropdown.value.toUpperCase() !== targaSelezionataGlobalmente.toUpperCase()) {
                        await handleTargaSelectionAndSync(targaSelezionataGlobalmente, targetSection);
                    } else {
                        showSection(targetSection);
                    }
                } else { 
                    showView('landing');
                }
            });
        }
        
        if (headerCameraBtn) {
            headerCameraBtn.addEventListener('click', () => {
                // console.log("Header Camera button clicked");
                if (cameraPageSection.style.display === 'flex') {
                    returnFromCamera(); 
                } else {
                    showCameraPage(); 
                }
            });
        }

        if (captureBtn) captureBtn.addEventListener('click', capturePhoto);
        if (closeCameraBtn) closeCameraBtn.addEventListener('click', returnFromCamera); 

        navButtons.forEach(b => b.addEventListener('click', async function() {
            const targetId = this.dataset.target;
            if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter) {
                currentGallerySectionFilter = targetId; 
                await showGalleryPage(currentGalleryTargaFilter, currentGallerySectionFilter); 
            } else if (checklistContainer.style.display === 'block' || (!targaSelezionataGlobalmente && landingPageSection.style.display === 'block')) {
                showSection(targetId);
            } else if (!currentGalleryTargaFilter && galleryPageSection.style.display === 'block') {
                 // console.log("Click su nav button da galleria globale, azione non definita o vai a landing.");
            }
        }));

        if (closeLightboxBtnElem) {
            closeLightboxBtnElem.addEventListener('click', closeImageLightbox);
        }
        if (imageLightbox) {
            imageLightbox.addEventListener('click', function(event) {
                if (event.target === imageLightbox) { 
                    closeImageLightbox();
                }
            });
        }

        if (checklistContainer) {
            checklistContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
            checklistContainer.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        if (galleryPageSection) {
            galleryPageSection.addEventListener('touchstart', handleTouchStart, { passive: true });
            galleryPageSection.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        
        initializeApplicationViewAndLoadData(); 
        
        if (mainExitAppBtn) { 
            mainExitAppBtn.addEventListener('click', () => { 
                const exitCurtain = document.getElementById('exit-curtain'); 
                const mainContentWrapper = document.getElementById('mainContentWrapper'); 
                const pageHeader = document.getElementById('pageHeaderContainer'); 
                if (exitCurtain) { 
                    if (mainContentWrapper) mainContentWrapper.style.display = 'none'; 
                    if (pageHeader) pageHeader.style.display = 'none'; 
                    if (cameraPageSection) cameraPageSection.style.display = 'none'; 
                    if (currentCameraStream) { 
                         currentCameraStream.getTracks().forEach(track => track.stop());
                         currentCameraStream = null;
                         if(cameraStreamElement) cameraStreamElement.srcObject = null;
                    }
                    document.body.style.paddingTop = '0px'; 
                    const exitLoadingText = exitCurtain.querySelector('.loading-text'); 
                    const barContainer = exitCurtain.querySelector('.loader-bar-container'); 
                    const defaultCloseText = "CHIUSURA IN CORSO..."; 
                    const glitchText = "ERRORE DI SISTEMA..."; 
                    exitCurtain.classList.remove('glitching', 'flash-out-effect');  
                    if (exitLoadingText) { exitLoadingText.textContent = defaultCloseText; exitLoadingText.style.animation = 'textGlow 1.8s infinite alternate ease-in-out'; exitLoadingText.style.color = '#ff8787'; exitLoadingText.style.textShadow = ''; } 
                    exitCurtain.setAttribute('data-text', defaultCloseText); 
                    if (barContainer) barContainer.style.display = 'flex'; 
                    exitCurtain.classList.add('visible-no-transition'); 
                    exitCurtain.style.display = 'flex';  
                    setTimeout(() => { 
                        exitCurtain.classList.add('glitching'); 
                        if (exitLoadingText) { exitLoadingText.textContent = glitchText; exitLoadingText.style.animation = '';  } 
                        exitCurtain.setAttribute('data-text', glitchText); 
                        setTimeout(() => { 
                            exitCurtain.classList.remove('glitching'); 
                            if (exitLoadingText) { exitLoadingText.textContent = 'Applicazione terminata.'; exitLoadingText.style.animation = 'none';  exitLoadingText.style.color = '#FFFFFF';  exitLoadingText.style.textShadow = 'none'; } 
                            if (barContainer) barContainer.style.display = 'none';  
                            setTimeout(() => { 
                                exitCurtain.classList.add('flash-out-effect');  
                                setTimeout(() => { 
                                    const macrodroidUrl = 'https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi'; 
                                    fetch(macrodroidUrl, { method: 'GET', mode: 'no-cors' })  
                                    .then(response => console.log('Macrodroid trigger request sent.')) 
                                    .catch(error => console.error('Error sending Macrodroid trigger:', error)); 
                                }, 500);  
                            }, 700);  
                        }, 800);  
                    }, 800);  
                } 
            }); 
        }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
