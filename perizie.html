<script>
  // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const galleryPageSection = document.getElementById('galleryPageSection');
    const photoGridContainer = document.getElementById('photoGridContainer');
    const backToMainFromGalleryBtn = document.getElementById('backToMainFromGalleryBtn');

    const cameraPageSection = document.getElementById('cameraPageSection');
    const cameraStreamElement = document.getElementById('cameraStream');
    const freezeFrameDisplayElement = document.getElementById('freezeFrameDisplay');
    const captureBtn = document.getElementById('captureBtn');
    const closeCameraBtn = document.getElementById('closeCameraBtn');
    let currentCameraStream = null;
    let lastViewBeforeCamera = 'landing'; // Default
    let lastSectionBeforeCamera = null; // Default

    const bottomNavCircles = document.getElementById('bottomNavCircles'); // New global for bottom bar

    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer'); // This is the TOP bar container
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const targaDropdownContainer = document.getElementById('targaDropdownContainer');
    const targaSwitcherDropdown = document.getElementById('targaSwitcherDropdown');
    const targaDetailsDisplay = document.getElementById('targaDetailsDisplay');

    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons');
    const mainPageNavButtons = navButtonsContainer.querySelector('#mainPageNavButtons');
    const utilityNavButtons = pageHeaderContainer.querySelector('#utilityNavButtons');

    const navButtons = mainPageNavButtons.querySelectorAll('button[data-target]');

    const backToListBtn = utilityNavButtons.querySelector('#backToListBtn');
    const historyBtn = utilityNavButtons.querySelector('#historyBtn');
    const mainExitAppBtn = utilityNavButtons.querySelector('#exitAppBtn');
    let syncToSheetsBtn;

    const headerExitBtn = document.getElementById('headerExitBtn');
    const headerPhotosBtn = document.getElementById('headerPhotosBtn');
    const headerPeriziaBtn = document.getElementById('headerPeriziaBtn');
    const headerCameraBtn = document.getElementById('headerCameraBtn');

    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn');
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn');
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn');
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
    const tipoTrazioneSelect = document.getElementById('tipo_trazione');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');

    const imageLightbox = document.getElementById('imageLightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const closeLightboxBtnElem = document.getElementById('closeLightboxBtn');
    let currentLightboxImageObjectUrl = null;
    let currentLightboxPhotoList = [];
    let currentLightboxPhotoIndex = -1;

    const downloadZipBtn = document.getElementById('downloadZipBtn');

    // >>> DICHIARAZIONE VARIABILE BLUETOOTH HANDLER <<<
    let bluetoothShutterHandler = null;


    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzN4bBhPi4d8i7fSpJQqCJ2CQYOtmes1yKeGeqVe053K4QkdKYH4PuQIughn_9YLEfCkA/exec';

    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';
    const LAST_ACTIVE_PERIZIA_PAGE_KEY = `${APP_PREFIX}lastActivePeriziaPage`;

    const currentAppVersion = "1.6.4";
    const changelogModal = document.getElementById('changelogModal');
    const closeChangelogBtnModal = document.getElementById('closeChangelogBtnModal');
    const changelogList = document.getElementById('changelogList');
    const changelogTitle = document.getElementById('changelogTitle');

    const latestChangesText = `
        <li><strong>Nuovi Pulsanti Azione Pagina:</strong>
            <ul>
                <li>Aggiunto pulsante "Azzera Campi" (<i class="fas fa-undo"></i>) per le sezioni Remarketing, Pneumatici e Danni/Verifiche.</li>
                <li>I pulsanti "Azzera" e "Compila Default" sono ora affiancati in alto a destra di ogni sezione operativa.</li>
            </ul>
        </li>
        <li><strong>Download Perizia ZIP:</strong>
            <ul>
                <li>Aggiunto pulsante "Download ZIP" (<i class="fas fa-file-archive"></i>) nella sezione Riepilogo, a destra del titolo.</li>
                <li>Il link punta a <code>https://192.168.1.154:8080/TARGA.zip</code>, sostituendo TARGA con la targa attiva.</li>
                <li>Il pulsante è visibile solo quando una targa è selezionata e si è nella sezione Riepilogo.</li>
            </ul>
        </li>
        <li>Miglioramenti Interfaccia Fotocamera e Navigazione Foto (come da v1.6.3).</li>
    `;


    let touchstartX = 0, touchstartY = 0;
    let touchendX = 0, touchendY = 0;
    const swipeThreshold = 50;
    const sectionOrder = ['remarketing', 'pneumatici', 'danniVerifiche', 'riepilogo'];

    let currentGalleryTargaFilter = null;
    let currentGallerySectionFilter = null;
    let lastViewBeforeGallery = 'landing';
    let lastSectionBeforeGallery = null;

    let lightboxTouchStartX = 0;
    let lightboxTouchStartY = 0;

    let galleryGridTouchStartY = 0;


    const IDB_NAME = 'PeriziePhotoDB_v1';
    const IDB_VERSION = 1;
    const PHOTO_STORE_NAME = 'capturedPhotosStore';
    let dbPromise = null;

    function openPhotoDB() {
        if (dbPromise) return dbPromise;

        dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(IDB_NAME, IDB_VERSION);

            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(PHOTO_STORE_NAME)) {
                    const store = db.createObjectStore(PHOTO_STORE_NAME, { keyPath: 'timestamp' });
                    store.createIndex('targaIdx', 'targa', { unique: false });
                    store.createIndex('sezioneIdx', 'sezione', { unique: false });
                    store.createIndex('targaSezioneIdx', ['targa', 'sezione'], { unique: false });
                }
            };

            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => {
                console.error("Errore apertura IndexedDB:", event.target.error);
                dbPromise = null;
                reject(event.target.error);
            };
        });
        return dbPromise;
    }

    async function savePhotoToDB(photoData) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.put(photoData);
            request.onsuccess = () => resolve();
            request.onerror = (event) => {
                console.error('Errore salvataggio foto in IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    async function getAllPhotosFromDB() {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => resolve(event.target.result || []);
            request.onerror = (event) => {
                console.error('Errore recupero tutte le foto da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    async function getPhotosByTargaAndSezioneFromDB(targaFilter, sectionKeyFilter) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            let request;
            if (targaFilter && sectionKeyFilter && sectionKeyFilter !== 'riepilogo') {
                 let effectiveSectionKey = sectionKeyFilter.toLowerCase();
                 if (effectiveSectionKey === 'danniverifiche') effectiveSectionKey = 'danni';
                const targaSezioneIndex = store.index('targaSezioneIdx');
                request = targaSezioneIndex.getAll(IDBKeyRange.only([targaFilter.toUpperCase(), effectiveSectionKey]));
            } else if (targaFilter) {
                const targaIndex = store.index('targaIdx');
                request = targaIndex.getAll(IDBKeyRange.only(targaFilter.toUpperCase()));
            } else {
                request = store.getAll();
            }
            request.onsuccess = (event) => resolve(event.target.result || []);
            request.onerror = (event) => {
                console.error('Errore recupero foto filtrate da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }


    async function deletePhotoFromDB(timestampToDelete) {
        const db = await openPhotoDB();
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.delete(timestampToDelete);
            request.onsuccess = () => resolve();
            request.onerror = (event) => {
                console.error('Errore eliminazione foto da IndexedDB:', event.target.error);
                reject(event.target.error);
            };
        });
    }

    function showSwipeEndIndicator(side) {
        const indicator = document.getElementById(`swipe-end-indicator-${side}`);
        if (indicator) {
            indicator.style.opacity = '1';
            setTimeout(() => {
                indicator.style.opacity = '0';
            }, 300);
        }
    }

    function resetSectionFields(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;

        section.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        section.querySelectorAll('input[type="text"]').forEach(txt => txt.value = '');
        section.querySelectorAll('textarea').forEach(ta => ta.value = '');
        section.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);

        if (sectionId === 'remarketingSection') {
            handleTrazioneChange();
        }

        updateNavButtonColors();
        if (targaSelezionataGlobalmente) {
            saveProgress(targaSelezionataGlobalmente);
        }
        section.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me'));
        if (typeof initSequentialAnimation === 'function' && section.classList.contains('active')) {
            setTimeout(initSequentialAnimation, 50);
        }
         alert(`Campi della sezione ${section.querySelector('h2.section-title')?.textContent.trim() || sectionId} azzerati.`);
    }


    function updateTargaDetailsDisplay(selectedTarga) {
        if (!targaDetailsDisplay || !selectedTarga || !listaTargheCompleta.length) {
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        const veicolo = listaTargheCompleta.find(v => v.targa.toUpperCase() === selectedTarga.toUpperCase());
        if (veicolo) {
            let detailsText = '';
            const marca = veicolo.marca ? String(veicolo.marca).trim() : '';
            const modello = veicolo.modello ? String(veicolo.modello).trim() : '';
            if (marca) detailsText += marca;
            if (modello) detailsText += (detailsText ? ' ' : '') + modello;
            targaDetailsDisplay.textContent = detailsText || '';
        } else {
            targaDetailsDisplay.textContent = '';
        }
    }

    function populateTargaSwitcherDropdown() {
        if (!targaSwitcherDropdown || !targaSelezionataGlobalmente || !listaTargheCompleta.length) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        const veicoloAttuale = listaTargheCompleta.find(v => v.targa.toUpperCase() === targaSelezionataGlobalmente.toUpperCase());
        if (!veicoloAttuale || !veicoloAttuale.piazzale) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        const piazzaleCorrente = veicoloAttuale.piazzale;
        const targheDelPiazzale = listaTargheCompleta.filter(v => v.piazzale === piazzaleCorrente && !localStorage.getItem(`${APP_PREFIX}deleted_${v.targa.toUpperCase()}`));
        targaSwitcherDropdown.innerHTML = '';
        if (targheDelPiazzale.length === 0) {
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
            return;
        }
        targheDelPiazzale.sort((a, b) => a.targa.localeCompare(b.targa));
        targheDelPiazzale.forEach(v => {
            const option = document.createElement('option');
            option.value = v.targa.toUpperCase();
            option.textContent = v.targa;
            if (v.targa.toUpperCase() === targaSelezionataGlobalmente.toUpperCase()) {
                option.selected = true;
            }
            targaSwitcherDropdown.appendChild(option);
        });
        if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex';
        updateTargaDetailsDisplay(targaSelezionataGlobalmente);
    }

    async function inviaPeriziaSingolaASheets(periziaDaInviare) {
        if (!GOOGLE_SHEET_WEB_APP_URL || GOOGLE_SHEET_WEB_APP_URL === 'INCOLLA_QUI_IL_TUO_URL_APPLICAZIONE_WEB') { console.error("URL Web App non config."); return { success: false, message: "URL Web App non config." }; }
        try {
            const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, { method: 'POST', mode: 'cors',  cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' },  body: JSON.stringify(periziaDaInviare)  });
            let responseData;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) { responseData = await response.json(); }
            else { const textResponse = await response.text(); try { responseData = JSON.parse(textResponse); } catch (e) { responseData = { status: "error", message: "Risposta non JSON: " + textResponse.substring(0,100)}; } }
            if (response.ok && responseData.status === "success") { return { success: true, message: responseData.message, data: responseData.data }; }
            else { return { success: false, message: responseData.message || `Errore server (HTTP ${response.status})` }; }
        } catch (error) { return { success: false, message: "Errore di rete: " + error.message }; }
    }

    async function fetchLatestPeriziaFromSheets(targa) {
        if (!GOOGLE_SHEET_WEB_APP_URL) { return null; }
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targa.toUpperCase()}`)) { return null; }
        const fetchUrl = `${GOOGLE_SHEET_WEB_APP_URL}?action=getPerizia&targa=${encodeURIComponent(targa.toUpperCase())}&nocache=${new Date().getTime()}`;
        try {
            const response = await fetch(fetchUrl, { method: 'GET', mode: 'cors' });
            if (!response.ok) { return null; }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const result = await response.json();
                if (result.status === "success" && result.data) { return result.data; }
                else if (result.status === "notfound") { return null; }
                else { return null; }
            } else { return null; }
        } catch (error) { return null; }
    }

    function fillSectionPositiveOrDefaults(sectionId) { const section = document.getElementById(sectionId); if (!section) return; if (sectionId === 'remarketingSection') { if (tipoTrazioneSelect) tipoTrazioneSelect.value = 'endotermico'; document.getElementById('foto_angolari').checked = true; document.getElementById('foto_vano_carico').checked = true; document.getElementById('tipo_equipaggiamento').value = 'kit_gonfia_ripara'; document.getElementById('equipaggiamento_presenza').value = 'presente'; document.getElementById('foto_interni_pannelli').checked = true; document.getElementById('foto_cruscotto').checked = true; document.getElementById('stato_chilometri').value = 'rilevabili'; document.getElementById('stato_cdc').value = 'originale'; document.getElementById('foto_vano_motore').checked = true; document.getElementById('foto_cofano_tetto').checked = true; document.getElementById('chiave_telecomando').value = 'presente'; document.getElementById('seconda_chiave').value = 'presente'; handleTrazioneChange();  if (tipoTrazioneSelect && tipoTrazioneSelect.value === 'elettrico') { if (cavoRapidaSelect) cavoRapidaSelect.value = 'presente'; if (cavoDomesticaSelect) cavoDomesticaSelect.value = 'presente'; } else {  if (cavoRapidaSelect) cavoRapidaSelect.value = 'non_applicabile';  if (cavoDomesticaSelect) cavoDomesticaSelect.value = 'non_applicabile'; } } else if (sectionId === 'pneumaticiSection') { document.getElementById('pneumatico_as').value = 'conforme'; document.getElementById('pneumatico_ad').value = 'conforme'; document.getElementById('pneumatico_pd').value = 'conforme'; document.getElementById('pneumatico_ps').value = 'conforme'; } else if (sectionId === 'danniVerificheSection') { document.getElementById('motore_accende').value = 'ok'; document.getElementById('batteria_stato').value = 'ok'; document.getElementById('foto_danni_generiche').checked = true;  document.getElementById('note_danni_verifiche').value = 'Nessuna anomalia da segnalare.'; } updateNavButtonColors(); if (typeof initSequentialAnimation === 'function') { section.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me')); initSequentialAnimation(); }  section.querySelectorAll('input, select, textarea').forEach(el => { const event = new Event('change', { bubbles: true }); el.dispatchEvent(event); }); }
    function handleTrazioneChange() { if (!tipoTrazioneSelect || !cavoRapidaSelect || !cavoDomesticaSelect) return; const selectedTrazione = tipoTrazioneSelect.value; const isElectric = selectedTrazione === 'elettrico'; cavoRapidaSelect.disabled = !isElectric; cavoDomesticaSelect.disabled = !isElectric; if (!isElectric) { cavoRapidaSelect.value = "non_applicabile";  cavoDomesticaSelect.value = "non_applicabile"; } else { if (cavoRapidaSelect.value === "" || cavoRapidaSelect.value === "non_applicabile") cavoRapidaSelect.value = ""; if (cavoDomesticaSelect.value === "" || cavoDomesticaSelect.value === "non_applicabile") cavoDomesticaSelect.value = ""; } updateNavButtonColors();  }
    function savePosizioneForTarga(targa, posizione) { if (!targa) return; try { localStorage.setItem(`${APP_PREFIX}posizione_${targa.toUpperCase()}`, posizione); } catch (e) { console.error("Errore LS pos:", e); } }
    function loadPosizioneForTarga(targa) { if (!targa) return ""; try { return localStorage.getItem(`${APP_PREFIX}posizione_${targa.toUpperCase()}`) || ""; } catch (e) { console.error("Errore LS pos:", e); return ""; } }
    function saveUrgentStatusForTarga(targa, isUrgent) {  if (!targa) return; try { localStorage.setItem(`${APP_PREFIX}urgent_${targa.toUpperCase()}`, JSON.stringify(isUrgent)); } catch (e) { console.error("Errore LS urg:", e); } }
    function loadUrgentStatusForTarga(targa) { if (!targa) return false; try { const status = localStorage.getItem(`${APP_PREFIX}urgent_${targa.toUpperCase()}`); return status ? JSON.parse(status) : false; } catch (e) { console.error("Errore LS urg:", e); return false; } }
    function resetChecklistForm() { const els = document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea'); els.forEach(el => { if (el.type === 'checkbox') el.checked = false; else if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; }); if (tipoTrazioneSelect) {  handleTrazioneChange(); } }
    function saveProgress(targa) { if(!targa){return false;} const data = {}; document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => { if (el.id) { if (el.type === 'checkbox') data[el.id] = el.checked; else data[el.id] = el.value; } }); data.timestamp = new Date().toISOString();  try { localStorage.setItem(`${APP_PREFIX}data_${targa.toUpperCase()}`, JSON.stringify(data)); updateNavButtonColors(); return true; } catch(e) { alert("Salvataggio locale fallito."); return false; } }
    function loadProgress(targa) { if(!targa) return; const targaUpper = targa.toUpperCase(); try { const json = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`); if (json) { const data = JSON.parse(json); document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => { if (el.id && data.hasOwnProperty(el.id)) { if (el.type === 'checkbox') el.checked = data[el.id]; else el.value = data[el.id]; } else if (el.id) {  if (el.type === 'checkbox') el.checked = false; else if (el.tagName === 'SELECT') el.selectedIndex = 0; } }); } else { resetChecklistForm();  } if (tipoTrazioneSelect) {   handleTrazioneChange(); } updateNavButtonColors();  } catch(e) { resetChecklistForm();  updateNavButtonColors(); } }
    function getCompletedTarghe() { try{const json=localStorage.getItem(`${APP_PREFIX}completedTarghe`);return json?JSON.parse(json):{};}catch(e){return{};}}
    function isTargaCompleted(targa) { if(!targa) return false; const completed = getCompletedTarghe(); return !!(completed[targa.toUpperCase()]); }
    function markTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe();completed[targa.toUpperCase()]=true;localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));}catch(e){console.error("Errore LS Mark:",e);}}
    function unmarkTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe(); if(completed[targa.toUpperCase()]){ delete completed[targa.toUpperCase()]; localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));}}catch(e){console.error("Errore LS Unmark:",e);}}

    function clearLocalDataForTarga(targaUpper) {
        if (!targaUpper) return;
        try {
            localStorage.removeItem(`${APP_PREFIX}data_${targaUpper}`);
            unmarkTargaAsCompleted(targaUpper);
            localStorage.removeItem(`${APP_PREFIX}posizione_${targaUpper}`);
            localStorage.removeItem(`${APP_PREFIX}urgent_${targaUpper}`);
            const sectionPhotoCounters = [`${APP_PREFIX}photoCount_${targaUpper}_remarketing`, `${APP_PREFIX}photoCount_${targaUpper}_pneumatici`, `${APP_PREFIX}photoCount_${targaUpper}_danni`];
            sectionPhotoCounters.forEach(counterKey => localStorage.removeItem(counterKey));
            getPhotosByTargaAndSezioneFromDB(targaUpper, null)
                .then(photos => {
                    const deletePromises = photos.map(photo => deletePhotoFromDB(photo.timestamp));
                    return Promise.all(deletePromises);
                })
                .then(() => {
                    if (galleryPageSection.style.display === 'block' && (currentGalleryTargaFilter === targaUpper || !currentGalleryTargaFilter)) {
                         populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
                    }
                })
                .catch(err => console.error(`Errore cancellazione foto DB per ${targaUpper}:`, err));
        } catch (e) { alert(`Errore cancellazione dati locali per ${targaUpper}.`); }
    }

    function generateAndDownloadScreenshot() { return new Promise((resolve, reject) => { const riepilogoSection = document.getElementById('riepilogoSection'); if (!riepilogoSection) { alert("Errore: Sezione Riepilogo non trovata."); return reject("Sezione riepilogo non trovata"); } if (typeof html2canvas === 'undefined') { alert("Errore: Libreria html2canvas non caricata."); return reject("html2canvas non caricata"); } setTimeout(() => { riepilogoSection.scrollTop = 0;  html2canvas(riepilogoSection, { scale: 2, useCORS: true, logging: false, scrollY: -window.scrollY, windowHeight: riepilogoSection.scrollHeight }) .then(canvas => { const link = document.createElement('a'); let targaSanitized = 'sconosciuta'; let piazzaleSanitized = 'piazzale_sconosciuto'; if (targaSelezionataGlobalmente) { targaSanitized = targaSelezionataGlobalmente.replace(/[^a-zA-Z0-9.-]/g, '_'); const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente); if (veicoloAttuale && veicoloAttuale.piazzale && veicoloAttuale.piazzale.trim() !== "") { piazzaleSanitized = veicoloAttuale.piazzale.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_'); if (!piazzaleSanitized) piazzaleSanitized = 'N_D'; } else { piazzaleSanitized = 'N_D'; } } link.download = `perizia_${targaSanitized}_${piazzaleSanitized}.png`; link.href = canvas.toDataURL('image/png'); document.body.appendChild(link); link.click(); document.body.removeChild(link); resolve(); }) .catch(error => { alert("Errore generazione screenshot."); reject(error); }); }, 100);  }); }

    async function downloadPhotosAsZip(targa) {
        if (!targa) { return; }
        if (typeof JSZip === 'undefined') { alert("Errore: Libreria JSZip non caricata."); return; }
        const originalButtonText = saveAndReturnBtn.textContent;
        saveAndReturnBtn.textContent = 'Creazione ZIP...';
        saveAndReturnBtn.disabled = true;
        try {
            const photos = await getPhotosByTargaAndSezioneFromDB(targa, null);
            if (!photos || photos.length === 0) {
                alert(`Nessuna foto per ${targa} da includere.`);
                saveAndReturnBtn.textContent = originalButtonText;
                saveAndReturnBtn.disabled = false;
                return;
            }
            const zip = new JSZip();
            photos.forEach(photoData => {
                if (photoData.blobData instanceof Blob && photoData.name) {
                    zip.file(photoData.name, photoData.blobData);
                }
            });
            const zipBlob = await zip.generateAsync({type:"blob", compression: "DEFLATE"});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(zipBlob);
            const zipFileName = `${targa.toUpperCase().replace(/[^A-Z0-9]/g, '_')}.zip`;
            link.download = zipFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            alert(`File ZIP "${zipFileName}" per ${targa} scaricato.`);
        } catch (error) { alert("Errore creazione ZIP.");
        } finally {
            saveAndReturnBtn.textContent = originalButtonText;
            saveAndReturnBtn.disabled = false;
        }
    }

async function handleSavePeriziaAndReturn() {
        if (!targaSelezionataGlobalmente) {
            alert("Nessuna targa attiva."); // Mantenuto in italiano
            return;
        }
        const originalButtonText = saveAndReturnBtn.textContent; // Memorizza il testo iniziale del pulsante
        saveAndReturnBtn.disabled = true; // Disabilita il pulsante durante l'elaborazione

        // 1. Salva i progressi
        saveAndReturnBtn.textContent = 'Salvataggio Dati...';
        if (!saveProgress(targaSelezionataGlobalmente)) {
            alert("Salvataggio dati browser fallito."); // Mantenuto in italiano
            saveAndReturnBtn.textContent = originalButtonText; // Ripristina il testo del pulsante
            saveAndReturnBtn.disabled = false; // Riabilita il pulsante
            return;
        }

        // 2. Genera il riepilogo se si è nella sezione riepilogo
        if (document.getElementById('riepilogoSection').classList.contains('active')) {
            generateSummary();
        }

        // 3. Scarica lo screenshot (comportamento esistente)
        saveAndReturnBtn.textContent = 'Generazione Screenshot...';
        try {
            await generateAndDownloadScreenshot();
        } catch (e) {
            console.warn("Generazione screenshot fallita, dati salvati localmente.", e);
            // Opzionalmente, informa l'utente che lo screenshot è fallito ma la perizia è stata salvata.
            // alert("Attenzione: la generazione dello screenshot è fallita, ma la perizia è stata salvata localmente.");
        }

        // 4. Contrassegna come completata
        markTargaAsCompleted(targaSelezionataGlobalmente);
        updateNavButtonColors(); // Aggiorna i colori dei pulsanti di navigazione

        // 5. Crea e scarica il file ZIP con le foto
        if (typeof JSZip === 'undefined') {
            alert("Errore: Libreria JSZip non caricata. Impossibile scaricare il file ZIP delle foto."); // Mantenuto in italiano
        } else {
            saveAndReturnBtn.textContent = 'Creazione ZIP Foto...';
            try {
                const photos = await getPhotosByTargaAndSezioneFromDB(targaSelezionataGlobalmente, null); // Ottieni tutte le foto per la targa

                if (!photos || photos.length === 0) {
                    console.log(`Nessuna foto trovata per la targa ${targaSelezionataGlobalmente} da includere nel file ZIP.`);
                    // Nessun avviso per l'assenza di foto, per mantenere il flusso regolare. L'utente potrebbe non aver scattato foto.
                } else {
                    const zip = new JSZip();
                    photos.forEach(photoData => {
                        if (photoData.blobData instanceof Blob && photoData.name) {
                            zip.file(photoData.name, photoData.blobData);
                        }
                    });

                    const zipBlob = await zip.generateAsync({ type: "blob", compression: "DEFLATE" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(zipBlob);

                    // Usa il nome della targa per il file ZIP come richiesto, es., AA000BB.zip
                    const zipFileName = `${targaSelezionataGlobalmente.toUpperCase().replace(/[^A-Z0-9.-]/g, '_')}.zip`;
                    link.download = zipFileName;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    // Potresti voler aggiungere un avviso di conferma qui se necessario:
                    // alert(`File ZIP "${zipFileName}" per la targa ${targaSelezionataGlobalmente} scaricato.`);
                }
            } catch (error) {
                alert(`Errore durante la creazione del file ZIP per la targa ${targaSelezionataGlobalmente}. La perizia è stata comunque salvata.`); // Mantenuto in italiano
                console.error("Errore durante la creazione del file ZIP in handleSavePeriziaAndReturn:", error);
            }
        }

        // 6. Ripristina lo stato del pulsante e naviga alla pagina iniziale
        saveAndReturnBtn.textContent = originalButtonText; // Ripristina il testo originale del pulsante
        saveAndReturnBtn.disabled = false; // Riabilita il pulsante
        showView('landing');
    }

    function handleSaveAndNext() { if(!targaSelezionataGlobalmente){return;} if(saveProgress(targaSelezionataGlobalmente)){const oT=this.textContent;this.textContent='Salvato!';this.disabled=true;setTimeout(()=>{this.textContent=oT;this.disabled=false;},1500);}else return; let curIdx=-1; navButtons.forEach((nb,i)=>{if(nb.classList.contains('active'))curIdx=i;}); if(curIdx!==-1&&curIdx<navButtons.length-1){const nextNB=navButtons[curIdx+1];if(nextNB)showSection(nextNB.dataset.target);}}
    function isInputDefault(inputElement) { if (!inputElement) return true; if (inputElement.type === 'checkbox') return !inputElement.checked; if (inputElement.tagName === 'SELECT') return inputElement.value === "" || inputElement.selectedIndex === 0; if (inputElement.type === 'text' || inputElement.type === 'url' || inputElement.tagName === 'TEXTAREA') return inputElement.value.trim() === ""; return true; }
    function getSectionInputs(sectionElementId) { const sectionDiv = document.getElementById(sectionElementId); if (!sectionDiv) return []; return Array.from(sectionDiv.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled)')); }
    function getSectionStatus(sectionElementId, targaData) { const inputs = getSectionInputs(sectionElementId); if (inputs.length === 0) return 'completed';  let allDefaultOrNA = true;  let allNonDefaultAndApplicable = true;  let hasAtLeastOneNonDefaultAndApplicable = false; inputs.forEach(input => { let isEffectivelyDefault = false; const savedValue = targaData && targaData.hasOwnProperty(input.id) ? targaData[input.id] : undefined; let currentValue = savedValue; if (savedValue === undefined) {  if (input.type === 'checkbox') currentValue = input.checked; else currentValue = input.value; } if (input.type === 'checkbox') { isEffectivelyDefault = !currentValue; } else if (input.tagName === 'SELECT') { isEffectivelyDefault = (currentValue === "" || (input.options.length > 0 && currentValue === input.options[0].value)); if ((input.id === 'cavo_ricarica_rapida' || input.id === 'cavo_ricarica_domestica') && currentValue === 'non_applicabile') { isEffectivelyDefault = true; } } else {  isEffectivelyDefault = (currentValue === ""); } if (!isEffectivelyDefault) { allDefaultOrNA = false; hasAtLeastOneNonDefaultAndApplicable = true; } else {  allNonDefaultAndApplicable = false; } }); if (allDefaultOrNA) return 'untouched'; if (allNonDefaultAndApplicable) return 'completed'; if (hasAtLeastOneNonDefaultAndApplicable) return 'partial';  return 'untouched';  }
    function updateNavButtonColors() { if (!targaSelezionataGlobalmente && checklistContainer.style.display === 'none' && galleryPageSection.style.display === 'none') { navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched', 'active'); btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; }); return; } const targaDataJSON = localStorage.getItem(`${APP_PREFIX}data_${(targaSelezionataGlobalmente || currentGalleryTargaFilter || "").toUpperCase()}`); const targaData = targaDataJSON ? JSON.parse(targaDataJSON) : null; navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched'); if (!btn.classList.contains('active')) { btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; } if (btn.classList.contains('active')) { return; } const targetSection = btn.dataset.target; let status = 'untouched'; const activeTargaForStatus = targaSelezionataGlobalmente || currentGalleryTargaFilter; if (targetSection === 'riepilogo') { if (isTargaCompleted(activeTargaForStatus)) { status = 'completed'; } else { let hasAnyDataForSummary = false; if (targaData && Object.keys(targaData).length > 0 && Object.keys(targaData).some(k => k !== 'timestamp')) { hasAnyDataForSummary = true; } else { ['remarketingSection', 'pneumaticiSection', 'danniVerificheSection'].forEach(secId => { if (getSectionStatus(secId, targaData) !== 'untouched') { hasAnyDataForSummary = true; } }); } status = hasAnyDataForSummary ? 'partial' : 'untouched'; } } else if (targetSection) { status = getSectionStatus(targetSection + 'Section', targaData); } if (status === 'completed') btn.classList.add('nav-btn-completed'); else if (status === 'partial') btn.classList.add('nav-btn-partial'); else btn.classList.add('nav-btn-untouched'); }); }

    // ----------------------------------------------------------------------------------
    // Funzione showView MODIFICATA (ma no changes needed based on analysis for this specific problem)
    // ----------------------------------------------------------------------------------
    function showView(viewName) {
        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        if(cameraPageSection) cameraPageSection.style.display = 'none'; // Nascondi cameraPageSection di default
        if(galleryPageSection) galleryPageSection.style.display = 'none';
        if(imageLightbox) imageLightbox.style.display = 'none';

        // Default visibility for top header elements
        if(pageHeaderContainer) pageHeaderContainer.style.display = 'block';
        if(utilityNavButtons) utilityNavButtons.style.display = 'flex';
        if(mainTitleGlobal) mainTitleGlobal.style.display = 'block';
        if(navButtonsContainer) navButtonsContainer.style.display = 'flex';

        let bodyPaddingTopValue = '0px';
        let bodyPaddingBottomValue = '0px';

        if (viewName !== 'camera') {
            // Se NON siamo in modalità fotocamera, la bottomNavCircles è visibile di default
            if (bottomNavCircles) {
                bottomNavCircles.style.display = 'flex';
            }

            if (pageHeaderContainer && getComputedStyle(pageHeaderContainer).display !== 'none' && pageHeaderContainer.classList.contains('fixed-header')) {
                let hasVisibleTopContent = false;
                const topElements = [utilityNavButtons, mainTitleGlobal, navButtonsContainer, targaDropdownContainer];
                for(let el of topElements) {
                    if (el && getComputedStyle(el).display !== 'none') {
                        hasVisibleTopContent = true;
                        break;
                    }
                }
                if(hasVisibleTopContent) {
                    bodyPaddingTopValue = `${pageHeaderContainer.offsetHeight + 10}px`;
                }
            }

            if (bottomNavCircles && getComputedStyle(bottomNavCircles).display !== 'none') {
                bodyPaddingBottomValue = `${bottomNavCircles.offsetHeight + 10}px`;
            }
        } else { // viewName === 'camera'
            // In modalità fotocamera, l'header superiore è nascosto
            if (pageHeaderContainer) pageHeaderContainer.style.display = 'none';

            // La bottomNavCircles DEVE essere visibile in modalità camera (come da richiesta)
            if (bottomNavCircles) {
                 bottomNavCircles.style.display = 'flex'; // Assicura che sia visibile
                 // Calcola il padding solo se effettivamente visibile
                 if (getComputedStyle(bottomNavCircles).display !== 'none') {
                    bodyPaddingBottomValue = `${bottomNavCircles.offsetHeight + 10}px`;
                 } else {
                     bodyPaddingBottomValue = '0px'; // Fallback
                 }
            } else {
                bodyPaddingBottomValue = '0px';
            }
        }
        document.body.style.paddingTop = bodyPaddingTopValue;
        document.body.style.paddingBottom = bodyPaddingBottomValue;

        // Gestione specifica della vista
        if (viewName === 'landing') {
            landingPageSection.style.display = 'block';
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            if (mainTitleGlobal) mainTitleGlobal.innerHTML = "Elenco Veicoli";
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (listaTargheCompleta.length > 0 &&
                (!document.getElementById('preloader') || document.getElementById('preloader').classList.contains('hidden')) &&
                typeof popolaTargheFiltrate === 'function') {
                popolaTargheFiltrate();
            }
            if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        } else if (viewName === 'checklist') {
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            if (!targaSelezionataGlobalmente) { showView('landing'); return; }
            if (localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente.toUpperCase()}`)) {
                showView('landing');
                alert(`Perizia per ${targaSelezionataGlobalmente} cancellata.`); return;
            }
            checklistContainer.style.display = 'block';
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex';
            populateTargaSwitcherDropdown(); updateTargaDetailsDisplay(targaSelezionataGlobalmente);
            if (tipoTrazioneSelect) handleTrazioneChange();
            const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
            if (downloadZipBtn && activeSectionElement && activeSectionElement.id === 'riepilogoSection' && targaSelezionataGlobalmente) {
                downloadZipBtn.href = `https://192.168.1.154:8080/${targaSelezionataGlobalmente.toUpperCase()}.zip`;
                downloadZipBtn.style.display = 'inline-flex';
            } else if (downloadZipBtn) {
                downloadZipBtn.style.display = 'none';
            }
        } else if (viewName === 'history') {
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            historyPageSection.style.display = 'block';
            if (mainTitleGlobal) mainTitleGlobal.innerHTML = "Cronistoria Salvataggi";
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            populateSavedTargasList();
            if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        } else if (viewName === 'gallery') {
            if (pageHeaderContainer) pageHeaderContainer.classList.add('fixed-header');
            // La visualizzazione di galleryPageSection è gestita da showGalleryPage()
            // Questa viene chiamata da altre parti della logica (es. click su headerPhotosBtn)
            if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        } else if (viewName === 'camera') {
            // La logica principale per preparare la cameraPageSection
            // e avviare lo stream è in showCameraPage()
            showCameraPage(); // Chiamata per attivare la fotocamera
        } else { // Vista sconosciuta o di default
             if (pageHeaderContainer) pageHeaderContainer.classList.remove('fixed-header');
             if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        }

        updateNavButtonColors();
        window.scrollTo(0, 0);
    }

    // >>> DEFINIZIONE FUNZIONE BLUETOOTH HANDLER <<<
    function bluetoothShutterHandler(event) {
        // Stampa in console per debugging - PREMI IL TUO TASTO BLUETOOTH E GUARDA COSA APPARE QUI
        console.log('Key pressed:', event.key, 'Code:', event.code);

        // Solo se la camera è attiva e non ci sono altre modali/lightbox aperte
        if (cameraPageSection.style.display !== 'flex' ||
            (imageLightbox && imageLightbox.style.display === 'flex') ||
            (changelogModal && changelogModal.style.display === 'flex')) {
            return;
        }

        // Controlla se il tasto premuto è Volume Su o Volume Giù
        if (event.key === 'AudioVolumeUp' || event.code === 'VolumeUp' || /* Tasto Volume Su */
            event.key === 'AudioVolumeDown' || event.code === 'VolumeDown' /* Tasto Volume Giù */
           ) {
            event.preventDefault(); // IMPORTANTE: previene l'azione di default (cambiare il volume)
            if (captureBtn && !captureBtn.disabled) {
                captureBtn.click(); // Simula il click sul pulsante di scatto
            }
        }
    }

    // ----------------------------------------------------------------------------------
    // Funzione showCameraPage MODIFICATA
    // ----------------------------------------------------------------------------------
    async function showCameraPage() {
        // The logic for setting lastViewBeforeCamera and lastSectionBeforeCamera
        // has been moved to the headerCameraBtn click listener.
        // These globals will be used directly by getFilenameSectionName() and returnFromCamera().

        cameraStreamElement.style.display = 'block';
        freezeFrameDisplayElement.style.display = 'none';
        cameraPageSection.style.display = 'flex'; 

        let topBarHeight = 0; 
        let bottomNavHeight = 0;

        if (bottomNavCircles && getComputedStyle(bottomNavCircles).display !== 'none') {
            bottomNavHeight = bottomNavCircles.offsetHeight;
        }
        cameraPageSection.style.paddingTop = `${topBarHeight}px`; 
        cameraPageSection.style.height = `calc(100vh - ${topBarHeight}px - ${bottomNavHeight}px)`;

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            const constraints = {
                video: {
                    facingMode: "environment",
                    width: { ideal: 1920, min: 1280 },
                    height: { ideal: 1080, min: 720 },
                    advanced: [{ focusMode: "continuous" }]
                },
                audio: false
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraStreamElement.srcObject = stream;
                currentCameraStream = stream;
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack && typeof videoTrack.applyConstraints === 'function') {
                    try { await videoTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] }); }
                    catch (e) { try { await videoTrack.applyConstraints({ advanced: [{ focusMode: 'auto' }] }); } catch (e2) { console.warn("Focus auto fallito:", e2); } }
                }
                // >>> AGGIUNTA EVENT LISTENER BLUETOOTH <<<
                document.addEventListener('keydown', bluetoothShutterHandler);

            } catch (err) {
                console.error("Errore getUserMedia principale:", err);
                try {
                    const fallbackStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                    cameraStreamElement.srcObject = fallbackStream;
                    currentCameraStream = fallbackStream;
                    // >>> AGGIUNTA EVENT LISTENER BLUETOOTH (ANCHE NEL FALLBACK) <<<
                    document.addEventListener('keydown', bluetoothShutterHandler);
                } catch (fallbackErr) {
                    console.error("Errore getUserMedia di fallback:", fallbackErr);
                    alert("Impossibile accedere alla fotocamera: " + fallbackErr.message);
                    returnFromCamera(); 
                    return; 
                }
            }
        } else {
            alert("Browser non supporta accesso fotocamera (navigator.mediaDevices non disponibile).");
            returnFromCamera(); 
            return; 
        }
        window.scrollTo(0, 0);
    }

    // ----------------------------------------------------------------------------------
    // Funzione returnFromCamera MODIFICATA
    // ----------------------------------------------------------------------------------
    function returnFromCamera() {
        if (currentCameraStream) {
            currentCameraStream.getTracks().forEach(track => track.stop());
            currentCameraStream = null;
            if (cameraStreamElement) cameraStreamElement.srcObject = null;
        }

        // >>> RIMOZIONE EVENT LISTENER BLUETOOTH <<<
        if (bluetoothShutterHandler) {
            document.removeEventListener('keydown', bluetoothShutterHandler);
        }

        if (cameraPageSection) cameraPageSection.style.display = 'none';
        if (cameraStreamElement) cameraStreamElement.style.display = 'block'; 
        if (freezeFrameDisplayElement) freezeFrameDisplayElement.style.display = 'none';

        if (cameraPageSection) {
            cameraPageSection.style.paddingTop = '';
            cameraPageSection.style.height = ''; 
        }

        if (lastViewBeforeCamera === 'gallery') {
            showGalleryPage(currentGalleryTargaFilter, lastSectionBeforeCamera);
        } else if (lastViewBeforeCamera === 'checklist' && targaSelezionataGlobalmente && lastSectionBeforeCamera) {
            showView('checklist'); 
            showSection(lastSectionBeforeCamera); 
        } else if (lastViewBeforeCamera === 'history') {
            showView('history');
        } else { 
            showView('landing');
        }
    }


    function getFilenameSectionName() {
        let sectionNameForFile = "generale"; // Default value
        let currentSectionKey = null;

        // Uses the globally set lastViewBeforeCamera and lastSectionBeforeCamera
        if (lastViewBeforeCamera === 'checklist' && lastSectionBeforeCamera) {
            currentSectionKey = lastSectionBeforeCamera;
        } else if (lastViewBeforeCamera === 'gallery' && currentGallerySectionFilter) {
            currentSectionKey = currentGallerySectionFilter;
        }

        if (currentSectionKey) {
            let tempSectionKey = currentSectionKey.toLowerCase();
            if (['remarketing', 'pneumatici'].includes(tempSectionKey)) {
                sectionNameForFile = tempSectionKey;
            } else if (tempSectionKey === 'danniverifiche') { // This corresponds to 'danniVerificheSection'
                sectionNameForFile = 'danni';
            } else if (tempSectionKey === 'riepilogo') {
                sectionNameForFile = 'generale_riepilogo';
            }
            // If currentSectionKey is something else, it will retain the default "generale"
            // or "generale_riepilogo" if from 'riepilogo'.
        }
        return sectionNameForFile;
    }


    function getNextPhotoNumber(targa, sectionName) {
        const sectionNormalized = sectionName.toLowerCase();
        let start, end, counterKey;

        if (sectionNormalized === 'remarketing') {
            start = 1; end = 99; counterKey = `${APP_PREFIX}photoCount_${targa}_remarketing`;
        } else if (sectionNormalized === 'pneumatici') {
            start = 101; end = 150; counterKey = `${APP_PREFIX}photoCount_${targa}_pneumatici`;
        } else if (sectionNormalized === 'danni' || sectionNormalized === 'danniverifiche') {
            start = 200; end = 999; counterKey = `${APP_PREFIX}photoCount_${targa}_danni`;
        } else {
            const genericCounterKey = `${APP_PREFIX}photoCount_${targa}_${sectionNormalized}`;
            let photoNumber = parseInt(localStorage.getItem(genericCounterKey) || '0') + 1;
            localStorage.setItem(genericCounterKey, photoNumber.toString());
            return photoNumber;
        }

        let currentNumber = parseInt(localStorage.getItem(counterKey) || (start - 1).toString());
        currentNumber++;
        if (currentNumber < start) currentNumber = start;
        if (currentNumber > end) {
            // alert(`Attenzione: Limite foto per "${sectionName}" (${start}-${end}) raggiunto. N.${currentNumber}.`);
        }
        localStorage.setItem(counterKey, currentNumber.toString());
        return currentNumber;
    }


    function capturePhoto() {
        if (captureBtn.disabled) return;
        if (currentCameraStream && cameraStreamElement.readyState >= cameraStreamElement.HAVE_CURRENT_DATA && cameraStreamElement.videoWidth > 0) {
            const canvas = document.createElement('canvas');
            canvas.width = cameraStreamElement.videoWidth;
            canvas.height = cameraStreamElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(cameraStreamElement, 0, 0, canvas.width, canvas.height);
            freezeFrameDisplayElement.src = canvas.toDataURL('image/jpeg', 0.7);
            freezeFrameDisplayElement.style.display = 'block';
            cameraStreamElement.style.display = 'none';
            captureBtn.disabled = true;
            const targaForFile = (targaSelezionataGlobalmente || currentGalleryTargaFilter || 'SCONOSCIUTA').toUpperCase().replace(/[^A-Z0-9]/g, '');
            const sectionNameForFile = getFilenameSectionName(); // Crucial call using updated globals
            const photoNumber = getNextPhotoNumber(targaForFile, sectionNameForFile);
            if (photoNumber === null) {
                 freezeFrameDisplayElement.style.display = 'none'; freezeFrameDisplayElement.src = '#';
                 cameraStreamElement.style.display = 'block'; captureBtn.disabled = false; return;
            }
            const formattedPhotoNumber = String(photoNumber).padStart(3, '0');
            const filename = `${formattedPhotoNumber} ${sectionNameForFile} ${targaForFile}.jpeg`;
            canvas.toBlob(async function(blob) {
                if (!blob) {
                    alert("Errore conversione foto.");
                    freezeFrameDisplayElement.style.display = 'none'; freezeFrameDisplayElement.src = '#';
                    cameraStreamElement.style.display = 'block'; captureBtn.disabled = false; return;
                }
                const photoObjectToSave = {
                    name: filename, blobData: blob, timestamp: new Date().toISOString(),
                    targa: targaForFile, sezione: sectionNameForFile
                };
                try {
                    await savePhotoToDB(photoObjectToSave);
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob); link.download = filename;
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                } catch (error) { alert("Errore salvataggio foto DB.");
                } finally {
                    setTimeout(() => {
                        freezeFrameDisplayElement.style.display = 'none'; freezeFrameDisplayElement.src = '#';
                        cameraStreamElement.style.display = 'block'; captureBtn.disabled = false;
                    }, 500);
                }
            }, 'image/jpeg', 0.7);
        }
    }

    async function showGalleryPage(targaToFilter = null, sectionToFilter = null) {
        if (checklistContainer.style.display === 'block') {
            lastViewBeforeGallery = 'checklist';
            const activeSectionEl = document.querySelector('#checklistContainer .category-section.active');
            lastSectionBeforeGallery = activeSectionEl ? activeSectionEl.id.replace('Section', '') : null;
        } else if (landingPageSection.style.display === 'block') {
            lastViewBeforeGallery = 'landing'; lastSectionBeforeGallery = null;
        } else if (historyPageSection.style.display === 'block') {
            lastViewBeforeGallery = 'history'; lastSectionBeforeGallery = null;
        }

        currentGalleryTargaFilter = targaToFilter ? targaToFilter.toUpperCase() : null;
        currentGallerySectionFilter = sectionToFilter;

        showView('gallery'); 

        galleryPageSection.style.display = 'block'; 

        const galleryTitleElement = galleryPageSection.querySelector('h2.section-title');
        let galleryTitleText = "Galleria Foto Catturate";

        if (currentGalleryTargaFilter) {
            targaSelezionataGlobalmente = currentGalleryTargaFilter;
            if(mainTitleGlobal) mainTitleGlobal.style.display = 'none'; 
            if(targaDropdownContainer) targaDropdownContainer.style.display = 'flex';
            populateTargaSwitcherDropdown();
            if(targaSwitcherDropdown.value.toUpperCase() !== currentGalleryTargaFilter) {
                targaSwitcherDropdown.value = currentGalleryTargaFilter;
            }
            updateTargaDetailsDisplay(currentGalleryTargaFilter);
            if(navButtonsContainer) navButtonsContainer.style.display = 'flex';
            if(mainPageNavButtons) mainPageNavButtons.style.display = 'flex';
            if(utilityNavButtons) utilityNavButtons.style.display = 'flex';

            navButtons.forEach(b => b.classList.remove('active'));
            let sectionNameForTitle = "Tutte le foto";
            if (currentGallerySectionFilter && currentGallerySectionFilter !== 'riepilogo') {
                const navButtonForSection = mainPageNavButtons.querySelector(`button[data-target="${currentGallerySectionFilter}"]`);
                if (navButtonForSection) {
                    navButtonForSection.classList.add('active');
                    sectionNameForTitle = navButtonForSection.textContent.split('. ')[1] || currentGallerySectionFilter;
                } else {
                     sectionNameForTitle = currentGallerySectionFilter.charAt(0).toUpperCase() + currentGallerySectionFilter.slice(1);
                     if (currentGallerySectionFilter === 'danniverifiche') sectionNameForTitle = 'Danni/Verifiche';
                }
            } else if (currentGallerySectionFilter === 'riepilogo') {
                 const riepilogoNavButton = mainPageNavButtons.querySelector(`button[data-target="riepilogo"]`);
                 if (riepilogoNavButton) riepilogoNavButton.classList.add('active');
            } else {
                 const riepilogoNavButton = mainPageNavButtons.querySelector(`button[data-target="riepilogo"]`);
                 if (riepilogoNavButton) riepilogoNavButton.classList.add('active');
                 sectionNameForTitle = "Tutte le foto";
            }
            galleryTitleText = `Galleria: ${currentGalleryTargaFilter} - ${sectionNameForTitle}`;
            updateNavButtonColors();
        } else {
            if (mainTitleGlobal) mainTitleGlobal.innerHTML = "Galleria Foto Catturate";
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (navButtonsContainer) navButtonsContainer.style.display = 'none';
        }
        if(galleryTitleElement) galleryTitleElement.textContent = galleryTitleText;
        await populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);

        window.scrollTo(0,0);
    }

    async function populatePhotoGrid(targaFilter, sectionKeyFilter) {
        photoGridContainer.innerHTML = '';
        currentLightboxPhotoList = [];

        try {
            let photosToDisplay;
            let effectiveSectionKeyForDBQuery = sectionKeyFilter;
            if (targaFilter) {
                if (sectionKeyFilter && sectionKeyFilter.toLowerCase() === 'danniverifiche') {
                    effectiveSectionKeyForDBQuery = 'danni';
                } else if (sectionKeyFilter && sectionKeyFilter.toLowerCase() === 'riepilogo'){
                    effectiveSectionKeyForDBQuery = null;
                }
                photosToDisplay = await getPhotosByTargaAndSezioneFromDB(targaFilter, effectiveSectionKeyForDBQuery);
            } else {
                photosToDisplay = await getAllPhotosFromDB();
            }

            if (photosToDisplay.length === 0) {
                photoGridContainer.innerHTML = '<p>Nessuna foto trovata.</p>'; return;
            }
            photosToDisplay.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            photosToDisplay.forEach((photoData) => {
                currentLightboxPhotoList.push(photoData.timestamp);
                const photoItemDiv = document.createElement('div');
                photoItemDiv.classList.add('photo-item');
                const img = document.createElement('img');
                let objectUrl = null;
                if (photoData.blobData instanceof Blob) {
                    objectUrl = URL.createObjectURL(photoData.blobData);
                    img.src = objectUrl;
                } else { img.alt = `Dati non validi ${photoData.name}`; }
                img.alt = photoData.name; img.dataset.timestamp = photoData.timestamp;
                img.addEventListener('click', function() { openImageLightbox(this.dataset.timestamp); });
                const caption = document.createElement('div');
                caption.classList.add('photo-item-caption'); caption.textContent = photoData.name;
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('photo-item-delete-btn'); deleteBtn.innerHTML = '&times;';
                deleteBtn.title = "Elimina foto";
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (objectUrl) { URL.revokeObjectURL(objectUrl); }
                    deleteCapturedPhoto(photoData.timestamp, photoData.targa, photoData.sezione);
                });
                photoItemDiv.appendChild(img); photoItemDiv.appendChild(caption);
                photoItemDiv.appendChild(deleteBtn); photoGridContainer.appendChild(photoItemDiv);
            });
        } catch (e) { photoGridContainer.innerHTML = '<p>Errore caricamento foto.</p>'; }
    }

    async function deleteCapturedPhoto(timestampToDelete, targa, sezione) {
        if (confirm("Sei sicuro di voler eliminare questa foto?")) {
            try {
                await deletePhotoFromDB(timestampToDelete);
                const indexInLightboxList = currentLightboxPhotoList.indexOf(timestampToDelete);
                if (indexInLightboxList > -1) {
                    currentLightboxPhotoList.splice(indexInLightboxList, 1);
                }

                if (targa && sezione) {
                    const photosRemaining = await getPhotosByTargaAndSezioneFromDB(targa, sezione);
                    if (photosRemaining.length === 0) {
                        const sectionForCounter = sezione.toLowerCase();
                        let counterKey, startNumber;
                        if (sectionForCounter === 'remarketing') {
                            counterKey = `${APP_PREFIX}photoCount_${targa}_remarketing`; startNumber = 1;
                        } else if (sectionForCounter === 'pneumatici') {
                            counterKey = `${APP_PREFIX}photoCount_${targa}_pneumatici`; startNumber = 101;
                        } else if (sectionForCounter === 'danni' || sectionForCounter === 'danniverifiche') {
                            counterKey = `${APP_PREFIX}photoCount_${targa}_danni`; startNumber = 200;
                        }
                        if (counterKey && startNumber !== undefined) {
                            localStorage.setItem(counterKey, (startNumber - 1).toString());
                        }
                    }
                }
                await populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
            } catch (e) { alert("Errore eliminazione foto."); }
        }
    }

    async function openImageLightbox(timestamp) {
        try {
            const db = await openPhotoDB();
            const transaction = db.transaction(PHOTO_STORE_NAME, 'readonly');
            const store = transaction.objectStore(PHOTO_STORE_NAME);
            const request = store.get(timestamp);
            request.onsuccess = (event) => {
                const photoData = event.target.result;
                if (photoData && photoData.blobData instanceof Blob) {
                    if (currentLightboxImageObjectUrl) { URL.revokeObjectURL(currentLightboxImageObjectUrl); }
                    currentLightboxImageObjectUrl = URL.createObjectURL(photoData.blobData);
                    lightboxImage.src = currentLightboxImageObjectUrl;
                    currentLightboxPhotoIndex = currentLightboxPhotoList.indexOf(timestamp);
                    imageLightbox.style.display = 'flex';
                } else { alert("Impossibile caricare immagine."); }
            };
            request.onerror = (event) => { alert("Errore caricamento immagine."); };
        } catch (error) { alert("Errore DB visualizzazione immagine."); }
    }

    function closeImageLightbox() {
        imageLightbox.style.display = 'none';
        if (currentLightboxImageObjectUrl) {
            URL.revokeObjectURL(currentLightboxImageObjectUrl);
            currentLightboxImageObjectUrl = null;
        }
        lightboxImage.src = '#';
        currentLightboxPhotoIndex = -1;
    }

    function handleLightboxTouchStart(event) {
        if (event.touches.length > 1) return;
        lightboxTouchStartX = event.changedTouches[0].screenX;
        lightboxTouchStartY = event.changedTouches[0].screenY;
    }

    function handleLightboxTouchEnd(event) {
        if (currentLightboxPhotoIndex === -1 || !lightboxTouchStartX || !lightboxTouchStartY) return;

        let lightboxTouchEndX = event.changedTouches[0].screenX;
        let lightboxTouchEndY = event.changedTouches[0].screenY;
        handleLightboxSwipe(lightboxTouchEndX, lightboxTouchEndY);

        lightboxTouchStartX = 0;
        lightboxTouchStartY = 0;
    }

function handleLightboxSwipe(endX, endY) {
        const deltaX = endX - lightboxTouchStartX;
        const deltaY = endY - lightboxTouchStartY;

        const horizontalSwipeStrength = Math.abs(deltaX);
        const verticalSwipeStrength = Math.abs(deltaY);

        // Verifica se lo swipe supera la soglia minima per essere considerato un gesto
        if (horizontalSwipeStrength > swipeThreshold || verticalSwipeStrength > swipeThreshold) {
            
            // Determina se lo swipe è prevalentemente orizzontale o verticale
            if (horizontalSwipeStrength > verticalSwipeStrength) {
                // Gesto prevalentemente orizzontale
                if (deltaX > 0) { // Swipe verso destra (foto precedente)
                    if (currentLightboxPhotoIndex > 0) {
                        currentLightboxPhotoIndex--;
                        openImageLightbox(currentLightboxPhotoList[currentLightboxPhotoIndex]);
                    } else {
                        showSwipeEndIndicator('left'); // Inizio della lista
                    }
                } else { // Swipe verso sinistra (foto successiva)
                    if (currentLightboxPhotoIndex < currentLightboxPhotoList.length - 1) {
                        currentLightboxPhotoIndex++;
                        openImageLightbox(currentLightboxPhotoList[currentLightboxPhotoIndex]);
                    } else {
                        showSwipeEndIndicator('right'); // Fine della lista
                    }
                }
            } else {
                // Gesto prevalentemente verticale
                if (deltaY > 0) { // Swipe verso il basso (foto precedente)
                    if (currentLightboxPhotoIndex > 0) {
                        currentLightboxPhotoIndex--;
                        openImageLightbox(currentLightboxPhotoList[currentLightboxPhotoIndex]);
                    } else {
                        showSwipeEndIndicator('top'); // Inizio della lista (swipe verso il basso all'inizio)
                    }
                } else { // Swipe verso l'alto (foto successiva)
                    if (currentLightboxPhotoIndex < currentLightboxPhotoList.length - 1) {
                        currentLightboxPhotoIndex++;
                        openImageLightbox(currentLightboxPhotoList[currentLightboxPhotoIndex]);
                    } else {
                        showSwipeEndIndicator('bottom'); // Fine della lista (swipe verso l'alto alla fine)
                    }
                }
            }
        }
        // Resetta le coordinate di inizio per il prossimo swipe
        lightboxTouchStartX = 0;
        lightboxTouchStartY = 0;
    }

    function handleGalleryGridTouchStart(event) {
        if (event.touches.length === 1) {
            galleryGridTouchStartY = event.touches[0].clientY;
        }
    }

    function handleGalleryGridTouchMove(event) {
        if (event.touches.length === 1 && galleryPageSection.style.display === 'block') {
            const currentTouchY = event.touches[0].clientY;
            const deltaY = currentTouchY - galleryGridTouchStartY;
            const isPageAtTop = (galleryPageSection.scrollTop || document.documentElement.scrollTop || document.body.scrollTop) === 0;


            if (isPageAtTop && deltaY > 0 && galleryPageSection.scrollHeight <= galleryPageSection.clientHeight) { 
                event.preventDefault(); 
                showSwipeEndIndicator('top');
            }
        }
    }

    async function handleTargaSelectionAndSync(selectedTarga, targetSectionId = null) {
        const targaUpper = selectedTarga.toUpperCase();
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`)) {
            if (targheLoadingStatus && landingPageSection.style.display === 'block') {
                targheLoadingStatus.textContent = `Targa ${targaUpper} cancellata.`;
            }
            if (targaSelezionataGlobalmente === targaUpper && checklistContainer.style.display === 'block') { showView('landing'); }
            return;
        }
        if (targaSelezionataGlobalmente === targaUpper && checklistContainer.style.display === 'block') {
            if (targaSwitcherDropdown.value !== targaUpper) { targaSwitcherDropdown.value = targaUpper; }
            updateTargaDetailsDisplay(targaUpper);
            if (targetSectionId) {
                 const currentActiveSectionEl = document.querySelector('#checklistContainer .category-section.active');
                 const currentActiveSectionId = currentActiveSectionEl ? currentActiveSectionEl.id.replace('Section', '') : null;
                 if (currentActiveSectionId !== targetSectionId) { showSection(targetSectionId); }
            }
            if (downloadZipBtn && targetSectionId === 'riepilogo') {
                downloadZipBtn.href = `https://192.168.1.154:8080/${targaUpper.toUpperCase()}.zip`;
                downloadZipBtn.style.display = 'inline-flex';
            } else if (downloadZipBtn) {
                downloadZipBtn.style.display = 'none';
            }
            return;
        }
        targaSelezionataGlobalmente = targaUpper;
        if (targheLoadingStatus && landingPageSection.style.display === 'block') {
            targheLoadingStatus.textContent = `Caricamento per ${targaSelezionataGlobalmente}...`;
        }
        let localData = null; let localDatiPeriziaTimestamp = null;
        const localJson = localStorage.getItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`);
        if (localJson) { try { localData = JSON.parse(localJson); localDatiPeriziaTimestamp = localData.timestamp ? new Date(localData.timestamp) : null; } catch (e) { localData = null; } }
        const sheetsPeriziaData = await fetchLatestPeriziaFromSheets(targaSelezionataGlobalmente);
        let sheetsRecordTimestamp = null; let sheetsDatiPerizia = null; let isSheetsDataCompleted = false;
        if (sheetsPeriziaData && sheetsPeriziaData.timestamp && sheetsPeriziaData.datiPerizia) {
            sheetsRecordTimestamp = new Date(sheetsPeriziaData.timestamp);
            sheetsDatiPerizia = sheetsPeriziaData.datiPerizia;
            isSheetsDataCompleted = sheetsPeriziaData.completata || false;
        }
        if (sheetsPeriziaData && sheetsRecordTimestamp && (!localDatiPeriziaTimestamp || sheetsRecordTimestamp > localDatiPeriziaTimestamp)) {
            try {
                if (!localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) {
                    localStorage.setItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`, JSON.stringify(sheetsDatiPerizia));
                    savePosizioneForTarga(targaSelezionataGlobalmente, sheetsPeriziaData.posizione || "");
                    saveUrgentStatusForTarga(targaSelezionataGlobalmente, sheetsPeriziaData.urgente || false);
                    if (isSheetsDataCompleted) markTargaAsCompleted(targaSelezionataGlobalmente);
                    else unmarkTargaAsCompleted(targaSelezionataGlobalmente);
                }
            } catch (e) { console.error("Errore salvataggio dati Sheets in LS:", e); }
        } else if (!localData && !localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) {
            resetChecklistForm();
        }
        if (localStorage.getItem(`${APP_PREFIX}deleted_${targaSelezionataGlobalmente}`)) { showView('landing'); return; }
        loadProgress(targaSelezionataGlobalmente);
        if (targheLoadingStatus && landingPageSection.style.display === 'block') {
            targheLoadingStatus.textContent = "Clicca targa per perizia:";
        }
        showView('checklist');
        if (targetSectionId && document.getElementById(targetSectionId + 'Section')) {
            showSection(targetSectionId);
        } else {
            const firstNav = Array.from(navButtons).find(b => b.dataset.target && !['backToListBtn', 'historyBtn', 'mainExitAppBtn'].includes(b.id));
            if (firstNav && firstNav.dataset.target) { showSection(firstNav.dataset.target); }
            else if (navButtons.length > 0 && navButtons[0].dataset.target) { showSection(navButtons[0].dataset.target); }
            else { showSection('remarketing'); }
        }
    }

    function populateSavedTargasList() {
        savedTargasListContainer.innerHTML = '';
        let hasSaves = false;
        const tempSavedTargas = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}data_`)) {
                const targa = key.substring(`${APP_PREFIX}data_`.length);
                if (targa && !tempSavedTargas.includes(targa)) {
                    tempSavedTargas.push(targa);
                }
            }
        }

        if (tempSavedTargas.length > 0) hasSaves = true;
        tempSavedTargas.sort();

        tempSavedTargas.forEach(targa => {
            const vehicleDetails = listaTargheCompleta.find(v => v.targa.toUpperCase() === targa.toUpperCase()) || { marca: '', modello: '', piazzale: '' };
            let displayText = targa;
            let details = [];
            if (vehicleDetails.marca) details.push(vehicleDetails.marca);
            if (vehicleDetails.modello) details.push(vehicleDetails.modello);
            if (vehicleDetails.piazzale) details.push(`(Piazzale: ${vehicleDetails.piazzale})`);
            if (details.length > 0) displayText += ` - ${details.join(' ')}`;

            const entryContainer = document.createElement('div');
            entryContainer.style.display = 'flex';
            entryContainer.style.justifyContent = 'space-between';
            entryContainer.style.alignItems = 'center';
            entryContainer.style.marginBottom = '8px';

            const mainTargaButton = document.createElement('button');
            mainTargaButton.classList.add('saved-targa-button');
            mainTargaButton.style.flexGrow = '1'; mainTargaButton.style.marginRight = '10px';
            mainTargaButton.dataset.targa = targa;
            mainTargaButton.addEventListener('click', async function() {
                if (localStorage.getItem(`${APP_PREFIX}deleted_${this.dataset.targa}`)) {
                    alert(`Targa ${this.dataset.targa} marcata per cancellazione server. Annulla marcatura per modificare.`); return;
                }
                await handleTargaSelectionAndSync(this.dataset.targa);
            });

            const markForDeleteBtn = document.createElement('button');
            markForDeleteBtn.classList.add('action-button');
            markForDeleteBtn.style.padding = '8px 10px'; markForDeleteBtn.style.fontSize = '0.85em';
            markForDeleteBtn.style.minWidth = '120px'; markForDeleteBtn.dataset.targa = targa;
            const isMarkedForDeletion = !!localStorage.getItem(`${APP_PREFIX}deleted_${targa}`);

            if (isMarkedForDeletion) {
                mainTargaButton.textContent = displayText + " (Marcata Del. Server)";
                mainTargaButton.style.opacity = '0.6';
                markForDeleteBtn.innerHTML = '<i class="fas fa-undo"></i> Annulla Marca';
                markForDeleteBtn.title = `Annulla marcatura cancellazione Sheets per ${targa}`;
                markForDeleteBtn.style.backgroundColor = '#ffc107'; markForDeleteBtn.style.borderColor = '#e0a800'; markForDeleteBtn.style.color = '#212529';
            } else {
                mainTargaButton.textContent = displayText;
                markForDeleteBtn.innerHTML = '<i class="fas fa-cloud-xmark"></i> Marca Del. Server';
                markForDeleteBtn.title = `Marca ${targa} per cancellazione Sheets`;
                markForDeleteBtn.style.backgroundColor = '#dc3545'; markForDeleteBtn.style.borderColor = '#c82333'; markForDeleteBtn.style.color = 'white';
            }

            markForDeleteBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                const targaToHandle = this.dataset.targa;
                const currentlyMarked = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaToHandle}`);
                if (currentlyMarked) {
                    if (confirm(`Annullare marcatura cancellazione Sheets per ${targaToHandle}?`)) {
                        localStorage.removeItem(`${APP_PREFIX}deleted_${targaToHandle}`);
                        alert(`Marcatura cancellazione Sheets annullata per ${targaToHandle}.`);
                        populateSavedTargasList();
                        if (typeof popolaTargheFiltrate === 'function' && landingPageSection.style.display === 'block') popolaTargheFiltrate();
                    }
                } else {
                    if (confirm(`Marcare ${targaToHandle} per cancellazione da Sheets?\nDati locali non modificati.`)) {
                        try {
                            localStorage.setItem(`${APP_PREFIX}deleted_${targaToHandle}`, new Date().toISOString());
                            alert(`${targaToHandle} marcata per cancellazione Sheets.`);
                            populateSavedTargasList();
                            if (typeof popolaTargheFiltrate === 'function' && landingPageSection.style.display === 'block') popolaTargheFiltrate();
                        } catch (e) { alert(`Errore marcatura ${targaToHandle} per cancellazione.`); }
                    }
                }
            });
            entryContainer.appendChild(mainTargaButton); entryContainer.appendChild(markForDeleteBtn);
            savedTargasListContainer.appendChild(entryContainer);
        });
        if (!hasSaves) { savedTargasListContainer.innerHTML = '<p style="text-align:center; color: #aaa;">Nessun salvataggio.</p>'; }
    }


    function clearAllSavedData() {
        if (confirm("ATTENZIONE! Cancellare TUTTI i dati salvati (perizie, foto, etc)? Azione IRREVERSIBILE.")) {
            let c = 0; const keysToRemove = [];
            for (let i=localStorage.length-1;i>=0;i--) {
                const k=localStorage.key(i); if (k.startsWith(APP_PREFIX)) { keysToRemove.push(k); }
            }
            keysToRemove.forEach(k => { localStorage.removeItem(k); c++; });
            openPhotoDB().then(db => {
                if (!db) { 
                    alert(`Errore: DB non inizializzato. ${c} elementi LS cancellati.`);
                    return;
                }
                const transaction = db.transaction(PHOTO_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(PHOTO_STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => {
                    alert(`${c} elementi LS e tutte le foto DB cancellati.`);
                    if(sheetFilterDropdown) sheetFilterDropdown.value = 'all';
                    localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all');
                    populateSavedTargasList();
                    if (typeof caricaEPopolaTarghe === 'function') caricaEPopolaTarghe();
                    if (typeof showView === 'function') showView('landing');
                    if (galleryPageSection.style.display === 'block') populatePhotoGrid(currentGalleryTargaFilter, currentGallerySectionFilter);
                };
                request.onerror = (event) => alert(`Errore cancellazione foto DB. ${c} elem LS cancellati.`);
            }).catch(err => alert("Errore DB per cancellazione foto. Solo dati LS cancellati. Dettagli: " + err));
        }
    }
    function setupSheetFilterDropdown() { if (!sheetFilterDropdown) return; const sources = ['all', ...new Set(listaTargheCompleta.map(item => item.piazzale).filter(p => p && p.trim() !== '').sort())]; sheetFilterDropdown.innerHTML = ''; sources.forEach(source => { const option = document.createElement('option'); option.value = source; option.textContent = source === 'all' ? 'Tutti gli Elenchi' : source; sheetFilterDropdown.appendChild(option); }); const savedPiazzaleFilter = localStorage.getItem(`${APP_PREFIX}selectedPiazzaleFilter`); if (savedPiazzaleFilter && sources.includes(savedPiazzaleFilter)) { sheetFilterDropdown.value = savedPiazzaleFilter; } else { sheetFilterDropdown.value = 'all'; localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all'); } sheetFilterDropdown.removeEventListener('change', handleSheetFilterChange); sheetFilterDropdown.addEventListener('change', handleSheetFilterChange); }
    function handleSheetFilterChange() { if (sheetFilterDropdown) { localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, sheetFilterDropdown.value); } popolaTargheFiltrate(); targaSelezionataGlobalmente = null; }

    function popolaTargheFiltrate() {
        const tEl = document.getElementById('targaListContainer');
        if (!tEl) return;
        tEl.innerHTML = '';
        const selectedSource = sheetFilterDropdown ? sheetFilterDropdown.value : 'all';
        let preliminaryFilteredList = selectedSource === 'all'
            ? [...listaTargheCompleta]
            : listaTargheCompleta.filter(item => item.piazzale === selectedSource);
        function getItemRank(item) {
            const targaUpper = item.targa.toUpperCase();
            const isMarkedForServerDelete = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`);
            if (isMarkedForServerDelete) return 0;
            const isUrgent = loadUrgentStatusForTarga(targaUpper);
            const isCompleted = isTargaCompleted(targaUpper);
            const localDataJson = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`);
            let hasData = false;
            if (localDataJson) { try { const parsedData = JSON.parse(localDataJson); hasData = Object.keys(parsedData).some(key => key !== 'timestamp' && parsedData[key] !== "" && parsedData[key] !== false && (!Array.isArray(parsedData[key]) || parsedData[key].length > 0) ); } catch (e) {} }
            if (isUrgent && !isCompleted) return 1;
            if (!isUrgent && !isCompleted && hasData) return 2;
            if (!isUrgent && !isCompleted && !hasData) return 3;
            if (!isUrgent && isCompleted) return 4;
            if (isUrgent && isCompleted) return 5;
            return 6;
        }
        preliminaryFilteredList.sort((a, b) => {
            const rankA = getItemRank(a); const rankB = getItemRank(b);
            if (rankA !== rankB) return rankA - rankB;
            return a.targa.localeCompare(b.targa);
        });
        const filteredList = preliminaryFilteredList;
        if (filteredList.length === 0) {
            tEl.innerHTML = '<p style="text-align:center; padding:10px; color: #aaa;">Nessuna targa per filtro.</p>';
            if(targheLoadingStatus) targheLoadingStatus.textContent = selectedSource === 'all' ? "Nessuna targa CSV." : `Nessuna targa per: ${selectedSource}.`;
            return;
        }
        filteredList.forEach((item) => {
            const targaUpper = item.targa.toUpperCase();
            const li = document.createElement('div'); li.classList.add('targa-list-item');
            const isMarkedForServerDeletionFlag = !!localStorage.getItem(`${APP_PREFIX}deleted_${targaUpper}`);
            if (isMarkedForServerDeletionFlag) li.classList.add('locally-deleted');
            const itemCompleted = isTargaCompleted(targaUpper);
            const localDataJson = localStorage.getItem(`${APP_PREFIX}data_${targaUpper}`);
            let hasData = false;
            if (localDataJson) { try { const parsed = JSON.parse(localDataJson); hasData = Object.keys(parsed).some(k => k !== 'timestamp' && parsed[k] !== "" && parsed[k] !== false ); } catch (e) {} }
            const isItemUrgent = loadUrgentStatusForTarga(targaUpper);
            if (!isMarkedForServerDeletionFlag) {
                if (isItemUrgent) {  li.classList.add('urgent-item'); if (itemCompleted) li.classList.add('completed'); }
                else if (itemCompleted) { li.classList.add('status-visto', 'completed'); }
                else if (hasData) { li.classList.add('status-parziale'); }
                else { li.classList.add('status-da-vedere'); }
            }
            const targaCol = document.createElement('span');
            targaCol.classList.add('targa-col', 'targa-col-targa');
            if (!isMarkedForServerDeletionFlag) {
                 targaCol.classList.add('clickable-targa');
                 targaCol.addEventListener('click', async function() {
                    const selectedTargaFromClick = this.dataset.targaValue;
                    if (selectedTargaFromClick) { await handleTargaSelectionAndSync(selectedTargaFromClick); }
                });
            } else { targaCol.title = "Marcata per cancellazione server"; }
            targaCol.textContent = item.targa || 'N/D'; targaCol.dataset.targaValue = targaUpper; li.appendChild(targaCol);
            const posizioneCol = document.createElement('span'); posizioneCol.classList.add('targa-col', 'targa-col-posizione');
            const posizioneInput = document.createElement('input'); posizioneInput.type = 'text'; posizioneInput.classList.add('posizione-input');
            posizioneInput.dataset.targa = targaUpper; posizioneInput.placeholder = 'Pos.'; posizioneInput.maxLength = 5;
            posizioneInput.value = loadPosizioneForTarga(targaUpper); posizioneInput.disabled = isMarkedForServerDeletionFlag;
            posizioneInput.addEventListener('mousedown', (e) => e.stopPropagation()); posizioneInput.addEventListener('click', (e) => e.stopPropagation());
            posizioneInput.addEventListener('focus', (e) => e.stopPropagation());
            posizioneInput.addEventListener('blur', function() { const newPosition = this.value.trim().toUpperCase(); if (newPosition !== loadPosizioneForTarga(this.dataset.targa)) { savePosizioneForTarga(this.dataset.targa, newPosition); this.style.backgroundColor = 'rgba(76, 175, 80, 0.2)'; setTimeout(() => { this.style.backgroundColor = ''; }, 1000); } });
            posizioneInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); this.blur(); }});
            posizioneCol.appendChild(posizioneInput); li.appendChild(posizioneCol);
            const urgenzaCol = document.createElement('span'); urgenzaCol.classList.add('targa-col', 'targa-col-urgenza');
            const urgenzaCheckbox = document.createElement('input'); urgenzaCheckbox.type = 'checkbox';
            urgenzaCheckbox.checked = isItemUrgent; urgenzaCheckbox.title = isItemUrgent ? "Togli urgenza" : "Marca urgente";
            urgenzaCheckbox.disabled = isMarkedForServerDeletionFlag;
            urgenzaCheckbox.addEventListener('mousedown', (e) => e.stopPropagation()); urgenzaCheckbox.addEventListener('click', (e) => e.stopPropagation());
            urgenzaCheckbox.addEventListener('change', function() { saveUrgentStatusForTarga(targaUpper, this.checked);  this.title = this.checked ? "Togli urgenza" : "Marca urgente"; popolaTargheFiltrate();  });
            urgenzaCol.appendChild(urgenzaCheckbox); li.appendChild(urgenzaCol);
            const marcaCol = document.createElement('span'); marcaCol.classList.add('targa-col', 'targa-col-marca'); marcaCol.textContent = item.marca || 'N/D'; li.appendChild(marcaCol);
            const modelloCol = document.createElement('span'); modelloCol.classList.add('targa-col', 'targa-col-modello'); modelloCol.textContent = item.modello || 'N/D'; li.appendChild(modelloCol);
            const piazzaleCol = document.createElement('span'); piazzaleCol.classList.add('targa-col', 'targa-col-piazzale'); piazzaleCol.textContent = item.piazzale || 'N/D'; li.appendChild(piazzaleCol);
            const actionsCol = document.createElement('span'); actionsCol.classList.add('targa-col', 'targa-col-actions');
            if (!isMarkedForServerDeletionFlag) {
                const delB = document.createElement('button'); delB.classList.add('action-button', 'delete-progress-btn');
                delB.dataset.targa = targaUpper; delB.title = `Cancella SOLO progressi e foto LOCALI per ${item.targa}`; delB.textContent = 'X';
                delB.addEventListener('click', function(event) {
                    event.stopPropagation(); const tDelUpper = this.dataset.targa;
                    const itemTargaForDisplay = listaTargheCompleta.find(v => v.targa.toUpperCase() === tDelUpper)?.targa || tDelUpper;
                    if (confirm(`Cancellare SOLO dati LOCALI (progressi/foto) per ${itemTargaForDisplay}?\nNON sarà marcata per cancellazione da server.`)) {
                        clearLocalDataForTarga(tDelUpper);
                        if (typeof popolaTargheFiltrate === 'function') popolaTargheFiltrate();
                        if (targaSelezionataGlobalmente && targaSelezionataGlobalmente.toUpperCase() === tDelUpper) {
                            targaSelezionataGlobalmente = null; showView('landing');
                        }
                    }
                });
                actionsCol.appendChild(delB);
            } else { actionsCol.textContent = 'DEL SRV'; actionsCol.title = 'Marcata cancellazione Sheets (gestisci da Cronistoria)'; }
            li.appendChild(actionsCol); tEl.appendChild(li);
        });
        if(targheLoadingStatus) targheLoadingStatus.textContent = "Clicca targa per perizia:";
    }


    async function caricaEPopolaTarghe() {
        if (targheLoadingStatus) targheLoadingStatus.textContent = "Caricamento dati server...";
        try {
            const r = await fetch(GOOGLE_SHEET_CSV_URL + `&nocache=${new Date().getTime()}`);
            if (!r.ok) { let e = `HTTP ${r.status}.`; if (r.status === 0) e = "Errore rete/CORS."; else if (r.status === 404) e = "File CSV non trovato."; else if (r.status === 403) e = "Accesso CSV negato."; throw new Error(e); }
            const csv = await r.text(); const lines = csv.split(/\r\n|\n|\r/).filter(l => l.trim() !== '');
            if (lines.length === 0) {
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessun dato CSV."; listaTargheCompleta = [];
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti Elenchi</option>';
                if (targaListContainer) targaListContainer.innerHTML = ''; return;
            }
            listaTargheCompleta = lines.map(l => { const p = l.split(','); return { targa: (p[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(), marca: (p[1] || '').trim().replace(/^"|"$/g, ''), modello: (p[2] || '').trim().replace(/^"|"$/g, ''), piazzale: (p[3] || '').trim().replace(/^"|"$/g, '') }; }).filter(i => i.targa && i.targa.length > 3);
            if (listaTargheCompleta.length === 0) {
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessuna targa valida CSV.";
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti Elenchi</option>';
                if (targaListContainer) targaListContainer.innerHTML = ''; return;
            }
            setupSheetFilterDropdown(); popolaTargheFiltrate();
        } catch (e) {
            if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore caricamento: ${e.message}.`;
            if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti Elenchi</option>';
            if (targaListContainer) targaListContainer.innerHTML = ''; listaTargheCompleta = [];
        }
    }
    function initSequentialAnimation() { const checklistContainerDiv = document.getElementById('checklistContainer'); if (!checklistContainerDiv || checklistContainerDiv.style.display === 'none') return; const activeSection = checklistContainerDiv.querySelector('.category-section.active'); if (!activeSection) return; activeSection.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me')); const allVisibleElementsInSection = Array.from( activeSection.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled), textarea:not(:disabled)') ).filter(el => { let current = el; while (current && current !== activeSection.parentElement) {  if (getComputedStyle(current).display === 'none' || getComputedStyle(current).visibility === 'hidden') return false; current = current.parentElement; } return el.offsetParent !== null;  }); const startIndex = allVisibleElementsInSection.findIndex(el => isInputDefault(el)); if (startIndex === -1 && allVisibleElementsInSection.length > 0) {  return; } if (allVisibleElementsInSection.length === 0) {   return; } const elementsToAnimate = allVisibleElementsInSection.slice(startIndex >= 0 ? startIndex : 0); if (elementsToAnimate.length === 0) return; let currentIndex = 0; let activeListeners = [];  function clearAllActiveAnimationListeners() { activeListeners.forEach(({element, type, handler}) => { element.removeEventListener(type, handler); element.classList.remove('animate-me');  }); activeListeners = []; } clearAllActiveAnimationListeners(); function animateNextElement() { if (currentIndex >= elementsToAnimate.length) { clearAllActiveAnimationListeners(); return; } const currentElement = elementsToAnimate[currentIndex]; if (!isInputDefault(currentElement)) {  currentIndex++; animateNextElement(); return; } currentElement.classList.add('animate-me'); currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); const onValueChange = (event) => { let processChange = false; if (event.type === 'change') { processChange = true; } else if (event.type === 'blur' && currentElement.tagName !== 'SELECT') {  processChange = true; }  if (processChange && !isInputDefault(currentElement)) {  currentElement.classList.remove('animate-me'); activeListeners = activeListeners.filter(listener => { if (listener.element === currentElement) { listener.element.removeEventListener(listener.type, listener.handler); return false;  } return true;  }); currentIndex++; setTimeout(animateNextElement, 50);  } }; currentElement.addEventListener('change', onValueChange); activeListeners.push({element: currentElement, type: 'change', handler: onValueChange}); if (currentElement.tagName === 'TEXTAREA' || currentElement.type === 'text') { currentElement.addEventListener('blur', onValueChange);  activeListeners.push({element: currentElement, type: 'blur', handler: onValueChange}); } } animateNextElement(); }

    function showSection(targetId) {
        document.querySelectorAll('#checklistContainer .animate-me').forEach(el => { el.classList.remove('animate-me'); });
        sections.forEach(s => s.classList.toggle('active', s.id === targetId + 'Section'));
        navButtons.forEach(b => { b.classList.toggle('active', b.dataset.target === targetId); });
        updateNavButtonColors();
        if (checklistContainer.style.display === 'block') {
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'none';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'flex';
            populateTargaSwitcherDropdown(); updateTargaDetailsDisplay(targaSelezionataGlobalmente);
            localStorage.setItem(LAST_ACTIVE_PERIZIA_PAGE_KEY, targetId);
        } else {
            if (mainTitleGlobal) mainTitleGlobal.style.display = 'block';
            if (targaDropdownContainer) targaDropdownContainer.style.display = 'none';
            if (targaDetailsDisplay) targaDetailsDisplay.textContent = '';
        }
        const targetSectionElement = document.getElementById(targetId + 'Section');
        if (targetSectionElement && Array.from(sections).includes(targetSectionElement) && targetId !== 'riepilogo') {
             setTimeout(initSequentialAnimation, 100);
        } else if (targetId === 'riepilogo') {
            generateSummary();
            if (downloadZipBtn && targaSelezionataGlobalmente) {
                downloadZipBtn.href = `https://192.168.1.154:8080/${targaSelezionataGlobalmente.toUpperCase()}.zip`;
                downloadZipBtn.style.display = 'inline-flex';
            } else if (downloadZipBtn) {
                downloadZipBtn.style.display = 'none';
            }
        } else {
             if (downloadZipBtn) downloadZipBtn.style.display = 'none';
        }
         window.scrollTo(0, 0);
    }

    function getSelectText(selectElementOrId) { const el = typeof selectElementOrId === 'string' ? document.getElementById(selectElementOrId) : selectElementOrId; if (el && el.tagName === 'SELECT' && el.value !== "") { if (el.selectedIndex >= 0 && el.options[el.selectedIndex]) { return el.options[el.selectedIndex].text; } return el.value;  } return "N/S";  }
    function generateSummary() { summaryContent.innerHTML = ''; let targa = targaSelezionataGlobalmente || "N/D"; function createSummaryItem(label, value, isAnomaly = false) { const itemDiv = document.createElement('div'); itemDiv.classList.add('summary-item'); if (isAnomaly) itemDiv.classList.add('summary-anomaly'); itemDiv.innerHTML = `<strong>${label}:</strong> ${value}`; return itemDiv; } summaryContent.appendChild(createSummaryItem("Targa", targa.toUpperCase())); if (targaSelezionataGlobalmente) { const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente); let marcaVeicolo = "N/D", modelloVeicolo = "N/D"; if (veicoloAttuale) { marcaVeicolo = veicoloAttuale.marca || "N/D"; modelloVeicolo = veicoloAttuale.modello || "N/D"; } summaryContent.appendChild(createSummaryItem("Marca", marcaVeicolo)); summaryContent.appendChild(createSummaryItem("Modello", modelloVeicolo)); summaryContent.appendChild(createSummaryItem("Posizione", loadPosizioneForTarga(targaSelezionataGlobalmente) || "N/D")); const isUrgentForSummary = loadUrgentStatusForTarga(targaSelezionataGlobalmente); summaryContent.appendChild(createSummaryItem("Urgente", isUrgentForSummary ? "Sì" : "No", isUrgentForSummary)); } else {  summaryContent.appendChild(createSummaryItem("Marca", "N/D")); summaryContent.appendChild(createSummaryItem("Modello", "N/D")); summaryContent.appendChild(createSummaryItem("Posizione", "N/D")); summaryContent.appendChild(createSummaryItem("Urgente", "N/D")); } summaryContent.innerHTML += `<h3>Remarketing:</h3>`; const tipoTrazioneValue = tipoTrazioneSelect ? tipoTrazioneSelect.value : ""; const isEV = tipoTrazioneValue === 'elettrico'; summaryContent.appendChild(createSummaryItem("Trazione Veicolo", getSelectText(tipoTrazioneSelect))); let equipaggiamento = getSelectText('tipo_equipaggiamento'), presenzaEquip = getSelectText('equipaggiamento_presenza'); let equipAnomalia = (equipaggiamento !== "N/S" && equipaggiamento !== "" && equipaggiamento !== "Seleziona..." && presenzaEquip === "Mancante"); summaryContent.appendChild(createSummaryItem("Equip. Vano Carico", equipaggiamento, equipAnomalia && presenzaEquip === "Mancante")); summaryContent.appendChild(createSummaryItem("Presenza Equip.", presenzaEquip, equipAnomalia)); let kmStato = getSelectText('stato_chilometri'); summaryContent.appendChild(createSummaryItem("Stato Chilometri", kmStato, kmStato === "Non rilevabili")); let cdcStato = getSelectText('stato_cdc'); summaryContent.appendChild(createSummaryItem("Stato CDC", cdcStato, cdcStato === "Mancante")); summaryContent.appendChild(createSummaryItem("Chiave con Telecomando", getSelectText('chiave_telecomando'), getSelectText('chiave_telecomando') === "Non Presente")); summaryContent.appendChild(createSummaryItem("Seconda Chiave", getSelectText('seconda_chiave'), getSelectText('seconda_chiave') === "Non Presente")); if (isEV) { summaryContent.innerHTML += `<h4>Dotazioni Veicolo Elettrico:</h4>`; let cavoRapidaText = getSelectText('cavo_ricarica_rapida'); let cavoDomesticaText = getSelectText('cavo_ricarica_domestica'); summaryContent.appendChild(createSummaryItem("Cavo Ricarica Rapida", cavoRapidaText, cavoRapidaText === "Non Presente")); summaryContent.appendChild(createSummaryItem("Cavo Ricarica Domestica", cavoDomesticaText, cavoDomesticaText === "Non Presente")); } summaryContent.innerHTML += `<h3>Pneumatici:</h3>`; const pneumaticiFields = [ { id: 'pneumatico_as', label: 'Ant. Sinistro' }, { id: 'pneumatico_ad', label: 'Ant. Destro' }, { id: 'pneumatico_pd', label: 'Post. Destro' }, { id: 'pneumatico_ps', label: 'Post. Sinistro' }]; pneumaticiFields.forEach(pneu => { summaryContent.appendChild(createSummaryItem(pneu.label, getSelectText(pneu.id), getSelectText(pneu.id) === "Non conforme")); }); summaryContent.innerHTML += `<h3>Danni/Verifiche:</h3>`; summaryContent.appendChild(createSummaryItem("Motore si Accende", getSelectText('motore_accende'), getSelectText('motore_accende') === 'Non OK')); summaryContent.appendChild(createSummaryItem("Stato Batteria", getSelectText('batteria_stato'), getSelectText('batteria_stato') === 'Non OK')); const noteDanniValue = document.getElementById('note_danni_verifiche') ? document.getElementById('note_danni_verifiche').value.trim() : ""; if (noteDanniValue) { const noteDiv = document.createElement('div'); noteDiv.classList.add('summary-item', 'summary-notes'); const strongNode = document.createElement('strong'); strongNode.textContent = "Note Danni/Verifiche: "; const contentDiv = document.createElement('div'); contentDiv.style.whiteSpace = 'pre-wrap'; contentDiv.style.paddingLeft = '10px'; contentDiv.textContent = noteDanniValue; noteDiv.appendChild(strongNode); noteDiv.appendChild(contentDiv); summaryContent.appendChild(noteDiv); } }

    async function fetchAllDataFromSheets() {
        if (!GOOGLE_SHEET_WEB_APP_URL) { return { success: false, message: "URL Web App non config.", data: [] }; }
        const fetchUrl = `${GOOGLE_SHEET_WEB_APP_URL}?nocache=${new Date().getTime()}`;
        try {
            const response = await fetch(fetchUrl, { method: 'GET', mode: 'cors' });
            if (!response.ok) { return { success: false, message: `Errore Sheets (${response.status}) recupero globale.`, data: [] }; }
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const result = await response.json();
                if (Array.isArray(result)) { return { success: true, data: result, message: "Dati recuperati." }; }
                else if (result && result.status === "success" && Array.isArray(result.data)) { return { success: true, data: result.data, message: result.message || "Dati recuperati."}; }
                else if (result && result.status === "notfound") { return { success: true, data: [], message: result.message || "Nessuna perizia."}; }
                else { return { success: false, message: "Formato risposta globale non valido.", data: [] }; }
            } else { return { success: false, message: "Errore formato risposta globale Sheets (non JSON).", data: [] }; }
        } catch (error) { return { success: false, message: "Errore rete recupero globale: " + error.message, data: [] }; }
    }

    async function syncAllLocalDataToSheets() {
        const originalSyncButtonText = syncToSheetsBtn.textContent;
        syncToSheetsBtn.disabled = true;
        let updatedFromSheetsCount = 0, localUpdatesFailedCount = 0;
        let sheetsDeletionsSuccessCount = 0, sheetsDeletionsFailedCount = 0;
        let localToSheetsSuccessCount = 0, localToSheetsErrorCount = 0;
        let errorMessages = [];

        syncToSheetsBtn.textContent = "Sinc (0/4 DelSheets)...";
        let deletionRequests = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}deleted_`)) deletionRequests.push(key.substring(`${APP_PREFIX}deleted_`.length));
        }
        if (deletionRequests.length > 0) {
            for (const targa of deletionRequests) {
                const deleteUrl = `${GOOGLE_SHEET_WEB_APP_URL}?action=deletePerizia&targa=${encodeURIComponent(targa)}`;
                try {
                    const response = await fetch(deleteUrl, { method: 'POST', mode: 'cors', body: JSON.stringify({targa: targa})});
                    const result = await response.json();
                    if (response.ok && result.status === "success") {
                        localStorage.removeItem(`${APP_PREFIX}deleted_${targa}`); sheetsDeletionsSuccessCount++;
                    } else {
                        sheetsDeletionsFailedCount++; errorMessages.push(`Targa ${targa} (Del Sheets): ${result.message || 'Errore'}`);
                    }
                } catch (error) {
                    sheetsDeletionsFailedCount++; errorMessages.push(`Targa ${targa} (Del Sheets Network): ${error.message}`);
                }
            }
        }

        syncToSheetsBtn.textContent = "Sinc (1/4 RecSheets)...";
        const sheetsResponse = await fetchAllDataFromSheets();
        if (!sheetsResponse.success) alert(`Errore recupero dati Sheets:\n${sheetsResponse.message}\nSinc incompleta.`);
        const allSheetsData = sheetsResponse.data || [];

        syncToSheetsBtn.textContent = "Sinc (2/4 AggLoc)...";
        if (allSheetsData.length > 0) {
            for (const sheetPerizia of allSheetsData) {
                if (!sheetPerizia || !sheetPerizia.targa || !sheetPerizia.timestamp || !sheetPerizia.datiPerizia || !sheetPerizia.datiPerizia.timestamp) continue;
                const targa = sheetPerizia.targa.toUpperCase();
                if (localStorage.getItem(`${APP_PREFIX}deleted_${targa}`)) continue;
                const localDataKey = `${APP_PREFIX}data_${targa}`;
                const localDataJSON = localStorage.getItem(localDataKey);
                let localDatiPeriziaTimestamp = null;
                if (localDataJSON) { try { const localDatiPeriziaObject = JSON.parse(localDataJSON); localDatiPeriziaTimestamp = localDatiPeriziaObject.timestamp ? new Date(localDatiPeriziaObject.timestamp) : null; } catch (e) {} }
                const sheetsRecordTimestamp = new Date(sheetPerizia.timestamp);
                if (!localDatiPeriziaTimestamp || sheetsRecordTimestamp > localDatiPeriziaTimestamp) {
                    try {
                        localStorage.setItem(localDataKey, JSON.stringify(sheetPerizia.datiPerizia));
                        if (sheetPerizia.hasOwnProperty('posizione')) savePosizioneForTarga(targa, sheetPerizia.posizione);
                        if (sheetPerizia.hasOwnProperty('urgente')) saveUrgentStatusForTarga(targa, sheetPerizia.urgente);
                        if (sheetPerizia.hasOwnProperty('completata')) {
                            if (sheetPerizia.completata) markTargaAsCompleted(targa); else unmarkTargaAsCompleted(targa);
                        }
                        updatedFromSheetsCount++;
                    } catch (e) { localUpdatesFailedCount++; }
                }
            }
        }
        syncToSheetsBtn.textContent = "Sinc (3/4 InvioSheets)...";
        let perizieLocaliKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith(`${APP_PREFIX}data_`)) {
                 const targaFromKey = key.substring(`${APP_PREFIX}data_`.length);
                 if (!localStorage.getItem(`${APP_PREFIX}deleted_${targaFromKey}`)) perizieLocaliKeys.push(key);
            }
        }
        if (perizieLocaliKeys.length === 0 && updatedFromSheetsCount === 0 && localUpdatesFailedCount === 0 && deletionRequests.length === 0) {
            alert("Nessuna operazione di sincronizzazione da eseguire.");
            syncToSheetsBtn.textContent = originalSyncButtonText; syncToSheetsBtn.disabled = false; return;
        }
        for (const key of perizieLocaliKeys) {
            const targa = key.substring(`${APP_PREFIX}data_`.length);
            let datiPeriziaSalvatiLocalmente;
            try { datiPeriziaSalvatiLocalmente = JSON.parse(localStorage.getItem(key)); }
            catch (e) { localToSheetsErrorCount++; errorMessages.push(`Targa ${targa} (Invio): Errore lettura dati locali.`); continue; }
            if (!datiPeriziaSalvatiLocalmente || !datiPeriziaSalvatiLocalmente.timestamp) {
                localToSheetsErrorCount++; errorMessages.push(`Targa ${targa} (Invio): Dati locali incompleti.`); continue;
            }
            const periziaDaInviare = {
                targa: targa, posizione: loadPosizioneForTarga(targa) || "", urgente: loadUrgentStatusForTarga(targa) || false,
                completata: isTargaCompleted(targa), datiPerizia: datiPeriziaSalvatiLocalmente, timestamp: datiPeriziaSalvatiLocalmente.timestamp
            };
            const result = await inviaPeriziaSingolaASheets(periziaDaInviare);
            if (result.success) {
                localToSheetsSuccessCount++;
                if (result.data && result.data.timestamp && new Date(result.data.timestamp) > new Date(datiPeriziaSalvatiLocalmente.timestamp)) {
                    datiPeriziaSalvatiLocalmente.timestamp = result.data.timestamp;
                    try { localStorage.setItem(key, JSON.stringify(datiPeriziaSalvatiLocalmente)); } catch (e) {}
                }
            } else { localToSheetsErrorCount++; errorMessages.push(`Targa ${targa} (Invio): ${result.message || 'Errore'}`); }
        }
        syncToSheetsBtn.textContent = "Sinc (4/4 Fine)";
        let finalMessage = `Sincronizzazione completata.\n\nCANCELLAZIONI (Locale -> Sheets):\n- ${sheetsDeletionsSuccessCount} cancellate da Sheets.\n`;
        if (sheetsDeletionsFailedCount > 0) finalMessage += `- ${sheetsDeletionsFailedCount} errori cancellazione Sheets.\n`;
        finalMessage += `\nAGGIORNAMENTI (Sheets -> Locale):\n- ${updatedFromSheetsCount} locali aggiornate/create da Sheets.\n`;
        if (localUpdatesFailedCount > 0) finalMessage += `- Errori aggiornamento locale: ${localUpdatesFailedCount}.\n`;
        finalMessage += `\nINVIO DATI (Locale -> Sheets):\n- ${localToSheetsSuccessCount} inviate/aggiornate con successo su Sheets.\n`;
        if (localToSheetsErrorCount > 0) finalMessage += `- ${localToSheetsErrorCount} errori durante invio.\n`;
        if (errorMessages.length > 0) finalMessage += "\n\nDETTAGLIO ERRORI:\n" + errorMessages.join("\n");
        alert(finalMessage);
        syncToSheetsBtn.textContent = originalSyncButtonText; syncToSheetsBtn.disabled = false;
        if (typeof popolaTargheFiltrate === 'function' && landingPageSection.style.display === 'block') popolaTargheFiltrate();
        if (typeof populateSavedTargasList === 'function' && historyPageSection.style.display === 'block') populateSavedTargasList();
    }

    function triggerMainExit() { if (mainExitAppBtn) mainExitAppBtn.click(); }

    function handleTouchStart(event) {
        if (imageLightbox && imageLightbox.style.display === 'flex') return;
        const targetElement = event.target;
        if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA' || targetElement.closest('.action-button') || targetElement.closest('.circle-button') || targetElement.closest('.page-action-button')) {
            return;
        }
        if (checklistContainer.style.display === 'block' || (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter)) {
             touchstartX = event.changedTouches[0].screenX;
             touchstartY = event.changedTouches[0].screenY;
        }
    }

    function handleTouchEnd(event) {
        if (imageLightbox && imageLightbox.style.display === 'flex') return;
        const targetElement = event.target;
         if (targetElement.tagName === 'INPUT' || targetElement.tagName === 'SELECT' || targetElement.tagName === 'TEXTAREA' || targetElement.closest('.action-button') || targetElement.closest('.circle-button') || targetElement.closest('.page-action-button')) {
            return;
        }
        if (checklistContainer.style.display === 'block' || (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter)) {
            touchendX = event.changedTouches[0].screenX;
            touchendY = event.changedTouches[0].screenY;
            handleSwipeGesture();
        }
    }

    async function handleSwipeGesture() {
        const deltaX = touchendX - touchstartX;
        const deltaY = touchendY - touchstartY;


        if (Math.abs(deltaX) < swipeThreshold && Math.abs(deltaY) < swipeThreshold) { return; }

        let currentViewElement = null;
        let sectionArrayForSwipe = sectionOrder; 
        let currentSectionIdInSwipe = null;
        let changeFunctionForSwipe = null;

        if (checklistContainer.style.display === 'block') {
            currentViewElement = checklistContainer;
            const activeSectionElement = checklistContainer.querySelector('.category-section.active');
            if (!activeSectionElement) return;
            currentSectionIdInSwipe = activeSectionElement.id.replace('Section', '');
            changeFunctionForSwipe = showSection; 
        } else if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter) {
            currentViewElement = galleryPageSection;
            const activeNavButton = mainPageNavButtons.querySelector('button.active');
            currentSectionIdInSwipe = activeNavButton ? activeNavButton.dataset.target : sectionArrayForSwipe[0];
            changeFunctionForSwipe = async (newSection) => {
                 await showGalleryPage(currentGalleryTargaFilter, newSection);
            };
        }

        if (!currentViewElement || !currentSectionIdInSwipe || !changeFunctionForSwipe) return;

        const currentIndexInSwipe = sectionArrayForSwipe.indexOf(currentSectionIdInSwipe);
        if (currentIndexInSwipe === -1) return;

        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) { 
            if (deltaX > 0) { 
                if (currentIndexInSwipe > 0) {
                    await changeFunctionForSwipe(sectionArrayForSwipe[currentIndexInSwipe - 1]);
                } else {
                    showSwipeEndIndicator('left');
                }
            } else { 
                if (currentIndexInSwipe < sectionArrayForSwipe.length - 1) {
                    await changeFunctionForSwipe(sectionArrayForSwipe[currentIndexInSwipe + 1]);
                } else {
                    showSwipeEndIndicator('right');
                }
            }
        }
    }

    // >>> FUNZIONE initializeApplicationViewAndLoadData CON I DEBUG LOG <<<
    async function initializeApplicationViewAndLoadData() {
        console.log("FN_DEBUG: Inizio initializeApplicationViewAndLoadData"); // DEBUG
        const preloader = document.getElementById('preloader');
        if (preloader) {
            preloader.style.display = 'flex'; preloader.classList.remove('hidden');
            preloader.style.opacity = '1'; preloader.style.visibility = 'visible';
            const loadingText = preloader.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = 'CARICAMENTO TARGHE...';
        }
        try {
            console.log("FN_DEBUG: Prima di openPhotoDB"); // DEBUG
            await openPhotoDB();
            console.log("FN_DEBUG: Dopo openPhotoDB"); // DEBUG
        }
        catch (error) {
            console.error("FN_DEBUG: Errore in openPhotoDB:", error); // DEBUG
            if (preloader) { const lt = preloader.querySelector('.loading-text'); if(lt) lt.textContent = 'ERRORE DB FOTO!';}
            alert("Errore inizializzazione DB foto."); return;
        }

        console.log("FN_DEBUG: Prima di caricaEPopolaTarghe"); // DEBUG
        await caricaEPopolaTarghe();
        console.log("FN_DEBUG: Dopo caricaEPopolaTarghe"); // DEBUG

        if (preloader) {
            console.log("FN_DEBUG: Prima di nascondere il preloader"); // DEBUG
            preloader.classList.add('hidden');
            setTimeout(() => { if (preloader) preloader.style.display = 'none'; }, 700);
            console.log("FN_DEBUG: Dopo aver nascosto il preloader"); // DEBUG
        }
        showView('landing');
        if (changelogModal && closeChangelogBtnModal && changelogList && changelogTitle) {
            const lastVersionSeen = localStorage.getItem('appVersionSeen');
            changelogTitle.textContent = `WebApp Perizie - Novità v${currentAppVersion}`;
            changelogList.innerHTML = latestChangesText;
            if (lastVersionSeen !== currentAppVersion) changelogModal.style.display = 'flex';
            closeChangelogBtnModal.onclick = () => {
                changelogModal.style.display = 'none';
                localStorage.setItem('appVersionSeen', currentAppVersion);
            };
        }
        console.log("FN_DEBUG: Fine initializeApplicationViewAndLoadData"); // DEBUG
    }


    document.addEventListener('DOMContentLoaded', () => {
        syncToSheetsBtn = document.createElement('button');
        syncToSheetsBtn.id = 'syncToSheetsBtn'; syncToSheetsBtn.classList.add('action-button');
        syncToSheetsBtn.textContent = 'Sincronizza';
        syncToSheetsBtn.style.backgroundColor = '#ffc107'; syncToSheetsBtn.style.borderColor = '#e0a800';
        syncToSheetsBtn.style.color = '#212529';
        const historyButton = document.getElementById('historyBtn');
        if (historyButton && historyButton.parentNode === utilityNavButtons) {
            utilityNavButtons.insertBefore(syncToSheetsBtn, historyButton.nextSibling);
        } else if (mainExitAppBtn && mainExitAppBtn.parentNode === utilityNavButtons) {
             utilityNavButtons.insertBefore(syncToSheetsBtn, mainExitAppBtn);
        } else if (utilityNavButtons.firstChild) {
            utilityNavButtons.insertBefore(syncToSheetsBtn, utilityNavButtons.firstChild);
        } else { utilityNavButtons.appendChild(syncToSheetsBtn); }
        syncToSheetsBtn.addEventListener('click', syncAllLocalDataToSheets);

        document.querySelectorAll('.fill-defaults-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.dataset.sectionid; const sectionTarget = sectionId.replace('Section', '');
                if (sectionId) {
                    fillSectionPositiveOrDefaults(sectionId);
                    if (saveProgress(targaSelezionataGlobalmente)) {
                        let currentSectionIndex = -1;
                        navButtons.forEach((nb, index) => { if (nb.dataset.target === sectionTarget) currentSectionIndex = index; });
                        if (currentSectionIndex !== -1 && currentSectionIndex < navButtons.length - 1) {
                            const nextNavButton = navButtons[currentSectionIndex + 1];
                            if (nextNavButton && nextNavButton.dataset.target) showSection(nextNavButton.dataset.target);
                        }
                    }
                }
            });
        });
        document.querySelectorAll('.reset-page-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.dataset.sectionid;
                if (sectionId) {
                    if (confirm(`Sei sicuro di voler azzerare tutti i campi in "${sectionId.replace('Section', '')}"?`)) {
                        resetSectionFields(sectionId);
                    }
                }
            });
        });

        if (tipoTrazioneSelect) tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);

        targaSwitcherDropdown.addEventListener('change', async function() {
            const nuovaTargaSelezionata = this.value;
            if (nuovaTargaSelezionata && nuovaTargaSelezionata.toUpperCase() !== (targaSelezionataGlobalmente ? targaSelezionataGlobalmente.toUpperCase() : null)) {
                this.disabled = true;
                if (galleryPageSection.style.display === 'block') {
                    const currentSectionForNewTarga = currentGallerySectionFilter || 'riepilogo'; 
                    targaSelezionataGlobalmente = nuovaTargaSelezionata.toUpperCase();
                    await showGalleryPage(targaSelezionataGlobalmente, currentSectionForNewTarga);
                } else {
                    let currentActiveSectionId = 'remarketing'; 
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    if (activeSectionElement && activeSectionElement.id) {
                        currentActiveSectionId = activeSectionElement.id.replace('Section', '');
                    }
                    await handleTargaSelectionAndSync(nuovaTargaSelezionata, currentActiveSectionId);
                }
                this.disabled = false;
            } else if (nuovaTargaSelezionata) { updateTargaDetailsDisplay(nuovaTargaSelezionata); }
        });

        if(backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if(historyBtn) historyBtn.addEventListener('click', () => showView('history'));
        if(clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', clearAllSavedData);
        if(backToLandingFromHistoryBtn) backToLandingFromHistoryBtn.addEventListener('click', () => showView('landing'));

        if(backToMainFromGalleryBtn) {
             backToMainFromGalleryBtn.addEventListener('click', () => {
                if (lastViewBeforeGallery === 'checklist' && currentGalleryTargaFilter && lastSectionBeforeGallery) {
                    if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) {
                         targaSelezionataGlobalmente = currentGalleryTargaFilter;
                         loadProgress(targaSelezionataGlobalmente);
                    }
                    showView('checklist'); showSection(lastSectionBeforeGallery);
                } else { showView('landing'); }
            });
        }

        if(saveAndReturnBtn) saveAndReturnBtn.addEventListener('click', handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button=>button.addEventListener('click',handleSaveAndNext));

        if (headerExitBtn) headerExitBtn.addEventListener('click', () => triggerMainExit());
        if (headerPhotosBtn) {
            headerPhotosBtn.addEventListener('click', async () => {
                let targaForGallery = null;
                let sectionKeyForGallery = null;

                if (cameraPageSection.style.display === 'flex') {
                    targaForGallery = (lastViewBeforeCamera === 'checklist' || lastViewBeforeCamera === 'gallery') ? targaSelezionataGlobalmente : null;
                    sectionKeyForGallery = (lastViewBeforeCamera === 'checklist' || lastViewBeforeCamera === 'gallery') ? lastSectionBeforeCamera : null;
                    returnFromCamera(); 
                    setTimeout(async () => await showGalleryPage(targaForGallery, sectionKeyForGallery || 'riepilogo'), 50);
                } else if (checklistContainer.style.display === 'block' && targaSelezionataGlobalmente) {
                    targaForGallery = targaSelezionataGlobalmente;
                    const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                    sectionKeyForGallery = activeSectionElement ? activeSectionElement.id.replace('Section', '') : 'riepilogo';
                    await showGalleryPage(targaForGallery, sectionKeyForGallery);
                } else if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter){
                    await showGalleryPage(currentGalleryTargaFilter, currentGallerySectionFilter || 'riepilogo');
                } else { 
                    await showGalleryPage(null, null);
                }
            });
        }
        if (headerPeriziaBtn) {
            headerPeriziaBtn.addEventListener('click', async () => {
                if (cameraPageSection.style.display === 'flex') {
                    returnFromCamera();
                    if (lastViewBeforeCamera === 'checklist' && targaSelezionataGlobalmente && lastSectionBeforeCamera) {
                         setTimeout(() => { 
                            showView('checklist');
                            showSection(lastSectionBeforeCamera);
                        }, 50);
                    } else if (targaSelezionataGlobalmente) {
                         setTimeout(() => {
                            const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY) || 'riepilogo';
                            handleTargaSelectionAndSync(targaSelezionataGlobalmente, lastActivePage);
                        }, 50);
                    } else {
                        setTimeout(() => showView('landing'), 50);
                    }
                } else if (galleryPageSection.style.display === 'block') {
                    if (lastViewBeforeGallery === 'checklist' && currentGalleryTargaFilter && lastSectionBeforeGallery) {
                        if (targaSelezionataGlobalmente !== currentGalleryTargaFilter) {
                            targaSelezionataGlobalmente = currentGalleryTargaFilter; loadProgress(targaSelezionataGlobalmente);
                        }
                        showView('checklist'); showSection(lastSectionBeforeGallery);
                    } else if (targaSelezionataGlobalmente){ 
                        const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY) || 'riepilogo';
                        await handleTargaSelectionAndSync(targaSelezionataGlobalmente, lastActivePage);
                    }
                    else { showView('landing'); }
                } else if (targaSelezionataGlobalmente) {
                    const lastActivePage = localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY);
                    const targetSection = (lastActivePage && document.getElementById(lastActivePage + 'Section')) ? lastActivePage : 'riepilogo';
                    if (checklistContainer.style.display !== 'block' || targaSwitcherDropdown.value.toUpperCase() !== targaSelezionataGlobalmente.toUpperCase()) {
                        await handleTargaSelectionAndSync(targaSelezionataGlobalmente, targetSection);
                    } else { showSection(targetSection); }
                } else { showView('landing'); }
            });
        }

        // MODIFIED headerCameraBtn event listener
        if (headerCameraBtn) {
            headerCameraBtn.addEventListener('click', () => {
                if (cameraPageSection.style.display === 'flex') { // If camera is already open
                    returnFromCamera();
                } else { // If opening camera
                    // Determine and set lastViewBeforeCamera and lastSectionBeforeCamera HERE
                    if (galleryPageSection.style.display === 'block') {
                        lastViewBeforeCamera = 'gallery';
                        lastSectionBeforeCamera = currentGallerySectionFilter;
                    } else if (checklistContainer.style.display === 'block') {
                        lastViewBeforeCamera = 'checklist';
                        const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                        lastSectionBeforeCamera = activeSectionElement ? activeSectionElement.id.replace('Section', '') : null;
                    } else if (historyPageSection.style.display === 'block') {
                        lastViewBeforeCamera = 'history';
                        lastSectionBeforeCamera = null;
                    } else { // Default if no specific section is active (e.g., on landing page)
                        lastViewBeforeCamera = 'landing';
                        lastSectionBeforeCamera = null;
                    }
                    showView('camera'); // This will call showCameraPage, which now uses the pre-set globals
                }
            });
        }

        if (captureBtn) captureBtn.addEventListener('click', capturePhoto);
        if (closeCameraBtn) closeCameraBtn.addEventListener('click', returnFromCamera);

        navButtons.forEach(b => b.addEventListener('click', async function() {
            const targetId = this.dataset.target;
            if (galleryPageSection.style.display === 'block' && currentGalleryTargaFilter) {
                currentGallerySectionFilter = targetId;
                await showGalleryPage(currentGalleryTargaFilter, currentGallerySectionFilter);
            } else if (checklistContainer.style.display === 'block' || (!targaSelezionataGlobalmente && landingPageSection.style.display === 'block')) {
                showSection(targetId);
            } else if (targaSelezionataGlobalmente) { 
                await handleTargaSelectionAndSync(targaSelezionataGlobalmente, targetId);
            }
        }));


        if (closeLightboxBtnElem) closeLightboxBtnElem.addEventListener('click', closeImageLightbox);
        if (imageLightbox) {
            imageLightbox.addEventListener('click', function(event) { if (event.target === imageLightbox) closeImageLightbox(); });
            imageLightbox.addEventListener('touchstart', handleLightboxTouchStart, { passive: false });
            imageLightbox.addEventListener('touchend', handleLightboxTouchEnd, { passive: true });
        }
        const mainWrapper = document.getElementById('mainContentWrapper');
        if (mainWrapper) {
            mainWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
            mainWrapper.addEventListener('touchend', handleTouchEnd, { passive: true });
        }
        if (galleryPageSection) {
            galleryPageSection.addEventListener('touchstart', handleGalleryGridTouchStart, { passive: true });
            galleryPageSection.addEventListener('touchmove', handleGalleryGridTouchMove, { passive: false });
        }
        initializeApplicationViewAndLoadData(); // Chiamata alla funzione di inizializzazione con i log
        if (mainExitAppBtn) {
            mainExitAppBtn.addEventListener('click', () => {
                const exitCurtain = document.getElementById('exit-curtain');
                const mainContentWrapper = document.getElementById('mainContentWrapper');
                const pageHeader = document.getElementById('pageHeaderContainer');
                const bottomNav = document.getElementById('bottomNavCircles');
                if (exitCurtain) {
                    if (mainContentWrapper) mainContentWrapper.style.display = 'none';
                    if (pageHeader) pageHeader.style.display = 'none';
                    if (bottomNav) bottomNav.style.display = 'none';
                    if (cameraPageSection && cameraPageSection.style.display === 'flex') { 
                        if (currentCameraStream) { currentCameraStream.getTracks().forEach(track => track.stop()); currentCameraStream = null; if(cameraStreamElement) cameraStreamElement.srcObject = null; }
                        cameraPageSection.style.display = 'none';
                    }
                    document.body.style.paddingTop = '0px';
                    document.body.style.paddingBottom = '0px';
                    const exitLoadingText = exitCurtain.querySelector('.loading-text');
                    const barContainer = exitCurtain.querySelector('.loader-bar-container');
                    const defaultCloseText = "CHIUSURA IN CORSO..."; const glitchText = "ERRORE DI SISTEMA...";
                    exitCurtain.classList.remove('glitching', 'flash-out-effect');
                    if (exitLoadingText) { exitLoadingText.textContent = defaultCloseText; exitLoadingText.style.animation = 'textGlow 1.8s infinite alternate ease-in-out'; exitLoadingText.style.color = '#ff8787'; exitLoadingText.style.textShadow = ''; }
                    exitCurtain.setAttribute('data-text', defaultCloseText);
                    if (barContainer) barContainer.style.display = 'flex';
                    exitCurtain.classList.add('visible-no-transition'); exitCurtain.style.display = 'flex';
                    setTimeout(() => {
                        exitCurtain.classList.add('glitching');
                        if (exitLoadingText) { exitLoadingText.textContent = glitchText; exitLoadingText.style.animation = ''; }
                        exitCurtain.setAttribute('data-text', glitchText);
                        setTimeout(() => {
                            exitCurtain.classList.remove('glitching');
                            if (exitLoadingText) { exitLoadingText.textContent = 'Applicazione terminata.'; exitLoadingText.style.animation = 'none';  exitLoadingText.style.color = '#FFFFFF';  exitLoadingText.style.textShadow = 'none'; }
                            if (barContainer) barContainer.style.display = 'none';
                            setTimeout(() => {
                                exitCurtain.classList.add('flash-out-effect');
                                setTimeout(() => {
                                    const macrodroidUrl = 'https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi';
                                    fetch(macrodroidUrl, { method: 'GET', mode: 'no-cors' }).catch(error => console.error('Errore Macrodroid:', error));
                                }, 500);
                            }, 700);
                        }, 800);
                    }, 800);
                }
            });
        }
    });
</script>
