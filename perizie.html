<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perizia Veicolo</title>
    <style>
        /* Preloader & Exit Curtain Styles */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75); /* Sfondo semitrasparente */
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 1;
            visibility: visible;
        }
        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-out, visibility 0.7s ease-out;
        }

        #exit-curtain {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            z-index: 99998; /* Leggermente sotto il preloader se entrambi attivi, ma non dovrebbero */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in, visibility 0.5s ease-in;
        }

        #exit-curtain.visible-no-transition {
            opacity: 1;
            visibility: visible;
            transition: none;
        }

        .loader-bar-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .loader-bar {
            width: 15px;
            height: 70px;
            background-color: #007bff;
            animation: barPulse 1.2s infinite ease-in-out;
            box-shadow: 0 0 8px #007bff, 0 0 15px #00aeff;
            border-radius: 3px;
        }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }

        #exit-curtain:not(.glitching):not(.flash-out-effect) .loader-bar {
            animation-direction: reverse;
        }
        #exit-curtain.glitching:not(.flash-out-effect) .loader-bar {
            animation-direction: normal; 
        }
        
        @keyframes barPulse {
            0%, 100% { transform: scaleY(0.3); opacity: 0.6; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        #preloader .loading-text, 
        #exit-curtain .loading-text {
            font-size: 1.6em;
            letter-spacing: 1px;
        }

        #preloader .loading-text {
            color: #00aeff;
            animation: textGlow 1.8s infinite alternate ease-in-out;
        }
        
        #exit-curtain .loading-text {
             color: #ff8787; 
        }

        @keyframes textGlow {
          from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 0.8;}
          to   { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; opacity: 1;}
        }

        #exit-curtain.glitching .loading-text {
            animation: glitchText 0.4s infinite steps(1, end), textGlow 1.8s infinite alternate ease-in-out; /* Durata glitchText ridotta */
            color: #ff3030 !important;
            position: relative;
            z-index: 10;
        }

        #exit-curtain.glitching::before,
        #exit-curtain.glitching::after {
            content: attr(data-text);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: auto;
            padding: 0 20px;
            text-align: center;
            font-size: 1.6em;
            letter-spacing: 1px;
            background: #000000;
            overflow: hidden;
            clip-path: inset(50% 50% 50% 50%);
            z-index: 5;
        }

        #exit-curtain.glitching::before {
            color: #00ffff;
            animation: glitchEffect 0.2s infinite linear alternate-reverse; /* Leggermente più veloce */
        }

        #exit-curtain.glitching::after {
            color: #ff00ff;
            animation: glitchEffect 0.15s infinite linear alternate-reverse, glitchSkew 0.3s infinite linear alternate; /* Leggermente più veloce */
            animation-delay: -0.05s;
        }

        @keyframes glitchEffect {
            0%    { clip-path: inset(40% 0 30% 0); transform: translate(-50.5%, -50.1%) skewX(5deg); opacity: 0.8; }
            10%   { clip-path: inset(20% 0 70% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.7; }
            20%   { clip-path: inset(10% 0 55% 0); transform: translate(-49.8%, -50.2%) skewX(-3deg); opacity: 0.9; }
            30%   { clip-path: inset(50% 0 50% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            40%   { clip-path: inset(60% 0 10% 0); transform: translate(-50.2%, -49.9%) skewY(2deg); opacity: 1; }
            50%   { clip-path: inset(80% 0  5% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.75; }
            60%   { clip-path: inset(25% 0 40% 0); transform: translate(-50.1%, -50.3%) skewX(4deg); opacity: 0.85; }
            70%   { clip-path: inset(15% 0 75% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.9; }
            80%   { clip-path: inset(50% 0 20% 0); transform: translate(-49.9%, -49.8%) skewY(-3deg); opacity: 1; }
            90%   { clip-path: inset(70% 0 10% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; }
            100%  { clip-path: inset(35% 0 45% 0); transform: translate(-50.3%, -50.0%) skewX(-2deg); opacity: 0.8; }
        }

        @keyframes glitchSkew {
            0%   { transform: translate(-50%, -50%) skew(-5deg, -2deg); }
            100% { transform: translate(-50%, -50%) skew(5deg, 2deg); }
        }

        @keyframes glitchText { /* Keyframes ridotti per animazione più breve se glitchText è usato a 0.4s */
            0%, 100% { text-shadow: 0 0 2px red, 0 0 3px blue; transform: translateX(0) translateY(0) skewX(0deg); opacity: 1;}
            25% { text-shadow: 1px 1px 2px red, -1px -1px 3px blue; transform: translateX(-1px) translateY(1px) skewX(3deg); opacity: 0.8;}
            50% { text-shadow: -1px 0 2px red, 1px 1px 3px blue; transform: translateX(2px) translateY(-1px) skewX(-2deg); opacity: 1;}
            75% { text-shadow: 0 -1px 2px red, -1px 1px 3px blue; transform: translateX(-1px) translateY(1px) skewX(1deg); opacity: 0.7;}
        }

        #exit-curtain.flash-out-effect .loading-text {
            color: #FFFFFF !important; 
            text-shadow: none !important;
            animation: textFlashOut 0.4s forwards ease-out; /* Durata flash ridotta a 0.4s */
            transform-origin: center center;
        }

        @keyframes textFlashOut {
            0% {
                opacity: 1;
                transform: scale(1);
                text-shadow: 0 0 5px rgba(255,255,255,0.5);
            }
            40% { 
                opacity: 1;
                transform: scale(1.15); 
                color: #FFFFE0 !important; 
                text-shadow: 0 0 15px #FFFFFF, 
                             0 0 30px #FFFFFF, 
                             0 0 45px #FFFFE0, 
                             0 0 60px #FFFF99; 
            }
            90% { 
                opacity: 0.5; 
                transform: scale(1.05);
            }
            100% { 
                opacity: 0;
                transform: scale(0.5); 
                text-shadow: none;
                color: transparent !important;
            }
        }

        /* ... (resto degli stili CSS come da versione precedente) ... */
        .header-circles { display: flex; justify-content: space-around; align-items: center; width: 100%; padding: 8px 0; box-sizing: border-box; }
        .circle { width: 1.5cm; height: 1.5cm; background-color: #ffffff; border-radius: 50%; flex-shrink: 0; opacity: 0.8; }
        body { font-family: sans-serif; line-height: 1.6; margin: 0; background-color: #1e1e1e; color: #f0f0f0; transition: padding-top 0.3s ease; }
        .content-wrapper { padding: 20px; }
        h1, h2 { text-align: center; color: #ffffff; }
        h1#mainTitleGlobal { line-height: 1.2; margin-bottom: 10px; margin-top: 5px; font-size: 1.6em;}
        h2.section-title { color: #cccccc; border-bottom: 1px solid #444444; padding-bottom: 5px; margin-top: 30px; text-align: left; }
        /* ... e così via per tutti gli altri stili ... */
        #sheetFilterDropdown { padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; min-width: 250px; vertical-align: middle; }
        .animate-me { animation: pulseHighlight 1.5s infinite alternate; outline: 2px solid rgba(0, 123, 255, 0.0); transition: outline 0.3s ease, box-shadow 0.3s ease; }
        @keyframes pulseHighlight { from { outline: 2px solid rgba(0, 123, 255, 0.7); box-shadow: 0 0 5px rgba(0, 123, 255, 0.5), 0 0 8px rgba(0, 123, 255, 0.3) inset; } to   { outline: 3px solid rgba(0, 150, 255, 1); box-shadow: 0 0 10px rgba(0, 150, 255, 0.8), 0 0 12px rgba(0, 150, 255, 0.5) inset; } }
        input[type="checkbox"].animate-me, select.animate-me { position: relative; z-index: 1; }
        @media (max-width: 768px) { /* ... stili responsive ... */ }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="exit-curtain" data-text="CHIUSURA IN CORSO...">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">CHIUSURA IN CORSO...</div>
    </div>

    <div id="pageHeaderContainer">
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>
        <div id="navButtons">
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
            <div id="utilityNavButtons">
                <button id="backToListBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe</button>
                <button id="historyBtn" class="action-button" style="background-color: #17a2b8; border-color: #117a8b;">Salvataggi</button>
                <button id="exitAppBtn" class="action-button" style="background-color: #dc3545; border-color: #c82333;">Esci</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;">
            <h2 style="margin-top: 10px;">Seleziona Veicolo da Periziare</h2>
            <div id="targaListContainer"></div>
        </div>
        <div id="checklistContainer" style="display: none;">
            </div>
        <div id="historyPageSection" style="display: none;">
            </div>
    </div>
<script>
    // Variabili globali (come prima)
    const landingPageSection = document.getElementById('landingPageSection');
    // ... altre variabili ...
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';

    // Funzioni (handleTrazioneChange, savePosizioneForTarga, ecc. come prima)
    // ... (tutte le funzioni di helper e gestione dati) ...
    function handleTrazioneChange() { /* ... */ }
    function savePosizioneForTarga(targa, posizione) { /* ... */ }
    // ... e tutte le altre funzioni fino a caricaEPopolaTarghe ...

    async function caricaEPopolaTarghe() {
        const preloader = document.getElementById('preloader');
        // Riferimenti aggiunti per targheLoadingStatus e targaListContainer per sicurezza
        const targheLoadingStatus = document.getElementById('targheLoadingStatus'); // Assicurati che questo ID esista se usi lo status
        const targaListContainer = document.getElementById('targaListContainer');
        const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');


        if (targheLoadingStatus) targheLoadingStatus.textContent = "Caricamento dati dal server...";

        try {
            const r = await fetch(GOOGLE_SHEET_CSV_URL);
            if (!r.ok) {
                let e = `HTTP ${r.status}.`;
                if (r.status === 0) e = "Errore di rete o CORS.";
                else if (r.status === 404) e = "File CSV non trovato (404).";
                else if (r.status === 403) e = "Accesso al file CSV negato (403).";
                throw new Error(e);
            }
            const csv = await r.text();
            const lines = csv.split(/\r\n|\n|\r/).filter(l => l.trim() !== '');
            
            if (lines.length === 0) {
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessun dato nel file CSV.";
                listaTargheCompleta = []; 
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>';
                if (targaListContainer) targaListContainer.innerHTML = '';
                return; 
            }

            listaTargheCompleta = lines.map(l => {
                const p = l.split(',');
                return {
                    targa: (p[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(),
                    marca: (p[1] || '').trim().replace(/^"|"$/g, ''),
                    modello: (p[2] || '').trim().replace(/^"|"$/g, ''),
                    piazzale: (p[3] || '').trim().replace(/^"|"$/g, ''),
                    isUrgent: (p[4] || '').trim().toUpperCase() === 'U' // MODIFICA APPORTATA QUI
                };
            }).filter(i => i.targa && i.targa.length > 3);

            if (listaTargheCompleta.length === 0) {
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessuna targa valida trovata nel file CSV.";
                 if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>';
                if (targaListContainer) targaListContainer.innerHTML = '';
                return; 
            }
            
            setupSheetFilterDropdown(); // Assicurati che questa funzione sia definita
            popolaTargheFiltrate(); // Assicurati che questa funzione sia definita

        } catch (e) {
            console.error("Errore caricamento/popolamento targhe:", e);
            if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore caricamento: ${e.message}. Riprova.`;
            if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti gli Elenchi</option>';
            if (targaListContainer) targaListContainer.innerHTML = '';
             listaTargheCompleta = []; 
        } finally {
            if (preloader) {
                preloader.classList.add('hidden');
                setTimeout(() => {
                    if (preloader) preloader.style.display = 'none';
                }, 700); 
            }
        }
    }
    // ... (altre funzioni come initSequentialAnimation, showSection, ecc.)
    // Definizione delle funzioni setupSheetFilterDropdown e popolaTargheFiltrate (esempio base se non presenti)
    function setupSheetFilterDropdown() {
        // Implementazione di esempio, se necessario
        // Questa funzione dovrebbe popolare il dropdown per filtrare le targhe,
        // se non è già presente nel codice originale.
        // console.log("setupSheetFilterDropdown chiamata");
        // const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
        // if (sheetFilterDropdown) {
        //     // Logica per popolare il dropdown basata su listaTargheCompleta
        //     // ad es. creando opzioni per ogni 'piazzale' unico
        // }
    }

    function popolaTargheFiltrate() {
        // Implementazione di esempio, se necessario
        // Questa funzione dovrebbe mostrare le targhe nel targaListContainer,
        // potenzialmente filtrate dal sheetFilterDropdown.
        // console.log("popolaTargheFiltrate chiamata");
        // const targaListContainer = document.getElementById('targaListContainer');
        // if (targaListContainer) {
        //     targaListContainer.innerHTML = ''; // Pulisce la lista precedente
        //     listaTargheCompleta.forEach(item => {
        //         const div = document.createElement('div');
        //         div.textContent = `${item.targa} - ${item.marca} ${item.modello} ${item.isUrgent ? '(URGENTE)' : ''}`;
        //         // Aggiungere event listener per selezionare la targa, ecc.
        //         targaListContainer.appendChild(div);
        //     });
        // }
    }
    
    function showView(viewName) {
        // Esempio di funzione showView se non definita globalmente
        // console.log(`Navigazione a: ${viewName}`);
        const landingPageSection = document.getElementById('landingPageSection');
        const checklistContainer = document.getElementById('checklistContainer');
        const historyPageSection = document.getElementById('historyPageSection');

        if (landingPageSection) landingPageSection.style.display = 'none';
        if (checklistContainer) checklistContainer.style.display = 'none';
        if (historyPageSection) historyPageSection.style.display = 'none';

        if (viewName === 'landing' && landingPageSection) {
            landingPageSection.style.display = 'block';
        } else if (viewName === 'checklist' && checklistContainer) {
            checklistContainer.style.display = 'block';
        } else if (viewName === 'history' && historyPageSection) {
            historyPageSection.style.display = 'block';
        }
    }

    function clearAllSavedData() {
        // Esempio di funzione
        console.log("Cancellazione di tutti i dati salvati...");
        // Logica per cancellare i dati da localStorage o IndexedDB
    }
    
    function handleSavePeriziaAndReturn() {
        // Esempio di funzione
        console.log("Salvataggio perizia e ritorno all'elenco...");
        // Logica per salvare i dati e poi chiamare showView('landing')
    }

    function handleSaveAndNext() {
        // Esempio di funzione
        console.log("Salvataggio e passaggio alla sezione successiva...");
        // Logica per salvare i dati della sezione corrente e navigare alla prossima
    }


    document.addEventListener('DOMContentLoaded', () => {
        const preloader = document.getElementById('preloader');
        const exitAppBtn = document.getElementById('exitAppBtn');
        const tipoTrazioneSelect = document.getElementById('tipo_trazione'); // Assicurati che l'ID sia corretto

        // Setup event listeners e stati iniziali
        if (tipoTrazioneSelect) { // Controllo aggiunto
            tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);
            handleTrazioneChange(); // Chiamata iniziale se l'elemento esiste
        } else {
            // console.warn("Elemento select 'tipo_trazione' non trovato."); // Avviso se non trovato
        }


        if(document.getElementById('backToListBtn')) document.getElementById('backToListBtn').addEventListener('click', () => showView('landing'));
        if(document.getElementById('historyBtn')) document.getElementById('historyBtn').addEventListener('click', () => showView('history'));
        if(document.getElementById('clearAllProgressBtn')) document.getElementById('clearAllProgressBtn').addEventListener('click', clearAllSavedData);
        if(document.getElementById('backToLandingFromHistoryBtn')) document.getElementById('backToLandingFromHistoryBtn').addEventListener('click', () => showView('landing'));
        if(document.getElementById('saveAndReturnBtn')) document.getElementById('saveAndReturnBtn').addEventListener('click',handleSavePeriziaAndReturn);
        
        const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
        saveAndNextButtons.forEach(button=>button.addEventListener('click',handleSaveAndNext));


        async function initializeApplicationViewAndLoadData() {
            showView('landing'); 

            if (preloader) { 
                preloader.style.display = 'flex';
                preloader.classList.remove('hidden');
                preloader.style.opacity = '1'; 
                preloader.style.visibility = 'visible';
                const loadingText = preloader.querySelector('.loading-text');
                if (loadingText) loadingText.textContent = 'CARICAMENTO ELENCO...';
            }
            await caricaEPopolaTarghe(); 
        }

        initializeApplicationViewAndLoadData();

        if (exitAppBtn) {
            exitAppBtn.addEventListener('click', () => {
                const exitCurtain = document.getElementById('exit-curtain');
                const mainContentWrapper = document.getElementById('mainContentWrapper');
                const pageHeader = document.getElementById('pageHeaderContainer');

                if (exitCurtain) {
                    if (mainContentWrapper) mainContentWrapper.style.display = 'none';
                    if (pageHeader) pageHeader.style.display = 'none';
                    document.body.style.paddingTop = '0px';

                    const exitLoadingText = exitCurtain.querySelector('.loading-text');
                    const barContainer = exitCurtain.querySelector('.loader-bar-container');
                    
                    const durationNormal = 800;     // 0.8s
                    const durationGlitch = 400;     // 0.4s
                    const durationFlashOut = 400;   // 0.4s (deve corrispondere alla durata CSS di textFlashOut)

                    const textNormal = "CHIUSURA IN CORSO...";
                    const textGlitch = "ERRORE DI SISTEMA..."; // Questo testo lampeggerà

                    // --- Fase 1: Animazione normale ---
                    exitCurtain.classList.remove('glitching', 'flash-out-effect');
                    if (exitLoadingText) {
                        exitLoadingText.textContent = textNormal;
                        exitLoadingText.style.animation = 'textGlow 1.8s infinite alternate ease-in-out';
                        exitLoadingText.style.color = '#ff8787'; 
                        exitLoadingText.style.textShadow = ''; 
                    }
                    exitCurtain.setAttribute('data-text', textNormal);
                    if (barContainer) barContainer.style.display = 'flex'; 

                    exitCurtain.classList.add('visible-no-transition');
                    exitCurtain.style.display = 'flex';

                    setTimeout(() => {
                        // --- Fase 2: Effetto glitch ---
                        exitCurtain.classList.add('glitching');
                        if (exitLoadingText) {
                           exitLoadingText.textContent = textGlitch;
                           exitLoadingText.style.animation = ''; 
                        }
                        exitCurtain.setAttribute('data-text', textGlitch);

                        setTimeout(() => {
                            // --- Fase 3: Effetto Flash Out (sul testo del glitch) ---
                            exitCurtain.classList.remove('glitching');
                            if (exitLoadingText) {
                                exitLoadingText.style.animation = 'none'; 
                                exitLoadingText.style.color = '#FFFFFF'; 
                                exitLoadingText.style.textShadow = 'none';
                            }
                            if (barContainer) barContainer.style.display = 'none'; 
                            
                            exitCurtain.classList.add('flash-out-effect');

                            setTimeout(() => {
                                // --- Dopo l'animazione Flash Out ---
                                const macrodroidUrl = 'https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi';
                                fetch(macrodroidUrl, { method: 'GET', mode: 'no-cors' })
                                    .then(response => console.log('Macrodroid trigger request sent.'))
                                    .catch(error => console.error('Error sending Macrodroid trigger:', error));
                            }, durationFlashOut);

                        }, durationGlitch);

                    }, durationNormal);
                }
            });
        }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
