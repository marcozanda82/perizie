<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perizia Veicolo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #23272a; /* Sfondo principale più scuro e desaturato */
            --card-bg-color: #2c2f33; /* Sfondo per sezioni/card */
            --input-bg-color: #36393f; /* Sfondo per input e select */
            --text-color: #e1e1e1; /* Colore testo principale */
            --text-muted-color: #99aab5; /* Testo secondario/meno importante */
            --primary-accent-color: #61daff; /* Blu accento per focus, link, ecc. */
            --border-color: #4f545c; /* Colore bordi generico */
            --border-radius-small: 4px;
            --border-radius-medium: 6px;
            --border-radius-large: 8px;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --shadow-medium: rgba(0, 0, 0, 0.2);
            --font-family-main: 'Roboto', 'Segoe UI', Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;

            --success-color: #43b581; /* Verde per completato/OK */
            --warning-color: #faa61a; /* Giallo per parziale/attenzione */
            --danger-color: #f04747;  /* Rosso per non toccato/errore */
            --info-color: #7289da;    /* Blu per info/bottoni principali */
            --secondary-color: #8e9297; /* Grigio per bottoni secondari */
        }

        /* Preloader & Exit Curtain Styles (Mantenuti come prima) */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 1; visibility: visible; }
        #preloader.hidden { opacity: 0; visibility: hidden; transition: opacity 0.7s ease-out, visibility 0.7s ease-out; }
        #exit-curtain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in, visibility 0.5s ease-in; }
        #exit-curtain.hidden { opacity: 0; visibility: hidden; transition: opacity 0.7s ease-out, visibility 0.7s ease-out; }
        #exit-curtain.visible-no-transition { opacity: 1; visibility: visible; transition: none; }
        .loader-bar-container { display: flex; gap: 10px; margin-bottom: 25px; }
        .loader-bar { width: 15px; height: 70px; background-color: var(--primary-accent-color); animation: barPulse 1.2s infinite ease-in-out; box-shadow: 0 0 8px var(--primary-accent-color), 0 0 15px #00aeff; border-radius: 3px; }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }
        #exit-curtain:not(.glitching):not(.flash-out-effect) .loader-bar { animation-direction: reverse; }
        #exit-curtain.glitching:not(.flash-out-effect) .loader-bar { animation-direction: normal; }
        @keyframes barPulse { 0%, 100% { transform: scaleY(0.3); opacity: 0.6; } 50% { transform: scaleY(1); opacity: 1; } }
        #preloader .loading-text, #exit-curtain .loading-text { font-size: 1.6em; letter-spacing: 1px; }
        #preloader .loading-text { color: var(--primary-accent-color); animation: textGlow 1.8s infinite alternate ease-in-out; }
        #exit-curtain .loading-text { color: #ff8787; }
        @keyframes textGlow { from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 0.8;} to { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; opacity: 1;} }
        #exit-curtain.glitching .loading-text { animation: glitchText 0.8s infinite steps(1, end), textGlow 1.8s infinite alternate ease-in-out; color: #ff3030 !important; position: relative; z-index: 10; }
        #exit-curtain.glitching::before, #exit-curtain.glitching::after { content: attr(data-text); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: auto; padding: 0 20px; text-align: center; font-size: 1.6em; letter-spacing: 1px; background: #111; overflow: hidden; clip-path: inset(50% 50% 50% 50%); z-index: 5; }
        #exit-curtain.glitching::before { color: #00ffff; animation: glitchEffect 0.3s infinite linear alternate-reverse; }
        #exit-curtain.glitching::after { color: #ff00ff; animation: glitchEffect 0.2s infinite linear alternate-reverse, glitchSkew 0.5s infinite linear alternate; animation-delay: -0.1s; }
        @keyframes glitchEffect {0%{clip-path:inset(40% 0 30% 0);transform:translate(-50.5%,-50.1%) skewX(5deg);opacity:.8}10%{clip-path:inset(20% 0 70% 0);transform:translate(-50%,-50%) skewX(0);opacity:.7}20%{clip-path:inset(10% 0 55% 0);transform:translate(-49.8%,-50.2%) skewX(-3deg);opacity:.9}30%{clip-path:inset(50% 0 50% 0);transform:translate(-50%,-50%) skewX(0);opacity:.6}40%{clip-path:inset(60% 0 10% 0);transform:translate(-50.2%,-49.9%) skewY(2deg);opacity:1}50%{clip-path:inset(80% 0 5% 0);transform:translate(-50%,-50%) skewX(0);opacity:.75}60%{clip-path:inset(25% 0 40% 0);transform:translate(-50.1%,-50.3%) skewX(4deg);opacity:.85}70%{clip-path:inset(15% 0 75% 0);transform:translate(-50%,-50%) skewX(0);opacity:.9}80%{clip-path:inset(50% 0 20% 0);transform:translate(-49.9%,-49.8%) skewY(-3deg);opacity:1}90%{clip-path:inset(70% 0 10% 0);transform:translate(-50%,-50%) skewX(0);opacity:.6}100%{clip-path:inset(35% 0 45% 0);transform:translate(-50.3%,-50%) skewX(-2deg);opacity:.8}}
        @keyframes glitchSkew { 0% { transform: translate(-50%, -50%) skew(-5deg, -2deg); } 100% { transform: translate(-50%, -50%) skew(5deg, 2deg); } }
        @keyframes glitchText {0%,100%{text-shadow:0 0 3px red,0 0 5px blue,0 0 1px #fff;transform:translateX(0) translateY(0) skewX(0);opacity:1}10%{text-shadow:1px 1px 3px red,-1px -1px 5px blue,0 0 1px #fff;transform:translateX(-2px) translateY(1px) skewX(5deg);opacity:.8}90%{text-shadow:1px 1px 3px red,-1px -1px 5px blue,0 0 1px #fff;transform:translateX(-1px) translateY(1px) skewX(1deg);opacity:.9}}
        #exit-curtain.flash-out-effect .loading-text { color: #FFF !important; text-shadow: none !important; animation: textFlashOut 0.5s forwards ease-out; transform-origin: center center; }
        @keyframes textFlashOut {0%{opacity:1;transform:scale(1);text-shadow:0 0 5px rgba(255,255,255,.5)}50%{opacity:1;transform:scale(1.1);color:#FFFFE0 !important;text-shadow:0 0 15px #fff,0 0 25px #fff,0 0 35px #FFFFE0,0 0 50px #FFFF99}99%{opacity:.8;transform:scale(1.05)}100%{opacity:0;transform:scale(.8);text-shadow:none;color:transparent !important}}
        /* Fine Stili Preloader/Exit */

        body {
            font-family: var(--font-family-main);
            line-height: 1.6;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: padding-top 0.3s ease;
        }
        .content-wrapper {
            padding: 20px;
            max-width: 900px; /* Leggermente più largo per un look moderno */
            margin-left: auto;
            margin-right: auto;
        }
        h1, h2, h3, h4 {
            text-align: center;
            color: var(--text-color);
            font-weight: 500; /* Un po' più leggero per un look moderno */
        }
        h1#mainTitleGlobal {
            line-height: 1.3;
            margin-bottom: 15px;
            margin-top: 10px;
            font-size: 2em; /* Più grande */
            font-weight: 700; /* Titolo principale più forte */
            letter-spacing: 0.5px;
        }
        h1#mainTitleGlobal span { /* Per la parte "Marca Modello" */
            font-size: 0.6em !important; /* Rispetto al titolo principale */
            color: var(--text-muted-color) !important;
            font-weight: 400 !important;
            display: block;
            margin-top: 4px;
        }
        h2.section-title {
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
            margin-top: 35px;
            margin-bottom: 20px; /* Aggiunto spazio sotto il titolo sezione */
            text-align: left;
            font-size: 1.5em;
            font-weight: 500;
        }
        h3 { font-size: 1.3em; margin-top: 25px; margin-bottom: 15px; font-weight: 500; text-align: left;}
        h4 { font-size: 1.15em; color: var(--text-muted-color); margin-top: 20px; margin-bottom: 10px; font-weight: 500; text-align: left;}

        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 18px; } /* Aumentato spazio tra items */

        input[type="checkbox"], input[type="text"], input[type="url"], select, input[type="radio"], textarea {
            vertical-align: middle;
            padding: 10px 12px; /* Più padding */
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            margin-bottom: 8px; /* Leggermente aumentato */
            font-family: var(--font-family-main);
            font-size: 0.95em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"], input[type="url"], textarea {
            width: calc(100% - 26px); /* Adattato per nuovo padding */
            box-sizing: border-box;
        }
        input[type="radio"] { margin-left: 5px; margin-right: 5px; }
        select { min-width: 240px; }
        label {
            vertical-align: middle;
            display: block;
            margin-bottom: 6px;
            color: var(--text-muted-color); /* Label più chiare */
            font-size: 0.9em;
            font-weight: 500;
        }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-accent-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-accent-color-rgb, 97, 218, 255), 0.3);
        }
        /* Stili specifici per checkbox per allineamento e aspetto */
        .category-section ul li > input[type="checkbox"] {
            margin-right: 8px; /* Più spazio */
            transform: scale(1.1); /* Leggermente più grande */
            accent-color: var(--primary-accent-color);
        }
        .category-section ul li > input[type="checkbox"] + label {
            display: inline-block;
            vertical-align: middle;
            margin-bottom: 0;
            color: var(--text-color); /* Label checkbox più visibili */
            font-weight: 400;
            font-size: 0.95em;
        }
        /* Custom styling for the "Fill Defaults" button */
        .fill-defaults-btn {
            position: absolute;
            top: 25px;
            right: 20px;
            width: 38px; /* Leggermente più grande */
            height: 38px;
            background-color: var(--info-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-medium);
            font-size: 1.6em;
            line-height: 1;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-shadow: 0 2px 5px var(--shadow-medium);
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
        }
        .fill-defaults-btn:hover {
            background-color: #5b6eae; /* Più scuro del --info-color */
            box-shadow: 0 4px 8px var(--shadow-medium);
        }
        .fill-defaults-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 3px var(--shadow-light);
        }


        #pageHeaderContainer {
            background-color: var(--card-bg-color); /* Header con colore card */
            z-index: 1000;
            width: 100%;
            padding-bottom: 10px; /* Più padding sotto */
            box-shadow: 0 2px 8px var(--shadow-medium); /* Ombra più pronunciata */
        }
        #pageHeaderContainer.fixed-header {
            position: fixed;
            top: 0;
            left: 0;
        }
        .header-circles { display: none; } /* Rimossi i cerchi */

        #navButtons { display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: 10px; }
        #mainPageNavButtons { display: flex; justify-content: center; flex-wrap: nowrap; overflow-x: auto; padding: 8px 0; width: calc(100% - 30px); max-width: 750px; }
        #mainPageNavButtons button {
            margin: 0 5px; /* Spaziatura tra i bottoni */
            flex-shrink: 0;
            position: relative; /* Per l'indicatore ::after */
            padding: 10px 18px; /* Più padding */
        }
        #mainPageNavButtons button::after { /* Indicatore per tab attiva */
            content: '';
            position: absolute;
            bottom: -2px; /* Posizionato sotto il bottone */
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background-color: var(--primary-accent-color);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        #mainPageNavButtons button.active::after {
            width: 60%; /* Larghezza dell'indicatore quando attivo */
        }

        #utilityNavButtons { display: flex; justify-content: center; flex-wrap: wrap; margin-top: 10px; gap: 8px; }

        #navButtons button, .action-button {
            padding: 10px 18px; /* Padding consistente */
            cursor: pointer;
            background-color: var(--info-color);
            color: white;
            border: none; /* Bordi rimossi, affidamento a shadow */
            border-radius: var(--border-radius-medium);
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            font-size: 0.9em;
            font-weight: 500;
            box-shadow: 0 1px 3px var(--shadow-light);
        }
        #navButtons button:hover, .action-button:hover {
            box-shadow: 0 3px 7px var(--shadow-medium);
            transform: translateY(-1px); /* Leggero sollevamento */
        }
        #navButtons button:active, .action-button:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px var(--shadow-light);
        }

        .save-and-next-btn { background-color: var(--info-color) !important; }
        .save-and-next-btn:hover { background-color: #5b6eae !important; } /* Più scuro di --info-color */

        #navButtons button.active {
            background-color: #5b6eae !important; /* Più scuro per tab attiva */
            color: white !important;
            box-shadow: inset 0 1px 3px var(--shadow-light), 0 1px 2px var(--shadow-light) !important;
        }
        #navButtons button.nav-btn-completed { background-color: var(--success-color) !important; }
        #navButtons button.nav-btn-completed:hover { background-color: #3aa170 !important; }
        #navButtons button.nav-btn-partial { background-color: var(--warning-color) !important; color: #23272a !important; }
        #navButtons button.nav-btn-partial:hover { background-color: #e0900a !important; }
        #navButtons button.nav-btn-untouched { background-color: var(--danger-color) !important; }
        #navButtons button.nav-btn-untouched:hover { background-color: #d83f3f !important; }

        /* Stili bottoni utility specifici */
        #backToListBtn { background-color: var(--secondary-color) !important; }
        #backToListBtn:hover { background-color: #7a7e83 !important; }
        #historyBtn { background-color: #5bc0de !important; } /* Azzurro diverso */
        #historyBtn:hover { background-color: #46b8da !important; }
        #exitAppBtn, #clearAllProgressBtn { background-color: var(--danger-color) !important; }
        #exitAppBtn:hover, #clearAllProgressBtn:hover { background-color: #d83f3f !important; }


        #landingPageSection, .category-section, #historyPageSection {
            padding: 25px; /* Più padding interno */
            border: none; /* Rimosso bordo, uso di shadow */
            border-radius: var(--border-radius-large); /* Angoli più arrotondati */
            margin-top: 25px;
            background-color: var(--card-bg-color);
            max-width: 850px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 4px 12px var(--shadow-medium); /* Ombra più evidente */
        }
        .category-section, #historyPageSection { display: none; }
        #landingPageSection { display: block; }
        .category-section.active { display: block; }

        /* Riepilogo */
        .summary-item {
            margin-bottom: 10px; padding: 12px; background-color: var(--input-bg-color);
            border-radius: var(--border-radius-medium); border-left: 4px solid var(--border-color);
        }
        .summary-item strong { color: var(--primary-accent-color); font-weight: 500; }
        .summary-anomaly {
            background-color: rgba(var(--danger-rgb, 240, 71, 71), 0.15) !important;
            border-left-color: var(--danger-color) !important;
            color: var(--text-color) !important;
        }
        .summary-anomaly strong { color: var(--danger-color) !important; }
        .summary-notes {
            background-color: rgba(var(--primary-accent-rgb, 97, 218, 255), 0.1) !important;
            border-left-color: var(--primary-accent-color) !important;
            color: var(--text-color) !important;
        }
        .summary-notes strong { color: var(--primary-accent-color) !important; }
        .summary-notes div { white-space: pre-wrap; padding-left: 10px; margin-top: 5px; font-size: 0.95em; }


        /* Stili Tabella Targhe */
        .table-scroll-wrapper {
            overflow-x: auto; width: 100%; margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            background-color: var(--input-bg-color); /* Sfondo leggero per la tabella */
        }
        .targa-list-table-content { min-width: 750px; /* Adattare in base al numero di colonne */ }
        .targa-list-header {
            display: flex; font-weight: 500; /* Più leggero */
            padding: 0 10px; border-bottom: 2px solid var(--border-color);
            color: var(--text-muted-color); background-color: var(--bg-color); /* Sfondo header più scuro */
            font-size: 0.85em; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .targa-list-header .targa-col { padding: 10px 12px; border-right: 1px solid var(--bg-color); }
        .targa-list-header .targa-col:last-child { border-right: none; }

        #targaListContainer { margin-top: 0; max-height: 400px; overflow-y: auto; padding: 0; }
        .targa-list-item {
            display: flex; align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding: 0 10px;
            transition: background-color 0.2s ease;
        }
        .targa-list-item:last-child { border-bottom: none; }
        .targa-list-item:hover { background-color: rgba(var(--primary-accent-rgb, 97, 218, 255), 0.05); }

        .targa-list-item .targa-col {
            padding: 10px 12px; /* Aumentato padding */
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-right: 1px solid var(--border-color);
            text-align: left; flex-grow: 1; display: flex; align-items: center;
            font-size: 0.9em;
        }
        .targa-list-item .targa-col:last-child { border-right: none; }

        .targa-col-urgente { flex-basis: 8%; min-width: 60px; justify-content: center; }
        .targa-col-urgente input[type="checkbox"] { transform: scale(1.3); accent-color: var(--danger-color); margin:0; }
        .targa-col-targa    { flex-basis: 15%; min-width: 90px;}
        .targa-col-targa.clickable-targa {
            cursor: pointer; color: var(--primary-accent-color); font-weight: 500;
            transition: color 0.2s ease, text-decoration 0.2s ease;
        }
        .targa-list-item:hover .targa-col-targa.clickable-targa { color: #82e9ff; text-decoration: underline; }
        .targa-col-posizione{ flex-basis: 12%; min-width: 70px; padding: 6px !important; }
        .targa-col-marca    { flex-basis: 20%; min-width: 100px;}
        .targa-col-modello  { flex-basis: 25%; min-width: 120px;}
        .targa-col-piazzale { flex-basis: 15%; min-width: 90px;}
        .targa-col-actions  { flex-basis: 5%; min-width: 50px; text-align: center; flex-grow: 0; }

        .targa-col-posizione input.posizione-input {
            width: 100%; padding: 8px 6px; margin: 0; box-sizing: border-box;
            background-color: var(--bg-color); /* Leggermente più scuro dello sfondo riga */
            color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-small);
            font-size: 0.9em; text-align: center;
        }
        .targa-col-posizione input.posizione-input:focus { background-color: #3e4247; border-color: var(--primary-accent-color); }

        .delete-progress-btn {
            background-color: transparent; border: 1px solid var(--danger-color); color: var(--danger-color);
            padding: 4px 8px; font-size: 0.8em; line-height: 1; border-radius: var(--border-radius-small);
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .delete-progress-btn:hover { background-color: var(--danger-color); color: white; }


        /* Colori di stato per le righe della tabella */
        .targa-list-item.status-da-vedere { background-color: transparent; }
        .targa-list-item.status-da-vedere:hover { background-color: rgba(var(--primary-accent-rgb, 97, 218, 255), 0.05); }
        .targa-list-item.status-da-vedere .targa-col { color: var(--text-color); }
        .targa-list-item.status-da-vedere .targa-col-targa.clickable-targa { color: var(--primary-accent-color); }

        .targa-list-item.status-visto { background-color: rgba(var(--success-rgb, 67, 181, 129), 0.1); }
        .targa-list-item.status-visto:hover { background-color: rgba(var(--success-rgb, 67, 181, 129), 0.18); }
        .targa-list-item.status-visto .targa-col { color: #b8e0c7; }
        .targa-list-item.status-visto .targa-col-targa.clickable-targa { color: var(--success-color); }

        .targa-list-item.urgent-item {
            background-color: rgba(var(--danger-rgb, 240, 71, 71), 0.1) !important;
            border-left: 4px solid var(--danger-color); /* Bordo sinistro più evidente */
            margin-left: -4px; /* Compensa il bordo */
        }
        .targa-list-item.urgent-item:hover { background-color: rgba(var(--danger-rgb, 240, 71, 71), 0.18) !important; }
        .targa-list-item.urgent-item .targa-col { color: #f5b5b5 !important; }
        .targa-list-item.urgent-item .targa-col-targa.clickable-targa { color: var(--danger-color) !important; }

        .targa-list-item.completed .targa-col { color: var(--text-muted-color) !important; }
        .targa-list-item.status-visto.completed .targa-col { color: #8bbd9f !important; } /* Verde più desaturato per completati */
        .targa-list-item.status-visto.completed .targa-col-targa.clickable-targa { color: #6aa886 !important; }
        .targa-list-item.urgent-item.completed .targa-col { color: #b18888 !important; } /* Rosso più desaturato */
        .targa-list-item.urgent-item.completed .targa-col-targa.clickable-targa { color: #d87070 !important; }

        .targa-list-item.status-parziale { background-color: rgba(var(--warning-rgb, 250, 166, 26), 0.1); }
        .targa-list-item.status-parziale:hover { background-color: rgba(var(--warning-rgb, 250, 166, 26), 0.18); }
        .targa-list-item.status-parziale .targa-col { color: #f8d99b !important; }
        .targa-list-item.status-parziale .targa-col-targa.clickable-targa { color: var(--warning-color) !important; }


        #targheLoadingStatus { text-align: center; padding: 15px; color: var(--text-muted-color); font-size: 1.05em; }
        #savedTargasListContainer {
            display: flex; flex-direction: column; gap: 10px; max-height: 450px; overflow-y: auto;
            padding: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius-medium); margin-bottom: 20px;
        }
        .saved-targa-button {
            display: block; width: 100%; padding: 12px 15px;
            background-color: var(--input-bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-medium);
            text-align: left; cursor: pointer; font-size: 0.95em;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .saved-targa-button:hover { background-color: #3e4247; border-color: var(--primary-accent-color); }

        #historyPageSection .action-button { margin-right: 10px; }
        #sheetFilterContainer { margin-bottom: 20px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        #sheetFilterContainer label { margin-right: 0; color: var(--text-muted-color); font-size: 0.9em; }
        #sheetFilterDropdown {
            padding: 10px 12px; background-color: var(--input-bg-color); color: var(--text-color);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-medium);
            min-width: 280px; vertical-align: middle; font-size: 0.95em;
        }

        .animate-me { /* Animazione campo da compilare */
            animation: pulseHighlight 1.5s infinite alternate;
            outline: 2px solid rgba(var(--primary-accent-rgb, 97, 218, 255), 0);
            transition: outline 0.3s ease, box-shadow 0.3s ease;
        }
        @keyframes pulseHighlight {
            from { outline-color: rgba(var(--primary-accent-rgb, 97, 218, 255), 0.8); box-shadow: 0 0 8px rgba(var(--primary-accent-rgb, 97, 218, 255), 0.6), 0 0 10px rgba(var(--primary-accent-rgb, 97, 218, 255), 0.4) inset; }
            to   { outline-color: rgba(var(--primary-accent-rgb, 97, 218, 255), 0.4); box-shadow: 0 0 15px rgba(var(--primary-accent-rgb, 97, 218, 255), 0.9), 0 0 15px rgba(var(--primary-accent-rgb, 97, 218, 255), 0.6) inset; }
        }
        input[type="checkbox"].animate-me, select.animate-me { position: relative; z-index: 1; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .content-wrapper { padding: 15px; }
            h1#mainTitleGlobal { font-size: 1.8em; }
            h2.section-title { font-size: 1.3em; margin-top: 25px; }
            #navButtons button, .action-button { padding: 9px 12px; font-size: 0.85em; }
            #mainPageNavButtons { width: calc(100% - 10px); padding: 5px; }
            #mainPageNavButtons button { font-size: 0.8em; padding: 8px 10px; margin: 0 3px; }
            input[type="text"], input[type="url"], select, textarea { width: 100%; box-sizing: border-box; font-size: 0.9em; }
            .table-scroll-wrapper { overflow-x: auto; }
            .targa-list-table-content { min-width: 680px; } /* Potrebbe necessitare aggiustamenti */
            .targa-list-header .targa-col, .targa-list-item .targa-col { padding: 8px 6px; font-size:0.85em; }
            .delete-progress-btn { padding: 5px 8px; }
            .targa-col-urgente { min-width: 50px; }
            .targa-col-targa    { min-width: 70px;}
            .targa-col-posizione{ min-width: 60px;}
            .targa-col-marca    { min-width: 80px;}
            .targa-col-modello  { min-width: 90px;}
            .targa-col-piazzale { min-width: 70px;}
            .targa-col-actions  { min-width: 45px; }
            #sheetFilterContainer { flex-direction: column; align-items: stretch; gap: 8px;}
            #sheetFilterDropdown { width: 100%; min-width: auto; }
            .fill-defaults-btn { top: 20px; right: 15px; width: 32px; height: 32px; font-size: 1.3em; }
        }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="exit-curtain" data-text="CHIUSURA IN CORSO...">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">CHIUSURA IN CORSO...</div>
    </div>

    <div id="pageHeaderContainer">
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>
        <div id="navButtons">
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
            <div id="utilityNavButtons">
                <button id="backToListBtn" class="action-button">Elenco Targhe</button>
                <button id="historyBtn" class="action-button">Salvataggi</button>
                <button id="exitAppBtn" class="action-button">Esci</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;">
            <h2 style="margin-top: 10px; text-align:left; border-bottom: none;">Seleziona Veicolo</h2>
            <div id="sheetFilterContainer">
                <label for="sheetFilterDropdown">Filtra per Piazzale:</label>
                <select id="sheetFilterDropdown">
                    <option value="all">Tutti i Piazzali</option>
                </select>
            </div>
            <div id="targheLoadingStatus">Caricamento targhe in corso...</div>
            <div class="table-scroll-wrapper">
                <div class="targa-list-table-content">
                    <div class="targa-list-header">
                        <span class="targa-col targa-col-urgente">Urg.</span>
                        <span class="targa-col targa-col-targa">Targa</span>
                        <span class="targa-col targa-col-posizione">Pos.</span>
                        <span class="targa-col targa-col-marca">Marca</span>
                        <span class="targa-col targa-col-modello">Modello</span>
                        <span class="targa-col targa-col-piazzale">Piazzale</span>
                        <span class="targa-col targa-col-actions">Az.</span>
                    </div>
                    <div id="targaListContainer"></div>
                </div>
            </div>
        </div>

        <div id="checklistContainer" style="display: none;">
            <div id="remarketingSection" class="category-section">
                <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="remarketingSection">&#x2713;</button>
                <h2 class="section-title">1. Foto Remarketing</h2>
                <ul>
                    <li>
                        <label for="tipo_trazione">Trazione veicolo:</label>
                        <select id="tipo_trazione">
                            <option value="">Seleziona...</option>
                            <option value="endotermico">Endotermico</option>
                            <option value="elettrico">Elettrico</option>
                        </select>
                    </li>
                    <li><input type="checkbox" id="foto_angolari"><label for="foto_angolari">Foto angolari (3/4)</label></li>
                    <li>
                        <input type="checkbox" id="foto_vano_carico">
                        <label for="foto_vano_carico">Vano Carico</label>
                    </li>
                    <li>
                        <label for="tipo_equipaggiamento">Equipaggiamento:</label>
                        <select id="tipo_equipaggiamento">
                            <option value="">Seleziona...</option>
                            <option value="kit_gonfia_ripara">Kit</option>
                            <option value="ruota">Ruota</option>
                            <option value="ruotino">Ruotino</option>
                            <option value="runflat">Runflat</option>
                        </select>
                    </li>
                    <li><label for="equipaggiamento_presenza">Presenza equip.:</label><select id="equipaggiamento_presenza"><option value="">Seleziona...</option><option value="presente">Presente</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_interni_pannelli"><label for="foto_interni_pannelli">Interni/pannelli</label></li>
                    <li><input type="checkbox" id="foto_cruscotto"><label for="foto_cruscotto">Cruscotto</label></li>
                    <li><label for="stato_chilometri">Chilometri - Stato:</label><select id="stato_chilometri"><option value="">Seleziona...</option><option value="rilevabili">Rilevabili</option><option value="non_rilevabili">Non rilevabili</option></select></li>
                    <li><label for="stato_cdc">CDC - Stato:</label><select id="stato_cdc"><option value="">Seleziona...</option><option value="originale">Originale</option><option value="copia_conforme">Copia conforme</option><option value="mancante">Mancante</option></select></li>
                    <li><input type="checkbox" id="foto_vano_motore"><label for="foto_vano_motore">Vano motore</label></li>
                    <li><input type="checkbox" id="foto_cofano_tetto"><label for="foto_cofano_tetto">Cofano e tetto</label></li>
                    <li>
                        <label for="chiave_telecomando">Chiave con telecomando:</label>
                        <select id="chiave_telecomando">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="seconda_chiave">Seconda chiave:</label>
                        <select id="seconda_chiave">
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_rapida">Cavo ricarica rapida:</label>
                        <select id="cavo_ricarica_rapida" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                    <li>
                        <label for="cavo_ricarica_domestica">Cavo ricarica domestica:</label>
                        <select id="cavo_ricarica_domestica" disabled>
                            <option value="">Seleziona...</option>
                            <option value="presente">Presente</option>
                            <option value="non_presente">Non Presente</option>
                            <option value="non_applicabile">Non Applicabile</option>
                        </select>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 25px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="pneumaticiSection" class="category-section">
                 <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="pneumaticiSection">&#x2713;</button>
                <h2 class="section-title">2. Foto Pneumatici</h2>
                <ul>
                    <li><label for="pneumatico_as">Ant. sinistro:</label><select id="pneumatico_as"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ad">Ant. destro:</label><select id="pneumatico_ad"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_pd">Post. destro:</label><select id="pneumatico_pd"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                    <li><label for="pneumatico_ps">Post. sinistro:</label><select id="pneumatico_ps"><option value="">Seleziona...</option><option value="conforme">Conforme</option><option value="non_conforme">Non conforme</option></select></li>
                </ul>
                <div style="text-align: right; margin-top: 25px;"><button class="action-button save-and-next-btn">Salva e Prosegui</button></div>
            </div>
            <div id="danniVerificheSection" class="category-section">
                <button class="fill-defaults-btn" title="Compila Positivamente/Default" data-sectionid="danniVerificheSection">&#x2713;</button>
                <h2 class="section-title">3. Foto Danni e Verifiche</h2>
                <ul>
                    <li><label for="motore_accende">Motore si accende:</label><select id="motore_accende"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><label for="batteria_stato">Batteria:</label><select id="batteria_stato"><option value="">Seleziona...</option><option value="ok">OK</option><option value="non_ok">Non OK</option></select></li>
                    <li><input type="checkbox" id="foto_danni_generiche"><label for="foto_danni_generiche">Altre foto danni</label></li>
                    <li>
                        <label for="note_danni_verifiche">Note Danni/Verifiche:</label>
                        <textarea id="note_danni_verifiche" rows="4"></textarea>
                    </li>
                </ul>
                <div style="text-align: right; margin-top: 25px;"><button class="action-button save-and-next-btn">Salva e Vai al Riepilogo</button></div>
            </div>
            <div id="riepilogoSection" class="category-section">
                <h2 class="section-title">Riepilogo Perizia</h2>
                <div id="summaryContent"><p><em>Compila le sezioni precedenti...</em></p></div>
                <button id="saveAndReturnBtn" class="action-button" style="margin-top: 20px;">Salva Perizia</button>
            </div>
        </div>

        <div id="historyPageSection" style="display: none;">
            <h2 class="section-title" style="text-align: center;">Cronistoria Salvataggi</h2>
            <div id="savedTargasListContainer"><p>Nessun salvataggio trovato.</p></div>
            <div style="margin-top: 20px; text-align: center;">
                <button id="clearAllProgressBtn" class="action-button">Cancella Tutti i Salvataggi</button>
                <button id="backToLandingFromHistoryBtn" class="action-button" style="background-color: var(--secondary-color);">Elenco Targhe Principale</button>
            </div>
        </div>
    </div>
<script>
    // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer');
    // const headerCircles = pageHeaderContainer.querySelector('.header-circles'); // Rimosso
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons');
    const navButtons = navButtonsContainer.querySelectorAll('#mainPageNavButtons button[data-target]');
    const utilityButtons = navButtonsContainer.querySelectorAll('#utilityNavButtons button');
    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const backToListBtn = pageHeaderContainer.querySelector('#backToListBtn');
    const historyBtn = pageHeaderContainer.querySelector('#historyBtn');
    const exitAppBtn = pageHeaderContainer.querySelector('#exitAppBtn');
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn');
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn');
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn');
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
    const tipoTrazioneSelect = document.getElementById('tipo_trazione');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';

    // Helper per convertire colori HEX in RGB per box-shadow con trasparenza
    function hexToRgb(hex) {
        let r = 0, g = 0, b = 0;
        if (hex.length == 4) { // #RGB
            r = "0x" + hex[1] + hex[1];
            g = "0x" + hex[2] + hex[2];
            b = "0x" + hex[3] + hex[3];
        } else if (hex.length == 7) { // #RRGGBB
            r = "0x" + hex[1] + hex[2];
            g = "0x" + hex[3] + hex[4];
            b = "0x" + hex[5] + hex[6];
        }
        return [+r, +g, +b];
    }

    // Inizializza variabili CSS con componenti RGB
    function setCssRgbVariables() {
        const rootStyle = document.documentElement.style;
        const primaryAccentColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-accent-color').trim();
        const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--danger-color').trim();
        const successColor = getComputedStyle(document.documentElement).getPropertyValue('--success-color').trim();
        const warningColor = getComputedStyle(document.documentElement).getPropertyValue('--warning-color').trim();

        if (primaryAccentColor) rootStyle.setProperty('--primary-accent-color-rgb', hexToRgb(primaryAccentColor).join(', '));
        if (dangerColor) rootStyle.setProperty('--danger-rgb', hexToRgb(dangerColor).join(', '));
        if (successColor) rootStyle.setProperty('--success-rgb', hexToRgb(successColor).join(', '));
        if (warningColor) rootStyle.setProperty('--warning-rgb', hexToRgb(warningColor).join(', '));
    }


    function fillSectionPositiveOrDefaults(sectionId) {
        const section = document.getElementById(sectionId);
        if (!section) return;

        if (sectionId === 'remarketingSection') {
            if (tipoTrazioneSelect) tipoTrazioneSelect.value = 'endotermico';
            document.getElementById('foto_angolari').checked = true;
            document.getElementById('foto_vano_carico').checked = true;
            document.getElementById('tipo_equipaggiamento').value = 'kit_gonfia_ripara';
            document.getElementById('equipaggiamento_presenza').value = 'presente';
            document.getElementById('foto_interni_pannelli').checked = true;
            document.getElementById('foto_cruscotto').checked = true;
            document.getElementById('stato_chilometri').value = 'rilevabili';
            document.getElementById('stato_cdc').value = 'originale';
            document.getElementById('foto_vano_motore').checked = true;
            document.getElementById('foto_cofano_tetto').checked = true;
            document.getElementById('chiave_telecomando').value = 'presente';
            document.getElementById('seconda_chiave').value = 'presente';
            handleTrazioneChange();
            if (tipoTrazioneSelect && tipoTrazioneSelect.value === 'elettrico') {
                if (cavoRapidaSelect && (cavoRapidaSelect.value === "" || cavoRapidaSelect.value === "non_applicabile")) cavoRapidaSelect.value = 'presente';
                if (cavoDomesticaSelect && (cavoDomesticaSelect.value === "" || cavoDomesticaSelect.value === "non_applicabile")) cavoDomesticaSelect.value = 'presente';
            }
        }
        else if (sectionId === 'pneumaticiSection') {
            document.getElementById('pneumatico_as').value = 'conforme';
            document.getElementById('pneumatico_ad').value = 'conforme';
            document.getElementById('pneumatico_pd').value = 'conforme';
            document.getElementById('pneumatico_ps').value = 'conforme';
        }
        else if (sectionId === 'danniVerificheSection') {
            document.getElementById('motore_accende').value = 'ok';
            document.getElementById('batteria_stato').value = 'ok';
            document.getElementById('foto_danni_generiche').checked = false;
            document.getElementById('note_danni_verifiche').value = 'Nessuna anomalia da segnalare.';
        }
        updateNavButtonColors();
        if (typeof initSequentialAnimation === 'function') {
            section.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me'));
            initSequentialAnimation();
        }
        section.querySelectorAll('input, select, textarea').forEach(el => {
            const event = new Event('change', { bubbles: true });
            el.dispatchEvent(event);
             // Trigger input event as well for some frameworks or listeners
            const inputEvent = new Event('input', { bubbles: true });
            el.dispatchEvent(inputEvent);
        });
    }

    function handleTrazioneChange() {
        if (!tipoTrazioneSelect || !cavoRapidaSelect || !cavoDomesticaSelect) return;
        const selectedTrazione = tipoTrazioneSelect.value;
        const isElectric = selectedTrazione === 'elettrico';
        cavoRapidaSelect.disabled = !isElectric;
        cavoDomesticaSelect.disabled = !isElectric;
        if (!isElectric) {
            cavoRapidaSelect.value = "non_applicabile";
            cavoDomesticaSelect.value = "non_applicabile";
        } else {
            if (cavoRapidaSelect.value === "non_applicabile") cavoRapidaSelect.value = ""; // Resetta a Seleziona se era non_applicabile
            if (cavoDomesticaSelect.value === "non_applicabile") cavoDomesticaSelect.value = "";
        }
        updateNavButtonColors();
    }

    function savePosizioneForTarga(targa, posizione) {
        if (!targa) return;
        try {
            localStorage.setItem(`${APP_PREFIX}posizione_${targa}`, posizione);
        } catch (e) {
            console.error("Errore salvataggio posizione LS:", e);
        }
    }

    function loadPosizioneForTarga(targa) {
        if (!targa) return "";
        try {
            return localStorage.getItem(`${APP_PREFIX}posizione_${targa}`) || "";
        } catch (e) {
            console.error("Errore caricamento posizione LS:", e);
            return "";
        }
    }

    function resetChecklistForm() {
        const els = document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea');
        els.forEach(el => {
            if (el.type === 'checkbox') el.checked = false;
            else if (el.tagName === 'SELECT') el.selectedIndex = 0;
            else el.value = '';
        });
        if (tipoTrazioneSelect) {
            handleTrazioneChange(); // Assicura che i campi dipendenti siano aggiornati
        }
        console.log("Modulo resettato.");
    }

    function saveProgress(targa) {
        if(!targa){console.warn("Nessuna targa attiva per il salvataggio.");return false;}
        const data = {};
        document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => {
            if (el.id) {
                if (el.type === 'checkbox') data[el.id] = el.checked;
                else data[el.id] = el.value;
            }
        });
        try {
            localStorage.setItem(`${APP_PREFIX}data_${targa}`, JSON.stringify(data));
            console.log(`Progresso salvato per la targa ${targa}.`);
            updateNavButtonColors();
            return true;
        } catch(e) {
            console.error("Errore durante il salvataggio in localStorage:", e);
            alert("Salvataggio fallito. Spazio esaurito o errore del browser.");
            return false;
        }
    }

    function loadProgress(targa) {
        if(!targa) return;
        resetChecklistForm(); // Resetta prima di caricare i nuovi dati
        try {
            const json = localStorage.getItem(`${APP_PREFIX}data_${targa}`);
            if (json) {
                const data = JSON.parse(json);
                document.querySelectorAll('#checklistContainer input[type="checkbox"], #checklistContainer select, #checklistContainer textarea').forEach(el => {
                    if (el.id && data.hasOwnProperty(el.id)) {
                        if (el.type === 'checkbox') el.checked = data[el.id];
                        else el.value = data[el.id];
                    }
                });
                console.log(`Progresso caricato per la targa ${targa}.`);
            } else {
                console.log(`Nessun dato salvato trovato per la targa ${targa}.`);
            }
            if (tipoTrazioneSelect) { // Chiamata dopo aver caricato i valori
                 handleTrazioneChange();
            }
            updateNavButtonColors();
        } catch(e) {
            console.error("Errore durante il caricamento da localStorage:", e);
            updateNavButtonColors(); // Assicura che i colori dei bottoni siano aggiornati anche in caso di errore
        }
    }
    function getCompletedTarghe() { try{const json=localStorage.getItem(`${APP_PREFIX}completedTarghe`);return json?JSON.parse(json):{};}catch(e){return{};}}
    function markTargaAsCompleted(targa) { if(!targa)return; try{const completed=getCompletedTarghe();completed[targa]=true;localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));console.log(`${targa} marked complete.`);}catch(e){console.error("LS Mark Err:",e);}}
    function isTargaCompleted(targa) { const completed=getCompletedTarghe(); return !!(completed[targa]); }

    function deleteProgressForTarga(targa) {
        if(!targa){return;}
        try {
            localStorage.removeItem(`${APP_PREFIX}data_${targa}`);
            localStorage.removeItem(`${APP_PREFIX}posizione_${targa}`);
            localStorage.removeItem(`${APP_PREFIX}urgent_${targa}`);
            console.log(`Dati modulo, posizione e urgenza rimossi per ${targa}.`);

            const completed = getCompletedTarghe();
            if(completed.hasOwnProperty(targa)){
                delete completed[targa];
                localStorage.setItem(`${APP_PREFIX}completedTarghe`,JSON.stringify(completed));
                console.log(`Stato completamento rimosso per ${targa}.`);
            }
        } catch(e) {
            console.error(`Errore cancellazione dati per ${targa}:`,e);
            alert(`Errore cancellazione dati per ${targa}.`);
        }
        if (typeof popolaTargheFiltrate === 'function') {
             popolaTargheFiltrate();
        }
        if (targaSelezionataGlobalmente === targa) {
             targaSelezionataGlobalmente = null;
        }
    }

    function generateAndDownloadScreenshot() {
        return new Promise((resolve, reject) => {
            const riepilogoSection = document.getElementById('riepilogoSection');
            if (!riepilogoSection) {
                alert("Errore: Sezione Riepilogo non trovata per lo screenshot.");
                return reject("Sezione riepilogo non trovata");
            }
            if (typeof html2canvas === 'undefined') {
                alert("Errore: Libreria html2canvas non caricata.");
                return reject("html2canvas non caricata");
            }

            setTimeout(() => {
                console.log("Inizio generazione screenshot...");
                riepilogoSection.scrollTop = 0; // Assicura che lo screenshot parta dall'alto
                html2canvas(riepilogoSection, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--card-bg-color').trim() || '#2c2f33' // Usa lo sfondo della card
                 })
                    .then(canvas => {
                        const link = document.createElement('a');
                        let targaSanitized = 'sconosciuta';
                        let piazzaleSanitized = 'piazzale_sconosciuto';
                        if (targaSelezionataGlobalmente) {
                            targaSanitized = targaSelezionataGlobalmente.replace(/[^a-zA-Z0-9.-]/g, '_');
                            const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente);
                            if (veicoloAttuale && veicoloAttuale.piazzale && veicoloAttuale.piazzale.trim() !== "") {
                                piazzaleSanitized = veicoloAttuale.piazzale.trim().replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_');
                                if (!piazzaleSanitized) piazzaleSanitized = 'N_D';
                            } else {
                                piazzaleSanitized = 'N_D';
                            }
                        }
                        link.download = `perizia_${targaSanitized}_${piazzaleSanitized}.png`;
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        console.log(`Screenshot generato e download avviato: ${link.download}`);
                        resolve();
                    })
                    .catch(error => {
                        console.error("Errore durante la generazione dello screenshot:", error);
                        alert("Si è verificato un errore durante la generazione dello screenshot.");
                        reject(error);
                    });
            }, 100); // Piccolo delay per assicurare che il DOM sia aggiornato
        });
    }
    async function handleSavePeriziaAndReturn() { if(!targaSelezionataGlobalmente){alert("Nessuna targa attiva per il salvataggio.");return;} if(!saveProgress(targaSelezionataGlobalmente)){alert("Salvataggio dati fallito.");return;} if(document.getElementById('riepilogoSection').classList.contains('active')){generateSummary();} try{await generateAndDownloadScreenshot();}catch(e){console.warn("Screenshot fallito, ma dati salvati.");} markTargaAsCompleted(targaSelezionataGlobalmente); updateNavButtonColors(); alert(`Perizia per ${targaSelezionataGlobalmente} salvata, screenshot generato. La targa è marcata come completata. Torno all'elenco.`); targaSelezionataGlobalmente=null;showView('landing');}
    function handleSaveAndNext() { if(!targaSelezionataGlobalmente){alert("Nessuna targa selezionata.");return;} if(saveProgress(targaSelezionataGlobalmente)){const originalText=this.textContent;this.textContent='Salvato!';this.disabled=true;setTimeout(()=>{this.textContent=originalText;this.disabled=false;},1500);}else{return;} let currentIndex=-1; navButtons.forEach((navBtn,index)=>{if(navBtn.classList.contains('active'))currentIndex=index;}); if(currentIndex!==-1&&currentIndex<navButtons.length-1){const nextNavButton=navButtons[currentIndex+1];if(nextNavButton)showSection(nextNavButton.dataset.target);}}

    function isInputDefault(inputElement) {
        if (!inputElement) return true;
        if (inputElement.type === 'checkbox') return !inputElement.checked;
        if (inputElement.tagName === 'SELECT') return inputElement.value === "" || inputElement.selectedIndex === 0;
        if (inputElement.type === 'text' || inputElement.type === 'url' || inputElement.tagName === 'TEXTAREA') return inputElement.value.trim() === "";
        return true; // Considera altri tipi non gestiti come default
    }

    function getSectionInputs(sectionElementId) {
        const sectionDiv = document.getElementById(sectionElementId);
        if (!sectionDiv) return [];
        // Esclude input disabilitati
        return Array.from(sectionDiv.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled)'));
    }

    function getSectionStatus(sectionElementId, targaData) {
        const inputs = getSectionInputs(sectionElementId);
        if (inputs.length === 0) return 'completed'; // Se non ci sono input, la sezione è considerata completa

        let allDefault = true;
        let allNonDefault = true; // Assumiamo che tutti siano non-default finché non ne troviamo uno default
        let hasAtLeastOneNonDefault = false;

        inputs.forEach(input => {
            let isCurrentInputDefault;
            const savedValue = targaData && targaData.hasOwnProperty(input.id) ? targaData[input.id] : undefined;

            if (savedValue !== undefined) { // Se ci sono dati salvati, usali
                if (input.type === 'checkbox') {
                    isCurrentInputDefault = !savedValue;
                } else { // Per i select, consideriamo "default" se il valore salvato è vuoto
                    isCurrentInputDefault = (savedValue === ""); // O se corrisponde al placeholder
                }
            } else { // Altrimenti, controlla lo stato attuale dell'elemento DOM
                 isCurrentInputDefault = isInputDefault(input);
            }

            if (!isCurrentInputDefault) { // Se l'input corrente non è default
                allDefault = false; // Non tutti gli input sono default
                hasAtLeastOneNonDefault = true;
            } else { // Se l'input corrente è default
                allNonDefault = false; // Non tutti gli input sono non-default
            }
        });

        if (allDefault) return 'untouched'; // Tutti gli input sono default
        if (allNonDefault) return 'completed'; // Tutti gli input sono non-default (quindi compilati)
        if (hasAtLeastOneNonDefault) return 'partial'; // Almeno un input non-default, ma non tutti
        return 'untouched'; // Caso di fallback, dovrebbe essere coperto sopra
    }


    function updateNavButtonColors() { if (!targaSelezionataGlobalmente && checklistContainer.style.display === 'none') { navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched', 'active'); btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; }); return; } const targaDataJSON = localStorage.getItem(`${APP_PREFIX}data_${targaSelezionataGlobalmente}`); const targaData = targaDataJSON ? JSON.parse(targaDataJSON) : null; navButtons.forEach(btn => { btn.classList.remove('nav-btn-completed', 'nav-btn-partial', 'nav-btn-untouched'); if (!btn.classList.contains('active')) { btn.style.backgroundColor = ''; btn.style.borderColor = ''; btn.style.color = ''; } if (btn.classList.contains('active')) { return; } const targetSection = btn.dataset.target; let status = 'untouched'; if (targetSection === 'riepilogo') { if (isTargaCompleted(targaSelezionataGlobalmente)) { status = 'completed'; } else { let hasAnyDataForSummary = false; if (targaData && Object.keys(targaData).length > 0) { hasAnyDataForSummary = true; } else { ['remarketingSection', 'pneumaticiSection', 'danniVerificheSection'].forEach(secId => { if (getSectionStatus(secId, targaData) !== 'untouched') { hasAnyDataForSummary = true; } }); } status = hasAnyDataForSummary ? 'partial' : 'untouched'; } } else if (targetSection) { status = getSectionStatus(targetSection + 'Section', targaData); } if (status === 'completed') btn.classList.add('nav-btn-completed'); else if (status === 'partial') btn.classList.add('nav-btn-partial'); else btn.classList.add('nav-btn-untouched'); }); }

    function showView(viewName) {
        landingPageSection.style.display = 'none';
        checklistContainer.style.display = 'none';
        historyPageSection.style.display = 'none';
        let bodyPaddingTopValue = '20px';
        if (viewName === 'landing') {
            landingPageSection.style.display = 'block';
            pageHeaderContainer.classList.add('fixed-header');
            // headerCircles.style.display = 'flex'; // Rimosso
            navButtonsContainer.style.display = 'none';
            mainTitleGlobal.innerHTML = "Elenco Veicoli"; // Titolo semplice per la landing
            if (listaTargheCompleta.length > 0 &&
                (!document.getElementById('preloader') || document.getElementById('preloader').classList.contains('hidden')) &&
                typeof popolaTargheFiltrate === 'function') {
                popolaTargheFiltrate();
            }
            targaSelezionataGlobalmente = null;
            updateNavButtonColors();
        } else if (viewName === 'checklist' || viewName === 'history') {
            pageHeaderContainer.classList.add('fixed-header');
            // headerCircles.style.display = 'flex'; // Rimosso
            navButtonsContainer.style.display = 'flex';
            if (viewName === 'checklist') {
                if (!targaSelezionataGlobalmente) {
                    alert("Nessuna targa selezionata.");
                    showView('landing');
                    return;
                }
                checklistContainer.style.display = 'block';
                const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente);
                let subIdentifier = (veicoloAttuale && (veicoloAttuale.marca || veicoloAttuale.modello))
                    ? `${veicoloAttuale.marca || ''} ${veicoloAttuale.modello || ''}`.trim()
                    : "";
                mainTitleGlobal.innerHTML = `${targaSelezionataGlobalmente}<span>${subIdentifier}</span>`;
            } else {
                historyPageSection.style.display = 'block';
                mainTitleGlobal.innerHTML = "Cronistoria Salvataggi";
                populateSavedTargasList();
            }
            updateNavButtonColors();
        } else { // Vista non definita, nasconde l'header specifico
            pageHeaderContainer.classList.remove('fixed-header');
            // headerCircles.style.display = 'none'; // Rimosso
            navButtonsContainer.style.display = 'none';
            mainTitleGlobal.innerHTML = ""; // Titolo vuoto o generico
        }

        // Calcolo padding body
        if (pageHeaderContainer.classList.contains('fixed-header') && getComputedStyle(pageHeaderContainer).display !== 'none') {
            bodyPaddingTopValue = `${pageHeaderContainer.offsetHeight + 15}px`; // Aggiunto un po' di spazio
        } else { // Se l'header non è fisso (caso non previsto attualmente ma per robustezza)
            let nonFixedHeaderHeight = 0;
            if (mainTitleGlobal && getComputedStyle(mainTitleGlobal).display !== 'none' && !pageHeaderContainer.classList.contains('fixed-header')) {
                 nonFixedHeaderHeight = mainTitleGlobal.offsetHeight;
            }
            bodyPaddingTopValue = `${nonFixedHeaderHeight + 20}px`;
        }
        document.body.style.paddingTop = bodyPaddingTopValue;
    }

    function populateSavedTargasList() { savedTargasListContainer.innerHTML = ''; let hasSaves = false; const tempSavedTargas = []; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key.startsWith(`${APP_PREFIX}data_`)) { const targa = key.substring(`${APP_PREFIX}data_`.length); if (targa && !tempSavedTargas.includes(targa)) { tempSavedTargas.push(targa);}}} if (tempSavedTargas.length > 0) hasSaves = true; tempSavedTargas.sort(); tempSavedTargas.forEach(targa => { const vehicleDetails = listaTargheCompleta.find(v => v.targa === targa) || { marca: '', modello: '', piazzale: '' }; let displayText = targa; let details = []; if (vehicleDetails.marca) details.push(vehicleDetails.marca); if (vehicleDetails.modello) details.push(vehicleDetails.modello); if (vehicleDetails.piazzale) details.push(`(Piazzale: ${vehicleDetails.piazzale})`); if (details.length > 0) { displayText += ` - ${details.join(' ')}`; } const button = document.createElement('button'); button.classList.add('saved-targa-button'); button.textContent = displayText; button.dataset.targa = targa; button.addEventListener('click', function() { targaSelezionataGlobalmente = this.dataset.targa; showView('checklist'); loadProgress(targaSelezionataGlobalmente); const firstChecklistNavButton = Array.from(navButtons).find(btn => btn.dataset.target && btn.id !== 'backToListBtn' && btn.id !== 'historyBtn'); if (firstChecklistNavButton) { showSection(firstChecklistNavButton.dataset.target); } else if (navButtons.length > 0 && navButtons[0].dataset.target) { showSection(navButtons[0].dataset.target); }}); savedTargasListContainer.appendChild(button); }); if (!hasSaves) { savedTargasListContainer.innerHTML = '<p style="text-align:center; color: var(--text-muted-color);">Nessun salvataggio trovato.</p>'; } }
    function clearAllSavedData() {
        if (confirm("ATTENZIONE!\n\nCancellare TUTTI i dati salvati (incluse posizioni, urgenze e filtro piazzale)?\n\nAzione irreversibile.")) {
            let c = 0;
            for (let i=localStorage.length-1;i>=0;i--) {
                const k=localStorage.key(i);
                if (k.startsWith(APP_PREFIX)) {
                    localStorage.removeItem(k);c++;
                }
            }
            alert(`${c} elementi cancellati.`);
            if(sheetFilterDropdown) sheetFilterDropdown.value = 'all';
            localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all');
            populateSavedTargasList();
            if (typeof caricaEPopolaTarghe === 'function') caricaEPopolaTarghe();
            if (typeof showView === 'function') showView('landing');
        }
    }

    function setupSheetFilterDropdown() {
        if (!sheetFilterDropdown) return;
        const sources = ['all', ...new Set(listaTargheCompleta.map(item => item.piazzale).filter(p => p && p.trim() !== ''))];
        sheetFilterDropdown.innerHTML = '';
        sources.forEach(source => {
            const option = document.createElement('option');
            option.value = source;
            option.textContent = source === 'all' ? 'Tutti i Piazzali' : source; // Modificato testo default
            sheetFilterDropdown.appendChild(option);
        });

        const savedPiazzaleFilter = localStorage.getItem(`${APP_PREFIX}selectedPiazzaleFilter`);
        if (savedPiazzaleFilter && sources.includes(savedPiazzaleFilter)) {
            sheetFilterDropdown.value = savedPiazzaleFilter;
        } else {
            sheetFilterDropdown.value = 'all';
            localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, 'all');
        }

        sheetFilterDropdown.removeEventListener('change', handleSheetFilterChange);
        sheetFilterDropdown.addEventListener('change', handleSheetFilterChange);
    }

    function handleSheetFilterChange() {
        if (sheetFilterDropdown) {
            localStorage.setItem(`${APP_PREFIX}selectedPiazzaleFilter`, sheetFilterDropdown.value);
        }
        popolaTargheFiltrate();
        targaSelezionataGlobalmente = null; // Deseleziona targa quando cambia il filtro
    }

    function getItemRank(item) {
        const isUrgent = JSON.parse(localStorage.getItem(APP_PREFIX + 'urgent_' + item.targa) || 'false');
        const isCompleted = isTargaCompleted(item.targa);
        const hasData = !!localStorage.getItem(`${APP_PREFIX}data_${item.targa}`);

        if (isUrgent && !isCompleted) return 1;
        if (!isUrgent && !isCompleted && hasData) return 2;
        if (!isUrgent && !isCompleted && !hasData) return 3;
        if (!isUrgent && isCompleted) return 4;
        if (isUrgent && isCompleted) return 5;
        return 6;
    }

    function popolaTargheFiltrate() {
        const tEl = document.getElementById('targaListContainer');
        const headerEl = document.querySelector('.targa-list-table-content .targa-list-header');
        if (!tEl || !headerEl) return;
        tEl.innerHTML = '';

        // Assicura che l'header "Urgente" sia presente una sola volta
        // Questa logica è stata spostata fuori dal ciclo forEach per evitare duplicazioni
        if (!headerEl.querySelector('.targa-col-urgente')) {
            const urgenteHeaderCol = document.createElement('span');
            urgenteHeaderCol.classList.add('targa-col', 'targa-col-urgente');
            urgenteHeaderCol.textContent = 'Urg.';
            headerEl.insertBefore(urgenteHeaderCol, headerEl.firstChild); // Inserisce come primo figlio
        }


        const selectedSource = sheetFilterDropdown ? sheetFilterDropdown.value : 'all';
        let preliminaryFilteredList = selectedSource === 'all'
            ? [...listaTargheCompleta]
            : listaTargheCompleta.filter(item => item.piazzale === selectedSource);

        preliminaryFilteredList.sort((a, b) => {
            const rankA = getItemRank(a);
            const rankB = getItemRank(b);
            if (rankA !== rankB) return rankA - rankB;
            return a.targa.localeCompare(b.targa);
        });
        const filteredList = preliminaryFilteredList;

        if (filteredList.length === 0) {
            tEl.innerHTML = `<p style="text-align:center; padding:15px; color: var(--text-muted-color);">Nessuna targa trovata per "${selectedSource === 'all' ? 'Tutti i Piazzali' : selectedSource}".</p>`;
            if(targheLoadingStatus) targheLoadingStatus.textContent = selectedSource === 'all' ? "Nessuna targa nel file CSV." : `Nessuna targa per il piazzale: ${selectedSource}.`;
            return;
        }

        filteredList.forEach((item, idx) => {
            const li = document.createElement('div');
            li.classList.add('targa-list-item');

            const isItemUrgent = JSON.parse(localStorage.getItem(APP_PREFIX + 'urgent_' + item.targa) || 'false');
            const itemCompleted = isTargaCompleted(item.targa);
            const hasData = !!localStorage.getItem(`${APP_PREFIX}data_${item.targa}`);

            if (isItemUrgent) {
                li.classList.add('urgent-item');
                if (itemCompleted) li.classList.add('completed');
            } else if (itemCompleted) {
                li.classList.add('status-visto', 'completed');
            } else if (hasData) {
                li.classList.add('status-parziale');
            } else {
                li.classList.add('status-da-vedere');
            }

            // Colonna Urgente (Checkbox)
            const urgenteCol = document.createElement('span');
            urgenteCol.classList.add('targa-col', 'targa-col-urgente');
            const urgentCheckbox = document.createElement('input');
            urgentCheckbox.type = 'checkbox';
            urgentCheckbox.checked = isItemUrgent;
            urgentCheckbox.dataset.targa = item.targa;
            urgentCheckbox.title = isItemUrgent ? "Rimuovi urgenza" : "Marca come urgente";
            urgentCheckbox.addEventListener('change', function(event) {
                event.stopPropagation();
                const targa = this.dataset.targa;
                localStorage.setItem(APP_PREFIX + 'urgent_' + targa, this.checked);
                popolaTargheFiltrate();
            });
            urgentCheckbox.addEventListener('mousedown', (e) => e.stopPropagation());
            urgentCheckbox.addEventListener('click', (e) => e.stopPropagation());
            urgenteCol.appendChild(urgentCheckbox);
            li.appendChild(urgenteCol);


            // Colonna Targa
            const targaCol = document.createElement('span');
            targaCol.classList.add('targa-col', 'targa-col-targa', 'clickable-targa');
            targaCol.textContent = item.targa || 'N/D';
            targaCol.dataset.targaValue = item.targa;
            targaCol.addEventListener('click', function() {
                const selectedTarga = this.dataset.targaValue;
                if (selectedTarga) {
                    targaSelezionataGlobalmente = selectedTarga;
                    showView('checklist');
                    loadProgress(targaSelezionataGlobalmente);
                    const firstNav = Array.from(navButtons).find(b => b.dataset.target && b.id !== 'backToListBtn' && b.id !== 'historyBtn' && b.id !== 'exitAppBtn');
                    if (firstNav) showSection(firstNav.dataset.target);
                    else if (navButtons.length > 0 && navButtons[0].dataset.target) showSection(navButtons[0].dataset.target);
                }
            });
            li.appendChild(targaCol);

            const posizioneCol = document.createElement('span');
            posizioneCol.classList.add('targa-col', 'targa-col-posizione');
            const posizioneInput = document.createElement('input');
            posizioneInput.type = 'text'; posizioneInput.classList.add('posizione-input');
            posizioneInput.dataset.targa = item.targa; posizioneInput.placeholder = 'Pos.';
            posizioneInput.maxLength = 5; posizioneInput.value = loadPosizioneForTarga(item.targa);
            posizioneInput.addEventListener('mousedown', (e) => e.stopPropagation());
            posizioneInput.addEventListener('click', (e) => e.stopPropagation());
            posizioneInput.addEventListener('focus', (e) => e.stopPropagation());
            posizioneInput.addEventListener('blur', function() {
                const newPosition = this.value.trim().toUpperCase();
                if (newPosition !== loadPosizioneForTarga(this.dataset.targa)) {
                    savePosizioneForTarga(this.dataset.targa, newPosition);
                    this.style.transition = 'background-color 0.3s ease, border-color 0.3s ease';
                    this.style.borderColor = 'var(--success-color)';
                    setTimeout(() => { this.style.borderColor = 'var(--border-color)'; }, 1500);
                }
            });
            posizioneInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); this.blur(); }});
            posizioneCol.appendChild(posizioneInput);
            li.appendChild(posizioneCol);

            const marcaCol = document.createElement('span');
            marcaCol.classList.add('targa-col', 'targa-col-marca'); marcaCol.textContent = item.marca || 'N/D';
            li.appendChild(marcaCol);

            const modelloCol = document.createElement('span');
            modelloCol.classList.add('targa-col', 'targa-col-modello'); modelloCol.textContent = item.modello || 'N/D';
            li.appendChild(modelloCol);

            const piazzaleCol = document.createElement('span');
            piazzaleCol.classList.add('targa-col', 'targa-col-piazzale'); piazzaleCol.textContent = item.piazzale || 'N/D';
            li.appendChild(piazzaleCol);

            const actionsCol = document.createElement('span');
            actionsCol.classList.add('targa-col', 'targa-col-actions');
            const delB = document.createElement('button');
            delB.classList.add('action-button', 'delete-progress-btn'); delB.dataset.targa = item.targa;
            delB.title = `Cancella progressi per ${item.targa}`; delB.innerHTML = '&#x1F5D1;'; // Icona cestino
            delB.addEventListener('click', function(event) {
                event.stopPropagation();
                const tDel = this.dataset.targa;
                if (confirm(`ATTENZIONE:\n\nCancellare dati per ${tDel} (inclusa posizione e urgenza)?\n\nAzione irreversibile.`)) {
                    deleteProgressForTarga(tDel);
                }
            });
            actionsCol.appendChild(delB);
            li.appendChild(actionsCol);

            tEl.appendChild(li);
        });

        if(targheLoadingStatus) targheLoadingStatus.textContent = "Clicca su una targa per iniziare la perizia, o filtra per piazzale.";
    }


    async function caricaEPopolaTarghe() {
        const preloader = document.getElementById('preloader');
        if (targheLoadingStatus) targheLoadingStatus.textContent = "Caricamento dati dal server...";

        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL + '&_=' + new Date().getTime()); // Cache busting
            if (!response.ok) {
                let errorMsg = `Errore HTTP ${response.status}.`;
                if (response.status === 0) errorMsg = "Errore di rete o blocco CORS. Verifica la connessione e le autorizzazioni del foglio.";
                else if (response.status === 404) errorMsg = "File CSV non trovato (404). Controlla l'URL del foglio.";
                else if (response.status === 403) errorMsg = "Accesso al file CSV negato (403). Assicurati che il foglio sia pubblicato e accessibile.";
                throw new Error(errorMsg);
            }
            const csvText = await response.text();
            const lines = csvText.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');

            if (lines.length === 0) {
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessun dato nel file CSV.";
                listaTargheCompleta = [];
                if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti i Piazzali</option>';
                if (targaListContainer) targaListContainer.innerHTML = '';
                return;
            }

            listaTargheCompleta = lines.map(line => {
                const parts = line.split(',');
                return {
                    targa: (parts[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(),
                    marca: (parts[1] || '').trim().replace(/^"|"$/g, ''),
                    modello: (parts[2] || '').trim().replace(/^"|"$/g, ''),
                    piazzale: (parts[3] || '').trim().replace(/^"|"$/g, '')
                    // isUrgent rimosso, gestito da localStorage
                };
            }).filter(item => item.targa && item.targa.length > 3); // Filtra targhe non valide

            if (listaTargheCompleta.length === 0) {
                if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessuna targa valida trovata nel file CSV.";
                 if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti i Piazzali</option>';
                if (targaListContainer) targaListContainer.innerHTML = '';
                return;
            }

            setupSheetFilterDropdown(); // Popola il dropdown dei piazzali
            popolaTargheFiltrate();    // Mostra le targhe filtrate

        } catch (error) {
            console.error("Errore caricamento/popolamento targhe:", error);
            if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore caricamento: ${error.message}. Verifica l'URL e la pubblicazione del foglio Google.`;
            if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Tutti i Piazzali</option>';
            if (targaListContainer) targaListContainer.innerHTML = '';
             listaTargheCompleta = [];
        } finally {
            if (preloader) {
                preloader.classList.add('hidden');
                setTimeout(() => {
                    if (preloader) preloader.style.display = 'none';
                }, 700); // Corrisponde alla transizione CSS
            }
        }
    }

    function initSequentialAnimation() {
        const checklistContainerDiv = document.getElementById('checklistContainer');
        if (!checklistContainerDiv || checklistContainerDiv.style.display === 'none') return;
        const activeSection = checklistContainerDiv.querySelector('.category-section.active');
        if (!activeSection) return;

        activeSection.querySelectorAll('.animate-me').forEach(el => el.classList.remove('animate-me'));

        const allVisibleElementsInSection = Array.from(
            activeSection.querySelectorAll('input[type="checkbox"]:not(:disabled), select:not(:disabled), textarea:not(:disabled)')
        ).filter(el => { // Filtra solo elementi visibili
            let current = el;
            while (current && current !== activeSection.parentElement) { // Controlla visibilità parenti
                if (getComputedStyle(current).display === 'none' || getComputedStyle(current).visibility === 'hidden') return false;
                current = current.parentElement;
            }
            return el.offsetParent !== null; // Verifica se l'elemento è renderizzato
        });

        const startIndex = allVisibleElementsInSection.findIndex(el => isInputDefault(el));

        if (startIndex === -1 && allVisibleElementsInSection.length > 0) { // Tutti i campi sono già compilati
            return;
        }
        if (allVisibleElementsInSection.length === 0) { // Nessun campo compilabile
             return;
        }

        const elementsToAnimate = allVisibleElementsInSection.slice(startIndex >= 0 ? startIndex : 0);

        if (elementsToAnimate.length === 0) return;

        let currentIndex = 0;
        let activeListeners = []; // Array per tenere traccia dei listener attivi

        // Funzione per rimuovere tutti i listener di animazione attivi
        function clearAllActiveAnimationListeners() {
            activeListeners.forEach(({element, type, handler}) => {
                element.removeEventListener(type, handler);
                element.classList.remove('animate-me');
            });
            activeListeners = [];
        }
        clearAllActiveAnimationListeners(); // Pulisce listener precedenti prima di iniziare

        function animateNextElement() {
            if (currentIndex >= elementsToAnimate.length) { // Fine degli elementi da animare
                return;
            }
            const currentElement = elementsToAnimate[currentIndex];
            if (!isInputDefault(currentElement)) { // Se l'elemento è già compilato, passa al successivo
                currentIndex++;
                animateNextElement();
                return;
            }

            currentElement.classList.add('animate-me');
            // Scroll migliorato per centrare l'elemento se possibile
            currentElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });

            const onValueChange = (event) => {
                let processChange = false;
                if (event.type === 'change') { // Per checkbox e select
                    processChange = true;
                } else if (event.type === 'blur' && currentElement.tagName !== 'SELECT') { // Per input text e textarea on blur
                    processChange = true;
                } else if (event.type === 'blur' && currentElement.tagName === 'SELECT' && !isInputDefault(currentElement)) { // Per select on blur solo se un valore è stato scelto
                     processChange = true;
                }

                if (processChange) {
                    currentElement.classList.remove('animate-me');
                    // Rimuove specifici listener
                    currentElement.removeEventListener('change', onValueChange);
                    currentElement.removeEventListener('blur', onValueChange);
                    // Filtra via il listener dall'array activeListeners
                    activeListeners = activeListeners.filter(listener => listener.element !== currentElement);
                    currentIndex++;
                    setTimeout(animateNextElement, 50); // Breve ritardo prima di passare al successivo
                }
            };

            currentElement.addEventListener('change', onValueChange);
            if (currentElement.tagName === 'SELECT' || currentElement.tagName === 'TEXTAREA' || currentElement.type === 'text') {
                currentElement.addEventListener('blur', onValueChange);
                 activeListeners.push({element: currentElement, type: 'blur', handler: onValueChange}); // Aggiunge listener blur
            }
            activeListeners.push({element: currentElement, type: 'change', handler: onValueChange}); // Aggiunge listener change
        }
        animateNextElement(); // Inizia l'animazione dal primo elemento
    }


    function showSection(targetId) {
        // Rimuove l'animazione da tutti gli elementi prima di cambiare sezione
        document.querySelectorAll('#checklistContainer .animate-me').forEach(el => {
            el.classList.remove('animate-me');
        });
        sections.forEach(s => s.classList.toggle('active', s.id === targetId + 'Section'));
        navButtons.forEach(b => {
            b.classList.toggle('active', b.dataset.target === targetId);
            // Aggiunta per far funzionare l'indicatore ::after con JS
            if (b.dataset.target === targetId) {
                b.classList.add('active');
            } else {
                b.classList.remove('active');
            }
        });
        updateNavButtonColors(); // Aggiorna i colori dei bottoni di navigazione (completato, parziale, etc.)
        const targetSectionElement = document.getElementById(targetId + 'Section');
        // Se la sezione target è una sezione di checklist (non riepilogo), avvia l'animazione
        if (targetSectionElement && Array.from(sections).includes(targetSectionElement) && targetId !== 'riepilogo') {
             setTimeout(initSequentialAnimation, 100); // Ritardo per permettere il rendering della sezione
        } else if (targetId === 'riepilogo') {
            generateSummary(); // Genera il contenuto del riepilogo
        }
    }

    navButtons.forEach(b => b.addEventListener('click', function() { showSection(this.dataset.target); }));

    function getSelectText(selectElementOrId) {
        const el = typeof selectElementOrId === 'string' ? document.getElementById(selectElementOrId) : selectElementOrId;
        if (el && el.tagName === 'SELECT' && el.value !== "") {
            if (el.selectedIndex >= 0 && el.options[el.selectedIndex]) {
                return el.options[el.selectedIndex].text;
            }
            return el.value; // Fallback al valore se il testo dell'opzione non è disponibile
        }
        return "N/S"; // Non Selezionato o Non Specificato
    }

    function generateSummary() {
        summaryContent.innerHTML = ''; // Pulisce il contenuto precedente
        let targa = targaSelezionataGlobalmente || "N/D";
        function createSummaryItem(label, value, isAnomaly = false) {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('summary-item');
            if (isAnomaly) itemDiv.classList.add('summary-anomaly');
            itemDiv.innerHTML = `<strong>${label}:</strong> ${value}`;
            return itemDiv;
        }
        summaryContent.appendChild(createSummaryItem("Targa", targa));
        if (targaSelezionataGlobalmente) { // Aggiunge dettagli veicolo se disponibili
            const veicoloAttuale = listaTargheCompleta.find(v => v.targa === targaSelezionataGlobalmente);
            let marcaVeicolo = "N/D", modelloVeicolo = "N/D";
            if (veicoloAttuale) {
                marcaVeicolo = veicoloAttuale.marca || "N/D";
                modelloVeicolo = veicoloAttuale.modello || "N/D";
            }
            summaryContent.appendChild(createSummaryItem("Marca", marcaVeicolo));
            summaryContent.appendChild(createSummaryItem("Modello", modelloVeicolo));
            summaryContent.appendChild(createSummaryItem("Posizione", loadPosizioneForTarga(targaSelezionataGlobalmente) || "N/D"));
        } else {
            summaryContent.appendChild(createSummaryItem("Marca", "N/D"));
            summaryContent.appendChild(createSummaryItem("Modello", "N/D"));
            summaryContent.appendChild(createSummaryItem("Posizione", "N/D"));
        }
        summaryContent.innerHTML += `<h3>Remarketing:</h3>`;

        const tipoTrazioneValue = tipoTrazioneSelect ? tipoTrazioneSelect.value : "";
        const isEV = tipoTrazioneValue === 'elettrico';
        summaryContent.appendChild(createSummaryItem("Trazione Veicolo", getSelectText(tipoTrazioneSelect)));


        let equipaggiamento = getSelectText('tipo_equipaggiamento'), presenzaEquip = getSelectText('equipaggiamento_presenza');
        // Considera anomalia se l'equipaggiamento è specificato ma mancante
        let equipAnomalia = (equipaggiamento !== "N/S" && equipaggiamento !== "" && equipaggiamento !== "Seleziona..." && presenzaEquip === "Mancante");
        summaryContent.appendChild(createSummaryItem("Equip. Vano Carico", equipaggiamento, equipAnomalia && presenzaEquip === "Mancante"));
        summaryContent.appendChild(createSummaryItem("Presenza Equip.", presenzaEquip, equipAnomalia));
        let kmStato = getSelectText('stato_chilometri');
        summaryContent.appendChild(createSummaryItem("Stato Chilometri", kmStato, kmStato === "Non rilevabili"));
        let cdcStato = getSelectText('stato_cdc');
        summaryContent.appendChild(createSummaryItem("Stato CDC", cdcStato, cdcStato === "Mancante"));
        summaryContent.appendChild(createSummaryItem("Chiave con Telecomando", getSelectText('chiave_telecomando'), getSelectText('chiave_telecomando') === "Non Presente"));
        summaryContent.appendChild(createSummaryItem("Seconda Chiave", getSelectText('seconda_chiave'), getSelectText('seconda_chiave') === "Non Presente"));
        if (isEV) { // Mostra campi specifici EV solo se la trazione è elettrica
            summaryContent.innerHTML += `<h4>Dotazioni Veicolo Elettrico:</h4>`;
            summaryContent.appendChild(createSummaryItem("Cavo Ricarica Rapida", getSelectText('cavo_ricarica_rapida'), getSelectText('cavo_ricarica_rapida') === "Non Presente"));
            summaryContent.appendChild(createSummaryItem("Cavo Ricarica Domestica", getSelectText('cavo_ricarica_domestica'), getSelectText('cavo_ricarica_domestica') === "Non Presente"));
        }
        summaryContent.innerHTML += `<h3>Pneumatici:</h3>`;
        const pneumaticiFields = [ { id: 'pneumatico_as', label: 'Ant. Sinistro' }, { id: 'pneumatico_ad', label: 'Ant. Destro' }, { id: 'pneumatico_pd', label: 'Post. Destro' }, { id: 'pneumatico_ps', label: 'Post. Sinistro' }];
        pneumaticiFields.forEach(pneu => { summaryContent.appendChild(createSummaryItem(pneu.label, getSelectText(pneu.id), getSelectText(pneu.id) === "Non conforme")); });
        summaryContent.innerHTML += `<h3>Danni/Verifiche:</h3>`;
        summaryContent.appendChild(createSummaryItem("Motore si Accende", getSelectText('motore_accende'), getSelectText('motore_accende') === 'Non OK'));
        summaryContent.appendChild(createSummaryItem("Stato Batteria", getSelectText('batteria_stato'), getSelectText('batteria_stato') === 'Non OK'));
        const noteDanniValue = document.getElementById('note_danni_verifiche') ? document.getElementById('note_danni_verifiche').value.trim() : "";
        if (noteDanniValue && noteDanniValue.toLowerCase() !== "nessuna anomalia da segnalare.") { // Mostra solo se ci sono note reali
            const noteDiv = document.createElement('div');
            noteDiv.classList.add('summary-item', 'summary-notes');
            const strongNode = document.createElement('strong'); strongNode.textContent = "Note Danni/Verifiche: ";
            const contentDiv = document.createElement('div'); // Div separato per il testo delle note
            // contentDiv.style.whiteSpace = 'pre-wrap'; // Mantiene la formattazione del testo
            // contentDiv.style.paddingLeft = '10px'; // Indentazione per il testo delle note
            contentDiv.textContent = noteDanniValue;
            noteDiv.appendChild(strongNode);
            noteDiv.appendChild(contentDiv);
            summaryContent.appendChild(noteDiv);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        setCssRgbVariables(); // Imposta le variabili RGB per i colori
        const preloader = document.getElementById('preloader');

        document.querySelectorAll('.fill-defaults-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.dataset.sectionid;
                if (sectionId) {
                    fillSectionPositiveOrDefaults(sectionId);
                }
            });
        });

        if (tipoTrazioneSelect) {
            tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);
        }
        handleTrazioneChange(); // Chiamata iniziale per impostare lo stato dei campi dipendenti

        if(backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if(historyBtn) historyBtn.addEventListener('click', () => showView('history'));
        if(clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', clearAllSavedData);
        if(backToLandingFromHistoryBtn) backToLandingFromHistoryBtn.addEventListener('click', () => showView('landing'));
        if(saveAndReturnBtn) saveAndReturnBtn.addEventListener('click',handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button=>button.addEventListener('click',handleSaveAndNext));

        async function initializeApplicationViewAndLoadData() {
            showView('landing'); // Mostra la landing page come predefinita

            if (preloader) { // Gestione preloader
                preloader.style.display = 'flex';
                preloader.classList.remove('hidden');
                preloader.style.opacity = '1';
                preloader.style.visibility = 'visible';
                const loadingText = preloader.querySelector('.loading-text');
                if (loadingText) loadingText.textContent = 'CARICAMENTO ELENCO...';
            }
            await caricaEPopolaTarghe(); // Carica i dati delle targhe
        }

        initializeApplicationViewAndLoadData(); // Avvia l'applicazione

        if (exitAppBtn) {
            exitAppBtn.addEventListener('click', () => {
                const exitCurtain = document.getElementById('exit-curtain');
                const mainContentWrapper = document.getElementById('mainContentWrapper');
                const pageHeader = document.getElementById('pageHeaderContainer');

                if (exitCurtain) {
                    if (mainContentWrapper) mainContentWrapper.style.display = 'none';
                    if (pageHeader) pageHeader.style.display = 'none';
                    document.body.style.paddingTop = '0px'; // Resetta padding corpo

                    const exitLoadingText = exitCurtain.querySelector('.loading-text');
                    const barContainer = exitCurtain.querySelector('.loader-bar-container');
                    const defaultCloseText = "CHIUSURA IN CORSO...";
                    const glitchText = "ERRORE DI SISTEMA...";

                    // --- Fase 1: Animazione normale (0.8 secondi) ---
                    exitCurtain.classList.remove('glitching', 'flash-out-effect');
                    if (exitLoadingText) {
                        exitLoadingText.textContent = defaultCloseText;
                        exitLoadingText.style.animation = 'textGlow 1.8s infinite alternate ease-in-out';
                        exitLoadingText.style.color = '#ff8787';
                        exitLoadingText.style.textShadow = '';
                    }
                    exitCurtain.setAttribute('data-text', defaultCloseText);
                    if (barContainer) barContainer.style.display = 'flex';

                    exitCurtain.classList.add('visible-no-transition'); // Mostra senza transizione iniziale
                    exitCurtain.style.display = 'flex'; // Assicura che sia visibile

                    setTimeout(() => {
                        // --- Fase 2: Effetto glitch (0.8 secondi) ---
                        exitCurtain.classList.add('glitching');
                        if (exitLoadingText) {
                           exitLoadingText.textContent = glitchText;
                           exitLoadingText.style.animation = ''; // Lascia che CSS per .glitching .loading-text prenda il controllo
                        }
                        exitCurtain.setAttribute('data-text', glitchText);

                        setTimeout(() => {
                            // --- Fase 3: Visualizzazione testo "Applicazione terminata." (0.7 secondi) ---
                            exitCurtain.classList.remove('glitching');
                            if (exitLoadingText) {
                                exitLoadingText.textContent = 'Applicazione terminata.';
                                exitLoadingText.style.animation = 'none';
                                exitLoadingText.style.color = '#FFFFFF';
                                exitLoadingText.style.textShadow = 'none';
                            }
                            if (barContainer) barContainer.style.display = 'none'; // Nasconde le barre di caricamento

                            setTimeout(() => {
                                // --- Fase 4: Effetto Flash Out sul testo (0.5 secondi) ---
                                exitCurtain.classList.add('flash-out-effect');
                                // L'animazione textFlashOut è applicata da CSS

                                setTimeout(() => {
                                    // --- Fase 5: Dopo l'animazione Flash Out ---
                                    const macrodroidUrl = 'https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/chiudi';
                                    fetch(macrodroidUrl, { method: 'GET', mode: 'no-cors' }) // no-cors per triggerare webhook senza attendere risposta completa
                                        .then(response => console.log('Macrodroid trigger request sent.'))
                                        .catch(error => console.error('Error sending Macrodroid trigger:', error));
                                }, 500); // Durata di textFlashOut

                            }, 700); // Durata visualizzazione "Applicazione terminata."

                        }, 800); // Durata effetto glitch

                    }, 800); // Durata animazione normale
                }
            });
        }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>
