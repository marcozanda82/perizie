<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Perizia Veicolo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        /* CSS non modificato, rimane identico */
        #preloader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 1; visibility: visible; }
        #preloader.hidden { opacity: 0; visibility: hidden; transition: opacity 0.7s ease-out, visibility 0.7s ease-out; }
        #exit-curtain { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000000; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in, visibility 0.5s ease-in; }
        #exit-curtain.hidden { opacity: 0; visibility: hidden; transition: opacity 0.7s ease-out, visibility 0.7s ease-out; }
        #exit-curtain.visible-no-transition { opacity: 1; visibility: visible; transition: none; }
        .loader-bar-container { display: flex; gap: 10px; margin-bottom: 25px; }
        .loader-bar { width: 15px; height: 70px; background-color: #007bff; animation: barPulse 1.2s infinite ease-in-out; box-shadow: 0 0 8px #007bff, 0 0 15px #00aeff; border-radius: 3px; }
        .loader-bar:nth-child(2) { animation-delay: 0.2s; }
        .loader-bar:nth-child(3) { animation-delay: 0.4s; }
        #exit-curtain:not(.glitching):not(.flash-out-effect) .loader-bar { animation-direction: reverse; }
        #exit-curtain.glitching:not(.flash-out-effect) .loader-bar { animation-direction: normal; }
        @keyframes barPulse { 0%, 100% { transform: scaleY(0.3); opacity: 0.6; } 50% { transform: scaleY(1); opacity: 1; } }
        #preloader .loading-text, #exit-curtain .loading-text { font-size: 1.6em; letter-spacing: 1px; }
        #preloader .loading-text { color: #00aeff; animation: textGlow 1.8s infinite alternate ease-in-out; text-align: center; width: 100%; }
        #exit-curtain .loading-text { color: #ff8787; }
        @keyframes textGlow { from { text-shadow: 0 0 5px currentColor, 0 0 10px currentColor; opacity: 0.8;} to { text-shadow: 0 0 10px currentColor, 0 0 20px currentColor, 0 0 30px currentColor; opacity: 1;} }
        #exit-curtain.glitching .loading-text { animation: glitchText 0.8s infinite steps(1, end), textGlow 1.8s infinite alternate ease-in-out; color: #ff3030 !important; position: relative; z-index: 10; }
        #exit-curtain.glitching::before, #exit-curtain.glitching::after { content: attr(data-text); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: auto; padding: 0 20px; text-align: center; font-size: 1.6em; letter-spacing: 1px; background: #000000; overflow: hidden; clip-path: inset(50% 50% 50% 50%); z-index: 5; }
        #exit-curtain.glitching::before { color: #00ffff; animation: glitchEffect 0.3s infinite linear alternate-reverse; }
        #exit-curtain.glitching::after { color: #ff00ff; animation: glitchEffect 0.2s infinite linear alternate-reverse, glitchSkew 0.5s infinite linear alternate; animation-delay: -0.1s; }
        @keyframes glitchEffect { 0% { clip-path: inset(40% 0 30% 0); transform: translate(-50.5%, -50.1%) skewX(5deg); opacity: 0.8; } 10% { clip-path: inset(20% 0 70% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.7; } 20% { clip-path: inset(10% 0 55% 0); transform: translate(-49.8%, -50.2%) skewX(-3deg); opacity: 0.9; } 30% { clip-path: inset(50% 0 50% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; } 40% { clip-path: inset(60% 0 10% 0); transform: translate(-50.2%, -49.9%) skewY(2deg); opacity: 1; } 50% { clip-path: inset(80% 0 5% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.75; } 60% { clip-path: inset(25% 0 40% 0); transform: translate(-50.1%, -50.3%) skewX(4deg); opacity: 0.85; } 70% { clip-path: inset(15% 0 75% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.9; } 80% { clip-path: inset(50% 0 20% 0); transform: translate(-49.9%, -49.8%) skewY(-3deg); opacity: 1; } 90% { clip-path: inset(70% 0 10% 0); transform: translate(-50%, -50%) skewX(0deg); opacity: 0.6; } 100% { clip-path: inset(35% 0 45% 0); transform: translate(-50.3%, -50.0%) skewX(-2deg); opacity: 0.8; } }
        @keyframes glitchSkew { 0% { transform: translate(-50%, -50%) skew(-5deg, -2deg); } 100% { transform: translate(-50%, -50%) skew(5deg, 2deg); } }
        @keyframes glitchText { 0%, 100% { text-shadow: 0 0 3px red, 0 0 5px blue, 0 0 1px white; transform: translateX(0) translateY(0) skewX(0deg); opacity: 1;} 10% { text-shadow: 1px 1px 3px red, -1px -1px 5px blue, 0 0 1px white; transform: translateX(-2px) translateY(1px) skewX(5deg); opacity: 0.8;} 90% { text-shadow: 1px 1px 3px red, -1px -1px 5px blue, 0 0 1px white; transform: translateX(-1px) translateY(1px) skewX(1deg); opacity: 0.9;} }
        #exit-curtain.flash-out-effect .loading-text { color: #FFFFFF !important; text-shadow: none !important; animation: textFlashOut 0.5s forwards ease-out; transform-origin: center center; }
        @keyframes textFlashOut { 0% { opacity: 1; transform: scale(1); text-shadow: 0 0 5px rgba(255,255,255,0.5); } 50% { opacity: 1; transform: scale(1.1); color: #FFFFE0 !important; text-shadow: 0 0 15px #FFFFFF, 0 0 25px #FFFFFF, 0 0 35px #FFFFE0, 0 0 50px #FFFF99; } 99% { opacity: 0.8; transform: scale(1.05); } 100% { opacity: 0; transform: scale(0.8); text-shadow: none; color: transparent !important; } }
        .header-circles { display: flex; justify-content: space-around; align-items: center; width: 100%; box-sizing: border-box; }
        .circle-button { width: 75px; height: 75px; background-color: #383838; color: #e0e0e0; border: 1px solid #555; border-radius: 6px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, color 0.3s ease; font-size: 2.1em; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .circle-button:hover { background-color: #4a4a4a; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .circle-button:active { background-color: #555; transform: translateY(0px); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .circle-button i { line-height: 1; }
        #headerShutdownBtn i { color: #dc3545; }
        #headerPhotosBtn i { color: #007bff; }
        #headerPeriziaBtn i { color: #ffc107; }
        #headerCameraBtn i { color: #28a745; }
        #headerShutdownBtn:hover i, #headerPhotosBtn:hover i, #headerPeriziaBtn:hover i, #headerCameraBtn:hover i { color: #ffffff; }
        #bottomNavCircles { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; align-items: center; padding: 10px 0; box-sizing: border-box; background-color: #2a2a2a; border-top: 1px solid #444; z-index: 2025; }
        body { font-family: sans-serif; line-height: 1.6; margin: 0; background-color: #1e1e1e; color: #f0f0f0; transition: padding-top 0.3s ease, padding-bottom 0.3s ease; padding-bottom: 70px; }
        .content-wrapper { padding: 20px; }
        h1, h2 { text-align: center; color: #ffffff; }
        h1#mainTitleGlobal { line-height: 1.2; margin-bottom: 10px; margin-top: 5px; font-size: 1.6em;}
        #targaDropdownContainer { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; margin-top: 5px; margin-bottom: 10px; }
        #targaSwitcherDropdown { padding: 8px 12px; background-color: #383838; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; min-width: 180px; max-width: 220px; font-size: 1.1em; font-family: sans-serif; cursor: pointer; text-align: center; }
        #targaSwitcherDropdown:hover { background-color: #454545; border-color: #666; }
        #targaSwitcherDropdown option { padding: 5px; background-color: #383838; color: #f0f0f0; text-align: left; }
        #targaDetailsDisplay { font-size: 0.8em; color: #cccccc; margin-top: 3px; text-align: center; min-height: 1.2em; line-height: 1.3; }
        @media (min-width: 480px) { #targaDropdownContainer { flex-direction: row; align-items: center; } #targaDetailsDisplay { margin-top: 0; margin-left: 10px; text-align: left; } }
        h2.section-title { color: #cccccc; border-bottom: 1px solid #444444; padding-bottom: 5px; margin-top: 30px; text-align: left; }
        #galleryPageSection h2.section-title { margin-top: 10px; text-align: center; }
        h3, h4 { color: #bbbbbb; margin-top: 20px; margin-bottom: 10px; }
        h4 {font-size: 1.1em; color: #c0c0c0; margin-top: 15px; margin-bottom: 8px;}
        ul { list-style-type: none; padding-left: 0; }
        li { margin-bottom: 15px; }
        input[type="checkbox"], input[type="text"], input[type="url"], select, input[type="radio"], textarea { margin-right: 8px; vertical-align: middle; padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; margin-bottom: 5px; font-family: sans-serif;}
        input[type="text"], input[type="url"], textarea { width: calc(100% - 20px); box-sizing: border-box; }
        input[type="radio"] { margin-left: 5px; }
        select:not(#targaSwitcherDropdown) { min-width: 220px; }
        label { vertical-align: middle; display: block; margin-bottom: 5px; color: #e0e0e0; }
        textarea {resize: vertical;}
        .category-section ul li > input[type="checkbox"] { vertical-align: middle; margin-right: 4px; }
        .category-section ul li > input[type="checkbox"] + label { display: inline-block; vertical-align: middle; margin-bottom: 0; }
        #pageHeaderContainer { background-color: #1e1e1e; z-index: 1000; width: 100%; }
        #pageHeaderContainer.fixed-header { position: fixed; top: 0; left: 0; padding-bottom: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 2030; }
        #navButtons { display: flex; flex-direction: column; align-items: center; width: 100%; }
        #mainPageNavButtons { display: flex; justify-content: center; flex-wrap: nowrap; overflow-x: auto; padding: 5px 0; width: calc(100% - 20px); max-width: 700px; }
        #mainPageNavButtons button { margin: 3px; flex-shrink: 0; }
        #utilityNavButtons { display: flex; justify-content: center; flex-wrap: wrap; margin-top: 5px; margin-bottom: 5px; }
        #utilityNavButtons button { margin: 3px 5px; }
        #navButtons button, .action-button { padding: 8px 15px; cursor: pointer; background-color: #007bff; color: white; border: 1px solid #0056b3; border-radius: 4px; transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease; font-size: 0.9em; }
        .save-and-next-btn { background-color: #0069d9 !important; border-color: #005cbf !important; }
        .save-and-next-btn:hover { background-color: #0056b3 !important; border-color: #004085 !important; }
        #navButtons button:hover, .action-button:hover { background-color: #0056b3; border-color: #004085; }
        @keyframes activeButtonGlow { 0% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; } 50% { box-shadow: 0 0 10px rgba(0, 150, 255, 1), 0 0 15px rgba(0, 150, 255, 0.7) inset; } 100% { box-shadow: 0 0 4px rgba(0, 123, 255, 0.7), 0 0 6px rgba(0, 123, 255, 0.5) inset; } }
        #navButtons button.active { background-color: #0056b3 !important; border-color: #004085 !important; color: white !important; animation-name: activeButtonGlow; animation-duration: 1.8s; animation-iteration-count: infinite; animation-timing-function: ease-in-out; animation-direction: alternate; }
        #navButtons button.nav-btn-completed { background-color: #28a745 !important; border-color: #1e7e34 !important; color: white !important; }
        #navButtons button.nav-btn-partial { background-color: #ffc107 !important; border-color: #e0a800 !important; color: #212529 !important; }
        #navButtons button.nav-btn-untouched { background-color: #dc3545 !important; border-color: #c82333 !important; color: white !important; }
        #landingPageSection, .category-section, #historyPageSection, #galleryPageSection, .camera-page-section { padding: 20px; border: 1px solid #444; border-radius: 8px; margin-top: 20px; background-color: #2a2a2a; max-width: 850px; margin-left: auto; margin-right: auto; }
        .category-section, #historyPageSection, #galleryPageSection, .camera-page-section { display: none; }
        #landingPageSection { display: block; }
        .category-section.active { display: block; }
        .category-section { position: relative; }
        .page-action-buttons-container { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 10; }
        .page-action-button { width: 35px; height: 35px; color: white; border: 1px solid; border-radius: 4px; font-size: 1.5em; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; }
        .fill-defaults-btn { background-color: #007bff; border-color: #0056b3; }
        .fill-defaults-btn:hover { background-color: #0056b3; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .fill-defaults-btn:active { background-color: #004085; }
        .reset-page-btn { background-color: #ffc107; border-color: #e0a800; color: #212529; }
        .reset-page-btn:hover { background-color: #e0a800; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .reset-page-btn:active { background-color: #c69500; }
        .summary-item { margin-bottom: 8px; padding: 8px; background-color: #333; border-radius: 3px; }
        .summary-item strong { color: #00aeff; }
        .summary-anomaly { background-color: #5d3d3d !important; color: #ffdddd !important; border-left: 3px solid #ff8888; padding-left: 10px !important; }
        .summary-anomaly strong { color: #ffc0c0 !important; }
        .summary-notes { background-color: #3a3a4a !important; color: #e0e0ff !important; border-left: 3px solid #8888ff; padding-left: 10px !important; }
        .summary-notes strong { color: #c0c0ff !important; }
        .table-scroll-wrapper { overflow-x: auto; width: 100%; margin-bottom: 10px; border: 1px solid #444; border-radius: 4px; }
        .targa-list-table-content { min-width: 650px; }
        .targa-list-header { display: flex; font-weight: bold; padding: 0 10px 0 10px; border-bottom: 2px solid #777; color: #ddd; background-color: #3a3a3a; }
        .targa-list-header .targa-col { padding: 6px 8px; border-right: 1px solid #555; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1;}
        .targa-list-header .targa-col:last-child { border-right: none; }
        .targa-list-header .targa-col-actions { flex-basis: 60px; text-align: center; flex-grow: 0; }
        .targa-list-header .targa-col-urgenza { flex-basis: 70px; text-align: center; flex-grow: 0; }
        #targaListContainer { margin-top: 0; max-height: 350px; overflow-y: auto; overflow-x: visible; padding: 0; }
        .targa-list-item { display: flex; align-items: center; border-bottom: 1px solid #444; padding: 0 10px 0 10px; }
        .targa-list-item:last-child { border-bottom: none; }
        .targa-list-item .targa-col { padding: 8px 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-right: 1px solid #444; text-align: left; flex-grow: 1; display: flex; align-items: center; }
        .targa-list-item .targa-col:last-child { border-right: none; }
        .targa-col-targa { flex-basis: 13%; min-width: 75px;}
        .targa-col-targa.clickable-targa { cursor: pointer; color: #8ab4f8; font-weight: 500; transition: color 0.2s ease; }
        .targa-list-item:hover .targa-col-targa.clickable-targa { color: #a1c5ff; text-decoration: underline; }
        .targa-col-posizione{ flex-basis: 12%; min-width: 60px; padding: 4px !important; }
        .targa-col-urgenza { flex-basis: 10%; min-width: 50px; text-align: center; justify-content: center;}
        .targa-col-urgenza input[type="checkbox"] { margin: 0 auto; }
        .targa-col-marca { flex-basis: 18%; min-width: 90px;}
        .targa-col-modello { flex-basis: 22%; min-width: 100px;}
        .targa-col-piazzale { flex-basis: 18%; min-width: 70px;}
        .targa-col-actions { flex-basis: 7%; min-width: 50px; flex-grow: 0; text-align: center; }
        .targa-col-posizione input.posizione-input { width: 100%; padding: 6px 4px; margin: 0; box-sizing: border-box; background-color: #404040; color: #f0f0f0; border: 1px solid #5a5a5a; border-radius: 3px; font-size: 0.9em; text-align: center; }
        .targa-col-posizione input.posizione-input:focus { background-color: #484848; border-color: #777; outline: none; }
        .delete-progress-btn { background-color: #dc3545; border-color: #c82333; color: white; padding: 3px 7px; font-size: 0.8em; line-height: 1; flex-shrink: 0; border-radius: 3px; }
        .delete-progress-btn:hover { background-color: #c82333; border-color: #bd2130; }
        .targa-list-item.status-da-vedere { background-color: #383838 !important; }
        .targa-list-item.status-da-vedere:hover { background-color: #454545 !important; }
        .targa-list-item.status-da-vedere .targa-col { color: #f0f0f0 !important; }
        .targa-list-item.status-da-vedere .targa-col-targa.clickable-targa { color: #8ab4f8 !important; }
        .targa-list-item.status-da-vedere:hover .targa-col-targa.clickable-targa { color: #a1c5ff !important; }
        .targa-list-item.status-da-vedere .targa-col-posizione input.posizione-input { background-color: #4f4f4f; color: #f0f0f0; border-color: #5a5a5a; }
        .targa-list-item.status-visto { background-color: #2E4B35 !important; }
        .targa-list-item.status-visto:hover { background-color: #395c40 !important; }
        .targa-list-item.status-visto .targa-col-targa, .targa-list-item.status-visto .targa-col-marca, .targa-list-item.status-visto .targa-col-modello, .targa-list-item.status-visto .targa-col-piazzale { color: #a3cca3 !important; }
        .targa-list-item.status-visto .targa-col-targa.clickable-targa { color: #81c784 !important; }
        .targa-list-item.status-visto:hover .targa-col-targa.clickable-targa { color: #9ccc65 !important; }
        .targa-list-item.status-visto .targa-col-posizione input.posizione-input { background-color: #384c3d; color: #d0e0d0; }
        .targa-list-item.urgent-item { background-color: #4d3232 !important; border-left: 3px solid #ff6b6b; }
        .targa-list-item.urgent-item:hover { background-color: #5e3f3f !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col { color: #ffc0c0 !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-targa.clickable-targa { color: #ff8a80 !important; }
        .targa-list-item.urgent-item:not(.completed):hover .targa-col-targa.clickable-targa { color: #ff5252 !important; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-posizione input.posizione-input { background-color: #5a3e3e; color: #ffc0c0; }
        .targa-list-item.urgent-item:not(.completed) .targa-col-urgenza input[type="checkbox"] { accent-color: #ff8a80; }
        .targa-list-item.completed .targa-col-targa, .targa-list-item.completed .targa-col-marca, .targa-list-item.completed .targa-col-modello, .targa-list-item.completed .targa-col-piazzale { color: #888 !important; }
        .targa-list-item.status-visto.completed .targa-col-targa, .targa-list-item.status-visto.completed .targa-col-marca, .targa-list-item.status-visto.completed .targa-col-modello, .targa-list-item.status-visto.completed .targa-col-piazzale { color: #a3cca3 !important; }
        .targa-list-item.status-visto.completed .targa-col-targa.clickable-targa { color: #81c784 !important; }
        .targa-list-item.urgent-item.completed .targa-col-targa, .targa-list-item.urgent-item.completed .targa-col-marca, .targa-list-item.urgent-item.completed .targa-col-modello, .targa-list-item.urgent-item.completed .targa-col-piazzale { color: #a07c7c !important; }
        .targa-list-item.urgent-item.completed .targa-col-targa.clickable-targa { color: #ff8a80 !important; }
        .targa-list-item.urgent-item.completed .targa-col-posizione input.posizione-input { background-color: #4a2e2e; color: #a07c7c; }
        .targa-list-item.urgent-item.completed .targa-col-urgenza input[type="checkbox"] { accent-color: #a07c7c; }
        .targa-list-item.status-parziale { background-color: #ffc107 !important; }
        .targa-list-item.status-parziale:hover { background-color: #e0a800 !important; }
        .targa-list-item.status-parziale .targa-col { color: #212529 !important; }
        .targa-list-item.status-parziale .targa-col-targa.clickable-targa { color: #b8860b !important; }
        .targa-list-item.status-parziale:hover .targa-col-targa.clickable-targa { color: #8B4513 !important; }
        .targa-list-item.status-parziale .targa-col-posizione input.posizione-input { background-color: #ffe082; color: #212529; border-color: #ffc107; }
        .targa-list-item.status-parziale .targa-col-urgenza input[type="checkbox"] { accent-color: #b8860b; }
        .targa-list-item.locally-deleted { opacity: 0.5; background-color: #404040 !important; }
        .targa-list-item.locally-deleted .targa-col-targa { text-decoration: line-through; color: #aaa !important; }
        .targa-list-item.locally-deleted .clickable-targa { cursor: default !important; text-decoration: line-through !important; }
        .targa-list-item.locally-deleted .delete-progress-btn { display: none; }
        .targa-list-item.locally-deleted input, .targa-list-item.locally-deleted select { pointer-events: none; opacity: 0.7; }
        #targheLoadingStatus { text-align: center; padding: 10px; color: #00aeff; }
        #savedTargasListContainer { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; border: 1px solid #333; border-radius: 4px; margin-bottom: 20px; }
        .saved-targa-button { display: block; width: 100%; padding: 10px; background-color: #383838; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; text-align: left; cursor: pointer; font-size: 0.95em; }
        .saved-targa-button:hover { background-color: #454545; }
        #historyPageSection .action-button { margin-right: 10px; }
        #sheetFilterContainer { margin-bottom: 15px; text-align: center; }
        #sheetFilterContainer label { margin-right: 10px; color: #ccc; display: inline-block; }
        #sheetFilterDropdown { padding: 8px; background-color: #333; color: #f0f0f0; border: 1px solid #555; border-radius: 4px; min-width: 250px; vertical-align: middle; }
        .animate-me { animation: pulseHighlight 1.5s infinite alternate; outline: 2px solid rgba(0, 123, 255, 0.0); transition: outline 0.3s ease, box-shadow 0.3s ease; }
        @keyframes pulseHighlight { from { outline: 2px solid rgba(0, 123, 255, 0.7); box-shadow: 0 0 5px rgba(0, 123, 255, 0.5), 0 0 8px rgba(0, 123, 255, 0.3) inset; } to { outline: 3px solid rgba(0, 150, 255, 1); box-shadow: 0 0 10px rgba(0, 150, 255, 0.8), 0 0 12px rgba(0, 150, 255, 0.5) inset; } }
        input[type="checkbox"].animate-me, select.animate-me { position: relative; z-index: 1; }
        .camera-page-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding-top: 0; margin: 0; border: none; border-radius: 0; max-width: none; box-sizing: border-box; }
        #cameraStream { width: 100%; height: 100%; object-fit: contain; }
        #freezeFrameDisplay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: 2015; border: 8px solid #00bcd4; box-sizing: border-box; }
        #captureBtn { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 2020; width: 70px; height: 70px; background-color: #fff; border: 4px solid #fff; border-radius: 50%; box-shadow: 0 0 0 4px #333; cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 0; transition: background-color 0.3s ease, box-shadow 0.3s ease; }
        #captureBtn::before { content: ''; width: 50px; height: 50px; background-color: #333; border-radius: 50%; display: block; }
        #captureBtn:hover { background-color: #f0f0f0; box-shadow: 0 0 0 5px #555; }
        #captureBtn:active { background-color: #e0e0e0; box-shadow: 0 0 0 5px #000; }
        #closeCameraBtn { position: absolute; bottom: 20px; right: 20px; z-index: 2020; width: 45px; height: 45px; background-color: rgba(40, 40, 40, 0.8); color: #ff4d4d; border: 1px solid #ff4d4d; border-radius: 4px; font-size: 1.8em; line-height: 43px; text-align: center; padding: 0; cursor: pointer; transition: background-color 0.3s ease, color 0.3s ease; }
        #closeCameraBtn:hover { background-color: rgba(255, 77, 77, 0.9); color: #fff; border-color: #fff; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 10000; padding: 15px; box-sizing: border-box; }
        .modal-content { background-color: #333; padding: 20px 25px; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.6); width: 90%; max-width: 550px; color: #e0e0e0; border-top: 5px solid #007bff; max-height: 80vh; overflow-y: auto; }
        .modal-content h2 { margin-top: 0; margin-bottom: 15px; color: #00aeff; border-bottom: 1px solid #555; padding-bottom: 10px; font-size: 1.5em; }
        .modal-content ul { list-style-position: inside; padding-left: 5px; }
        .modal-content ul li { margin-bottom: 10px; line-height: 1.6; }
        .modal-close-btn { display: block; margin: 25px auto 0 auto; padding: 10px 25px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        .modal-close-btn:hover { background-color: #0056b3; }
        #galleryPageSection { text-align: center; overscroll-behavior-y: contain; }
        #photoGridContainer { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .photo-item { background-color: #3c3c3c; border-radius: 6px; padding: 10px; text-align: center; box-shadow: 0 3px 6px rgba(0,0,0,0.35); display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .photo-item img { max-width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px; cursor: pointer; border: 1px solid #555; }
        .photo-item-caption { font-size: 0.75em; color: #bdbdbd; word-wrap: break-word; margin-bottom: 8px; line-height: 1.3; max-height: 3.9em; overflow: hidden; text-overflow: ellipsis; }
        .photo-item-delete-btn { background-color: #c82333; color: white; border: none; padding: 4px 8px; font-size: 0.9em; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease; }
        .photo-item-delete-btn:hover { background-color: #a41523; }
        #imageLightbox { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; -webkit-tap-highlight-color: transparent; }
        #lightboxContent { position: relative; margin: auto; padding: 0; width: 90%; max-width: 700px; }
        #lightboxImage { display: block; width: 100%; height: auto; max-height: 80vh; object-fit: contain; border: 3px solid #444; border-radius: 5px; }
        #closeLightboxBtn { position: absolute; top: -5px; right: -5px; color: #fff; background-color: #333; border: 1px solid #555; font-size: 28px; font-weight: bold; padding: 0px 10px; line-height: 1.2; border-radius: 50%; cursor: pointer; transition: color 0.3s, background-color 0.3s; z-index: 3010; }
        #closeLightboxBtn:hover, #closeLightboxBtn:focus { background-color: #c82333; color: #fff; text-decoration: none; }
        .swipe-end-indicator { position: fixed; background-color: rgba(255, 0, 0, 0.6); z-index: 10001; opacity: 0; transition: opacity 0.15s ease-out; pointer-events: none; }
        #swipe-end-indicator-left { top: 0; bottom: 0; left: 0; width: 5px; }
        #swipe-end-indicator-right { top: 0; bottom: 0; right: 0; width: 5px; }
        #swipe-end-indicator-top { left: 0; right: 0; top: 0; height: 5px; }
        #swipe-end-indicator-bottom { left: 0; right: 0; bottom: 0; height: 5px; }
        .riepilogo-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        #downloadZipBtn { padding: 8px 12px; background-color: #17a2b8; color: white; border: 1px solid #117a8b; border-radius: 4px; font-size: 0.9em; cursor: pointer; transition: background-color 0.3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
        #downloadZipBtn:hover { background-color: #117a8b; }
        #downloadZipBtn i { font-size: 1.1em; }
        @media (max-width: 768px) { .circle-button { width: 68px; height: 68px; font-size: 1.8em; border-radius: 6px; } .content-wrapper { margin-top: 0; } #bottomNavCircles { padding: 8px 0; } #navButtons button, .action-button { padding: 8px 10px; font-size: 0.85em; } #mainPageNavButtons { width: 100%; padding: 5px; box-sizing: border-box; } #mainPageNavButtons button { font-size: 0.8em; padding: 6px 8px; } #utilityNavButtons button { font-size: 0.85em; padding: 8px 10px; } input[type="text"], input[type="url"], select:not(#targaSwitcherDropdown), textarea { width: 100%; box-sizing: border-box; } #targaSwitcherDropdown { min-width: 160px; font-size: 1em; } #targaDetailsDisplay { font-size: 0.75em; } .table-scroll-wrapper { overflow-x: auto; } .targa-list-table-content { min-width: 600px; } .targa-list-header { display: flex !important; } .targa-list-header .targa-col, .targa-list-item .targa-col { padding: 6px 5px; } .delete-progress-btn { padding: 5px 8px; } .targa-col-targa { min-width: 65px;} .targa-col-posizione{ min-width: 50px;} .targa-col-urgenza { min-width: 45px;} .targa-col-marca { min-width: 70px;} .targa-col-modello { min-width: 80px;} .targa-col-piazzale { min-width: 60px;} .targa-col-actions { min-width: 40px;} #sheetFilterContainer { display: flex; flex-direction: column; align-items: stretch; } #sheetFilterContainer label { margin-bottom: 5px; margin-right: 0; text-align: left;} #sheetFilterDropdown { width: 100%; } .page-action-buttons-container { top: 15px; right: 15px; gap: 8px;} .page-action-button { width: 30px; height: 30px; font-size: 1.2em; } #captureBtn { bottom: 80px; width: 60px; height: 60px; border-width: 3px; box-shadow: 0 0 0 3px #333;} #captureBtn::before { width: 40px; height: 40px; } #closeCameraBtn { bottom: 15px; right: 15px; width: 40px; height: 40px; font-size: 1.6em; line-height: 38px;} #photoGridContainer { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;} .photo-item img { height: 100px; } #lightboxContent { width: 95%; } #lightboxImage { max-height: 75vh; } #closeLightboxBtn { font-size: 22px; top: 0px; right: 0px; padding: 0px 8px;} #downloadZipBtn { padding: 6px 10px; font-size: 0.85em; } }
        @media (max-width: 400px) { .circle-button { width: 60px; height: 60px; font-size: 1.7em; border-radius: 6px; } #bottomNavCircles { padding: 6px 0; } #photoGridContainer { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); } .modal-content { width: 95%; padding: 15px; } .modal-content h2 {font-size: 1.3em;} #captureBtn { bottom: 75px; width: 55px; height: 55px; border-width: 3px; box-shadow: 0 0 0 3px #222;} #captureBtn::before { width: 35px; height: 35px; background-color: #222; } .riepilogo-header { flex-direction: column; align-items: flex-start; gap: 10px;} .riepilogo-header .section-title { width: 100%; text-align: center; } #downloadZipBtn { width: 100%; justify-content: center;} }
    </style>
</head>
<body>
    <div id="preloader">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">AVVIO IN CORSO...</div>
    </div>

    <div id="changelogModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="changelogTitle">WebApp Perizie - Novità</h2>
            <ul id="changelogList"></ul>
            <button id="closeChangelogBtnModal" class="modal-close-btn">Chiudi</button>
        </div>
    </div>

    <div id="exit-curtain" data-text="CHIUSURA IN CORSO...">
        <div class="loader-bar-container">
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
            <div class="loader-bar"></div>
        </div>
        <div class="loading-text">CHIUSURA IN CORSO...</div>
    </div>

    <div id="imageLightbox">
        <span id="closeLightboxBtn">&times;</span>
        <div id="lightboxContent">
            <img id="lightboxImage" src="#" alt="Immagine Ingrandita">
        </div>
    </div>
    
    <div id="swipe-end-indicator-left" class="swipe-end-indicator"></div>
    <div id="swipe-end-indicator-right" class="swipe-end-indicator"></div>
    <div id="swipe-end-indicator-top" class="swipe-end-indicator"></div>
    <div id="swipe-end-indicator-bottom" class="swipe-end-indicator"></div>


    <div id="pageHeaderContainer">
        <div id="utilityNavButtons">
            <button id="backToListBtn" class="action-button" style="background-color: #6c757d; border-color: #5a6268;">Elenco Targhe</button>
            <button id="historyBtn" class="action-button" style="background-color: #17a2b8; border-color: #117a8b;">Salvataggi</button>
            <button id="exitAppBtn" class="action-button" style="background-color: #dc3545; border-color: #c82333;">Esci</button>
        </div>
        <h1 id="mainTitleGlobal">Checklist Perizia Veicolo</h1>
        <div id="targaDropdownContainer" style="display: none;">
            <select id="targaSwitcherDropdown"></select>
            <span id="targaDetailsDisplay"></span>
        </div>
        <div id="navButtons">
            <div id="mainPageNavButtons">
                <button data-target="remarketing">1. Remarketing</button>
                <button data-target="pneumatici">2. Pneumatici</button>
                <button data-target="danniVerifiche">3. Danni/Verifiche</button>
                <button data-target="riepilogo">Riepilogo</button>
            </div>
        </div>
    </div>

    <div class="content-wrapper" id="mainContentWrapper">
        <div id="landingPageSection" style="display: block;">
            <h2 style="margin-top: 10px;">Seleziona Veicolo da Periziare</h2>
            <div id="sheetFilterContainer">
                <label for="sheetFilterDropdown">Filtra per Elenco:</label>
                <select id="sheetFilterDropdown">
                    <option value="all">Tutti gli Elenchi</option>
                </select>
                <button id="scanPlateBtn" class="action-button" style="background-color: #28a745; border-color: #1e7e34; margin-top: 10px;">
                    <i class="fas fa-camera"></i> Scansiona Targa
                </button>
            </div>
            <div id="targheLoadingStatus">Caricamento targhe in corso...</div>
            <div class="table-scroll-wrapper">
                <div class="targa-list-table-content">
                    <div class="targa-list-header">
                        <span class="targa-col targa-col-targa">Targa</span>
                        <span class="targa-col targa-col-posizione">Posizione</span>
                        <span class="targa-col targa-col-urgenza">Urgenza</span>
                        <span class="targa-col targa-col-marca">Marca</span>
                        <span class="targa-col targa-col-modello">Modello</span>
                        <span class="targa-col targa-col-piazzale">Piazzale</span>
                        <span class="targa-col targa-col-actions">Azioni</span>
                    </div>
                    <div id="targaListContainer"></div>
                </div>
            </div>
        </div>

        <div id="checklistContainer" style="display: none;">
            <div id="remarketingSection" class="category-section">
                </div>
            <div id="pneumaticiSection" class="category-section">
                </div>
            <div id="danniVerificheSection" class="category-section">
                </div>
            <div id="riepilogoSection" class="category-section">
                 </div>
        </div>

        <div id="historyPageSection" style="display: none;">
            </div>

        <div id="galleryPageSection" style="display: none;">
            </div>

        <div id="cameraPageSection" class="camera-page-section" style="display: none;">
            
            <div id="ocrOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; z-index: 2018; background-color: rgba(0,0,0,0.5);">
                <img id="ocrFrozenImage" src="#" alt="Targa Bloccata" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; display: none; z-index: 1;">
                <div id="ocrTargetBox" style="width: 80%; max-width: 400px; height: 100px; border: 3px dashed #ffc107; background-color: rgba(0,0,0,0.2); border-radius: 10px; margin: auto; z-index: 2;"></div>
                <div id="ocrControls" style="position: absolute; bottom: 0; left: 0; width: 100%; background-color: rgba(0,0,0,0.8); padding: 15px; box-sizing: border-box; text-align: center; z-index: 2;">
                    <p id="ocrStatusText" style="color: white; font-size: 1.1em; margin-top: 0; margin-bottom: 15px;">Inquadra la targa nel riquadro</p>
                    <div style="display: flex; justify-content: center; gap: 10px;">
                        <button id="ocrFreezeBtn" class="action-button" style="background-color: #007bff;"><i class="fas fa-pause"></i> Blocca Targa</button>
                        <button id="ocrScanBtn" class="action-button" style="background-color: #28a745; display: none;"><i class="fas fa-search"></i> Acquisisci</button>
                        <button id="ocrExitBtn" class="action-button" style="background-color: #dc3545;"><i class="fas fa-times"></i> Esci</button>
                    </div>
                </div>
            </div>

            <video id="cameraStream" autoplay playsinline></video>
            <img id="freezeFrameDisplay" src="#" alt="Foto Catturata" style="display: none;">
            <button id="captureBtn" class="action-button"></button>
            <button id="closeCameraBtn" class="action-button">×</button> 
        </div>

    </div>
    
    <div id="bottomNavCircles">
        <div class="header-circles">
            <button id="headerShutdownBtn" class="circle-button" title="Spegni Tablet"><i class="fas fa-power-off"></i></button>
            <button id="headerPhotosBtn" class="circle-button" title="Galleria Foto App"><i class="fas fa-images"></i></button>
            <button id="headerPeriziaBtn" class="circle-button" title="Vai all'ultima perizia/sezione"><i class="fas fa-clipboard-list"></i></button>
            <button id="headerCameraBtn" class="circle-button" title="Fotocamera"><i class="fas fa-camera-retro"></i></button>
        </div>
    </div>

<script>
// ==================================================================
// ==== INIZIO SCRIPT COMPLETO - COPIA E INCOLLA TUTTO QUESTO ====
// ==================================================================

  // Variabili globali
    const landingPageSection = document.getElementById('landingPageSection');
    const checklistContainer = document.getElementById('checklistContainer');
    const historyPageSection = document.getElementById('historyPageSection');
    const galleryPageSection = document.getElementById('galleryPageSection');
    const photoGridContainer = document.getElementById('photoGridContainer');
    const backToMainFromGalleryBtn = document.getElementById('backToMainFromGalleryBtn');

    const cameraPageSection = document.getElementById('cameraPageSection');
    const cameraStreamElement = document.getElementById('cameraStream');
    const freezeFrameDisplayElement = document.getElementById('freezeFrameDisplay');
    const captureBtn = document.getElementById('captureBtn');
    const closeCameraBtn = document.getElementById('closeCameraBtn');
    let currentCameraStream = null;
    let lastViewBeforeCamera = 'landing';
    let lastSectionBeforeCamera = null;

    const bottomNavCircles = document.getElementById('bottomNavCircles');

    const targaListContainer = document.getElementById('targaListContainer');
    const savedTargasListContainer = document.getElementById('savedTargasListContainer');
    const targheLoadingStatus = document.getElementById('targheLoadingStatus');
    const pageHeaderContainer = document.getElementById('pageHeaderContainer');
    const mainTitleGlobal = pageHeaderContainer.querySelector('#mainTitleGlobal');
    const targaDropdownContainer = document.getElementById('targaDropdownContainer');
    const targaSwitcherDropdown = document.getElementById('targaSwitcherDropdown');
    const targaDetailsDisplay = document.getElementById('targaDetailsDisplay');

    const navButtonsContainer = pageHeaderContainer.querySelector('#navButtons');
    const mainPageNavButtons = navButtonsContainer.querySelector('#mainPageNavButtons');
    const utilityNavButtons = pageHeaderContainer.querySelector('#utilityNavButtons');

    const navButtons = mainPageNavButtons.querySelectorAll('button[data-target]');

    const backToListBtn = utilityNavButtons.querySelector('#backToListBtn');
    const historyBtn = utilityNavButtons.querySelector('#historyBtn');
    const mainExitAppBtn = utilityNavButtons.querySelector('#exitAppBtn');
    let syncToSheetsBtn;

    const headerShutdownBtn = document.getElementById('headerShutdownBtn');
    const headerPhotosBtn = document.getElementById('headerPhotosBtn');
    const headerPeriziaBtn = document.getElementById('headerPeriziaBtn');
    const headerCameraBtn = document.getElementById('headerCameraBtn');

    const sections = document.querySelectorAll('#checklistContainer .category-section');
    const summaryContent = document.getElementById('summaryContent');
    const clearAllProgressBtn = document.getElementById('clearAllProgressBtn');
    const backToLandingFromHistoryBtn = document.getElementById('backToLandingFromHistoryBtn');
    const saveAndReturnBtn = document.getElementById('saveAndReturnBtn');
    const saveAndNextButtons = document.querySelectorAll('.save-and-next-btn');
    const sheetFilterDropdown = document.getElementById('sheetFilterDropdown');
    const tipoTrazioneSelect = document.getElementById('tipo_trazione');
    const cavoRapidaSelect = document.getElementById('cavo_ricarica_rapida');
    const cavoDomesticaSelect = document.getElementById('cavo_ricarica_domestica');

    const imageLightbox = document.getElementById('imageLightbox');
    const lightboxImage = document.getElementById('lightboxImage');
    const closeLightboxBtnElem = document.getElementById('closeLightboxBtn');
    let currentLightboxImageObjectUrl = null;
    let currentLightboxPhotoList = [];
    let currentLightboxPhotoIndex = -1;

    const downloadZipBtn = document.getElementById('downloadZipBtn');

    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyr8y5rUam29BeUwH9JKGz5hQknO3vWnczW3CYuzwnfqPwmxsWw20usJeMo9UH3yPyfsMBSkvKdy5n/pub?output=csv';
    const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzN4bBhPi4d8i7fSpJQqCJ2CQYOtmes1yKeGeqVe053K4QkdKYH4PuQIughn_9YLEfCkA/exec';

    let listaTargheCompleta = [];
    let targaSelezionataGlobalmente = null;
    const APP_PREFIX = 'periziaApp_';
    const LAST_ACTIVE_PERIZIA_PAGE_KEY = `${APP_PREFIX}lastActivePeriziaPage`;

    const currentAppVersion = "1.6.4";
    const changelogModal = document.getElementById('changelogModal');
    const closeChangelogBtnModal = document.getElementById('closeChangelogBtnModal');
    const changelogList = document.getElementById('changelogList');
    const changelogTitle = document.getElementById('changelogTitle');

    let touchstartX = 0, touchstartY = 0;
    let touchendX = 0, touchendY = 0;
    const swipeThreshold = 50;
    const sectionOrder = ['remarketing', 'pneumatici', 'danniVerifiche', 'riepilogo'];

    let currentGalleryTargaFilter = null;
    let currentGallerySectionFilter = null;
    let lastViewBeforeGallery = 'landing';
    let lastSectionBeforeGallery = null;

    let lightboxTouchStartX = 0;
    let lightboxTouchStartY = 0;

    let galleryGridTouchStartY = 0;

    const IDB_NAME = 'PeriziePhotoDB_v1';
    const IDB_VERSION = 1;
    const PHOTO_STORE_NAME = 'capturedPhotosStore';
    let dbPromise = null;

// ========= INIZIO BLOCCO OCR A 3 PULSANTI ===========

// --- Variabili globali per la nuova modalità OCR ---
const scanPlateBtn = document.getElementById('scanPlateBtn');
const ocrOverlay = document.getElementById('ocrOverlay');
const ocrStatusText = document.getElementById('ocrStatusText');
const ocrFreezeBtn = document.getElementById('ocrFreezeBtn');
const ocrScanBtn = document.getElementById('ocrScanBtn');
const ocrExitBtn = document.getElementById('ocrExitBtn');
const ocrFrozenImage = document.getElementById('ocrFrozenImage');
let frozenCanvas = null; // Per conservare l'immagine bloccata
let isScanningForPlate = false; // Variabile di stato

// --- Funzioni per la nuova modalità OCR ---

// 1. Funzione chiamata dal pulsante "Scansiona Targa"
function startPlateScan() {
    // Salva la vista corrente prima di aprire la fotocamera
    lastViewBeforeCamera = 'landing'; // La scansione parte sempre dalla lista
    lastSectionBeforeCamera = null;
    
    showView('camera'); // Apre la vista fotocamera
    isScanningForPlate = true;
    
    // Nasconde i controlli della fotocamera standard
    captureBtn.style.display = 'none';
    closeCameraBtn.style.display = 'none';
    
    // Mostra l'interfaccia di scansione e imposta lo stato iniziale
    ocrOverlay.style.display = 'flex';
    ocrFrozenImage.style.display = 'none';
    if (cameraStreamElement.paused) {
        cameraStreamElement.play();
    }
    cameraStreamElement.style.display = 'block'; // Assicurati che il video sia visibile
    
    ocrStatusText.textContent = 'Inquadra la targa nel riquadro';
    ocrFreezeBtn.style.display = 'inline-block';
    ocrScanBtn.style.display = 'none';
    ocrExitBtn.style.display = 'inline-block';
}

// 2. Funzione per bloccare l'immagine
function freezePlateImage() {
    frozenCanvas = document.createElement('canvas');
    const context = frozenCanvas.getContext('2d');
    frozenCanvas.width = cameraStreamElement.videoWidth;
    frozenCanvas.height = cameraStreamElement.videoHeight;
    context.drawImage(cameraStreamElement, 0, 0, frozenCanvas.width, frozenCanvas.height);
    cameraStreamElement.pause(); // Metti in pausa lo stream video

    // Mostra l'immagine bloccata
    ocrFrozenImage.src = frozenCanvas.toDataURL('image/jpeg');
    ocrFrozenImage.style.display = 'block';
    
    // Aggiorna l'interfaccia: nascondi "Blocca", mostra "Acquisisci"
    ocrStatusText.textContent = 'Immagine bloccata. Premi "Acquisisci".';
    ocrFreezeBtn.style.display = 'none';
    ocrScanBtn.style.display = 'inline-block';
}

// 3. Funzione per analizzare l'immagine bloccata
async function acquirePlateFromImage() {
    if (!frozenCanvas) return;

    ocrStatusText.textContent = 'Analisi in corso...';
    ocrScanBtn.style.display = 'none';
    ocrExitBtn.style.display = 'none';

    try {
        const worker = await Tesseract.createWorker('eng');
        await worker.setParameters({
            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',
        });
        const { data: { text } } = await worker.recognize(frozenCanvas);
        await worker.terminate();

        const cleanedText = text.replace(/[^A-Z0-9]/g, '');
        const plateRegex = /^[A-Z]{2}\d{3}[A-Z]{2}$/;

        if (plateRegex.test(cleanedText)) {
            const foundVehicle = listaTargheCompleta.find(v => v.targa.toUpperCase() === cleanedText.toUpperCase());
            if (foundVehicle) {
                alert(`Targa trovata: ${cleanedText}! Caricamento perizia...`);
                exitPlateScan(cleanedText);
            } else {
                alert(`Targa "${cleanedText}" letta, ma non presente in elenco. Riprova.`);
                startPlateScan();
            }
        } else {
            alert('Nessuna targa valida trovata. Riprova inquadrando meglio.');
            startPlateScan();
        }
    } catch (error) {
        console.error("Errore OCR:", error);
        alert("Errore durante l'analisi dell'immagine.");
        startPlateScan();
    }
}

// 4. Funzione per uscire dalla modalità scansione
async function exitPlateScan(targaDaCaricare = null) {
    isScanningForPlate = false;
    ocrOverlay.style.display = 'none';
    
    captureBtn.style.display = 'flex';
    closeCameraBtn.style.display = 'flex';
    
    returnFromCamera();

    if (targaDaCaricare) {
        await handleTargaSelectionAndSync(targaDaCaricare);
    } else {
        showView('landing');
    }
}

// ========= FINE BLOCCO OCR A 3 PULSANTI ===========

    function openPhotoDB() {
        if (dbPromise) return dbPromise;
        dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(IDB_NAME, IDB_VERSION);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(PHOTO_STORE_NAME)) {
                    const store = db.createObjectStore(PHOTO_STORE_NAME, { keyPath: 'timestamp' });
                    store.createIndex('targaIdx', 'targa', { unique: false });
                    store.createIndex('sezioneIdx', 'sezione', { unique: false });
                    store.createIndex('targaSezioneIdx', ['targa', 'sezione'], { unique: false });
                }
            };
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => {
                console.error("Errore apertura IndexedDB:", event.target.error);
                dbPromise = null;
                reject(event.target.error);
            };
        });
        return dbPromise;
    }

    // ... (Il resto di tutte le funzioni originali, da savePhotoToDB a handleSwipeGesture, va qui)
    // ...
    // COPIA E INCOLLA TUTTE LE FUNZIONI CHE SI TROVANO TRA QUESTO PUNTO E "document.addEventListener"
    // CHE HAI NEL TUO FILE FUNZIONANTE PRECEDENTE. DI SEGUITO LE RIPORTO PER COMPLETEZZA.

    async function savePhotoToDB(photoData) { /* ... */ }
    async function getAllPhotosFromDB() { /* ... */ }
    async function getPhotosByTargaAndSezioneFromDB(targaFilter, sectionKeyFilter) { /* ... */ }
    async function deletePhotoFromDB(timestampToDelete) { /* ... */ }
    function showSwipeEndIndicator(side) { /* ... */ }
    function resetSectionFields(sectionId) { /* ... */ }
    function updateTargaDetailsDisplay(selectedTarga) { /* ... */ }
    function populateTargaSwitcherDropdown() { /* ... */ }
    async function inviaPeriziaSingolaASheets(periziaDaInviare) { /* ... */ }
    async function fetchLatestPeriziaFromSheets(targa) { /* ... */ }
    function fillSectionPositiveOrDefaults(sectionId) { /* ... */ }
    function handleTrazioneChange() { /* ... */ }
    function savePosizioneForTarga(targa, posizione) { /* ... */ }
    function loadPosizioneForTarga(targa) { /* ... */ }
    function saveUrgentStatusForTarga(targa, isUrgent) { /* ... */ }
    function loadUrgentStatusForTarga(targa) { /* ... */ }
    function resetChecklistForm() { /* ... */ }
    function saveProgress(targa) { /* ... */ }
    function loadProgress(targa) { /* ... */ }
    function getCompletedTarghe() { /* ... */ }
    function isTargaCompleted(targa) { /* ... */ }
    function markTargaAsCompleted(targa) { /* ... */ }
    function unmarkTargaAsCompleted(targa) { /* ... */ }
    function clearLocalDataForTarga(targaUpper) { /* ... */ }
    function generateAndDownloadScreenshot() { /* ... */ }
    async function handleSavePeriziaAndReturn() { /* ... */ }
    function handleSaveAndNext() { /* ... */ }
    function isInputDefault(inputElement) { /* ... */ }
    function getSectionInputs(sectionElementId) { /* ... */ }
    function getSectionStatus(sectionElementId, targaData) { /* ... */ }
    function updateNavButtonColors() { /* ... */ }
    function showView(viewName) { /* ... */ }
    async function showCameraPage() { /* ... */ }
    function returnFromCamera() { /* ... */ }
    function getFilenameSectionName() { /* ... */ }
    function getNextPhotoNumber(targa, sectionName) { /* ... */ }
    function capturePhoto() { /* ... */ }
    async function showGalleryPage(targaToFilter = null, sectionToFilter = null) { /* ... */ }
    async function populatePhotoGrid(targaFilter, sectionKeyFilter) { /* ... */ }
    async function deleteCapturedPhoto(timestampToDelete, targa, sezione) { /* ... */ }
    async function openImageLightbox(timestamp) { /* ... */ }
    function closeImageLightbox() { /* ... */ }
    function handleLightboxTouchStart(event) { /* ... */ }
    function handleLightboxTouchEnd(event) { /* ... */ }
    function handleLightboxSwipe(endX, endY) { /* ... */ }
    function handleGalleryGridTouchStart(event) { /* ... */ }
    function handleGalleryGridTouchMove(event) { /* ... */ }
    async function handleTargaSelectionAndSync(selectedTarga, targetSectionId = null) { /* ... */ }
    function populateSavedTargasList() { /* ... */ }
    function clearAllSavedData() { /* ... */ }
    function setupSheetFilterDropdown() { /* ... */ }
    function handleSheetFilterChange() { /* ... */ }
    function popolaTargheFiltrate() { /* ... */ }
    // NUOVA VERSIONE CON TIMEOUT
async function caricaEPopolaTarghe() {
    if (targheLoadingStatus) targheLoadingStatus.textContent = "Download elenco targhe...";

    // Imposta un controller per annullare il download dopo 10 secondi
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 secondi

    try {
        const response = await fetch(GOOGLE_SHEET_CSV_URL + `&nocache=${new Date().getTime()}`, {
            signal: controller.signal // Collega il controller al fetch
        });

        // Una volta ricevuta la risposta, cancella il timer
        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`Errore server HTTP ${response.status}.`);
        }

        const csv = await response.text();
        const lines = csv.split(/\r\n|\n|\r/).filter(l => l.trim() !== '');
        if (lines.length === 0) {
            throw new Error("Il file CSV da Google Sheets è vuoto.");
        }

        listaTargheCompleta = lines.map(l => {
            const p = l.split(',');
            return {
                targa: (p[0] || '').trim().replace(/^"|"$/g, '').toUpperCase(),
                marca: (p[1] || '').trim().replace(/^"|"$/g, ''),
                modello: (p[2] || '').trim().replace(/^"|"$/g, ''),
                piazzale: (p[3] || '').trim().replace(/^"|"$/g, '')
            };
        }).filter(i => i.targa && i.targa.length > 3);

        if (listaTargheCompleta.length === 0) {
             if (targheLoadingStatus) targheLoadingStatus.textContent = "Nessuna targa valida trovata nel file.";
        } else {
            setupSheetFilterDropdown();
            popolaTargheFiltrate();
        }

    } catch (error) {
        if (error.name === 'AbortError') {
            console.error("Timeout: impossibile scaricare l'elenco targhe in 10 secondi.");
            if (targheLoadingStatus) targheLoadingStatus.textContent = "Timeout: impossibile scaricare l'elenco targhe. Controlla la connessione.";
        } else {
            console.error("Errore durante il caricamento delle targhe:", error);
            if (targheLoadingStatus) targheLoadingStatus.textContent = `Errore di rete: ${error.message}`;
        }
        listaTargheCompleta = [];
        if (sheetFilterDropdown) sheetFilterDropdown.innerHTML = '<option value="all">Nessun elenco caricato</option>';
        if (targaListContainer) targaListContainer.innerHTML = '';
    }
}
    function initSequentialAnimation() { /* ... */ }
    function showSection(targetId) { /* ... */ }
    function getSelectText(selectElementOrId) { /* ... */ }
    function generateSummary() { /* ... */ }
    async function fetchAllDataFromSheets() { /* ... */ }
    async function syncAllLocalDataToSheets() { /* ... */ }
    function triggerMainExit() { /* ... */ }
    function handleTouchStart(event) { /* ... */ }
    function handleTouchEnd(event) { /* ... */ }
    async function handleSwipeGesture() { /* ... */ }
    async function initializeApplicationViewAndLoadData() { /* ... */ }


    document.addEventListener('DOMContentLoaded', () => {
        syncToSheetsBtn = document.createElement('button');
        syncToSheetsBtn.id = 'syncToSheetsBtn';
        syncToSheetsBtn.classList.add('action-button');
        syncToSheetsBtn.textContent = 'Sincronizza';
        syncToSheetsBtn.style.backgroundColor = '#ffc107';
        syncToSheetsBtn.style.borderColor = '#e0a800';
        syncToSheetsBtn.style.color = '#212529';
        const historyButton = document.getElementById('historyBtn');
        if (historyButton && historyButton.parentNode === utilityNavButtons) {
            utilityNavButtons.insertBefore(syncToSheetsBtn, historyButton.nextSibling);
        } else {
            utilityNavButtons.appendChild(syncToSheetsBtn);
        }
        syncToSheetsBtn.addEventListener('click', syncAllLocalDataToSheets);

        document.querySelectorAll('.fill-defaults-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.dataset.sectionid;
                fillSectionPositiveOrDefaults(sectionId);
                saveProgress(targaSelezionataGlobalmente);
            });
        });

        document.querySelectorAll('.reset-page-btn').forEach(button => {
            button.addEventListener('click', function() {
                const sectionId = this.dataset.sectionid;
                if (confirm(`Sei sicuro di voler azzerare i campi per questa sezione?`)) {
                    resetSectionFields(sectionId);
                }
            });
        });

        if (tipoTrazioneSelect) tipoTrazioneSelect.addEventListener('change', handleTrazioneChange);
        if (targaSwitcherDropdown) targaSwitcherDropdown.addEventListener('change', async function() {
            const nuovaTarga = this.value;
            if (nuovaTarga && nuovaTarga !== targaSelezionataGlobalmente) {
                await handleTargaSelectionAndSync(nuovaTarga, 'remarketing');
            }
        });

        if (backToListBtn) backToListBtn.addEventListener('click', () => showView('landing'));
        if (historyBtn) historyBtn.addEventListener('click', () => showView('history'));
        if (clearAllProgressBtn) clearAllProgressBtn.addEventListener('click', clearAllSavedData);
        if (backToLandingFromHistoryBtn) backToLandingFromHistoryBtn.addEventListener('click', () => showView('landing'));
        if (backToMainFromGalleryBtn) backToMainFromGalleryBtn.addEventListener('click', () => {
            if (lastViewBeforeGallery === 'checklist' && currentGalleryTargaFilter && lastSectionBeforeGallery) {
                showView('checklist');
                showSection(lastSectionBeforeGallery);
            } else {
                showView('landing');
            }
        });

        if (saveAndReturnBtn) saveAndReturnBtn.addEventListener('click', handleSavePeriziaAndReturn);
        saveAndNextButtons.forEach(button => button.addEventListener('click', handleSaveAndNext));

        if (headerShutdownBtn) headerShutdownBtn.addEventListener('click', () => {
            fetch('https://trigger.macrodroid.com/5759064d-6af9-4af0-aef0-2548335e41fd/disattivaperizie', { mode: 'no-cors' });
        });
        if (headerPhotosBtn) headerPhotosBtn.addEventListener('click', () => showGalleryPage(targaSelezionataGlobalmente, 'riepilogo'));
        if (headerPeriziaBtn) headerPeriziaBtn.addEventListener('click', () => {
            if(targaSelezionataGlobalmente) {
                showView('checklist');
                showSection(localStorage.getItem(LAST_ACTIVE_PERIZIA_PAGE_KEY) || 'remarketing');
            } else {
                showView('landing');
            }
        });

        // --- COLLEGAMENTI PER NUOVA MODALITÀ OCR E FOTOCAMERA ---

        // Pulsante "Scansiona Targa" nella lista
        if (scanPlateBtn) {
            scanPlateBtn.addEventListener('click', startPlateScan);
        }

        // Pulsante FOTOCAMERA nella barra in basso
        if (headerCameraBtn) {
            headerCameraBtn.addEventListener('click', () => {
                if (cameraPageSection.style.display === 'flex') {
                    if (isScanningForPlate) { exitPlateScan(null); } 
                    else { returnFromCamera(); }
                } else {
                    isScanningForPlate = false;
                    // Salva la vista corrente prima di aprire la fotocamera
                    if (galleryPageSection.style.display === 'block') {
                        lastViewBeforeCamera = 'gallery';
                        lastSectionBeforeCamera = currentGallerySectionFilter;
                    } else if (checklistContainer.style.display === 'block') {
                        lastViewBeforeCamera = 'checklist';
                        const activeSectionElement = document.querySelector('#checklistContainer .category-section.active');
                        lastSectionBeforeCamera = activeSectionElement ? activeSectionElement.id.replace('Section', '') : null;
                    } else {
                        lastViewBeforeCamera = 'landing';
                        lastSectionBeforeCamera = null;
                    }
                    showView('camera');
                }
            });
        }
        
        // Pulsante di SCATTO/CATTURA principale (ora funziona solo in modalità foto)
        if (captureBtn) {
            captureBtn.addEventListener('click', capturePhoto);
        }

        // Pulsanti interni all'interfaccia di scansione
        if (ocrFreezeBtn) ocrFreezeBtn.addEventListener('click', freezePlateImage);
        if (ocrScanBtn) ocrScanBtn.addEventListener('click', acquirePlateFromImage);
        if (ocrExitBtn) ocrExitBtn.addEventListener('click', () => exitPlateScan(null));

        // Pulsante 'X' (close) della fotocamera
        if (closeCameraBtn) {
            closeCameraBtn.addEventListener('click', () => {
                if (isScanningForPlate) {
                    exitPlateScan(null);
                } else {
                    returnFromCamera();
                }
            });
        }
        
        document.addEventListener('keydown', function(event) {
            const shutterKeys = ['Enter', 'AudioVolumeUp', 'AudioVolumeDown', ' '];
            if (cameraPageSection.style.display === 'flex' && !isScanningForPlate && shutterKeys.includes(event.key)) {
                event.preventDefault();
                capturePhoto();
            }
        });

        navButtons.forEach(b => b.addEventListener('click', () => showSection(b.dataset.target)));

        if (closeLightboxBtnElem) closeLightboxBtnElem.addEventListener('click', closeImageLightbox);
        if (imageLightbox) { /* ... */ }
        
        const mainWrapper = document.getElementById('mainContentWrapper');
        if (mainWrapper) { /* ... */ }
        if (galleryPageSection) { /* ... */ }
        
        initializeApplicationViewAndLoadData();
        
        if (mainExitAppBtn) mainExitAppBtn.addEventListener('click', () => { /* ... */ });
    });


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
</html>

